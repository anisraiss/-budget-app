<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#08080C">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiB2aWV3Qm94PSIwIDAgMTgwIDE4MCI+PHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIHJ4PSI0MCIgZmlsbD0iIzA4MDgwQyIvPjx0ZXh0IHg9IjkwIiB5PSI5OCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9Ii1hcHBsZS1zeXN0ZW0sc3lzdGVtLXVpLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDQiIGZvbnQtd2VpZ2h0PSI5MDAiIGxldHRlci1zcGFjaW5nPSI2IiBmaWxsPSIjRTJBOTNCIj5HUklQPC90ZXh0Pjwvc3ZnPg==">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiB2aWV3Qm94PSIwIDAgMTgwIDE4MCI+PHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIHJ4PSI0MCIgZmlsbD0iIzA4MDgwQyIvPjx0ZXh0IHg9IjkwIiB5PSI5OCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9Ii1hcHBsZS1zeXN0ZW0sc3lzdGVtLXVpLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDQiIGZvbnQtd2VpZ2h0PSI5MDAiIGxldHRlci1zcGFjaW5nPSI2IiBmaWxsPSIjRTJBOTNCIj5HUklQPC90ZXh0Pjwvc3ZnPg==">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GRIP">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR1JJUCIsInNob3J0X25hbWUiOiJHUklQIiwiZGVzY3JpcHRpb24iOiJXZWV0IHdhdCBqZSBrdW50IHNwYXJlbiIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMDgwODBDIiwidGhlbWVfY29sb3IiOiIjMDgwODBDIn0=">
    <title>GRIP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;0,9..40,900;1,9..40,400&display=swap" rel="stylesheet">
    <style>
    /* ═══════════════════════════════════════
       GRIP — DESIGN TOKENS
       ═══════════════════════════════════════ */
    :root {
        /* Brand */
        --accent: #E2A93B;
        --accent-bright: #F0BD5C;
        --accent-rgb: 226, 169, 59;
        --accent-rgb: 226,169,59;
        --accent-dim: rgba(226,169,59,0.08);
        --accent-mid: rgba(226,169,59,0.20);
        --accent-glow: rgba(226,169,59,0.12);

        /* Status — locked tokens */
        --green: #34D399;
        --green-dim: rgba(61,213,152,0.10);
        --red: #F87171;
        --red-dim: rgba(232,90,90,0.10);
        --caution: #E8965A;
        --caution-dim: rgba(232,150,90,0.10);
        --danger: #E85A5A;
        --danger-dim: rgba(232,90,90,0.10);

        /* Surfaces — Dark */
        --bg: #08080C;
        --bg-card: rgba(255,255,255,0.028);
        --bg-card-solid: #111116;
        --bg-elevated: #16161c;
        --bg-input: #0e0e14;
        --glass: rgba(255,255,255,0.035);
        --glass-border: rgba(255,255,255,0.07);

        /* Text */
        --text-primary: #f0f0f5;
        --text-secondary: rgba(255,255,255,0.55);
        --text-tertiary: rgba(255,255,255,0.45);
        --text-muted: rgba(255,255,255,0.50);

        /* Spacing */
        --space-xs: 4px;
        --space-sm: 8px;
        --space-md: 12px;
        --space-lg: 16px;
        --space-xl: 20px;
        --space-2xl: 24px;
        --space-3xl: 32px;

        /* Radius */
        --radius-sm: 10px;
        --radius-md: 14px;
        --radius-lg: 18px;
        --radius-xl: 24px;
        --radius-full: 50%;

        /* Shadows */
        --shadow: 0 2px 16px rgba(0,0,0,0.3);
        --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);

        /* Motion */
        --ease: cubic-bezier(0.4, 0, 0.2, 1);
        --duration: 0.25s;

        /* Type */
        --font: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        --tabular: tabular-nums;
    }

    /* Light mode */
    

    /* ═══════════════════════════════════════
       RESET & BASE
       ═══════════════════════════════════════ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { touch-action: manipulation; color-scheme: dark; }

    body {
        font-family: var(--font);
        background: var(--bg);
        color: var(--text-primary);
        min-height: 100svh;
        min-height: 100vh; /* fallback */
        overflow-x: hidden;
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
        width: 100%;
        -webkit-font-smoothing: antialiased;
        -webkit-tap-highlight-color: transparent;
    }

    .hidden { display: none !important; }

    /* ═══════════════════════════════════════
       PIN SCREEN
       ═══════════════════════════════════════ */
    .pin-screen {
        position: fixed;
        inset: 0;
        background: var(--bg);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .pin-logo {
        font-size: 1.6rem;
        font-weight: 900;
        letter-spacing: 6px;
        color: var(--accent);
        margin-bottom: 32px;
    }

    .pin-subtitle {
        font-size: 0.85rem;
        color: var(--text-tertiary);
        margin-bottom: 24px;
    }

    .pin-dots {
        display: flex;
        gap: 20px;
        margin-bottom: 32px;
    }

    .pin-dot {
        width: 16px;
        height: 16px;
        border-radius: var(--radius-full);
        border: 2px solid rgba(255,255,255,0.2);
        transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        transition: all var(--duration) var(--ease);
    }

    .pin-dot.filled {
        background: var(--accent);
        border-color: var(--accent);
        transform: scale(1.15);
    }

    .pin-error {
        font-size: 0.82rem;
        color: var(--danger);
        margin-top: var(--space-md);
        opacity: 0;
        transition: opacity 0.3s;
    }
    .pin-error.show { opacity: 1; }
    .pin-key:active { background: rgba(226,169,59,0.15); border-color: rgba(226,169,59,0.3); transform: scale(0.95); }
    .pin-shake { animation: pinShake 0.5s ease; }
    @keyframes pinShake { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-8px)} 40%,80%{transform:translateX(8px)} }

    .pin-keypad {
        display: grid;
        grid-template-columns: repeat(3, 72px);
        gap: 12px;
        justify-content: center;
    }

    .pin-key {
        width: 72px;
        height: 72px;
        border-radius: var(--radius-full);
        border: 1px solid rgba(255,255,255,0.08);
        background: rgba(255,255,255,0.04);
        color: var(--text-primary);
        font-size: 1.5rem;
        font-weight: 600;
        font-family: var(--font);
        cursor: pointer;
        transition: all 0.15s ease;
        -webkit-tap-highlight-color: transparent;
        transition: all 0.15s var(--ease);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .pin-key:active { background: var(--accent-dim); transform: scale(0.95); }

    /* ═══════════════════════════════════════
       APP HEADER (glass)
       ═══════════════════════════════════════ */
    .app-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: calc(52px + env(safe-area-inset-top, 0px));
        padding-top: env(safe-area-inset-top, 0px);
        background: rgba(8,8,12,0.85);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border-bottom: none;
        box-shadow: 0 4px 24px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-left: var(--space-lg);
        padding-right: var(--space-lg);
        z-index: 100;
    }

    .header-logo {
        font-size: 1.1rem;
        font-weight: 900;
        letter-spacing: 4px;
        color: var(--accent);
    }

    .header-avatar {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-full);
        background: var(--accent-dim);
        border: 1.5px solid rgba(var(--accent-rgb), 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        cursor: pointer;
        overflow: hidden;
    }
    .header-avatar img { width:100%;height:100%;object-fit:cover; }

    /* ═══════════════════════════════════════
       TAB BAR (glass, bottom)
       ═══════════════════════════════════════ */
    .tab-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(8,8,12,0.92);
        backdrop-filter: blur(40px) saturate(180%);
        -webkit-backdrop-filter: blur(40px) saturate(180%);
        border-top: none;
        display: flex;
        align-items: center;
        justify-content: space-around;
        z-index: 100;
        padding: 6px 0;
        padding-bottom: calc(6px + env(safe-area-inset-bottom, 0px));
        box-shadow: 0 -8px 32px rgba(0,0,0,0.4);
    }

    .tab-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3px;
        cursor: pointer;
        padding: 10px 0;
        min-height: 48px;
        -webkit-tap-highlight-color: transparent;
    }

    .tab-icon {
        width: 24px;
        height: 24px;
        color: var(--text-tertiary);
        transition: color var(--duration) var(--ease);
    }
    .tab-icon svg { width: 100%; height: 100%; }

    .tab-label {
        font-size: 0.65rem;
        font-weight: 600;
        color: var(--text-tertiary);
        letter-spacing: 0.3px;
        transition: color var(--duration) var(--ease);
    }

    .tab-item.active .tab-icon { color: var(--accent); }
    .tab-item.active .tab-label { color: var(--accent); }
    .tab-item.active::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 20px;
        height: 2px;
        background: var(--accent);
        border-radius: 2px;
    }

    /* ═══════════════════════════════════════
       VIEWS
       ═══════════════════════════════════════ */
    #app {
        padding-top: calc(52px + env(safe-area-inset-top, 0px));
        padding-bottom: calc(72px + env(safe-area-inset-bottom, 0px));
    }

    .view {
        padding: var(--space-lg);
        padding-bottom: calc(var(--space-lg) + 100px);
        animation: viewFadeIn 0.3s var(--ease);
        overflow-x: hidden;
        max-width: 100vw;
        word-wrap: break-word;
    }

    @keyframes viewFadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ═══════════════════════════════════════
       CARDS
       ═══════════════════════════════════════ */
    .card {
        background: var(--bg-card);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        margin-bottom: var(--space-lg);
        position: relative;
        overflow: hidden;
        max-width: 100%;
        transition: all 0.2s var(--ease);
    }
    .card:active { transform: scale(0.985); }
    .card > * { min-width: 0; }

    .card-primary {
        text-align: center;
        padding: var(--space-2xl) var(--space-xl);
        border-color: rgba(var(--accent-rgb), 0.10);
    }

    .card-label {
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--text-tertiary);
        letter-spacing: 0.5px;
        text-transform: uppercase;
        margin-bottom: var(--space-sm);
    }

    .card-amount {
        font-size: 2.8rem;
        font-weight: 900;
        font-variant-numeric: var(--tabular);
        line-height: 1;
        margin-bottom: var(--space-md);
        transition: color 0.3s var(--ease);
    }

    .card-sub {
        font-size: 0.8rem;
        color: var(--text-tertiary);
    }

    /* Progressbar */
    .progress-track {
        width: 100%;
        height: 6px;
        background: var(--text-muted);
        border-radius: 3px;
        margin: var(--space-md) 0 var(--space-sm);
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        border-radius: 3px;
        background: var(--accent);
        transition: width 0.5s var(--ease);
    }
    .progress-fill.caution { background: var(--caution); }

    /* ═══════════════════════════════════════
       QUICK-ADD
       ═══════════════════════════════════════ */
    .quick-add-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-sm);
        margin-bottom: var(--space-lg);
    }

    .quick-chip {
        padding: 14px 0;
        min-height: 44px;
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        background: var(--glass);
        color: var(--text-primary);
        font-size: 0.88rem;
        font-weight: 700;
        font-family: var(--font);
        font-variant-numeric: var(--tabular);
        cursor: pointer;
        transition: all 0.15s var(--ease);
        text-align: center;
    }
    .quick-chip:active {
        background: var(--accent-dim);
        border-color: var(--accent);
        transform: scale(0.96);
    }
    .quick-chip.edit-chip {
        color: var(--text-tertiary);
        font-weight: 600;
    }

    /* Inline manual input */
    .inline-input-area {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height 0.3s var(--ease), opacity 0.25s var(--ease), margin 0.3s var(--ease);
        margin-bottom: 0;
    }
    .inline-input-area.open {
        max-height: 200px;
        opacity: 1;
        margin-bottom: var(--space-lg);
    }
    .inline-input-row {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
    }
    .grip-input {
        flex: 1;
        padding: 12px 14px;
        background: var(--bg-input);
        border: 1.5px solid var(--glass-border);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 1rem;
        font-family: var(--font);
        font-variant-numeric: var(--tabular);
        outline: none;
        transition: border-color var(--duration) var(--ease);
    }
    .grip-input:focus { border-color: var(--accent); outline: none; }
    .grip-input:focus-visible { box-shadow: 0 0 0 2px rgba(var(--accent-rgb), 0.3); }
    .grip-input.caution { border-color: var(--caution); }
    .grip-input::placeholder { color: var(--text-muted); }
    select.grip-input { appearance: auto; }
    input, select, textarea { font-size: 16px !important; }
    input[type="date"] { color-scheme: dark; }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1) brightness(0.8) sepia(1) hue-rotate(5deg) saturate(3); }

    /* Focus-visible for all interactive elements */
    .pin-key:focus-visible,
    .quick-chip:focus-visible,
    .tab-item:focus-visible,
    .btn-add:focus-visible,
    .btn-save:focus-visible,
    .btn-danger:focus-visible,
    .ob-nav-next:focus-visible,
    .ob-nav-back:focus-visible,
    .prof-row:focus-visible,
    .collapse-toggle:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
    }


    /* Verdict profile card */
    .cin-profile-card {
        background: linear-gradient(135deg, rgba(226,169,59,0.08) 0%, rgba(226,169,59,0.02) 100%);
        border: 1px solid rgba(226,169,59,0.2);
        border-radius: 20px;
        padding: var(--space-xl) var(--space-lg);
        text-align: center;
        max-width: 320px;
        width: 100%;
        position: relative;
        overflow: hidden;
    }
    .cin-profile-card::before {
        content: '';
        position: absolute;
        top: -50%; left: -50%;
        width: 200%; height: 200%;
        background: radial-gradient(circle at 50% 50%, rgba(226,169,59,0.06) 0%, transparent 60%);
        animation: cinProfileGlow 4s ease-in-out infinite;
    }
    @keyframes cinProfileGlow {
        0%, 100% { transform: scale(1); opacity: 0.5; }
        50% { transform: scale(1.1); opacity: 1; }
    }
    .cin-profile-emoji {
        font-size: 3.5rem;
        margin-bottom: var(--space-md);
        position: relative;
        z-index: 1;
        animation: cinEmojiPop 0.5s cubic-bezier(0.34,1.56,0.64,1) both;
    }
    @keyframes cinEmojiPop {
        from { transform: scale(0); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    .cin-profile-name {
        font-size: 1.8rem;
        font-weight: 900;
        color: var(--accent);
        margin-bottom: var(--space-xs);
        position: relative; z-index: 1;
    }
    .cin-profile-label {
        font-size: 0.68rem;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: var(--space-md);
        position: relative; z-index: 1;
    }
    .cin-profile-insight {
        font-size: 0.88rem;
        color: var(--text-secondary);
        line-height: 1.75;
        position: relative; z-index: 1;
        text-align: left;
        padding: var(--space-md) 0;
        border-top: 1px solid rgba(255,255,255,0.06);
    }
    .cin-profile-insight strong { color: var(--accent); font-weight: inherit; }
    .cin-profile-insight em { color: var(--accent); font-style: normal; }
    .cin-profile-rec {
        font-size: 0.82rem;
        color: var(--text-primary);
        line-height: 1.6;
        font-weight: 600;
        position: relative; z-index: 1;
        margin-top: var(--space-md);
        padding: var(--space-sm) var(--space-md);
        background: rgba(226,169,59,0.06);
        border-radius: 10px;
        text-align: left;
    }
    .cin-profile-rec em { color: var(--accent); font-style: normal; }
    @media (prefers-reduced-motion: reduce) {
        .cin-profile-card::before { animation: none; }
        .cin-profile-emoji { animation: none; }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
            animation-duration: 0.01ms !important;
            transition-duration: 0.01ms !important;
        }
    }

    .grip-input-sm {
        padding: 10px 12px;
        font-size: 0.88rem;
    }

    .btn-add {
        padding: 12px 20px;
        background: var(--accent);
        color: #000;
        border: none;
        border-radius: var(--radius-md);
        font-size: 0.88rem;
        font-weight: 700;
        font-family: var(--font);
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.15s var(--ease);
    }
    .btn-add:active { transform: scale(0.96); }

    .inline-note-row {
        margin-top: var(--space-sm);
    }

    .input-hint {
        font-size: 0.72rem;
        color: var(--caution);
        margin-top: var(--space-xs);
        opacity: 0;
        transition: opacity 0.2s;
    }
    .input-hint.visible { opacity: 1; }

    /* ═══════════════════════════════════════
       TRANSACTION LIST
       ═══════════════════════════════════════ */
    .section-title {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: var(--space-md);
    }

    .tx-list {
        margin-bottom: var(--space-lg);
    }

    .tx-item { min-width: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-md) 0;
        border-bottom: 1px solid var(--glass-border);
    }
    .tx-item:last-child { border-bottom: none; }

    .tx-info { flex: 1; }
    .tx-note {
        font-size: 0.82rem;
        color: var(--text-secondary);
    }
    .tx-time {
        font-size: 0.72rem;
        color: var(--text-muted);
        margin-top: 2px;
    }
    .tx-amount {
        font-size: 0.92rem;
        font-weight: 700;
        font-variant-numeric: var(--tabular);
        margin-left: var(--space-md);
    }
    .tx-delete {
        margin-left: var(--space-sm);
        width: 36px;
        height: 36px;
        border: none;
        background: none;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        flex-shrink: 0;
    }
    .tx-delete:hover { background: var(--danger-dim); color: var(--danger); }

    /* ═══════════════════════════════════════
       STATUS CARD (periode + spaargeld)
       ═══════════════════════════════════════ */
    .status-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-lg);
        cursor: pointer;
    }

    .status-left { flex: 1; }
    .status-label {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        margin-bottom: 2px;
    }
    .status-value {
        font-size: 0.95rem;
        font-weight: 700;
    }
    .status-sub {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        margin-top: 2px;
    }

    .status-dots {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        max-width: 120px;
        justify-content: flex-end;
    }
    .dot {
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
        background: var(--text-muted);
    }
    .dot.green { background: var(--green); }
    .dot.caution { background: var(--caution); }
    .dot.today { box-shadow: 0 0 0 2px var(--accent); }

    /* ═══════════════════════════════════════
       UNDO TOAST
       ═══════════════════════════════════════ */
    .toast {
        position: fixed;
        bottom: calc(72px + env(safe-area-inset-bottom, 0px) + 8px);
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        padding: 12px 20px;
        background: var(--bg-card-solid);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 0.85rem;
        font-weight: 600;
        font-family: var(--font);
        z-index: 9000;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s var(--ease);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        box-shadow: var(--shadow);
        max-width: calc(100vw - 32px);
    }
    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
        pointer-events: auto;
    }
    .toast-undo {
        color: var(--accent);
        font-weight: 700;
        cursor: pointer;
        margin-left: var(--space-sm);
    }

    /* ═══════════════════════════════════════
       EMPTY STATES
       ═══════════════════════════════════════ */
    .empty-state {
        text-align: center;
        padding: var(--space-2xl) var(--space-lg);
        color: var(--text-tertiary);
        font-size: 0.88rem;
        line-height: 1.6;
    }

    /* ═══════════════════════════════════════
       GREETING
       ═══════════════════════════════════════ */
    .greeting {
        font-size: 0.82rem;
        color: var(--text-tertiary);
        margin-bottom: var(--space-lg);
    }

    /* ═══════════════════════════════════════
       PLACEHOLDER VIEWS
       ═══════════════════════════════════════ */
    .placeholder-view {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 50vh;
        text-align: center;
        color: var(--text-tertiary);
    }
    .placeholder-icon {
        font-size: 2.5rem;
        margin-bottom: var(--space-lg);
        opacity: 0.5;
    }
    .placeholder-title {
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: var(--space-sm);
        color: var(--text-secondary);
    }

    /* ═══════════════════════════════════════
       ONBOARDING BASE STYLES
       ═══════════════════════════════════════ */
    .ob-screen {
        position: fixed;
        inset: 0;
        background: var(--bg);
        z-index: 9998;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 24px;
        text-align: center;
    }
    .ob-title {
        font-size: 1.8rem;
        font-weight: 900;
        letter-spacing: 4px;
        color: var(--accent);
        margin-bottom: var(--space-md);
    }
    .ob-sub {
        font-size: 0.95rem;
        color: var(--text-secondary);
        margin-bottom: var(--space-3xl);
        line-height: 1.6;
    }
    .ob-btn {
        padding: 16px 48px;
        background: var(--accent);
        color: #000;
        border: none;
        border-radius: var(--radius-md);
        font-size: 1rem;
        font-weight: 700;
        font-family: var(--font);
        cursor: pointer;
    }

    /* ═══════════════════════════════════════
       PERIOD STRIP (horizontal scroll)
       ═══════════════════════════════════════ */
    .period-strip {
        display: flex;
        gap: var(--space-sm);
        overflow-x: auto;
        -ms-overflow-style: none;
        scrollbar-width: none;
        padding-bottom: 2px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        padding-bottom: var(--space-sm);
        margin: 0 calc(-1 * var(--space-lg)) var(--space-lg);
        padding-left: var(--space-lg);
        padding-right: var(--space-lg);
        scrollbar-width: none;
        -webkit-mask-image: linear-gradient(to right, transparent 0, #000 var(--space-lg), #000 calc(100% - var(--space-lg)), transparent 100%);
        mask-image: linear-gradient(to right, transparent 0, #000 var(--space-lg), #000 calc(100% - var(--space-lg)), transparent 100%);
    }
    .period-strip::-webkit-scrollbar { display: none; }

    .period-chip {
        flex-shrink: 0;
        scroll-snap-align: start;
        padding: 8px 16px;
        border-radius: 100px;
        border: 1.5px solid var(--glass-border);
        background: var(--glass);
        color: var(--text-tertiary);
        font-size: 0.78rem;
        font-weight: 600;
        font-family: var(--font);
        cursor: pointer;
        white-space: nowrap;
        transition: all var(--duration) var(--ease);
    }
    .period-chip.active {
        background: var(--accent-dim);
        border-color: var(--accent);
        color: var(--accent);
    }
    .period-chip-sub {
        display: block;
        font-size: 0.65rem;
        font-weight: 500;
        opacity: 0.7;
        margin-top: 1px;
    }

    /* ═══════════════════════════════════════
       SUMMARY TABLE
       ═══════════════════════════════════════ */
    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
    }
    .summary-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    .summary-value {
        font-size: 0.88rem;
        font-weight: 700;
        font-variant-numeric: var(--tabular);
    }
    .summary-divider {
        border: none;
        border-top: 1px solid var(--glass-border);
        margin: 4px 0;
    }
    .summary-total .summary-label { font-weight: 700; color: var(--text-primary); }
    .summary-total .summary-value { color: var(--accent); }

    /* ═══════════════════════════════════════
       PROGRESS BARS (overzicht)
       ═══════════════════════════════════════ */
    .budget-meter {
        margin-bottom: var(--space-lg);
    }
    .meter-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: var(--space-xs);
    }
    .meter-label {
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--text-secondary);
    }
    .meter-value {
        font-size: 0.78rem;
        font-weight: 700;
        font-variant-numeric: var(--tabular);
        color: var(--text-tertiary);
    }
    .meter-track {
        width: 100%;
        height: 8px;
        background: var(--text-muted);
        border-radius: 4px;
        overflow: hidden;
    }
    .meter-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s var(--ease);
    }
    .meter-fill.green { background: var(--green); }
    .meter-fill.accent { background: var(--accent); }
    .meter-fill.caution { background: var(--caution); }

    /* ═══════════════════════════════════════
       CALENDAR (compact dots grid)
       ═══════════════════════════════════════ */
    .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        margin-bottom: var(--space-lg);
    }
    .cal-header {
        font-size: 0.6rem;
        font-weight: 700;
        color: var(--text-muted);
        text-align: center;
        padding: 4px 0;
        text-transform: uppercase;
    }
    .cal-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: background 0.15s;
        position: relative;
    }
    .cal-day:hover { background: var(--glass); }
    .cal-dot {
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
        background: var(--text-muted);
    }
    .cal-dot.green { background: var(--green); }
    .cal-dot.caution { background: var(--caution); }
    .cal-dot.empty { background: transparent; border: 1.5px solid var(--text-muted); }
    .cal-day.today { background: var(--accent-dim); }
    .cal-day.today .cal-dot { box-shadow: 0 0 0 2px var(--accent); }

    /* Day detail inline */
    .day-detail {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height 0.3s var(--ease), opacity 0.25s var(--ease), margin 0.3s var(--ease);
        margin-bottom: 0;
    }
    .day-detail.open {
        max-height: 500px;
        opacity: 1;
        margin-bottom: var(--space-lg);
    }
    .day-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-sm) 0;
    }
    .day-detail-title {
        font-size: 0.82rem;
        font-weight: 700;
    }
    .day-detail-close {
        background: none;
        border: none;
        color: var(--text-tertiary);
        cursor: pointer;
        padding: 8px;
        min-width: 36px;
        min-height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* ═══════════════════════════════════════
       TRANSACTION LIST (Overzicht grouped)
       ═══════════════════════════════════════ */
    .tx-day-group {
        margin-bottom: var(--space-md);
    }
    .tx-day-header {
        font-size: 0.72rem;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        padding: var(--space-sm) 0 var(--space-xs);
    }
    .tx-tag {
        display: inline-block;
        font-size: 0.6rem;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: var(--space-sm);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .tx-tag.daily { background: var(--accent-dim); color: var(--accent); }
    .tx-tag.free { background: rgba(52,211,153,0.1); color: var(--green); }

    /* ═══════════════════════════════════════
       SPAREN — RING
       ═══════════════════════════════════════ */
    .save-ring-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: var(--space-2xl) 0;
    }
    .save-ring {
        position: relative;
        width: 160px;
        height: 160px;
        margin-bottom: var(--space-lg);
    }
    .save-ring svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
    }
    .save-ring-bg {
        fill: none;
        stroke: var(--text-muted);
        stroke-width: 8;
    }
    .save-ring-fill {
        fill: none;
        stroke: var(--accent);
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 1s var(--ease);
    }
    .save-ring-text {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .save-ring-pct {
        font-size: 2rem;
        font-weight: 900;
        font-variant-numeric: var(--tabular);
    }
    .save-ring-label {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        margin-top: 2px;
    }

    /* Prediction card */
    .pred-card {
        text-align: center;
        padding: var(--space-lg);
    }
    .pred-date {
        font-size: 1.1rem;
        font-weight: 800;
        color: var(--accent);
        margin-bottom: var(--space-xs);
    }
    .pred-sub {
        font-size: 0.8rem;
        color: var(--text-tertiary);
    }
    .pred-confidence {
        display: inline-flex;
        align-items: center;
        gap: var(--space-xs);
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 100px;
        background: var(--glass);
        margin-top: var(--space-md);
    }

    /* Milestones */
    .milestone-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }
    .milestone-item {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        padding: var(--space-md);
        border-radius: var(--radius-md);
        background: var(--glass);
    }
    .milestone-pct {
        font-size: 0.82rem;
        font-weight: 800;
        min-width: 40px;
        font-variant-numeric: var(--tabular);
    }
    .milestone-status {
        flex: 1;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    .milestone-check {
        color: var(--green);
        font-weight: 700;
        font-size: 0.8rem;
    }

    /* Collapsible info */
    .collapse-toggle {
        width: 100%;
        padding: var(--space-md) var(--space-lg);
        background: var(--glass);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: 0.82rem;
        font-weight: 600;
        font-family: var(--font);
        cursor: pointer;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-sm);
    }
    .collapse-toggle .arrow {
        transition: transform 0.3s var(--ease);
        color: var(--text-muted);
    }
    .collapse-toggle.open .arrow { transform: rotate(180deg); }
    .collapse-content {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.4s var(--ease), opacity 0.3s var(--ease);
    }
    .collapse-content.open {
        max-height: 600px;
        opacity: 1;
    }
    .collapse-inner {
        padding: var(--space-lg);
        font-size: 0.8rem;
        color: var(--text-tertiary);
        line-height: 1.7;
    }
    .collapse-inner p { margin-bottom: var(--space-md); }
    .collapse-inner p:last-child { margin-bottom: 0; }
    .collapse-inner strong { color: var(--text-primary); }

    /* Breakdown rows */
    .breakdown-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        font-size: 0.85rem;
    }
    .breakdown-label { color: var(--text-secondary); }
    .breakdown-value { font-weight: 700; font-variant-numeric: var(--tabular); }

    /* Spending add (Overzicht) */
    .add-spending-row {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
        margin-top: var(--space-md);
    }

    /* ═══════════════════════════════════════
       MENU TILES
       ═══════════════════════════════════════ */
    .menu-list { margin-top: var(--space-md); }
    .menu-item {
        display: flex; align-items: center; gap: var(--space-lg); padding: 16px 0;
        border-bottom: 1px solid rgba(255,255,255,0.04); cursor: pointer;
        transition: all 0.15s; -webkit-user-select: none; user-select: none;
    }
    .menu-item:last-child { border-bottom: none; }
    .menu-item:active { opacity: 0.7; transform: translateX(2px); }
    .menu-item-icon {
        width: 40px; height: 40px; border-radius: var(--radius-md);
        display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .menu-item-content { flex: 1; min-width: 0; }
    .menu-item-title { font-size: 0.92rem; font-weight: 700; }
    .menu-item-sub { font-size: 0.72rem; color: var(--text-muted); margin-top: 2px; }
    .menu-item-value { font-size: 0.82rem; font-weight: 700; font-variant-numeric: var(--tabular); flex-shrink: 0; }
    .menu-item-arrow { color: rgba(255,255,255,0.15); flex-shrink: 0; }

    /* View back header */
    .view { animation: viewIn 0.3s var(--ease); }
    @keyframes viewIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
    .view-header {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        padding: var(--space-sm) 0 var(--space-lg);
    }
    .view-back-btn {
        width: 36px; height: 36px;
        border-radius: var(--radius-full);
        background: var(--glass);
        border: 1px solid var(--glass-border);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        color: var(--text-secondary);
        flex-shrink: 0;
        font-family: var(--font);
    }
    .view-back-btn:active { transform: scale(0.93); }
    .view-title {
        font-size: 1.1rem;
        font-weight: 800;
        color: var(--text-primary);
    }

    /* ═══════════════════════════════════════
       PROFIEL
       ═══════════════════════════════════════ */
    .prof-header {
        display: flex;
        align-items: center;
        gap: var(--space-lg);
        margin-bottom: var(--space-2xl);
        padding: var(--space-lg) 0;
    }
    .prof-avatar {
        width: 52px; height: 52px;
        border-radius: var(--radius-full);
        background: var(--accent-dim);
        border: 2px solid rgba(var(--accent-rgb), 0.25);
        display: flex; align-items: center; justify-content: center;
        font-size: 1rem;
        overflow: hidden;
    }
    .prof-avatar img { width:100%;height:100%;object-fit:cover; }
    .prof-name { font-size: 1.1rem; font-weight: 800; }
    .prof-since { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 2px; }

    .prof-group-title {
        font-size: 0.7rem; font-weight: 700; color: var(--text-muted);
        text-transform: uppercase; letter-spacing: 0.5px;
        padding: var(--space-lg) 0 var(--space-sm);
    }
    .prof-row {
        display: flex; align-items: center; justify-content: space-between;
        padding: var(--space-lg) 0;
        min-height: 44px;
        border-bottom: 1px solid var(--glass-border);
        cursor: pointer;
        transition: background 0.15s;
    }
    .prof-row:last-child { border-bottom: none; }
    .prof-row:active { background: var(--glass); }
    .prof-row-label { font-size: 0.88rem; color: var(--text-secondary); }
    .prof-row-value {
        font-size: 0.88rem; font-weight: 600;
        color: var(--text-tertiary);
        display: flex; align-items: center; gap: var(--space-sm);
        font-variant-numeric: var(--tabular);
    }
    .prof-row-arrow { color: var(--text-muted); flex-shrink: 0; }
    .prof-row.danger .prof-row-label { color: var(--danger); }
    .prof-footer {
        text-align: center; padding: var(--space-2xl) 0;
        font-size: 0.72rem; color: var(--text-muted);
    }

    /* Subscreen panel */
    .sub-panel {
        position: fixed; inset: 0; z-index: 200;
        background: var(--bg);
        transform: translateX(100%);
        transition: transform 0.3s var(--ease);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: env(safe-area-inset-top, 0px) var(--space-lg) calc(var(--space-3xl) + env(safe-area-inset-bottom, 0px));
    }
    .sub-panel.open { transform: translateX(0); }
    .sub-header {
        position: sticky; top: 0; background: var(--bg);
        padding: var(--space-lg) 0;
        display: flex; align-items: center; gap: var(--space-md);
        border-bottom: 1px solid var(--glass-border);
        margin-bottom: var(--space-lg); z-index: 1;
    }
    .sub-back {
        background: none; border: none; color: var(--text-secondary);
        cursor: pointer; padding: 8px; display: flex;
        min-width: 36px; min-height: 36px;
        align-items: center; justify-content: center;
    }
    .sub-title { font-size: 1rem; font-weight: 700; }

    .field-group { margin-bottom: var(--space-xl); }
    .field-label {
        font-size: 0.78rem; font-weight: 600;
        color: var(--text-secondary); margin-bottom: var(--space-xs);
    }
    .field-helper {
        font-size: 0.72rem; color: var(--text-muted);
        margin-top: var(--space-xs); line-height: 1.5;
    }
    .field-error {
        font-size: 0.72rem; color: var(--caution);
        margin-top: var(--space-xs);
    }

    .btn-save {
        width: 100%; padding: 14px;
        background: var(--accent); color: #000; border: none;
        border-radius: var(--radius-md);
        font-size: 0.92rem; font-weight: 700; font-family: var(--font);
        cursor: pointer; margin-top: var(--space-lg);
    }
    .btn-save:active { opacity: 0.85; }
    .btn-danger {
        width: 100%; padding: 14px;
        background: var(--danger-dim); color: var(--danger); border: 1.5px solid var(--danger);
        border-radius: var(--radius-md);
        font-size: 0.92rem; font-weight: 700; font-family: var(--font);
        cursor: pointer; margin-top: var(--space-lg);
    }
    .btn-danger:disabled { opacity: 0.3; cursor: not-allowed; }

    /* Toggle */
    .toggle-row {
        display: flex; align-items: center; justify-content: space-between;
        padding: var(--space-md) 0;
    }
    .toggle-track {
        width: 44px; height: 24px; border-radius: 12px;
        background: var(--text-muted); cursor: pointer;
        position: relative; transition: background 0.2s;
    }
    .toggle-track.on { background: var(--accent); }
    .toggle-thumb {
        width: 20px; height: 20px; border-radius: 50%;
        background: white; position: absolute; top: 2px; left: 2px;
        transition: left 0.2s var(--ease);
    }
    .toggle-track.on .toggle-thumb { left: 22px; }

    /* Fixed cost items */
    .fc-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: var(--space-sm) 0;
        border-bottom: 1px solid var(--glass-border);
    }
    .fc-item-name { font-size: 0.85rem; }
    .fc-item-amount { font-size: 0.85rem; font-weight: 700; font-variant-numeric: var(--tabular); }
    .fc-cat-title {
        font-size: 0.72rem; font-weight: 700; color: var(--text-muted);
        text-transform: uppercase; padding: var(--space-md) 0 var(--space-xs);
    }

    /* Avatar grid */
    .avatar-grid {
        display: flex; flex-direction: column; gap: var(--space-md);
    }
    .avatar-upload-area {
        display: flex; align-items: center; gap: var(--space-lg);
        padding: var(--space-lg);
        background: var(--glass);
        border-radius: var(--radius-lg);
        border: 1.5px dashed var(--glass-border);
    }
    .avatar-preview {
        width: 64px; height: 64px;
        border-radius: var(--radius-full);
        background: var(--accent-dim);
        border: 2px solid var(--accent);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.4rem; font-weight: 800; color: var(--accent);
        overflow: hidden; flex-shrink: 0;
    }
    .avatar-preview img { width:100%;height:100%;object-fit:cover; }
    .avatar-upload-info { flex:1; }
    .avatar-upload-btn {
        padding: 8px 16px;
        background: var(--glass);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: 0.82rem; font-weight: 600;
        font-family: var(--font); cursor: pointer;
    }

    /* ═══════════════════════════════════════
       ONBOARDING (7-step)
       ═══════════════════════════════════════ */
    .ob-container {
        position: fixed; inset: 0; background: var(--bg);
        z-index: 9998; overflow-y: auto;
        display: flex; flex-direction: column;
        padding: calc(var(--space-2xl) + env(safe-area-inset-top, 0px)) var(--space-2xl) calc(var(--space-2xl) + env(safe-area-inset-bottom, 0px));
    }
    .ob-progress {
        display: flex; gap: 4px; margin-bottom: var(--space-3xl);
    }
    .ob-progress-dot {
        flex: 1; height: 3px; border-radius: 2px;
        background: var(--text-muted); transition: background 0.3s;
    }
    .ob-progress-dot.done { background: var(--accent); }
    .ob-progress-dot.current { background: var(--accent); }

    .ob-step-title {
        font-size: 1.4rem; font-weight: 900; margin-bottom: var(--space-sm); text-align: center;
    }
    .ob-step-sub {
        font-size: 0.88rem; color: var(--text-secondary);
        line-height: 1.6; margin-bottom: var(--space-2xl); text-align: center;
    }
    .ob-step-content { flex: 1; }
    .prof-card {
        display: flex; justify-content: space-between; align-items: center;
        padding: 14px 16px; background: var(--glass); border-radius: var(--radius-md);
        margin-bottom: 8px; font-size: 0.82rem;
    }

    .ob-nav {
        display: flex; gap: var(--space-md);
        padding-top: var(--space-xl);
        margin-top: auto;
    }
    .ob-nav-back {
        padding: 14px 24px; background: var(--glass);
        border: 1px solid var(--glass-border); border-radius: var(--radius-md);
        color: var(--text-secondary); font-size: 0.92rem; font-weight: 600;
        font-family: var(--font); cursor: pointer;
    }
    .ob-nav-next {
        flex: 1; padding: 14px; background: var(--accent);
        color: #000; border: none; border-radius: var(--radius-md);
        font-size: 0.92rem; font-weight: 700; font-family: var(--font);
        cursor: pointer;
    }
    .ob-nav-next:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Language styles removed — Dutch only */
    

    .ob-step-label {
        font-size: 0.72rem; color: var(--text-muted);
        margin-bottom: var(--space-lg);
    }

    /* Aha moment */
    .aha-amount {
        font-size: 2.4rem; font-weight: 900; color: var(--accent);
        text-align: center; margin: var(--space-2xl) 0 var(--space-md);
        font-variant-numeric: var(--tabular);
    }
    .aha-line {
        font-size: 0.95rem; text-align: center;
        color: var(--text-secondary); margin-bottom: var(--space-sm);
        line-height: 1.6;
    }
    .aha-closing {
        font-size: 1rem; text-align: center; font-weight: 600;
        color: var(--text-primary); margin-top: var(--space-2xl);
        line-height: 1.6;
    }

    /* ═══════════════════════════════════════
       UTILITY CLASSES (v2)
       ═══════════════════════════════════════ */
    .input-row { display: flex; gap: var(--space-sm); align-items: center; flex-wrap: wrap; }
    .input-row > * { min-width: 0; }
    .card-meta { font-size: 0.72rem; color: var(--text-muted); }
    .salary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-sm); }
    .salary-grid-item {
        background: var(--glass); border: 1.5px solid var(--glass-border);
        border-radius: var(--radius-md); padding: var(--space-md);
        text-align: center; transition: all 0.2s var(--ease);
    }
    .salary-grid-item.has-override {
        border-color: var(--accent); background: var(--accent-dim);
    }
    .salary-grid-item .month-label {
        font-size: 0.72rem; font-weight: 700; color: var(--text-muted);
        text-transform: uppercase; margin-bottom: var(--space-xs);
    }
    .salary-grid-item .day-value {
        font-size: 1.1rem; font-weight: 800;
        font-variant-numeric: var(--tabular);
    }
    .salary-grid-item.has-override .day-value { color: var(--accent); }
    .override-badge {
        display: inline-block; font-size: 0.6rem; font-weight: 700;
        padding: 2px 8px; border-radius: 100px;
        background: var(--accent-dim); color: var(--accent);
        text-transform: uppercase; letter-spacing: 0.3px;
    }
    .summary-card {
        background: linear-gradient(135deg, var(--accent-dim), rgba(var(--accent-rgb), 0.04));
        border: 1.5px solid rgba(var(--accent-rgb), 0.15);
        border-radius: var(--radius-lg); padding: var(--space-xl);
        margin-bottom: var(--space-lg);
    }
    .summary-card-title { font-size: 0.72rem; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; }
    .summary-card-amount { font-size: 1.6rem; font-weight: 900; font-variant-numeric: var(--tabular); margin-top: var(--space-xs); overflow: hidden; text-overflow: ellipsis; }
    .summary-card-sub { font-size: 0.82rem; color: var(--text-tertiary); margin-top: var(--space-xs); }
    .settings-card { background: var(--bg-card); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: var(--space-xl); margin-bottom: var(--space-lg); }
    .settings-card-title { font-size: 0.78rem; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-lg); }
    .celebration-card {
        background: linear-gradient(135deg, rgba(61,213,152,0.12), rgba(var(--accent-rgb),0.12));
        border: 1.5px solid var(--green); border-radius: var(--radius-lg);
        padding: var(--space-2xl); text-align: center;
    }

        /* Scrollbar */
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 10px; }
    

    /* ═══════════════════════════════════════
       PREMIUM SYSTEM
       ═══════════════════════════════════════ */
    .prem-overlay {
        position: fixed; inset: 0; z-index: 1100;
        background: rgba(0,0,0,0.65);
        display: flex; align-items: flex-end; justify-content: center;
        opacity: 0; transition: opacity 0.25s ease;
        pointer-events: none;
        -webkit-backdrop-filter: blur(4px);
        backdrop-filter: blur(4px);
    }
    .prem-overlay.show { opacity: 1; pointer-events: auto; }
    .prem-sheet {
        background: var(--surface-card);
        border-radius: 20px 20px 0 0;
        width: 100%; max-width: 480px;
        max-height: 88vh; overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: var(--space-2xl) var(--space-lg) calc(var(--space-2xl) + env(safe-area-inset-bottom));
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
    }
    .prem-overlay.show .prem-sheet { transform: translateY(0); }
    .prem-sheet-handle {
        width: 36px; height: 4px; border-radius: 2px;
        background: rgba(255,255,255,0.12);
        margin: 0 auto var(--space-xl);
    }
    .prem-close {
        position: absolute; top: 16px; right: 16px;
        width: 32px; height: 32px; border-radius: 50%;
        background: rgba(255,255,255,0.06); border: none;
        color: var(--text-muted); font-size: 1.2rem;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; -webkit-tap-highlight-color: transparent;
    }
    .prem-badge {
        display: inline-flex; align-items: center; gap: 4px;
        font-size: 0.6rem; font-weight: 800; letter-spacing: 1.5px;
        text-transform: uppercase; color: #000;
        background: var(--accent); border-radius: 6px;
        padding: 3px 8px;
    }
    .prem-badge-sm {
        font-size: 0.55rem; padding: 2px 6px; border-radius: 4px;
        background: rgba(226,169,59,0.15); color: var(--accent);
        font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
    }

    /* Premium teaser card on dashboard */
    .prem-teaser {
        background: linear-gradient(135deg, rgba(226,169,59,0.10) 0%, rgba(226,169,59,0.03) 100%);
        border: 1px solid rgba(226,169,59,0.18);
        border-radius: var(--radius-xl);
        padding: var(--space-xl) var(--space-lg);
        margin-bottom: var(--space-lg);
        cursor: pointer; transition: all 0.2s;
        -webkit-tap-highlight-color: transparent;
    }
    .prem-teaser:active { transform: scale(0.98); }
    .prem-teaser-title {
        font-size: 0.95rem; font-weight: 800; color: var(--accent);
        margin-bottom: var(--space-sm);
        display: flex; align-items: center; gap: var(--space-sm);
    }
    .prem-teaser-list {
        list-style: none; padding: 0; margin: 0 0 var(--space-md);
    }
    .prem-teaser-list li {
        font-size: 0.78rem; color: var(--text-secondary);
        padding: 4px 0; display: flex; align-items: center; gap: 8px;
    }
    .prem-teaser-list li::before {
        content: '✦'; color: var(--accent); font-size: 0.6rem; flex-shrink: 0;
    }
    .prem-teaser-cta {
        font-size: 0.78rem; font-weight: 700; color: var(--accent);
    }

    /* Lock overlay for premium features */
    .prem-lock {
        position: relative;
    }
    .prem-lock::after {
        content: '';
        position: absolute; inset: 0;
        background: rgba(15,15,15,0.5);
        border-radius: inherit;
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
    }
    .prem-lock-label {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2; text-align: center;
    }

    /* Paywall bottom-sheet */
    .prem-paywall {
        position: fixed; inset: 0; z-index: 1200;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: flex-end;
    }
    .prem-paywall.show { display: flex; }
    .prem-pw-sheet {
        width: 100%;
        max-height: 92vh;
        background: var(--bg);
        border-radius: 20px 20px 0 0;
        overflow-y: auto; -webkit-overflow-scrolling: touch;
        transform: translateY(100%);
        transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
        display: flex; flex-direction: column;
    }
    .prem-paywall.show .prem-pw-sheet {
        transform: translateY(0);
    }
    .prem-pw-top {
        text-align: center;
        padding: calc(env(safe-area-inset-top) + var(--space-xl)) var(--space-lg) var(--space-xl);
        background: linear-gradient(180deg, rgba(226,169,59,0.08) 0%, transparent 100%);
    }
    .prem-pw-close {
        position: absolute; top: calc(env(safe-area-inset-top) + 12px); left: 16px;
        background: none; border: none; color: var(--text-muted);
        font-size: 0.82rem; font-weight: 600; cursor: pointer;
        padding: 8px; -webkit-tap-highlight-color: transparent;
    }
    .prem-pw-headline {
        font-size: 1.5rem; font-weight: 900; color: var(--text-primary);
        line-height: 1.25; margin-bottom: var(--space-sm);
    }
    .prem-pw-sub {
        font-size: 0.88rem; color: var(--text-secondary); line-height: 1.5;
    }
    .prem-pw-content {
        flex: 1; padding: var(--space-lg);
    }
    .prem-pw-features {
        margin-bottom: var(--space-xl);
    }
    .prem-pw-feat {
        display: flex; align-items: flex-start; gap: 12px;
        padding: 10px 0;
    }
    .prem-pw-feat-icon {
        width: 28px; height: 28px; border-radius: 8px;
        background: rgba(226,169,59,0.12);
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0; color: var(--accent); font-size: 0.75rem;
    }
    .prem-pw-feat-text {
        font-size: 0.85rem; font-weight: 600; color: var(--text-primary);
    }
    .prem-pw-feat-sub {
        font-size: 0.72rem; color: var(--text-muted); margin-top: 2px;
        font-style: italic;
    }

    /* Comparison table */
    .prem-compare {
        border-radius: var(--radius-lg);
        overflow: hidden; margin-bottom: var(--space-xl);
        border: 1px solid rgba(255,255,255,0.06);
    }
    .prem-compare-row {
        display: grid; grid-template-columns: 1fr 70px 70px;
        padding: 10px 14px; font-size: 0.75rem;
        border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .prem-compare-row:last-child { border-bottom: none; }
    .prem-compare-head {
        background: rgba(255,255,255,0.03);
        font-weight: 700; color: var(--text-muted);
        text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.65rem;
    }
    .prem-compare-row > :nth-child(2),
    .prem-compare-row > :nth-child(3) { text-align: center; }
    .prem-compare-check { color: var(--accent); font-weight: 700; }
    .prem-compare-x { color: var(--text-muted); opacity: 0.4; }

    /* Plan cards */
    .prem-plans {
        display: flex; gap: var(--space-sm); margin-bottom: var(--space-lg);
    }
    .prem-plan {
        flex: 1; border: 2px solid rgba(255,255,255,0.08);
        border-radius: var(--radius-lg); padding: var(--space-md);
        text-align: center; cursor: pointer; transition: all 0.2s;
        position: relative; -webkit-tap-highlight-color: transparent;
    }
    .prem-plan.selected {
        border-color: var(--accent);
        background: rgba(226,169,59,0.06);
    }
    .prem-plan-rec {
        position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
        font-size: 0.55rem; font-weight: 800; letter-spacing: 1px;
        text-transform: uppercase; background: var(--accent); color: #000;
        padding: 2px 10px; border-radius: 10px; white-space: nowrap;
    }
    .prem-plan-period {
        font-size: 0.72rem; font-weight: 700; color: var(--text-secondary);
        margin-bottom: 4px;
    }
    .prem-plan-price {
        font-size: 1.2rem; font-weight: 900; color: var(--text-primary);
    }
    .prem-plan-per {
        font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;
    }
    .prem-plan-save {
        font-size: 0.62rem; font-weight: 700; color: var(--green); margin-top: 4px;
    }

    .prem-pw-cta {
        width: 100%; padding: 16px; border: none;
        background: var(--accent); color: #000;
        font-size: 0.95rem; font-weight: 800;
        border-radius: 14px; cursor: pointer;
        font-family: var(--font);
        -webkit-tap-highlight-color: transparent;
    }
    .prem-pw-cta:active { transform: scale(0.98); }
    .prem-pw-footer {
        text-align: center; padding: var(--space-md) var(--space-lg) calc(var(--space-lg) + env(safe-area-inset-bottom));
        font-size: 0.65rem; color: var(--text-muted);
    }
    .prem-pw-footer a { color: var(--text-tertiary); text-decoration: underline; }
    .prem-pw-footer span { margin: 0 6px; opacity: 0.3; }

    /* Premium active state */
    .prem-active-badge {
        display: flex; align-items: center; gap: 6px;
        font-size: 0.68rem; font-weight: 700; color: var(--accent);
        padding: 6px 12px; border-radius: 8px;
        background: rgba(226,169,59,0.08);
    }

    /* Context modal */
    .prem-modal-icon {
        width: 56px; height: 56px; border-radius: 16px;
        background: linear-gradient(135deg, rgba(226,169,59,0.15) 0%, rgba(226,169,59,0.05) 100%);
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto var(--space-lg); font-size: 1.4rem;
    }
    .prem-modal-title {
        font-size: 1.1rem; font-weight: 800; color: var(--text-primary);
        text-align: center; margin-bottom: var(--space-sm);
    }
    .prem-modal-body {
        font-size: 0.85rem; color: var(--text-secondary); text-align: center;
        line-height: 1.6; margin-bottom: var(--space-xl);
    }
    .prem-modal-body em { color: var(--accent); font-style: normal; }
    .prem-modal-btns {
        display: flex; flex-direction: column; gap: var(--space-sm);
    }
    .prem-modal-btn-primary {
        width: 100%; padding: 14px; border: none;
        background: var(--accent); color: #000;
        font-size: 0.88rem; font-weight: 700;
        border-radius: 12px; cursor: pointer;
        font-family: var(--font);
    }
    .prem-modal-btn-secondary {
        width: 100%; padding: 12px; border: none;
        background: none; color: var(--text-muted);
        font-size: 0.82rem; font-weight: 600;
        cursor: pointer; font-family: var(--font);
    }

    @media (prefers-reduced-motion: reduce) {
        .prem-overlay { transition: opacity 0.1s; }
        .prem-sheet { transition: transform 0.15s; }
        .prem-teaser:active { transform: none; }
    }


    /* Premium: due date & paid status */
    .prem-due-row {
        display: flex; align-items: center; gap: 8px;
        padding: 6px 0 2px; margin-top: 4px;
        border-top: 1px solid rgba(255,255,255,0.04);
    }
    .prem-due-label {
        font-size: 0.65rem; color: var(--text-muted); min-width: 55px;
    }
    .prem-due-input {
        width: 50px; padding: 4px 6px; font-size: 0.75rem;
        background: var(--surface-input); border: 1px solid rgba(255,255,255,0.08);
        border-radius: 6px; color: var(--text-primary); text-align: center;
        font-family: var(--font);
    }
    .prem-paid-toggle {
        display: flex; align-items: center; gap: 6px;
        font-size: 0.65rem; color: var(--text-muted); cursor: pointer;
        -webkit-tap-highlight-color: transparent; margin-left: auto;
    }
    .prem-paid-dot {
        width: 18px; height: 18px; border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.15);
        display: flex; align-items: center; justify-content: center;
        font-size: 0.6rem; transition: all 0.2s;
    }
    .prem-paid-dot.paid {
        background: var(--green); border-color: var(--green); color: #000;
    }

    /* ═══ MOBILE RESPONSIVE FIXES ═══ */
    @media (max-width: 430px) {
        .view { padding: var(--space-md); }
        .settings-card { padding: var(--space-lg); }
        .salary-grid { gap: 6px; }
        .salary-grid-item { padding: var(--space-sm); }
        .summary-card { padding: var(--space-lg); }
        .summary-card-amount { font-size: 1.4rem; }
        .card-amount { font-size: 1.4rem; }
        .tx-amount { font-size: 0.78rem; flex-shrink: 0; white-space: nowrap; }
        .tx-note { font-size: 0.82rem; overflow: hidden; text-overflow: ellipsis; }
        .tx-item { min-width: 0; gap: var(--space-xs); }
        .tx-delete { padding: 4px; flex-shrink: 0; }
        .btn-save, .btn-add { padding: 10px 14px; font-size: 0.82rem; }
        .field-label { font-size: 0.72rem; }
        .field-helper { font-size: 0.72rem; }
        .grip-input { padding: 10px 12px; font-size: 1rem; }
        .grip-input-sm { padding: 8px 10px; font-size: 1rem; }
        .section-title { font-size: 0.72rem; }
        .card { padding: var(--space-lg); }
        .period-chip { padding: 8px 12px; font-size: 0.72rem; }
        .greeting { font-size: 1.2rem; }
        .menu-item { gap: var(--space-md); padding: 14px 0; }
        .menu-item-icon { width: 36px; height: 36px; }
        .menu-item-title { font-size: 0.85rem; }
        .menu-item-sub { font-size: 0.68rem; }
        .menu-item-value { font-size: 0.78rem; }
        .input-row { gap: 6px; }
        .collapse-toggle { font-size: 0.78rem; padding: var(--space-md) 0; }
        .collapse-inner { font-size: 0.75rem; }
        .pred-card { padding: var(--space-md); }
        .milestone-list { font-size: 0.78rem; }
        .save-ring-pct { font-size: 1.4rem; }
        .donut-legend { font-size: 0.68rem; }
    }
    @media (max-width: 375px) {
        .view { padding: var(--space-sm); }
        .card { padding: var(--space-md); }
        .greeting { font-size: 1.1rem; }
        .summary-card-amount { font-size: 1.2rem; }
        .card-amount { font-size: 1.2rem; }
        .salary-grid { grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .salary-grid-item { padding: 6px; }
        .tab-label { font-size: 0.58rem; }
    }
    


    /* Start screen */
    .cin-start-iphone {
        width: 140px; height: 280px;
        border: 3px solid rgba(255,255,255,0.15);
        border-radius: 28px;
        background: rgba(255,255,255,0.03);
        position: relative;
        overflow: hidden;
        animation: cinPhoneFloat 3s ease-in-out infinite;
        box-shadow: 0 0 40px rgba(226,169,59,0.08), inset 0 0 20px rgba(226,169,59,0.03);
    }
    .cin-start-iphone::before {
        content: ''; position: absolute;
        top: 8px; left: 50%; transform: translateX(-50%);
        width: 40px; height: 5px; border-radius: 3px;
        background: rgba(255,255,255,0.1);
    }
    .cin-start-iphone-screen {
        position: absolute; inset: 12px 8px;
        border-radius: 16px; overflow: hidden;
    }
    .cin-start-iphone-matrix {
        position: absolute; inset: 0;
    }

    .cin-start-iphone-logo {
        position: absolute; inset: 0;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.1rem; font-weight: 900; letter-spacing: 4px;
        color: var(--accent); opacity: 0.7;
    }
    @keyframes cinPhoneFloat {
        0%, 100% { transform: translateY(0) rotate(-2deg); }
        50% { transform: translateY(-8px) rotate(1deg); }
    }
    .cin-start-btn {
        margin-top: var(--space-2xl);
        padding: 16px 48px;
        background: var(--accent);
        color: #000; font-weight: 700;
        font-size: 0.95rem; font-family: var(--font);
        border: none; border-radius: 14px;
        cursor: pointer;
        opacity: 0; transform: translateY(12px);
        transition: opacity 0.5s ease 0.8s, transform 0.5s ease 0.8s;
        -webkit-tap-highlight-color: transparent;
    }
    .cin-start-btn.show { opacity: 1; transform: translateY(0); }
    .cin-start-btn:active { transform: scale(0.96); }
    @media (prefers-reduced-motion: reduce) {
        .cin-start-iphone { animation: none; }
        .cin-start-btn { transition: opacity 0.2s; transform: none !important; }
        .cin-start-btn.show { transform: none; }
    }

    /* Matrix rain */
    .cin-matrix {
        position: absolute; inset: 0; overflow: hidden;
        pointer-events: none;
    }
    .cin-matrix-num {
        position: absolute;
        font-family: 'Courier New', monospace;
        font-weight: 700;
        color: var(--accent);
        white-space: nowrap;
        will-change: transform;
        animation: cinRain var(--dur) linear forwards;
        opacity: 0;
        text-shadow: 0 0 6px rgba(226,169,59,0.25);
        letter-spacing: -0.5px;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
    }
    @keyframes cinRain {
        0% { transform: translate3d(0, -30px, 0); opacity: 0; }
        10% { opacity: var(--peak); }
        55% { opacity: var(--peak); }
        100% { transform: translate3d(0, var(--travel), 0); opacity: 0; }
    }
    .cin-matrix.fade-out .cin-matrix-num {
        transition: opacity 0.8s ease !important;
        opacity: 0 !important;
    }
    @media (prefers-reduced-motion: reduce) {
        .cin-matrix-num { animation-duration: 0.5s !important; }
    }

    /* ═══ CINEMATIC INTRO ═══ */
    #cinIntro {
        position: fixed; inset: 0; z-index: 1000;
        background: var(--bg);
        display: flex; flex-direction: column;
        overflow: hidden;
    }
    #cinIntro.hidden { display: none; }

    .cin-skip {
        position: absolute; top: max(env(safe-area-inset-top,12px),12px); right: 16px;
        background: none; border: none; color: var(--text-muted);
        font-size: 0.75rem; font-family: var(--font); cursor: pointer;
        padding: 8px 12px; z-index: 10; letter-spacing: 0.5px;
        transition: opacity 0.3s;
    }
    .cin-skip:active { opacity: 0.5; }
    .cin-back {
        background: none; border: none; color: var(--text-muted);
        font-size: 0.78rem; font-family: var(--font); cursor: pointer;
        padding: 8px 0; margin-bottom: var(--space-md);
        display: flex; align-items: center; gap: 4px;
        -webkit-tap-highlight-color: transparent;
    }
    .cin-back svg { width: 16px; height: 16px; }
    .cin-back:active { opacity: 0.5; }

    .cin-phase {
        position: absolute; inset: 0;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        padding: var(--space-xl) var(--space-lg);
        text-align: center;
        opacity: 0; transition: opacity 0.4s ease;
        pointer-events: none;
    }
    .cin-phase.active { opacity: 1; pointer-events: auto; }

    .cin-typewriter {
        font-size: 1.1rem; font-weight: 600;
        color: #ffffff; line-height: 1.6;
        min-height: 3.5em; max-width: 300px;
        transition: opacity 0.3s ease;
    }
    .cin-typewriter strong { color: var(--accent); font-weight: inherit; }
    .cin-typewriter em { color: var(--accent); font-style: normal; font-weight: 700; }
    .cin-source { display: block; font-size: 0.58rem; color: rgba(255,255,255,0.35); margin-top: 6px; font-style: italic; letter-spacing: 0.3px; }
    .cin-cursor {
        display: inline-block; width: 2px; height: 1.1em;
        background: var(--accent); margin-left: 2px;
        vertical-align: text-bottom;
        animation: cinBlink 0.6s step-end infinite;
    }
    @keyframes cinBlink { 0%,100%{opacity:1} 50%{opacity:0} }

    .cin-choice-title {
        font-size: 1.15rem; font-weight: 800;
        color: #ffffff; margin-bottom: var(--space-lg);
    }
    .cin-card {
        width: 100%; max-width: 320px;
        background: var(--glass); border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        padding: 14px 18px; margin-bottom: 10px;
        font-size: 0.88rem; font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer; text-align: left;
        transition: all 0.2s ease;
        -webkit-tap-highlight-color: transparent;
    }
    .cin-card:active { transform: scale(0.97); }
    .cin-card.selected {
        background: var(--accent-dim); border-color: var(--accent);
        color: var(--accent); font-weight: 600;
    }

    .cin-progress {
        position: absolute; bottom: max(env(safe-area-inset-bottom,20px),20px);
        left: 50%; transform: translateX(-50%);
        display: flex; gap: 8px;
    }
    .cin-pip {
        width: 8px; height: 8px; border-radius: 50%;
        background: rgba(255,255,255,0.12);
        transition: all 0.3s ease;
    }
    .cin-pip.done { background: var(--accent); }
    .cin-pip.current { background: var(--accent); transform: scale(1.3); }

    .cin-loader-text {
        font-size: 0.82rem; color: var(--text-muted);
        transition: opacity 0.3s ease;
        margin-top: var(--space-md);
    }
    .cin-loader-ring {
        width: 48px; height: 48px; border-radius: 50%;
        border: 3px solid rgba(255,255,255,0.08);
        border-top-color: var(--accent);
        animation: cinSpin 0.8s linear infinite;
    }
    @keyframes cinSpin { to { transform: rotate(360deg); } }

    .cin-verdict-text {
        font-size: 1.2rem; font-weight: 700;
        color: var(--text-primary); line-height: 1.5;
        max-width: 300px;
        opacity: 0; transform: translateY(16px);
        transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .cin-verdict-text.show { opacity: 1; transform: translateY(0); }

    .cin-promise-line em { color: var(--accent); font-style: normal; }
    .cin-promise-line {
        font-size: 1.05rem; color: #ffffff;
        line-height: 1.7; max-width: 280px; font-weight: 600;
        opacity: 0; transform: translateY(12px);
        transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .cin-promise-line.show { opacity: 1; transform: translateY(0); }

    .cin-cta {
        margin-top: var(--space-xl);
        opacity: 0; transform: translateY(10px);
        transition: opacity 0.4s ease 0.2s, transform 0.4s ease 0.2s;
    }
    .cin-cta.show { opacity: 1; transform: translateY(0); }


    /* Verdict profile card */
    .cin-profile-card {
        background: linear-gradient(135deg, rgba(226,169,59,0.08) 0%, rgba(226,169,59,0.02) 100%);
        border: 1px solid rgba(226,169,59,0.2);
        border-radius: 20px;
        padding: var(--space-xl) var(--space-lg);
        text-align: center;
        max-width: 320px;
        width: 100%;
        position: relative;
        overflow: hidden;
    }
    .cin-profile-card::before {
        content: '';
        position: absolute;
        top: -50%; left: -50%;
        width: 200%; height: 200%;
        background: radial-gradient(circle at 50% 50%, rgba(226,169,59,0.06) 0%, transparent 60%);
        animation: cinProfileGlow 4s ease-in-out infinite;
    }
    @keyframes cinProfileGlow {
        0%, 100% { transform: scale(1); opacity: 0.5; }
        50% { transform: scale(1.1); opacity: 1; }
    }
    .cin-profile-emoji {
        font-size: 3.5rem;
        margin-bottom: var(--space-md);
        position: relative;
        z-index: 1;
        animation: cinEmojiPop 0.5s cubic-bezier(0.34,1.56,0.64,1) both;
    }
    @keyframes cinEmojiPop {
        from { transform: scale(0); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    .cin-profile-name {
        font-size: 1.8rem;
        font-weight: 900;
        color: var(--accent);
        margin-bottom: var(--space-xs);
        position: relative; z-index: 1;
    }
    .cin-profile-label {
        font-size: 0.68rem;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: var(--space-md);
        position: relative; z-index: 1;
    }
    .cin-profile-insight {
        font-size: 0.88rem;
        color: var(--text-secondary);
        line-height: 1.75;
        position: relative; z-index: 1;
        text-align: left;
        padding: var(--space-md) 0;
        border-top: 1px solid rgba(255,255,255,0.06);
    }
    .cin-profile-insight strong { color: var(--accent); font-weight: inherit; }
    .cin-profile-insight em { color: var(--accent); font-style: normal; }
    .cin-profile-rec {
        font-size: 0.82rem;
        color: var(--text-primary);
        line-height: 1.6;
        font-weight: 600;
        position: relative; z-index: 1;
        margin-top: var(--space-md);
        padding: var(--space-sm) var(--space-md);
        background: rgba(226,169,59,0.06);
        border-radius: 10px;
        text-align: left;
    }
    .cin-profile-rec em { color: var(--accent); font-style: normal; }
    @media (prefers-reduced-motion: reduce) {
        .cin-profile-card::before { animation: none; }
        .cin-profile-emoji { animation: none; }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        .cin-phase { transition: opacity 0.15s; }
        .cin-verdict-text, .cin-promise-line, .cin-cta { transition: opacity 0.15s; transform: none !important; }
        .cin-verdict-text.show, .cin-promise-line.show, .cin-cta.show { transform: none; }
        .cin-loader-ring { animation-duration: 1.5s; }
        .cin-cursor { animation: none; opacity: 1; }
        .cin-card { transition: all 0.1s; }
    }

</style>
</head>
<body>

    <!-- ═══ CINEMATIC PRE-ONBOARDING ═══ -->
    <div id="cinIntro" class="hidden">
        <button class="cin-skip" onclick="cinSkip()">Overslaan</button>

        <!-- Phase 0: Start screen -->
        <div class="cin-phase" id="cinP0">
            <div class="cin-start-iphone">
                <div class="cin-start-iphone-screen">
                    <div class="cin-start-iphone-matrix" id="cinPhoneMatrix"></div>
                    <div class="cin-start-iphone-logo">GRIP</div>
                </div>
            </div>
            <button class="cin-start-btn" id="cinStartBtn" onclick="cinLaunchMatrix()">Start</button>
        </div>



        <!-- Phase 2: Typewriter -->
        <div class="cin-phase" id="cinP2">
            <div class="cin-typewriter" id="cinTypewriter"></div>
        </div>

        <!-- Phase 3a: Choice 1 -->
        <div class="cin-phase" id="cinP3a">
            <button class="cin-back" onclick="cinBackTo(1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg> Terug</button>
            <div class="cin-choice-title">Wat past bij jou?</div>
            <div id="cinCards3a"></div>
        </div>

        <!-- Phase 3b: Choice 2 -->
        <div class="cin-phase" id="cinP3b">
            <button class="cin-back" onclick="cinBackTo(2)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg> Terug</button>
            <div class="cin-choice-title">Hoe zou je jezelf omschrijven?</div>
            <div id="cinCards3b"></div>
        </div>

        <!-- Phase 3c: Choice 3 -->
        <div class="cin-phase" id="cinP3c">
            <button class="cin-back" onclick="cinBackTo(3)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg> Terug</button>
            <div class="cin-choice-title">Waar wil je vooral grip op?</div>
            <div id="cinCards3c"></div>
        </div>

        <!-- Phase 4: Analyzing -->
        <div class="cin-phase" id="cinP4">
            <div class="cin-loader-ring"></div>
            <div class="cin-loader-text" id="cinLoaderText"></div>
        </div>

        <!-- Phase 5: Verdict -->
        <div class="cin-phase" id="cinP5">
            <div class="cin-verdict-text" id="cinVerdict"></div>
        </div>

        <!-- Phase 6: Promise + CTA -->
        <div class="cin-phase" id="cinP6">
            <div class="cin-promise-line" id="cinPromise"></div>
            <div class="cin-cta" id="cinCta">
                <button class="btn-add" onclick="cinFinish()" style="min-width:220px;padding:16px 32px;font-size:1rem;border-radius:14px">Laten we beginnen</button>
            </div>
        </div>

        <!-- Progress pips -->
        <div class="cin-progress" id="cinPips"></div>
    </div>

    <!-- ═══════════════════════════════════════
         INTRO SPLASH
         ═══════════════════════════════════════ -->
    <div id="introSplash" class="hidden" style="position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:var(--space-2xl);text-align:center">
        <div style="font-size:2.4rem;font-weight:900;letter-spacing:6px;color:var(--accent);margin-bottom:var(--space-md)">GRIP</div>
        <div style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:var(--space-3xl);font-weight:500">Weet wat je kunt sparen</div>
        <button class="btn-add" onclick="dismissIntro()" style="min-width:220px;padding:16px 32px;font-size:1rem;border-radius:14px">Aan de slag</button>
    </div>

    <!-- ═══════════════════════════════════════
         PIN SCREEN
         ═══════════════════════════════════════ -->
    <div id="pinScreen" class="hidden" style="position:fixed;inset:0;z-index:998;background:var(--bg);display:flex;flex-direction:column;align-items:center;padding:0 var(--space-lg)">
        <!-- Top: avatar + greeting + dots -->
        <div style="display:flex;flex-direction:column;align-items:center;padding-top:max(env(safe-area-inset-top,48px),48px)">
            <div id="pinAvatar" style="width:56px;height:56px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:800;color:#fff;margin-bottom:var(--space-lg)"></div>
            <div style="font-size:0.88rem;color:var(--text-secondary);margin-bottom:var(--space-xl)">Vul je pincode in om verder te gaan</div>
            <div class="pin-dots" id="pinDots" style="justify-content:center;margin-bottom:var(--space-xs)"></div>
            <div class="pin-error" id="pinError" style="min-height:20px"></div>
        </div>
        <!-- Keypad: centered in remaining space -->
        <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;padding-bottom:env(safe-area-inset-bottom,16px)">
            <div class="pin-keypad" id="pinKeypad"></div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════
         ONBOARDING (7-step)
         ═══════════════════════════════════════ -->
    <div id="onboarding" class="hidden" style="position:fixed;inset:0;z-index:997;background:var(--bg);overflow-y:auto;padding:env(safe-area-inset-top,0) var(--space-lg) var(--space-3xl)">
        <div style="padding-top:var(--space-2xl)">
            <div id="obProgress" style="display:flex;gap:6px;justify-content:center;margin-bottom:var(--space-sm)"></div>
            <div id="obStepLabel" style="text-align:center;font-size:0.72rem;color:var(--text-muted);margin-bottom:var(--space-2xl)"></div>
            <div id="obContent"></div>
            <div id="obNav" style="display:flex;justify-content:space-between;align-items:center;margin-top:var(--space-2xl);padding-bottom:var(--space-2xl)"></div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════
         MAIN APP
         ═══════════════════════════════════════ -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="header-logo">GRIP <span style="font-size:0.5rem;font-weight:400;letter-spacing:1px;color:var(--text-muted);margin-left:4px">weet wat je kunt sparen</span></div>
            <div class="header-avatar" id="headerAvatar" onclick="showView('menu')" role="button" aria-label="Menu"></div>
        </header>

        <!-- ═══ HOME VIEW ═══ -->
        <div id="homeView" class="view">
            <!-- Greeting -->
            <div class="greeting" id="homeGreeting" style="color:var(--accent)"></div>
            <div style="font-size:0.78rem;color:var(--text-muted);margin-top:-4px;margin-bottom:var(--space-lg)" id="homeDateLabel"></div>

            <!-- Primary card: dagbudget resterend -->
            <div class="card card-primary">
                <div class="card-label">Vandaag</div>
                <div class="card-amount" id="homeBudgetLeft"></div>
                <div class="progress-track">
                    <div class="progress-fill" id="homeBudgetBar" style="width:0%"></div>
                </div>
                <div class="card-sub" id="homeBudgetSub"></div>
            </div>

            <!-- Premium: Slimme waarschuwing -->
            <div id="premAlertBanner" style="display:none">
                <div class="card" style="border-color:rgba(239,68,68,0.3);background:rgba(239,68,68,0.06)">
                    <div style="display:flex;align-items:flex-start;gap:12px">
                        <div style="font-size:1.1rem;flex-shrink:0;margin-top:2px">⚠️</div>
                        <div>
                            <div style="font-size:0.82rem;font-weight:700;color:var(--red)" id="premAlertTitle"></div>
                            <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px" id="premAlertBody"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Premium: Cashflow card -->
            <div id="premCashflowCard" style="display:none">
                <div class="card" style="border-color:rgba(226,169,59,0.15)">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-sm)">
                        <div style="font-size:0.68rem;text-transform:uppercase;font-weight:700;color:var(--accent);letter-spacing:1px">Veilig te besteden tot salarisdag</div>
                        <span class="prem-badge-sm">PREMIUM</span>
                    </div>
                    <div style="font-size:1.4rem;font-weight:900;font-variant-numeric:var(--tabular)" id="premSafeAmount"></div>
                    <div style="font-size:0.72rem;color:var(--text-muted);margin-top:4px" id="premSafeSub"></div>
                    <div id="premUpcomingBills" style="margin-top:var(--space-md)"></div>
                </div>
            </div>

            <!-- Free: Waarschuwing-teaser -->
            <div id="premAlertTeaser" style="display:none">
                <div class="card" style="border-color:rgba(226,169,59,0.12);cursor:pointer" onclick="premShowModal('waarschuwing')">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="font-size:1rem;opacity:0.5">🔒</div>
                        <div>
                            <div style="font-size:0.78rem;font-weight:600;color:var(--text-secondary)">Premium waarschuwt je voordat het krap wordt</div>
                            <div style="font-size:0.68rem;color:var(--accent);margin-top:4px">Meer info &#8594;</div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Quick-add grid -->
            <div style="margin-bottom:var(--space-xs)">
                <div class="section-title" style="margin-bottom:var(--space-sm)" id="homeDailyTitle">Dagelijkse uitgaven invoeren</div>
            </div>
            <div class="quick-add-grid" id="quickAddGrid"></div>

            <!-- Inline manual input -->
            <div class="inline-input-area" id="inlineInputArea">
                <div class="inline-input-row">
                    <span style="color:var(--text-tertiary);font-weight:700;font-size:1.1rem">€</span>
                    <input type="text" class="grip-input" id="inlineAmount" placeholder="Bedrag" step="0.01" min="0" inputmode="decimal">
                    <button class="btn-add" onclick="addInlineExpense()" id="inlineAddBtn">Toevoegen</button>
                </div>
                <div class="inline-note-row">
                    <input type="text" class="grip-input grip-input-sm" id="inlineNote" placeholder="" style="width:100%">
                </div>
                <div class="input-hint" id="inlineHint">Vul een bedrag in.</div>
            </div>

            <!-- Today's transactions -->
            <div id="homeTodaySection">
                <div class="section-title" id="homeTodaySectionTitle">Vandaag</div>
                <div class="tx-list" id="homeTodayList"></div>
            </div>

            <!-- Savings balance - prominent position -->
            <div style="background:linear-gradient(135deg,rgba(226,169,59,0.10) 0%,rgba(52,211,153,0.06) 100%);border:1px solid rgba(226,169,59,0.15);border-radius:var(--radius-xl);padding:var(--space-2xl);margin-bottom:var(--space-lg);cursor:pointer;transition:all 0.2s" onclick="showView('sparen')">
                <div style="display:flex;align-items:center;justify-content:space-between">
                    <div>
                        <div style="font-size:0.68rem;text-transform:uppercase;font-weight:700;color:var(--accent);letter-spacing:1px">Huidig spaarsaldo</div>
                        <div style="font-size:1.6rem;font-weight:900;font-variant-numeric:var(--tabular);margin-top:4px" id="homeSavingsTotal"></div>
                        <div class="status-sub" id="homeSavingsChange"></div>
                    </div>
                    <div style="color:var(--accent);opacity:0.5">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                    </div>
                </div>
            </div>

            <!-- Period status card -->
            <div class="card status-card" id="periodStatusCard" onclick="showView('overzicht')">
                <div class="status-left">
                    <div class="status-label" id="periodLabel"></div>
                    <div class="status-value" id="periodStatus"></div>
                </div>
                <div class="status-dots" id="periodDots"></div>
            </div>

            <!-- Premium teaser (hidden when premium active) -->
            <div class="prem-teaser" id="premTeaser" onclick="premShowPaywall('teaser')" style="display:none">
                <div class="prem-teaser-title"><span class="prem-badge">PREMIUM</span> Meer zekerheid over je geld</div>
                <ul class="prem-teaser-list">
                    <li>Huur over 5 dagen? Dagbudget past zich aan.</li>
                    <li>Waarschuwing als je krap dreigt te komen.</li>
                    <li>Wat als je &#8364;25/week minder uitgeeft?</li>
                </ul>
                <div class="prem-teaser-cta">Bekijk Premium →</div>
            </div>
        </div>

        <!-- ═══ OVERZICHT VIEW ═══ -->
        <div id="overzichtView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title">Overzicht</div>
            </div>

            <!-- Period selector -->
            <div class="period-strip" id="periodStrip"></div>

            <!-- Savings highlight -->
            <div class="card" style="background:var(--accent-dim);border-color:var(--accent)">
                <div style="display:flex;align-items:center;justify-content:space-between">
                    <div>
                        <div style="font-size:0.72rem;text-transform:uppercase;font-weight:700;color:var(--accent);letter-spacing:0.5px" id="ovSavingsLabel">Huidig spaarsaldo</div>
                        <div style="font-size:1.3rem;font-weight:800;font-variant-numeric:var(--tabular);margin-top:2px" id="ovSavingsAmount"></div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:0.72rem;color:var(--text-muted)" id="ovAvgLabel">Gem. per dag</div>
                        <div style="font-size:1rem;font-weight:700;font-variant-numeric:var(--tabular)" id="ovDailyAvg"></div>
                    </div>
                </div>
            </div>

            <!-- Daily spending chart (SVG bars) -->
            <div class="card">
                <div class="section-title" id="ovDailyTitle">Dagelijks uitgegeven</div>
                <div id="ovDailyChart" style="width:100%;overflow-x:auto"></div>
            </div>

            <!-- Budget donut -->
            <div class="card">
                <div class="section-title" id="ovDistTitle">Verdeling deze periode</div>
                <div style="display:flex;align-items:center;gap:var(--space-xl)">
                    <div id="ovDonut" style="flex-shrink:0"></div>
                    <div id="ovDonutLegend" style="font-size:0.78rem;line-height:1.8"></div>
                </div>
            </div>

            <!-- Key numbers -->
            <div class="card" id="ovStatsCard">
                <div class="section-title" id="ovStatsTitle">Cijfers</div>
                <div id="ovStatsRows"></div>
            </div>

            <!-- Calendar -->
            <div class="card">
                <div class="section-title" id="ovCalTitle">Kalender</div>
                <div class="cal-grid" id="ovCalendar"></div>
                <div class="day-detail" id="ovDayDetail">
                    <div class="day-detail-header">
                        <span class="day-detail-title" id="ovDayTitle"></span>
                        <button class="day-detail-close" onclick="closeDayDetail()" aria-label="Sluit dagdetail">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div id="ovDayEntries"></div>
                </div>
            </div>
        </div>

        <!-- ═══ SPAREN VIEW ═══ -->
        <div id="sparenView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title" id="sparenViewTitle">Spaarrace</div>
            </div>
            <!-- Primary: current savings -->
            <div class="card card-primary">
                <div class="card-label" id="spCardLabel">Huidig spaarsaldo</div>
                <div class="card-amount" id="spSavingsTotal"></div>
                <div class="card-sub" id="spSavingsChange"></div>
            </div>

            <!-- Goal ring + prediction (hidden if no goal) -->
            <div id="spGoalSection">
                <div class="card">
                    <div class="save-ring-container">
                        <div class="save-ring">
                            <svg viewBox="0 0 160 160">
                                <circle class="save-ring-bg" cx="80" cy="80" r="68"/>
                                <circle class="save-ring-fill" id="spRingFill" cx="80" cy="80" r="68" stroke-dasharray="427.3" stroke-dashoffset="427.3"/>
                            </svg>
                            <div class="save-ring-text">
                                <div class="save-ring-pct" id="spRingPct">0%</div>
                                <div class="save-ring-label" id="spRingLabel"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Prediction -->
                    <div class="pred-card" id="spPrediction"></div>
                </div>

                <!-- Milestones -->
                <div class="card" id="spMilestonesCard">
                    <div class="section-title" id="spMilestonesTitle">Mijlpalen</div>
                    <div class="milestone-list" id="spMilestones"></div>
                </div>
            </div>

            <!-- Goal reached celebration (hidden by default) -->
            <div id="spGoalReached" class="hidden">
                <div class="card" style="background:linear-gradient(135deg, rgba(61,213,152,0.12), rgba(var(--accent-rgb),0.12));border-color:var(--green)">
                    <div style="text-align:center;padding:var(--space-xl) 0">
                        <div style="font-size:2.4rem;margin-bottom:var(--space-md)">🏆</div>
                        <div style="font-size:1.2rem;font-weight:800;color:var(--green)" id="goalReachedTitle">🎉 Doel bereikt!</div>
                        <div style="font-size:0.88rem;color:var(--text-secondary);margin-top:var(--space-sm)" id="goalReachedSub">Gefeliciteerd!</div>
                        <div style="font-size:0.82rem;color:var(--text-muted);margin-top:var(--space-md)" id="goalReachedAmount"></div>
                        <div style="margin-top:var(--space-xl);display:flex;flex-direction:column;gap:var(--space-sm);align-items:center">
                            <button class="btn-add" onclick="spOpenGoalInput()" id="goalReachedNewBtn" style="min-width:200px">Nieuw doel instellen</button>
                            <div style="font-size:0.75rem;color:var(--text-muted);margin-top:var(--space-xs)" id="goalReachedKeep">Of blijf gewoon sparen</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No goal prompt -->
            <div id="spNoGoal" class="hidden">
                <div class="card">
                    <div class="empty-state">
                        <span id="spNoGoalText">Stel een spaardoel in om je voortgang te volgen.</span>
                        <div style="margin-top:var(--space-lg)">
                            <button class="btn-add" onclick="spOpenGoalInput()" id="spNoGoalBtn">Spaardoel instellen</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inline goal input (hidden by default) -->
            <div id="spGoalInput" class="hidden">
                <div class="card" style="border-color:rgba(226,169,59,0.2);background:linear-gradient(135deg,rgba(226,169,59,0.08) 0%,rgba(52,211,153,0.04) 100%)">
                    <div style="font-size:0.82rem;font-weight:800;color:var(--accent);margin-bottom:var(--space-md)">Spaardoel instellen</div>
                    <div class="field-helper" style="margin-bottom:var(--space-md)">Hoeveel wil je sparen? GRIP berekent op basis van je spaargedrag wanneer je dit haalt.</div>
                    <div style="display:flex;gap:var(--space-sm);align-items:center">
                        <span style="color:var(--text-muted);font-weight:700">€</span>
                        <input type="text" class="grip-input" id="spGoalInput2" inputmode="decimal" placeholder="bijv. 5000" style="flex:1">
                        <button class="btn-add" onclick="spSaveGoalInline()" style="min-width:90px">Opslaan</button>
                    </div>
                </div>
            </div>

            <!-- Extra savings goals (premium) -->
            <div id="premExtraGoals" style="margin-bottom:var(--space-lg)"></div>

            <!-- How GRIP calculates -->
            <button class="collapse-toggle" onclick="toggleCollapse(this)" id="spCollapseBtn" aria-expanded="false" aria-controls="spCollapseContent">
                <span id="spCollapseLabel">Hoe berekent GRIP dit?</span>
                <svg class="arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="collapse-content" id="spCollapseContent">
                <div class="collapse-inner" id="spCollapseInner">
                    GRIP berekent je besparing per periode: auto-sparen + wat je dagelijks overhoudt + wat je van vrij budget niet uitgeeft. Op basis van een gewogen gemiddelde (recente periodes tellen zwaarder) schat GRIP wanneer je je doel bereikt. Hoe meer data, hoe betrouwbaarder de schatting.
                </div>
            </div>

            <!-- Period breakdown -->
            <div class="card" id="spBreakdownCard">
                <div class="section-title" id="spBreakdownTitle">Deze periode</div>
                <div id="spBreakdown"></div>
            </div>

            <!-- Spaarsaldo corrigeren -->
            <div class="card">
                <div class="section-title" id="spCorrTitle">Saldo corrigeren</div>
                <div class="field-helper" style="margin-bottom:var(--space-md)" id="spCorrExplain">Heb je toch spaargeld uitgegeven? Onvoorziene uitgaven, een reparatie of boete? Of juist iets erbij, belastingteruggave of een bonus? Corrigeer het hier en alle berekeningen gaan automatisch mee.</div>
                <div style="display:flex;gap:var(--space-sm);align-items:center">
                    <span style="color:var(--text-muted);font-weight:700">€</span>
                    <input type="text" class="grip-input grip-input-sm" id="spCorrectionVal" inputmode="decimal" placeholder="Nieuw saldo" style="flex:1">
                    <button class="btn-add" onclick="applySavingsCorrection()" style="flex-shrink:0;min-width:90px" id="spCorrBtn">Corrigeren</button>
                </div>
            </div>
        </div>

        <!-- ═══ MENU VIEW ═══ -->
        <div id="menuView" class="view hidden">
            <div class="greeting" id="menuGreeting"></div>
            <div class="menu-list">
                <div class="menu-item" onclick="showView('overzicht')">
                    <div class="menu-item-icon" style="background:rgba(139,92,246,0.15)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg></div>
                    <div class="menu-item-content"><div class="menu-item-title">Overzicht</div><div class="menu-item-sub">Periodes, kalender, transacties</div></div>
                    <div class="menu-item-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                </div>
                <div class="menu-item" onclick="showView('vrijbudget')">
                    <div class="menu-item-icon" style="background:rgba(34,197,94,0.15)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4h-4z"/></svg></div>
                    <div class="menu-item-content"><div class="menu-item-title">Vrij budget</div><div class="menu-item-sub">Uitgaven uit vrij besteedbaar geld</div></div>
                    <div class="menu-item-value" id="menuFreeStatus"></div>
                    <div class="menu-item-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                </div>
                <div class="menu-item" onclick="showView('sparen')">
                    <div class="menu-item-icon" style="background:rgba(226,169,59,0.15)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#E2A93B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-0.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2"/></svg></div>
                    <div class="menu-item-content"><div class="menu-item-title">Spaarrace</div><div class="menu-item-sub">Spaardoel, prognose, saldo</div></div>
                    <div class="menu-item-value" id="menuSavingsStatus"></div>
                    <div class="menu-item-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                </div>
                <div class="menu-item" onclick="showView('inkomen')">
                    <div class="menu-item-icon" style="background:rgba(59,130,246,0.15)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.2 7A7 7 0 0 0 7 12a7 7 0 0 0 10.2 5"/><line x1="5" y1="10" x2="14" y2="10"/><line x1="5" y1="14" x2="14" y2="14"/></svg></div>
                    <div class="menu-item-content"><div class="menu-item-title" id="menuIncomeTitle">Inkomen & uitbetaling</div><div class="menu-item-sub" id="menuIncomeSub">Netto inkomen, uitbetalingsdag</div></div>
                    <div class="menu-item-value" id="menuIncomeVal"></div>
                    <div class="menu-item-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                </div>
                <div class="menu-item" onclick="showView('dagsparen')">
                    <div class="menu-item-icon" style="background:rgba(6,182,212,0.15)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
                    <div class="menu-item-content"><div class="menu-item-title" id="menuDagTitle">Dagbudget & sparen</div><div class="menu-item-sub" id="menuDagSub">Dagbudget, auto-sparen, doel</div></div>
                    <div class="menu-item-value" id="menuBudgetVal"></div>
                    <div class="menu-item-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                </div>
                <div class="menu-item" onclick="showView('vastelasten')">
                    <div class="menu-item-icon" style="background:rgba(239,68,68,0.15)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></div>
                    <div class="menu-item-content"><div class="menu-item-title">Vaste lasten</div><div class="menu-item-sub">Huur, energie, verzekeringen</div></div>
                    <div class="menu-item-value" id="menuFixedTotal" style="color:var(--red)"></div>
                    <div class="menu-item-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                </div>
                <div class="menu-item" onclick="premOpenTrends()">
                    <div class="menu-item-icon" style="background:rgba(139,92,246,0.15)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
                    <div class="menu-item-content"><div class="menu-item-title">Trends <span class="prem-badge-sm" id="trendsPremBadge">PREMIUM</span></div><div class="menu-item-sub">Maandvergelijking en historie</div></div>
                    <div class="menu-item-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                </div>
                <div class="menu-item" onclick="premOpenScenario()">
                    <div class="menu-item-icon" style="background:rgba(226,169,59,0.15)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#e2a93b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div>
                    <div class="menu-item-content"><div class="menu-item-title">Scenario&#39;s <span class="prem-badge-sm" id="scenarioPremBadge">PREMIUM</span></div><div class="menu-item-sub">Wat als... doorrekenen</div></div>
                    <div class="menu-item-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                </div>
                <div class="menu-item" onclick="showView('profiel')">
                    <div class="menu-item-icon" style="background:rgba(168,85,247,0.15)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <div class="menu-item-content"><div class="menu-item-title">Profiel</div><div class="menu-item-sub">Naam, avatar, beveiliging</div></div>
                    <div class="menu-item-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                </div>
                <div class="menu-item" onclick="showView('dataview')">
                    <div class="menu-item-icon" style="background:rgba(100,116,139,0.15)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
                    <div class="menu-item-content"><div class="menu-item-title">Data & privacy</div><div class="menu-item-sub">Backup, data wissen, privacy</div></div>
                    <div class="menu-item-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                </div>
            </div>
            <div class="prof-footer">GRIP v3.0</div>
        </div>

        <!-- ═══ VRIJ BUDGET VIEW ═══ -->
        <div id="vrijbudgetView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title">Vrij budget</div>
            </div>

            <!-- Budget status today -->
            <div class="card card-primary">
                <div class="card-label">Vrij te besteden deze periode</div>
                <div class="card-amount" id="vbBudgetLeft"></div>
                <div class="card-sub" id="vbBudgetSub"></div>
            </div>

            <!-- Add spending -->
            <div class="card">
                <div class="section-title">Uitgave toevoegen</div>
                <div class="add-spending-row" style="flex-wrap:wrap">
                    <input type="text" class="grip-input grip-input-sm" id="vbSpendAmount" inputmode="decimal" placeholder="Bedrag" style="flex:1;min-width:100px">
                    <select class="grip-input grip-input-sm" id="vbSpendCat" style="flex:1;min-width:140px">
                        <option value="kleding">Kleding</option>
                        <option value="elektronica">Elektronica</option>
                        <option value="horeca">Uit eten/drinken</option>
                        <option value="cadeaus">Cadeaus</option>
                        <option value="gezondheid">Gezondheid</option>
                        <option value="hobby">Hobby</option>
                        <option value="vakantie">Vakantie</option>
                        <option value="huishouden">Huishouden</option>
                        <option value="auto">Auto/vervoer</option>
                        <option value="overig_vrij">Overig</option>
                    </select>
                </div>
                <div style="margin-top:var(--space-sm)">
                    <input type="text" class="grip-input grip-input-sm" id="vbSpendName" placeholder="Omschrijving (optioneel)" style="width:100%;margin-bottom:var(--space-sm)">
                    <div style="display:flex;gap:var(--space-sm)">
                        <button class="btn-add" onclick="addFreeSpendingVB()" style="flex:1">Toevoegen</button>
                        <button class="btn-add" onclick="vbClearSpendForm()" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                    </div>
                </div>
            </div>

            <!-- Spending list -->
            <div class="card">
                <div class="section-title">Uitgaven deze periode</div>
                <div id="vbSpendingList"></div>
            </div>

            <!-- Category donut -->
            <div class="card" id="vbDonutCard">
                <div class="section-title">Per categorie</div>
                <div style="display:flex;align-items:center;gap:var(--space-xl)">
                    <div id="vbDonut" style="flex-shrink:0"></div>
                    <div id="vbDonutLegend" style="font-size:0.72rem;line-height:1.8"></div>
                </div>
            </div>

            <!-- Custom date range -->
            <div class="card">
                <div class="section-title">Aangepast overzicht</div>
                <div class="field-helper" style="margin-bottom:var(--space-md)">Kies een eigen datumbereik.</div>
                <div style="display:flex;gap:var(--space-sm);align-items:center;flex-wrap:wrap">
                    <input type="date" class="grip-input grip-input-sm" id="ovCustomStart" style="flex:1;min-width:120px">
                    <span style="color:var(--text-muted);font-size:0.78rem">t/m</span>
                    <input type="date" class="grip-input grip-input-sm" id="ovCustomEnd" style="flex:1;min-width:120px">
                </div>
                <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-sm)">
                    <button class="btn-add" onclick="showCustomDateRange()" style="flex:1">Toon overzicht</button>
                    <button class="btn-add" onclick="vbClearCustomDate()" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                </div>
                <div id="ovCustomResult" style="margin-top:var(--space-md)"></div>
            </div>
        </div>

        <!-- ═══ INKOMEN & SALARIS VIEW (v2 redesign) ═══ -->
        <div id="inkomenView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title" id="inkomenViewTitle">Inkomen & uitbetaling</div>
            </div>

            <!-- Summary card -->
            <div class="summary-card">
                <div class="summary-card-title">Netto inkomen</div>
                <div class="summary-card-amount" id="inkomenSummaryAmount"></div>
                <div class="summary-card-sub" id="inkomenSummarySub"></div>
            </div>

            <!-- Standaard netto inkomen -->
            <div class="settings-card">
                <div class="settings-card-title">Standaard netto inkomen</div>
                <div class="field-helper" style="margin-bottom:var(--space-md)">Dit bedrag geldt voor elke uitbetalingsperiode tenzij je hieronder een afwijking instelt.</div>
                <div class="input-row">
                    <span style="color:var(--text-tertiary);font-weight:700;font-size:1.1rem">€</span>
                    <input type="text" class="grip-input" id="instIncome" inputmode="decimal" style="flex:1" placeholder="0,00">
                    <button class="btn-save" onclick="saveInstIncome()" style="flex-shrink:0;min-height:44px;min-width:80px">Opslaan</button>
                </div>
            </div>

            <!-- Afwijkend inkomen per maand -->
            <div class="settings-card">
                <div class="settings-card-title">Afwijkend inkomen per maand</div>
                <div class="field-helper" style="margin-bottom:var(--space-md)">Vakantiegeld in mei, eindejaarsuitkering in december, bonus, of minder uren? Stel hier het afwijkende bedrag in voor een specifieke periode.</div>
                <div class="input-row" style="margin-bottom:var(--space-sm)">
                    <select class="grip-input grip-input-sm" id="instIncomeOverridePeriod" style="flex:1.5"></select>
                    <input type="text" class="grip-input grip-input-sm" id="instIncomeOverrideVal" inputmode="decimal" placeholder="€ Bedrag" style="flex:1">
                    <button class="btn-add" onclick="saveInstIncomeOverride()" style="flex-shrink:0;min-height:44px">Opslaan</button>
                </div>
                <div id="instIncomeOverrideList"></div>
            </div>

            <!-- Standaard uitbetalingsdag -->
            <div class="settings-card">
                <div class="settings-card-title">Standaard uitbetalingsdag</div>
                <div class="field-helper" style="margin-bottom:var(--space-md)">Op welke dag van de maand ontvang je meestal je uitbetaling?</div>
                <div class="input-row">
                    <span style="font-size:0.88rem;color:var(--text-tertiary)">Dag</span>
                    <input type="number" class="grip-input" id="instSalaryDay" min="1" max="31" inputmode="numeric" style="flex:1;max-width:100px;text-align:center">
                    <button class="btn-save" onclick="saveInstSalaryDay()" style="flex-shrink:0;min-height:44px">Opslaan</button>
                </div>
            </div>

            <!-- Afwijkende uitbetalingsdagen per maand -->
            <div class="settings-card">
                <div class="settings-card-title">Uitbetalingsdagen per maand</div>
                <div class="field-helper" style="margin-bottom:var(--space-lg)">Maanden die afwijken van je standaarddag worden gemarkeerd. Leeg = standaarddag.</div>
                <div style="display:flex;gap:var(--space-sm);align-items:center;margin-bottom:var(--space-lg)">
                    <div style="font-size:0.78rem;font-weight:700;color:var(--text-secondary);flex-shrink:0">Jaar:</div>
                    <select class="grip-input grip-input-sm" id="salaryYearSelect" onchange="renderSalaryDayGrid()" style="flex:1"></select>
                </div>
                <div id="salaryDayGrid"></div>
                <button class="btn-save" onclick="saveSalaryDayGridAll()" style="width:100%;margin-top:var(--space-lg);min-height:44px">Alle wijzigingen opslaan</button>
            </div>
        </div>

        <!-- ═══ DAGBUDGET & SPAREN VIEW ═══ -->
        <div id="dagsparenView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title">Dagbudget & sparen</div>
            </div>

            <!-- Hero stats -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-md);margin-bottom:var(--space-xl)">
                <div class="card" style="text-align:center;padding:var(--space-xl);margin:0">
                    <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:var(--accent);margin-bottom:var(--space-xs)">Dagbudget</div>
                    <div style="font-size:1.3rem;font-weight:900;font-variant-numeric:var(--tabular)" id="dsDagbudgetDisplay"></div>
                    <div style="font-size:0.68rem;color:var(--text-muted);margin-top:2px">per dag</div>
                </div>
                <div class="card" style="text-align:center;padding:var(--space-xl);margin:0">
                    <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:var(--green);margin-bottom:var(--space-xs)">Auto-sparen</div>
                    <div style="font-size:1.3rem;font-weight:900;font-variant-numeric:var(--tabular)" id="dsAutoSaveDisplay"></div>
                    <div style="font-size:0.68rem;color:var(--text-muted);margin-top:2px">per maand</div>
                </div>
            </div>

            <!-- Spaardoel card -->
            <div class="card" style="padding:var(--space-xl);background:linear-gradient(135deg,rgba(226,169,59,0.08) 0%,rgba(52,211,153,0.04) 100%);border-color:rgba(226,169,59,0.12)">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-md)">
                    <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:var(--accent)">Spaardoel</div>
                    <div style="font-size:1.1rem;font-weight:800;font-variant-numeric:var(--tabular)" id="dsGoalDisplay"></div>
                </div>
                <div style="font-size:0.82rem;font-weight:700;margin-bottom:var(--space-xs)">Huidig spaarsaldo</div>
                <div style="font-size:1.2rem;font-weight:900;font-variant-numeric:var(--tabular);color:var(--green)" id="dsCurrentSavings"></div>
            </div>

            <!-- Dagbudget instellen -->
            <div class="section-title" style="margin-top:var(--space-2xl)">Dagbudget instellen</div>
            <div class="card" style="padding:var(--space-xl)">
                <div class="field-helper" style="margin-bottom:var(--space-md)">Je dagelijkse limiet voor supermarkt, koffie, lunch en afhalen. Wat je niet uitgeeft wordt automatisch gespaard.</div>
                <div style="display:flex;align-items:center;gap:var(--space-sm)">
                    <span style="color:var(--text-muted);font-weight:700;font-size:1.1rem">€</span>
                    <input type="text" class="grip-input" id="instBudget" inputmode="decimal" style="flex:1">
                    <button class="btn-add" onclick="saveInstBudget()" style="min-width:100px">Opslaan</button>
                </div>
            </div>

            <!-- Auto-sparen instellen -->
            <div class="section-title">Automatisch sparen</div>
            <div class="card" style="padding:var(--space-xl)">
                <div class="field-helper" style="margin-bottom:var(--space-md)">Dit bedrag gaat elke uitbetalingsperiode automatisch opzij. Alsof het een vaste overboeking naar je spaarrekening is.</div>
                <div style="display:flex;align-items:center;gap:var(--space-sm)">
                    <span style="color:var(--text-muted);font-weight:700;font-size:1.1rem">€</span>
                    <input type="text" class="grip-input" id="instAutoSave" inputmode="decimal" style="flex:1">
                    <button class="btn-add" onclick="saveInstAutoSave()" style="min-width:100px">Opslaan</button>
                </div>
            </div>

            <!-- Spaardoel instellen -->
            <div class="section-title">Spaardoel</div>
            <div class="card" style="padding:var(--space-xl)">
                <div class="field-helper" style="margin-bottom:var(--space-md)">Stel een bedrag in dat je wilt bereiken. GRIP berekent op basis van je spaargedrag wanneer je dit haalt.</div>
                <div style="display:flex;align-items:center;gap:var(--space-sm)">
                    <span style="color:var(--text-muted);font-weight:700;font-size:1.1rem">€</span>
                    <input type="text" class="grip-input" id="instGoal" inputmode="decimal" placeholder="bijv. 5000" style="flex:1">
                    <button class="btn-add" onclick="saveInstGoal()" style="min-width:100px">Opslaan</button>
                </div>
            </div>

            <!-- Spaarsaldo corrigeren -->
            <div class="section-title">Spaarsaldo corrigeren</div>
            <div class="card" style="padding:var(--space-xl)">
                <div class="field-helper" style="margin-bottom:var(--space-md)">Heb je toch spaargeld uitgegeven? Onvoorziene kosten of een reparatie? Of juist iets erbij, belastingteruggave of een bonus? Vul je werkelijke saldo in en alle berekeningen gaan automatisch mee.</div>
                <div style="display:flex;align-items:center;gap:var(--space-sm)">
                    <span style="color:var(--text-muted);font-weight:700;font-size:1.1rem">€</span>
                    <input type="text" class="grip-input" id="dsCorrectionInput" inputmode="decimal" placeholder="Nieuw saldo" style="flex:1">
                    <button class="btn-add" onclick="dsSaveCorrection()" style="min-width:100px">Corrigeren</button>
                </div>
            </div>
        </div>

        <div id="vastelastenView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title">Vaste lasten</div>
            </div>

            <!-- Periode selector -->
            <select class="grip-input" id="vlPeriodDropdown" onchange="vlSelectPeriod(this.value)" style="margin-bottom:var(--space-xl)"></select>

            <!-- Donut + totaal -->
            <div style="display:flex;align-items:center;gap:var(--space-xl);margin-bottom:var(--space-lg)">
                <div id="vlDonut"></div>
                <div style="flex:1">
                    <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:var(--text-muted);margin-bottom:4px">Totaal per maand</div>
                    <div style="font-size:1.8rem;font-weight:900;color:var(--red);font-variant-numeric:var(--tabular)" id="vlDonutTotal"></div>
                </div>
            </div>
            <div id="vlDonutLegend" style="display:flex;flex-wrap:wrap;gap:var(--space-sm);font-size:0.72rem;color:var(--text-secondary);margin-bottom:var(--space-2xl)"></div>

            <!-- Lijst per categorie -->
            <div id="vlCatList"></div>

            <!-- Toevoegen -->
            <!-- Categorieën bewerken -->
            <div id="vlCatEditSection" class="hidden">
                <div class="card" style="padding:var(--space-lg);margin-top:var(--space-lg)">
                    <div style="font-size:0.82rem;font-weight:800;margin-bottom:var(--space-md)">Categorienamen bewerken</div>
                    <div id="vlCatEditList"></div>
                    <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-md)">
                    <button class="btn-add" onclick="vlSaveCatLabels()" style="flex:1">Opslaan</button>
                    <button class="btn-add" onclick="vlToggleCatEdit()" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                </div>
                </div>
            </div>
            <button class="btn-add" onclick="vlToggleCatEdit()" id="vlCatEditBtn" style="width:100%;margin-top:var(--space-md);background:var(--glass);color:var(--text-secondary);padding:10px;font-size:0.78rem">Categorienamen bewerken</button>
            <div id="vlNewCatSection" class="hidden">
                <div class="card" style="padding:var(--space-lg);margin-top:var(--space-md)">
                    <div style="font-size:0.82rem;font-weight:800;margin-bottom:var(--space-md)">Nieuwe categorie toevoegen</div>
                    <div style="margin-bottom:var(--space-sm)">
                        <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:6px">Kies een icoon</div>
                        <div id="vlEmojiGrid" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:var(--space-md)"></div>
                        <input type="hidden" id="vlNewCatEmoji" value="📌">
                    </div>
                    <div style="margin-bottom:var(--space-sm)">
                        <input type="text" class="grip-input grip-input-sm" id="vlNewCatName" placeholder="Naam categorie" style="width:100%">
                    </div>
                    <div style="display:flex;gap:var(--space-sm)">
                        <button class="btn-add" onclick="vlAddNewCategory()" style="flex:1">Toevoegen</button>
                        <button class="btn-add" onclick="vlToggleNewCat()" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                    </div>
                </div>
            </div>
            <button class="btn-add" onclick="vlToggleNewCat()" id="vlNewCatBtn" style="width:100%;margin-top:var(--space-sm);background:var(--glass);color:var(--text-secondary);padding:10px;font-size:0.78rem">+ Categorie toevoegen</button>

            <div class="card" style="padding:var(--space-lg);margin-top:var(--space-lg);border-color:rgba(226,169,59,0.15)">
                <div style="font-size:0.82rem;font-weight:800;margin-bottom:var(--space-md);color:var(--accent)">+ Nieuwe vaste last</div>
                <input type="text" class="grip-input grip-input-sm" id="vlAddName" placeholder="Naam" style="margin-bottom:var(--space-sm);width:100%">
                <div style="display:flex;gap:var(--space-sm);margin-bottom:var(--space-sm)">
                    <div style="display:flex;align-items:center;gap:4px;flex:1">
                        <span style="color:var(--text-muted);font-weight:700;font-size:0.9rem">€</span>
                        <input type="text" class="grip-input grip-input-sm" id="vlAddAmount" inputmode="decimal" placeholder="0,00" style="flex:1">
                    </div>
                    <select class="grip-input grip-input-sm" id="vlAddCat" style="flex:1"></select>
                </div>
                <div style="display:flex;gap:var(--space-sm)">
                    <button class="btn-add" onclick="vlAddFixedCost()" style="flex:1;padding:12px;font-size:0.82rem">Toevoegen</button>
                    <button class="btn-add" onclick="vlClearAddForm()" style="flex:1;padding:12px;font-size:0.82rem;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                </div>
            </div>
        </div>

        <div id="profielView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title">Profiel</div>
            </div>

            <div class="prof-header">
                <div class="prof-avatar" id="profAvatar"></div>
                <div>
                    <div class="prof-name" id="profName"></div>
                    <div class="prof-since" id="profSince"></div>
                </div>
            </div>

            <div class="prof-group-title">Persoonlijk</div>
            <div class="card" style="padding:0 var(--space-lg)">
                <div class="prof-row" onclick="openSub('subPersonal')"><span class="prof-row-label">Naam & avatar</span><span class="prof-row-value"><span id="prNameVal"></span><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></span></div>
                
            </div>


            <div class="prof-group-title" style="margin-top:var(--space-lg)">GRIP Premium</div>
            <div class="card" style="padding:0 var(--space-lg)">
                <div class="prof-row" id="premStatusRow">
                    <span class="prof-row-label" id="premStatusLabel">Gratis versie</span>
                    <span class="prof-row-value"><div class="toggle-track" id="premiumToggle" onclick="premToggle()"><div class="toggle-thumb"></div></div></span>
                </div>
                <div class="field-helper" style="padding:0 0 var(--space-md)" id="premStatusHelper">Schakel Premium in om alle functies te testen.</div>
                <div class="prof-row" onclick="premShowPaywall('profile')" id="premViewPaywallRow"><span class="prof-row-label" style="color:var(--accent)">Bekijk Premium</span><span class="prof-row-value"><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></span></div>
            </div>

            <div class="prof-group-title" style="margin-top:var(--space-lg);opacity:0.4;font-size:0.6rem">Ontwikkelaar</div>
            <div class="card" style="padding:0 var(--space-lg)">
                <div class="prof-row" onclick="premShowEventLog()"><span class="prof-row-label">Event log bekijken</span><span class="prof-row-value"><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></span></div>
            </div>

            <div class="prof-group-title">Veiligheid</div>
            <div class="card" style="padding:0 var(--space-lg)">
                <div class="prof-row" onclick="openSub('subSecurity')"><span class="prof-row-label">PIN wijzigen</span><span class="prof-row-value"><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></span></div>
                <div class="prof-row"><span class="prof-row-label">Biometrie</span><span class="prof-row-value"><div class="toggle-track" id="biometrieToggle" onclick="toggleBiometrie()"><div class="toggle-thumb"></div></div></span></div>
                <div class="field-helper" style="padding:0 0 var(--space-md)">Ontgrendel GRIP met je vingerafdruk of gezichtsherkenning. Werkt alleen als je apparaat dit ondersteunt. Je PIN blijft altijd als backup beschikbaar.</div>
            </div>
        </div>

        <!-- ═══ DATA & PRIVACY VIEW ═══ -->
        <div id="dataviewView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title">Data & privacy</div>
            </div>

            <div class="card" style="padding:0 var(--space-lg)">
                <div class="prof-row" onclick="downloadBackup()"><span class="prof-row-label">Backup downloaden <span class="prem-badge-sm" style="margin-left:6px">PREMIUM</span></span><span class="prof-row-value"><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></span></div>
                <div class="prof-row" onclick="openSub('subPrivacy')"><span class="prof-row-label">Hoe bewaart GRIP mijn data?</span><span class="prof-row-value"><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></span></div>
                <div class="prof-row danger" onclick="openSub('subData')"><span class="prof-row-label">Data wissen</span><span class="prof-row-value"><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></span></div>
            </div>

            <div class="prof-footer">GRIP v3.0</div>
        </div>

        <!-- Sub-panels (slide over) -->
        <div class="sub-panel" id="subIncome">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subIncome')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Inkomen & uitbetalingdag</span></div>

            <div style="background:var(--glass);padding:var(--space-md);border-radius:var(--radius-md);margin-bottom:var(--space-lg)">
                <div class="field-helper" style="margin:0;line-height:1.5">
                    Je <strong>standaard inkomen</strong> geldt voor elke uitbetalingsperiode. Krijg je in een bepaalde maand meer of minder? Gebruik <strong>Per-periode afwijkingen</strong> hieronder. Die gelden alleen voor die ene periode. Andere maanden blijven ongewijzigd.
                </div>
            </div>

            <div class="field-group"><div class="field-label">Standaard netto inkomen per maand</div><input type="text" class="grip-input" id="subIncomeVal" inputmode="decimal"><div class="field-helper">Dit bedrag wordt gebruikt voor elke periode tenzij je hieronder een afwijking instelt.</div></div>
            <div class="field-group"><div class="field-label">Standaard uitbetalingsdag</div><input type="number" class="grip-input" id="subSalaryDay" min="1" max="31" inputmode="numeric"><div class="field-helper">Op welke dag ontvang je meestal je uitbetaling? Valt dit op een dag die niet bestaat (bijv. 31 februari), dan gebruikt GRIP de laatste dag van die maand.</div></div>

            <div class="field-group">
                <button class="collapse-toggle" onclick="toggleIncomeOverrides(this)" id="incomeOverrideToggle" aria-expanded="false" aria-controls="incomeOverrideContent" style="margin-top:var(--space-sm)">
                    Per-periode inkomen afwijkingen
                    <svg class="arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="collapse-content" id="incomeOverrideContent">
                    <div class="collapse-inner" style="padding:var(--space-md) 0">
                        <div class="field-helper" style="margin-bottom:var(--space-md)">Is je inkomen in een bepaalde maand anders? Bijv. vakantiegeld, bonus, minder uren. Dit geldt <strong>alleen</strong> voor de gekozen periode.</div>
                        <div id="incomeOverrideGrid"></div>
                    </div>
                </div>
            </div>

            <div class="field-group">
                <button class="collapse-toggle" onclick="toggleSalaryOverrides(this)" id="salaryOverrideToggle" aria-expanded="false" aria-controls="salaryOverrideContent" style="margin-top:var(--space-sm)">
                    Afwijkende uitbetalingsdagen per maand
                    <svg class="arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="collapse-content" id="salaryOverrideContent">
                    <div class="collapse-inner" style="padding:var(--space-md) 0">
                        <div class="field-helper" style="margin-bottom:var(--space-md)">Krijg je in bepaalde maanden op een andere dag betaald? Vul hier alleen de afwijkingen in. Leeg = standaarddag.</div>
                        <div id="salaryOverrideGrid"></div>
                    </div>
                </div>
            </div>
            <button class="btn-save" onclick="saveSubIncome()">Opslaan</button>
        </div>

        <div class="sub-panel" id="subFixed">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subFixed')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Vaste lasten</span></div>

            <div style="background:var(--glass);padding:var(--space-md);border-radius:var(--radius-md);margin-bottom:var(--space-lg)">
                <div class="field-helper" style="margin:0;line-height:1.5">
                    <strong>Standaard vaste lasten</strong> gelden voor elke uitbetalingsperiode. Tik op een bedrag om het aan te passen. Heb je in een bepaalde maand andere vaste lasten? Gebruik dan <strong>Per-periode afwijkingen</strong> hieronder. Die gelden alleen voor die ene periode. Andere maanden blijven ongewijzigd.
                </div>
            </div>

            <div id="subFixedList"></div>
            <div style="margin-top:var(--space-lg)">
                <div class="field-group"><div class="field-label">Naam</div><input type="text" class="grip-input grip-input-sm" id="subFcName" placeholder="bijv. Huur"></div>
                <div class="field-group"><div class="field-label">Bedrag</div><input type="text" class="grip-input grip-input-sm" id="subFcAmount" inputmode="decimal" placeholder="0,00"></div>
                <div class="field-group"><div class="field-label">Categorie</div>
                    <select class="grip-input grip-input-sm" id="subFcCat">
                        <option value="huis">Wonen</option><option value="energie">Energie & water</option>
                        <option value="verzekeringen">Verzekeringen</option><option value="telefoon">Telefoon</option><option value="internet">Internet</option>
                        <option value="abonnementen">Abonnementen</option><option value="sport">Sport & bewegen</option>
                        <option value="leningen">Leningen & schulden</option><option value="gezin">Gezin & huishouden</option>
                        <option value="belastingen">Belastingen</option><option value="vervoer">Vervoer</option>
                        <option value="overig">Overig</option>
                        <option value="vliegtuig">Vliegtuig</option>
                    </select>
                </div>
                <button class="btn-save" onclick="addFixedCost()">Toevoegen</button>
            </div>

            <hr style="border:none;border-top:1px solid var(--glass-border);margin:var(--space-xl) 0">

            <div class="field-group">
                <button class="collapse-toggle" onclick="toggleFixedOverrides(this)" id="fixedOverrideToggle" aria-expanded="false" aria-controls="fixedOverrideContent">
                    Per-periode afwijkingen
                    <svg class="arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="collapse-content" id="fixedOverrideContent">
                    <div class="collapse-inner" style="padding:var(--space-md) 0">
                        <div class="field-helper" style="margin-bottom:var(--space-md)">Zijn je vaste lasten in een bepaalde maand anders? Kies de periode en voeg de afwijking toe. Dit overschrijft <strong>alleen</strong> het bedrag voor die ene periode.</div>
                        <div class="field-group">
                            <div class="field-label">Periode</div>
                            <select class="grip-input grip-input-sm" id="fcOverridePeriod"></select>
                        </div>
                        <div id="fcOverrideList"></div>
                        <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-sm)">
                            <input type="text" class="grip-input grip-input-sm" id="fcOverrideName" placeholder="Naam" style="flex:2">
                            <input type="text" class="grip-input grip-input-sm" id="fcOverrideAmount" inputmode="decimal" placeholder="Bedrag" style="flex:1">
                        </div>
                        <button class="btn-add" onclick="addFixedCostOverride()" style="width:100%;margin-top:var(--space-sm)">Afwijking toevoegen</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="sub-panel" id="subBudget">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subBudget')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Dagbudget</span></div>
            <div class="field-group"><div class="field-label">Dagbudget</div><input type="text" class="grip-input" id="subDailyBudget" inputmode="decimal"><div class="field-helper">Je dagelijkse limiet voor supermarkt, koffie, lunch en afhalen. Wat je niet uitgeeft, wordt automatisch als besparing geteld.</div></div>
            <button class="btn-save" onclick="saveSubBudget()">Opslaan</button>
        </div>

        <div class="sub-panel" id="subAutoSave">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subAutoSave')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Automatisch sparen</span></div>
            <div class="field-group">
                <div class="field-label">Vast spaarbedrag per maand</div>
                <input type="text" class="grip-input" id="subAutoSave2" inputmode="decimal">
                <div class="field-helper">Dit bedrag gaat elke uitbetalingsperiode automatisch opzij. Alsof het een vaste overboeking naar je spaarrekening is. GRIP trekt dit af van je besteedbaar inkomen.</div>
            </div>
            <div class="field-group" style="background:var(--glass);padding:var(--space-lg);border-radius:var(--radius-md)">
                <div class="field-label" style="margin-bottom:var(--space-sm)">Wanneer gaat deze wijziging in?</div>
                <div class="field-helper">Je nieuwe bedrag geldt <strong>vanaf de huidige uitbetalingsperiode</strong>. Eerdere periodes blijven ongewijzigd, zodat je historie klopt.</div>
            </div>
            <button class="btn-save" onclick="saveSubAutoSave()">Opslaan</button>
        </div>

        <div class="sub-panel" id="subGoal">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subGoal')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Spaardoel & saldo</span></div>
            <div class="field-group"><div class="field-label">Berekend spaargeld</div><div class="card-amount" style="font-size:1.3rem;text-align:left;margin:var(--space-xs) 0" id="subCurrentSavings"></div><div class="field-helper">Dit is wat GRIP berekent op basis van je auto-sparen, dagelijkse besparingen en vrij budget.</div></div>
            <div class="field-group" style="background:var(--glass);padding:var(--space-lg);border-radius:var(--radius-md)">
                <div class="field-label">Spaarsaldo corrigeren</div>
                <input type="text" class="grip-input" id="subSavingsCorrection" inputmode="decimal" placeholder="Nieuw saldo">
                <div class="field-helper">Klopt je spaarsaldo niet meer? Vul hier je werkelijke spaargeld in. GRIP past het startsaldo aan zodat de berekening weer klopt. Gebruik dit als je geld hebt opgenomen of bijgestort buiten GRIP om.</div>
                <button class="btn-add" onclick="applySavingsCorrection()" style="width:100%;margin-top:var(--space-sm)">Saldo corrigeren</button>
            </div>
            <hr style="border:none;border-top:1px solid var(--glass-border);margin:var(--space-lg) 0">
            <div class="field-group">
                <div class="field-label">Startsaldo (geavanceerd)</div>
                <input type="text" class="grip-input" id="subStartSavings" inputmode="decimal">
                <div class="field-helper">Het onderliggende basisbedrag. Wordt automatisch aangepast als je bovenstaande correctie gebruikt.</div>
            </div>
            <div class="field-group">
                <div class="field-label">Spaardoel</div>
                <input type="text" class="grip-input" id="subSavingsGoal" inputmode="decimal">
                <div class="field-helper">Laat leeg als je geen specifiek doel hebt. GRIP berekent op basis van je spaargedrag wanneer je dit bedrag bereikt.</div>
            </div>
            <button class="btn-save" onclick="saveSubGoal()">Opslaan</button>
        </div>

        <div class="sub-panel" id="subPersonal">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subPersonal')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Persoonlijk</span></div>
            <div class="field-group"><div class="field-label">Naam</div><input type="text" class="grip-input" id="subUserName"></div>
            <div class="field-group"><div class="field-label">Avatar</div><div class="avatar-grid" id="subAvatarGrid"></div></div>
            
            <button class="btn-save" onclick="saveSubPersonal()">Opslaan</button>
        </div>

        <div class="sub-panel" id="subSecurity">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subSecurity')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Veiligheid</span></div>
            <div id="securityContent"></div>
        </div>

        <div class="sub-panel" id="subData">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subData')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Data wissen</span></div>
            <div class="field-helper" style="padding:var(--space-lg) 0">Dit verwijdert al je gegevens permanent. Dit kan niet ongedaan worden gemaakt.</div>
            <div class="field-group"><div class="field-label">Typ GRIP om te bevestigen</div><input type="text" class="grip-input" id="confirmWipe" placeholder="GRIP" oninput="checkWipeConfirm()"></div>
            <button class="btn-danger" id="btnWipe" disabled onclick="wipeData()">Data wissen</button>
        </div>

        <div class="sub-panel" id="subPrivacy">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subPrivacy')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Hoe bewaart GRIP mijn data?</span></div>
            <div class="collapse-inner">
                <p><strong>Alles blijft op je apparaat.</strong></p>
                <p>GRIP slaat al je gegevens lokaal op in je browser (localStorage). Er worden geen gegevens naar een server gestuurd.</p>
                <p>Dit betekent dat je data privé is, maar ook dat je verantwoordelijk bent voor het maken van backups. Als je je browsergegevens wist of een ander apparaat gebruikt, heb je geen toegang tot je data.</p>
                <p><strong>Tip:</strong> maak regelmatig een backup via Profiel → Backup downloaden.</p>
                <p>GRIP verzamelt geen analytics, plaatst geen cookies en deelt geen informatie met derden.</p>
            </div>
        </div>

        <!-- Tab bar -->
        <nav class="tab-bar" role="tablist">
            <div class="tab-item active" onclick="showView('home')" data-tab="home" role="tab">
                <div class="tab-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
                <div class="tab-label">Vandaag</div>
            </div>
            <div class="tab-item" onclick="showView('overzicht')" data-tab="overzicht" role="tab">
                <div class="tab-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg></div>
                <div class="tab-label">Overzicht</div>
            </div>
            <div class="tab-item" onclick="showView('sparen')" data-tab="sparen" role="tab">
                <div class="tab-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-0.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2"/></svg></div>
                <div class="tab-label">Sparen</div>
            </div>
            <div class="tab-item" onclick="showView('vrijbudget')" data-tab="vrijbudget" role="tab">
                <div class="tab-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4h-4z"/></svg></div>
                <div class="tab-label">Budget</div>
            </div>
            <div class="tab-item" onclick="showView('menu')" data-tab="menu" role="tab">
                <div class="tab-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></div>
                <div class="tab-label">Meer</div>
            </div>
        </nav>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
    // ═══════════════════════════════════════════════════════════════
    // i18n — TRANSLATION SYSTEM
    // ═══════════════════════════════════════════════════════════════
    // Language: Dutch only
    // LANGS removed — Dutch only
    
    const T = {
        morning:'Goedemorgen',
        afternoon:'Goedemiddag',
        evening:'Goedenavond',
        night:'Goedenacht',
        today:'Vandaag',
        menu:'Menu',
        back:'Terug',
        save:'Opslaan',
        cancel:'Annuleren',
        add:'Toevoegen',
        delete:'Verwijderen',
        edit:'Bewerken',
        next:'Volgende',
        overview:'Overzicht',
        overviewSub:'Grafieken, kalender, cijfers',
        freeBudget:'Vrij budget',
        freeBudgetSub:'Uitgaven vrij besteedbaar',
        savings:'Spaarrace',
        savingsSub:'Doel, prognose, voortgang',
        incomeAndSalary:'Inkomen & uitbetaling',
        incomeAndSalarySub:'Netto inkomen, uitbetalingsdag',
        fixedCosts:'Vaste lasten',
        fixedCostsSub:'Huur, energie, verzekeringen',
        budgetAndSaving:'Dagbudget & sparen',
        budgetAndSavingSub:'Dagbudget, auto-sparen, doel',
        profile:'Profiel',
        profileSub:'Naam, avatar, thema',
        dataPrivacy:'Data & privacy',
        dataPrivacySub:'Backup, data wissen',
        income:'Inkomen',
        expenses:'Uitgaven',
        spent:'uitgegeven',
        remaining:'over',
        perMonth:'per maand',
        perDay:'per dag',
        period:'Periode',
        currentPeriod:'Huidige periode',
        dailyBudget:'Dagbudget',
        autoSave:'Automatisch sparen',
        savingsGoal:'Spaardoel',
        savingsBalance:'Spaargeld',
        freeToSpend:'Vrij besteedbaar',
        avgPerDay:'Gem. per dag',
        noData:'Nog geen data.',
        noExpenses:'Nog geen uitgaven.',
        total:'Totaal',
        saved:'bespaard',
        over:'over budget',
        adjusted:'Aangepast.',
        removed:'Verwijderd.',
        added:'Toegevoegd.',
        chooseLang:'Kies je taal',
        welcomeTitle:'Welkom bij GRIP',
        welcomeSub:'Grip op je geld. Zonder gedoe.',
        yourName:'Hoe heet je?',
        namePlaceholder:'Jouw naam',
        choosePIN:'Kies een PIN',
        pinSub:'4 cijfers om je gegevens te beschermen.',
        pinChoose:'Kies je PIN',
        pinConfirm:'Bevestig je PIN',
        pinMismatch:'De PINs komen niet overeen. Probeer opnieuw.',
        whenStart:'Wanneer gaat GRIP in?',
        startDate:'Startdatum',
        startDateHelper:'Standaard: vandaag.',
        whenPaid:'Wanneer krijg je betaald?',
        salaryDaySub:'GRIP rekent in uitbetalingsperiodes.',
        fixedDay:'Vaste dag',
        perMonthDay:'Per maand',
        salaryDay:'Salarisdag',
        financialBase:'Je financiële basis',
        financialBaseSub:'Dit bepaalt hoeveel je per dag te besteden hebt.',
        netIncome:'Netto inkomen per maand',
        fixedCostsTitle:'Vaste lasten',
        fixedCostsSub2:'Hoeveel gaat er maandelijks af?',
        totalAmount:'Totaalbedrag',
        perCategory:'Per categorie',
        savingsTitle:'Sparen',
        savingsSub2:'Zelfs een klein bedrag per maand maakt verschil. Hoeveel wil jij opzij zetten?',
        autoSavePerMonth:'Elke maand automatisch opzij',
        currentSavings:'Huidig spaargeld',
        howMuchSaved:'Hoeveel heb je al gespaard?',
        savingsGoalOpt:'Spaardoel (optioneel)',
        ahaTitle:'Dit is wat GRIP voor je uitrekent',
        maxGrowth:'Maximale groei per maand',
        readyToStart:'Klaar om te beginnen?',
        startGrip:'Start GRIP',
        enterAmount:'Vul een bedrag in.',
        enterName:'Vul je naam in om door te gaan.',
        enterIncome:'Vul je inkomen in.',
        catHuis:'Wonen',
        catEnergie:'Energie & water',
        catVerzekeringen:'Verzekeringen',
        catTelefoon:'Telefoon & internet',
        catAbonnementen:'Abonnementen',
        catSport:'Sport & bewegen',
        catLeningen:'Leningen & schulden',
        catGezin:'Gezin & huishouden',
        catBelastingen:'Belastingen',
        catVervoer:'Vervoer',
        catOverig:'Overig',
        catKleding:'Kleding',
        catElektronica:'Elektronica',
        catHoreca:'Uit eten/drinken',
        catCadeaus:'Cadeaus',
        catGezondheid:'Gezondheid',
        catHobby:'Hobby',
        catVakantie:'Vakantie',
        catHuishouden:'Huishouden',
        catAuto:'Auto/vervoer',
        catOverigVrij:'Overig',
        dailySpending:'Dagelijks uitgegeven',
        distribution:'Verdeling deze periode',
        numbers:'Cijfers',
        calendar:'Kalender',
        dailySaved:'Dagelijks bespaard',
        freeSpent:'Vrij budget uitgegeven',
        freeRemaining:'Vrij budget over',
        actual:'Actueel',
        adjustBalance:'Spaarsaldo aanpassen',
        actualBalance:'Werkelijk saldo',
        correct:'Corrigeren',
        thisPeriod:'Deze periode',
        netMonthlyIncome:'Netto maandinkomen',
        differentIncome:'Afwijkend inkomen',
        differentIncomeSub:'Vakantiegeld, bonus, of minder uren?',
        defaultSalaryDay:'Standaard uitbetalingsdag',
        differentDaysPerMonth:'Andere dag per maand?',
        dailyLimit:'Limiet per dag',
        dailyBudgetHelper:'Supermarkt, koffie, lunch. Wat je niet uitgeeft → besparing.',
        fixedSavingPerMonth:'Vast spaarbedrag per maand',
        startBalance:'Startsaldo',
        startBalanceHelper:'Hoeveel spaargeld had je toen je GRIP begon?',
        goal:'Doel',
        description:'Omschrijving',
        amount:'Bedrag',
        optional:'optioneel',
        viewFor:'Bekijk voor:',
        deviation:'afwijkend',
        undo:'Ongedaan maken',
        savingsRace:'Spaarrace',
        savingsRaceSub:'Doel, prognose, voortgang',
        myBalance:'Huidig spaarsaldo',
        balanceNow:'Saldo nu',
        goalReached:'🎉 Doel bereikt!',
        goalReachedSub:'Gefeliciteerd! Je hebt je spaardoel behaald.',
        setNewGoal:'Nieuw doel instellen',
        keepGoing:'Of blijf gewoon sparen — GRIP houdt bij hoe je saldo groeit.',
        correctBalanceTitle:'Saldo corrigeren',
        correctBalanceExplain:'Klopt je spaarsaldo niet meer? Dat kan gebeuren bij onvoorziene uitgaven (reparatie, boete, medische kosten) of juist een meevaller (bonus, belastingteruggave, cadeau). Vul je werkelijke saldo in en GRIP past alles automatisch aan.',
        salaryPerMonthExplain:'Niet elke maand dezelfde dag? Vul hieronder per maand de uitbetalingsdag in. Na de onboarding kun je dit aanpassen via Premium.',
        incomeVariesHint:'Verschilt je inkomen per maand (vakantiegeld, bonus)? Dat kun je later aanpassen via het menu → Inkomen & uitbetaling.',
        fixedCostsAdjustHint:'Later kun je dit per categorie specificeren in het menu → Vaste lasten. Daar kun je ook categorieën toevoegen, hernoemen of verwijderen.',
        estimated:'Geschat',
        milestones:'Mijlpalen',
        howGripCalc:'Hoe berekent GRIP dit?',
        highConf:'Hoge betrouwbaarheid',
        medConf:'Gemiddelde betrouwbaarheid',
        lowConf:'Nog weinig data',
        nothingSpent:'geen uitgaven',
        otherAmount:'anders',
        addExpense:'Toevoegen',
        noteOptional:'Notitie (optioneel)',
        enterAmountHint:'Vul een bedrag in.',
        dailyExpenses:'Dagelijkse uitgaven invoeren',
        perMonthAvg:'per maand gemiddeld',
        noGoalSet:'Stel een spaardoel in om je voortgang te volgen.',
        setGoal:'Spaardoel instellen',
        spendingOverBudget:'Je geeft momenteel meer uit dan je spaart.',
        months:['Januari','Februari','Maart','April','Mei','Juni','Juli','Augustus','September','Oktober','November','December'],
        monthsShort:['jan','feb','mrt','apr','mei','jun','jul','aug','sep','okt','nov','dec'],
        days:['zo','ma','di','wo','do','vr','za'],
    };
    function t(key) {
        return T[key] || key;
    }
    function tMonth(i) { return T.months[i] || ''; }
    function tMonthShort(i) { return T.monthsShort[i] || ''; }
    function tDay(i) { return T.days[i] || ''; }
    function getCatLabel(cat) {
        if (appData.customCatLabels?.[cat]) return appData.customCatLabels[cat];
        return CAT_LABELS[cat] || cat;
    }
    /* ═══════════════════════════════════════════════════════════════
       GRIP v1 — Slice A
       Business logic preserved from Budget Tracker v16+
       New UI layer: 4-tab structure per GRIP blauwdruk
       ═══════════════════════════════════════════════════════════════ */

    // ─── CONSTANTS ───
    // No emoji avatars — using initials + photo upload

    const FIXED_COST_SUGGESTIONS = [
        { name:'Huur/Hypotheek', cat:'huis' },
        { name:'Servicekosten', cat:'huis' },
        { name:'Energie', cat:'energie' },
        { name:'Water', cat:'water' },
        { name:'Zorgverzekering', cat:'verzekeringen' },
        { name:'Aanvullende verzekering', cat:'verzekeringen' },
        { name:'Inboedelverzekering', cat:'verzekeringen' },
        { name:'Autoverzekering', cat:'verzekeringen' },
        { name:'Reisverzekering', cat:'verzekeringen' },
        { name:'Telefoon', cat:'telefoon' },
        { name:'Internet', cat:'internet' },
        { name:'Spotify', cat:'abonnementen' },
        { name:'Netflix', cat:'abonnementen' },
        { name:'Disney+', cat:'abonnementen' },
        { name:'YouTube Premium', cat:'abonnementen' },
        { name:'iCloud / Google One', cat:'abonnementen' },
        { name:'Krant / Nieuwsapp', cat:'abonnementen' },
        { name:'Sportschool', cat:'sport' },
        { name:'Sportvereniging', cat:'sport' },
        { name:'Studiefinanciering', cat:'leningen' },
        { name:'Persoonlijke lening', cat:'leningen' },
        { name:'Creditcard', cat:'leningen' },
        { name:'Alimentatie', cat:'gezin' },
        { name:'Kinderopvang', cat:'gezin' },
        { name:'Schoolkosten', cat:'gezin' },
        { name:'Gezamenlijke rekening', cat:'gezin' },
        { name:'Gemeentebelasting', cat:'belastingen' },
        { name:'Waterschapsbelasting', cat:'belastingen' },
        { name:'OV-abonnement', cat:'vervoer' },
        { name:'Auto (lease/afbetaling)', cat:'vervoer' },
        { name:'Motorrijtuigenbelasting', cat:'vervoer' },
        { name:'Parkeervergunning', cat:'vervoer' },
        { name:'Overig', cat:'overig' }
    ];

    const CAT_LABELS = {
        huis: 'Wonen',
        energie: 'Energie',
        water: 'Water',
        verzekeringen: 'Verzekeringen',
        telefoon: 'Telefoon',
        internet: 'Internet',
        abonnementen: 'Abonnementen',
        sport: 'Sport & bewegen',
        leningen: 'Leningen & schulden',
        gezin: 'Gezin & huishouden',
        belastingen: 'Belastingen',
        vervoer: 'Vervoer',
        verzorging: 'Verzorging',
        vliegtuig: 'Reizen',
        overig: 'Overig'
    };

    const MONTH_NAMES_NL = ['Januari','Februari','Maart','April','Mei','Juni','Juli','Augustus','September','Oktober','November','December'];
    const MONTH_KEYS_SHORT = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];

    // ─── APP DATA ───
    let appData = {
        setupComplete: false,
        appStartDate: '',
        userName: '',
        pin: '',
        avatar: '',
        avatarPhoto: '',
        theme: 'dark',
        accentIndex: 0,
        selectedQuoteIds: [],
        defaultSalaryDay: 24,
        salaryDates: {},
        monthlyIncome: 0,
        incomePerMonth: false,
        incomeByMonth: {},
        dailyGroceryBudget: 3500,
        autoSaveCents: 0,
        startSavingsCents: 0,
        savingsGoalCents: 0,
        savingsCorrections: [],
        customCatLabels: {},
        income: {},
        fixedCosts: {
            huis: [], energie: [], water: [], verzekeringen: [],
            telefoon: [], internet: [], abonnementen: [],
            sport: [], leningen: [],
            gezin: [], belastingen: [], vervoer: [],
            verzorging: [], vliegtuig: [], overig: []
        },
        groceries: {},
        spending: {},
        fixedCostOverrides: {},
        freeBudgetOverride: {},
        currentMonth: null,
        lastActiveMonthKey: null,
        biometrie: false,
        isPremium: false,
        fixedCostsMeta: {},
        priceStyle: '',
        personaArchetype: '',
        personaScores: {},
        dailyBudgetSuggestedCents: 0,
        dailyBudgetUserCents: 0,
        dailyBudgetConfidenceTag: '',
        personaQ4: '',
        personaQ5: '',
        extraGoals: []
    };

    let salaryPeriods = [];
    let currentViewName = 'home';
    let undoAction = null;
    let undoTimer = null;

    // ─── CENTS HELPERS ───
    function toCents(euros) {
        // Handle NL comma input: "27,50" → "27.50"
        const cleaned = String(euros).replace(',', '.');
        const num = Number(cleaned);
        if (isNaN(num)) return 0;
        return Math.round(num * 100);
    }
    function fromCents(cents) { return (Math.round(Number(cents) || 0)) / 100; }

    // Parse number from input, handling both comma and dot as decimal separator
    function parseNum(val) {
        if (val === null || val === undefined) return NaN;
        const str = String(val).trim().replace(/[€\s]/g, '').replace(',', '.');
        return parseFloat(str);
    }

    function formatEuro(cents) {
        const rounded = Math.round(Number(cents) || 0);
        const abs = Math.abs(rounded);
        const sign = rounded < 0 ? '-' : '';
        const euros = Math.floor(abs / 100);
        const cts = String(abs % 100).padStart(2, '0');
        const formatted = euros.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        return sign + '€' + formatted + ',' + cts;
    }

    // ─── DATE HELPERS ───
    function startOfDay(date) { return new Date(date.getFullYear(), date.getMonth(), date.getDate()); }
    function getNLDate() { return new Date(); }
    function formatDate(date) {
        return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    }
    function parseLocalDate(dateStr) {
        const [y, m, d] = String(dateStr).split('-').map(Number);
        return new Date(y, (m||1)-1, d||1);
    }
    function formatDateNL(date) {
        const months = ['jan','feb','mrt','apr','mei','jun','jul','aug','sep','okt','nov','dec'];
        return `${date.getDate()} ${months[date.getMonth()]}`;
    }
    function formatDateNLFull(date) {
        const days = ['zo','ma','di','wo','do','vr','za'];
        const months = ['jan','feb','mrt','apr','mei','jun','jul','aug','sep','okt','nov','dec'];
        return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
    }
    function genId(prefix) { return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`; }
    function getTimeStr(isoString) {
        if (!isoString) return '';
        const d = new Date(isoString);
        const day = d.getDate();
        const months = ['jan','feb','mrt','apr','mei','jun','jul','aug','sep','okt','nov','dec'];
        return day + ' ' + months[d.getMonth()];
    }

    // ─── THEME ───
    function applyTheme() {
        document.documentElement.setAttribute('data-theme', appData.theme);
    }

    // ─── DYNAMIC SALARY PERIODS ───
    function generateSalaryPeriods() {
        salaryPeriods = [];
        const today = startOfDay(getNLDate());
        const appStart = appData.appStartDate ? startOfDay(parseLocalDate(appData.appStartDate)) : today;
        const effectiveStart = appStart <= today ? appStart : today;
        const defaultDay = appData.defaultSalaryDay || 24;

        function getSalaryDayForMonth(year, month) {
            const key = `${year}-${String(month+1).padStart(2,'0')}`;
            let day = defaultDay;
            if (appData.salaryDates && appData.salaryDates[key]) day = appData.salaryDates[key];
            // Check per-month overrides (new system)
            if (appData.salaryDayOverrides && appData.salaryDayOverrides[String(month)]) day = appData.salaryDayOverrides[String(month)];
            const lastDay = new Date(year, month + 1, 0).getDate();
            return Math.min(day, lastDay);
        }

        let searchDate = new Date(effectiveStart.getFullYear(), effectiveStart.getMonth(), 1);
        let salDay = getSalaryDayForMonth(searchDate.getFullYear(), searchDate.getMonth());
        let salDate = new Date(searchDate.getFullYear(), searchDate.getMonth(), salDay);
        let foundSalary = null;

        if (salDate <= effectiveStart) {
            foundSalary = salDate;
        } else {
            searchDate.setMonth(searchDate.getMonth() - 1);
            salDay = getSalaryDayForMonth(searchDate.getFullYear(), searchDate.getMonth());
            salDate = new Date(searchDate.getFullYear(), searchDate.getMonth(), salDay);
            if (salDate <= effectiveStart) foundSalary = salDate;
        }

        if (!foundSalary) {
            searchDate = new Date(effectiveStart.getFullYear(), effectiveStart.getMonth(), 1);
            salDay = getSalaryDayForMonth(searchDate.getFullYear(), searchDate.getMonth());
            foundSalary = new Date(searchDate.getFullYear(), searchDate.getMonth(), salDay);
        }

        let nextMonth = new Date(foundSalary.getFullYear(), foundSalary.getMonth() + 1, 1);
        let nextSalDay = getSalaryDayForMonth(nextMonth.getFullYear(), nextMonth.getMonth());
        let nextSalDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), nextSalDay);

        if (effectiveStart > foundSalary && effectiveStart < nextSalDate) {
            const endDate = new Date(nextSalDate);
            endDate.setDate(endDate.getDate() - 1);
            const key = MONTH_KEYS_SHORT[foundSalary.getMonth()] + foundSalary.getFullYear();
            salaryPeriods.push({
                key, name: MONTH_NAMES_NL[foundSalary.getMonth()] + ' ' + foundSalary.getFullYear(),
                startDate: new Date(effectiveStart), endDate, salaryDate: null
            });
            foundSalary = nextSalDate;
        }

        let currentSalary = new Date(foundSalary);
        for (let i = 0; i < 14; i++) {
            const periodStart = new Date(currentSalary);
            nextMonth = new Date(currentSalary.getFullYear(), currentSalary.getMonth() + 1, 1);
            nextSalDay = getSalaryDayForMonth(nextMonth.getFullYear(), nextMonth.getMonth());
            nextSalDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), nextSalDay);
            const periodEnd = new Date(nextSalDate);
            periodEnd.setDate(periodEnd.getDate() - 1);

            const key = MONTH_KEYS_SHORT[periodStart.getMonth()] + periodStart.getFullYear();
            const name = MONTH_NAMES_NL[periodStart.getMonth()] + ' ' + periodStart.getFullYear();

            if (!salaryPeriods.find(p => p.key === key)) {
                salaryPeriods.push({ key, name, startDate: periodStart, endDate: periodEnd, salaryDate: periodStart });
            }
            currentSalary = nextSalDate;
        }
    }

    function getMonthKeyForDate(date) {
        const d = startOfDay(date);
        for (const period of salaryPeriods) {
            if (d >= startOfDay(period.startDate) && d <= startOfDay(period.endDate)) return period.key;
        }
        return salaryPeriods[0]?.key || 'unknown';
    }

    function getActiveMonthKey() { return getMonthKeyForDate(getNLDate()); }

    function getPeriodInfo(monthKey) {
        const found = salaryPeriods.find(p => p.key === monthKey) || salaryPeriods[0];
        if (!found) {
            // Fallback: generate a synthetic period so app never crashes
            const today = getNLDate();
            return { key: monthKey || 'fallback', name: 'Periode', startDate: today, endDate: today, salaryDate: null };
        }
        return found;
    }

    function ensureActiveMonthSynced() {
        const active = getActiveMonthKey();
        if (!appData.lastActiveMonthKey) {
            appData.lastActiveMonthKey = active;
            if (!appData.currentMonth) appData.currentMonth = active;
        }
        if (appData.lastActiveMonthKey !== active) {
            appData.lastActiveMonthKey = active;
            appData.currentMonth = active;
            saveData();
        }
    }

    // ─── MONEY CALCULATIONS ───
    function ensureFixedCostsIds() {
        if (!appData.fixedCosts || typeof appData.fixedCosts !== 'object') {
            appData.fixedCosts = {};
        }
        Object.keys(CAT_LABELS).forEach(cat => {
            if (!Array.isArray(appData.fixedCosts[cat])) appData.fixedCosts[cat] = [];
            appData.fixedCosts[cat].forEach(item => {
                if (!item.id) item.id = genId('fix');
                if (item.amountCents === undefined && item.amount !== undefined) { item.amountCents = toCents(item.amount); delete item.amount; }
            });
        });
    }

    function ensureIncomeForMonth(monthKey) {
        if (!appData.income || typeof appData.income !== 'object') appData.income = {};
        if (!Array.isArray(appData.income[monthKey])) {
            let incomeCents = appData.monthlyIncome || 0;
            // Per-period income override
            if (appData.incomeByMonth && appData.incomeByMonth[monthKey] !== undefined) {
                incomeCents = appData.incomeByMonth[monthKey];
            }
            appData.income[monthKey] = incomeCents > 0
                ? [{ id: genId('inc'), name: 'Salaris', amountCents: incomeCents, createdAt: new Date().toISOString() }]
                : [];
            saveData();
        }
        appData.income[monthKey].forEach(item => {
            if (!item.id) item.id = genId('inc');
            if (item.amountCents === undefined && item.amount !== undefined) { item.amountCents = toCents(item.amount); delete item.amount; }
        });
    }

    function calculateFixedCostsTotalCents(monthKey) {
        ensureFixedCostsIds();
        let total = 0;
        const overrides = (monthKey && appData.fixedCostOverrides?.[monthKey]) || [];
        Object.keys(appData.fixedCosts || {}).forEach(cat => {
            (appData.fixedCosts[cat] || []).forEach(it => {
                const override = overrides.find(o => o.id === it.id);
                total += override ? (Number(override.amountCents) || 0) : (Number(it.amountCents) || 0);
            });
        });
        return Math.round(total);
    }

    function calculateIncomeTotalCents(monthKey) {
        ensureIncomeForMonth(monthKey);
        return Math.round((appData.income[monthKey] || []).reduce((s, it) => s + (Number(it.amountCents) || 0), 0));
    }

    function getAutoSaveForMonthCents(monthKey) {
        return appData.autoSaveCents || 0;
    }

    function getFreeBudgetCents(monthKey) {
        if (appData.freeBudgetOverride && appData.freeBudgetOverride[monthKey] !== undefined) {
            return appData.freeBudgetOverride[monthKey];
        }
        const p = getPeriodInfo(monthKey);
        if (!p) return 0;
        const incomeCents = calculateIncomeTotalCents(monthKey);
        const fixedCents = calculateFixedCostsTotalCents(monthKey);
        const daysInPeriod = Math.round((p.endDate - p.startDate) / (1000*60*60*24)) + 1;
        const groceryCapCents = (appData.dailyGroceryBudget || 3500) * daysInPeriod;
        const autoSaveCents = getAutoSaveForMonthCents(monthKey);
        return Math.round(incomeCents - fixedCents - groceryCapCents - autoSaveCents);
    }

    function calculateMonthGroceriesCents(monthKey) {
        const monthGroceries = appData.groceries[monthKey] || {};
        let totalCents = 0;
        Object.values(monthGroceries).forEach(dayEntries => {
            if (Array.isArray(dayEntries)) dayEntries.forEach(e => { totalCents += Number(e.amountCents) || 0; });
        });
        return Math.round(totalCents);
    }

    function calculateMonthGrocerySavingsCents(monthKey) {
        const monthGroceries = appData.groceries[monthKey] || {};
        let savingsCents = 0;
        const budget = appData.dailyGroceryBudget || 3500;
        Object.keys(monthGroceries).forEach(dateStr => {
            const dayEntries = monthGroceries[dateStr];
            if (Array.isArray(dayEntries) && dayEntries.length > 0) {
                const dayTotal = dayEntries.reduce((s, e) => s + (Number(e.amountCents) || 0), 0);
                savingsCents += budget - Math.round(dayTotal);
            }
        });
        return Math.round(savingsCents);
    }

    function calculateMonthSpendingCents(monthKey) {
        return Math.round((appData.spending[monthKey] || []).reduce((s, e) => s + (Number(e.amountCents) || 0), 0));
    }

    function calculateRealtimeSavingsCents() {
        const today = startOfDay(getNLDate());
        let totalCents = appData.startSavingsCents || 0;
        for (const period of salaryPeriods) {
            const periodStart = startOfDay(period.startDate);
            if (periodStart > today) break;
            totalCents += (appData.autoSaveCents || 0);
            totalCents += calculateMonthGrocerySavingsCents(period.key);
            const spentCents = calculateMonthSpendingCents(period.key);
            totalCents += (getFreeBudgetCents(period.key) - spentCents);
        }
        return Math.round(totalCents);
    }

    function calculateSavingsAtPeriodStartCents(monthKey) {
        const target = getPeriodInfo(monthKey);
        const targetStart = startOfDay(target.startDate);
        let totalCents = appData.startSavingsCents || 0;
        for (const period of salaryPeriods) {
            const pStart = startOfDay(period.startDate);
            if (pStart > targetStart) break;
            if (period.key === monthKey) {
                totalCents += (appData.autoSaveCents || 0);
                break;
            }
            totalCents += (appData.autoSaveCents || 0);
            totalCents += calculateMonthGrocerySavingsCents(period.key);
            totalCents += (getFreeBudgetCents(period.key) - calculateMonthSpendingCents(period.key));
        }
        return Math.round(totalCents);
    }

    // ─── SAVE/LOAD ───
    const STORAGE_KEY = 'grip_v12';
    function saveData() {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); } catch(e) { console.error('Save:', e); }
    }
    function loadData() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed && typeof parsed === 'object') {
                    appData = { ...appData, ...parsed };
                    ensureFixedCostsIds();
                }
            }
            // Migration: try old key
            if (!appData.setupComplete) {
                try {
                    const old = localStorage.getItem('budgetAppData_v18b');
                    if (old) {
                        const parsed = JSON.parse(old);
                        if (parsed && typeof parsed === 'object') {
                            appData = { ...appData, ...parsed };
                            ensureFixedCostsIds();
                            saveData();
                        }
                    }
                } catch(me) { console.warn('Migration failed:', me); }
            }
            // Restore language
            // Language: Dutch only
        } catch(e) {
            console.error('Load failed, resetting:', e);
            // Corrupt data: remove and start fresh
            try { localStorage.removeItem(STORAGE_KEY); } catch(x) {}
        }
    }

    // ─── TOAST ───
    let toastTimer = null;
    function showToast(message, undoCallback) {
        const el = document.getElementById('toast');
        if (!el) return;
        if (toastTimer) clearTimeout(toastTimer);

        if (undoCallback) {
            el.innerHTML = `${message} <span class="toast-undo" onclick="executeUndo()">Ongedaan maken</span>`;
            undoAction = undoCallback;
        } else {
            el.textContent = message;
            undoAction = null;
        }

        el.classList.add('show');
        toastTimer = setTimeout(() => {
            el.classList.remove('show');
            undoAction = null;
        }, 3500);
    }

    function executeUndo() {
        if (undoAction) {
            undoAction();
            undoAction = null;
        }
        const el = document.getElementById('toast');
        if (el) el.classList.remove('show');
        if (toastTimer) clearTimeout(toastTimer);
    }

    // ─── GREETING ───
    function getGreeting() {
        const name = appData.userName || '';
        const firstName = name.split(' ')[0] || '';
        return firstName ? 'Portaal van ' + firstName : 'Mijn portaal';
    }

    function getMotivation() {
        const savings = calculateRealtimeSavingsCents();
        const goal = appData.savingsGoalCents || 0;
        if (goal > 0 && savings >= goal) return 'Spaardoel bereikt! 🎉';
        if (goal > 0) {
            const pct = Math.round((savings / goal) * 100);
            if (pct >= 75) return 'Bijna bij je doel — blijf erbij!';
            if (pct >= 50) return 'Halverwege je spaardoel 💪';
            if (pct >= 25) return 'Goed op weg naar je doel';
        }
        const mk = getActiveMonthKey();
        const period = getPeriodInfo(mk);
        const today = startOfDay(getNLDate());
        const daysLeft = Math.max(0, Math.round((startOfDay(period.endDate) - today) / (1000*60*60*24)));
        if (daysLeft <= 3) return 'Bijna einde van de periode';
        return 'Weet wat je kunt sparen';
    }

    function getInitials(name) {
        if (!name) return '?';
        const parts = name.trim().split(/\s+/);
        if (parts.length >= 2) return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
        return name.substring(0, 2).toUpperCase();
    }

    function getInitialsHTML(name, fontSize) {
        const fs = fontSize || 16;
        return `<span style="font-size:${fs}px;font-weight:800;color:var(--accent);letter-spacing:1px">${getInitials(name)}</span>`;
    }

    // ═══════════════════════════════════════════════════════════════
    // VIEW SYSTEM
    // ═══════════════════════════════════════════════════════════════
    function showView(viewName) {
        const views = ['home','overzicht','sparen','vrijbudget','inkomen','dagsparen','vastelasten','profiel','dataview','menu'];
        views.forEach(v => {
            const el = document.getElementById(v + 'View');
            if (el) el.classList.toggle('hidden', v !== viewName);
        });
        currentViewName = viewName;

        // Update tab bar
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        const tabMap = { home: 0, overzicht: 1, sparen: 2, vrijbudget: 3, menu: 4 };
        const parentMap = { inkomen: 4, dagsparen: 4, vastelasten: 4, profiel: 4, dataview: 4 };
        const tabIdx = tabMap[viewName] !== undefined ? tabMap[viewName] : (parentMap[viewName] !== undefined ? parentMap[viewName] : -1);
        const tabs = document.querySelectorAll('.tab-item');
        if (tabIdx >= 0 && tabs[tabIdx]) tabs[tabIdx].classList.add('active');

        window.scrollTo({ top: 0, behavior: 'instant' });

        try {
            if (viewName === 'home') updateHome();
            else if (viewName === 'menu') updateMenu();
            else if (viewName === 'overzicht') updateOverzicht();
            else if (viewName === 'sparen') updateSparen();
            else if (viewName === 'vrijbudget') updateVrijBudget();
            else if (viewName === 'inkomen') updateInkomen();
            else if (viewName === 'dagsparen') updateDagSparen();
            else if (viewName === 'vastelasten') { updateVasteLasten(); updateVasteLastenView(); }
            else if (viewName === 'profiel') updateProfiel();
        } catch(e) { console.error('View error:', e); }
    }

    function updateAllViews() {
        ensureActiveMonthSynced();
        if (currentViewName === 'home') updateHome();
        else if (currentViewName === 'overzicht') updateOverzicht();
        else if (currentViewName === 'sparen') updateSparen();
    }

    // ═══════════════════════════════════════════════════════════════
    // HOME (GRIP Vandaag)
    // ═══════════════════════════════════════════════════════════════
    function updateHome() {
        try {
            const today = getNLDate();
            const todayStr = formatDate(today);
            const activeMK = getActiveMonthKey();
            const activePeriod = getPeriodInfo(activeMK);
            const budget = appData.dailyGroceryBudget || 3500;

            // Greeting
            document.getElementById('homeGreeting').textContent = getGreeting();

            // Show actual date
            const dateLabel = document.getElementById('homeDateLabel');
            if (dateLabel) {
                const days = ['zondag','maandag','dinsdag','woensdag','donderdag','vrijdag','zaterdag'];
                const months = ['januari','februari','maart','april','mei','juni','juli','augustus','september','oktober','november','december'];
                dateLabel.textContent = days[today.getDay()] + ' ' + today.getDate() + ' ' + months[today.getMonth()] + ' ' + today.getFullYear();
            }

            // i18n labels
            const s = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
            s('homeDailyTitle', t('dailyExpenses'));
            s('inlineAddBtn', t('addExpense'));
            s('inlineHint', t('enterAmountHint'));
            const noteEl = document.getElementById('inlineNote');
            if (noteEl) noteEl.placeholder = t('noteOptional');
            s('homeTodaySectionTitle', t('today'));

            // Avatar
            const avatarEl = document.getElementById('headerAvatar');
            if (avatarEl) {
                avatarEl.innerHTML = appData.avatarPhoto
                    ? `<img src="${appData.avatarPhoto}">`
                    : getInitialsHTML(appData.userName, 16);
            }

            // Today entries
            const todayMK = getMonthKeyForDate(today);
            const todayEntries = (appData.groceries[todayMK]?.[todayStr]) || [];
            const todayTotal = todayEntries.reduce((s, e) => s + (Number(e.amountCents) || 0), 0);
            const remaining = budget - todayTotal;
            const pctSpent = Math.min(100, Math.max(0, (todayTotal / budget) * 100));

            // Primary card
            const amountEl = document.getElementById('homeBudgetLeft');
            const barEl = document.getElementById('homeBudgetBar');
            const subEl = document.getElementById('homeBudgetSub');

            amountEl.textContent = formatEuro(remaining);
            amountEl.style.color = remaining >= 0 ? 'var(--green)' : 'var(--red)';

            barEl.style.width = pctSpent + '%';
            barEl.className = 'progress-fill' + (remaining < 0 ? ' caution' : '');

            if (remaining < 0) {
                subEl.textContent = `${formatEuro(Math.abs(remaining))} ${t('over')}`;
                subEl.style.color = 'var(--red)';
            } else {
                subEl.textContent = `${formatEuro(todayTotal)} / ${formatEuro(budget)} ${t('dailyBudget').toLowerCase()}`;
                subEl.style.color = '';
            }

            // Quick-add grid
            buildQuickAddGrid();

            // Today list
            renderTodayList(todayEntries, todayMK, todayStr);

            // Period status
            renderPeriodStatus(activeMK, activePeriod);

            // Savings
            renderSavingsCompact(activeMK);

        } catch(e) { console.error('Home error:', e); }

        // Premium home rendering
        try {
            premCheckTeaser();
            premRenderHome(getActiveMonthKey());
        } catch(e) { console.error('premHome:', e); }
    }

    function buildQuickAddGrid() {
        const grid = document.getElementById('quickAddGrid');
        if (!grid) return;
        const amounts = [10, 20, 35, 50];
        grid.innerHTML = amounts.map(v =>
            `<button class="quick-chip" onclick="quickAdd(${v})">€${v}</button>`
        ).join('') +
        `<button class="quick-chip edit-chip" onclick="toggleInlineInput()">✎ ${t('otherAmount')}</button>` +
        `<button class="quick-chip" onclick="markNoSpending()" style="border-color:var(--green);color:var(--green)">✓ ${t('nothingSpent')}</button>`;
    }

    function markNoSpending() {
        const today = getNLDate();
        const todayStr = formatDate(today);
        const mk = getMonthKeyForDate(today);
        if (!appData.groceries[mk]) appData.groceries[mk] = {};
        if (!appData.groceries[mk][todayStr]) appData.groceries[mk][todayStr] = [];
        // Only mark if no entries yet
        if (appData.groceries[mk][todayStr].length === 0) {
            appData.groceries[mk][todayStr].push({
                amountCents: 0,
                note: t('nothingSpent'),
                timestamp: new Date().toISOString()
            });
            saveData();
            showToast('Mooi! Je volledige dagbudget is bespaard.');
        } else {
            showToast('Er zijn al uitgaven geregistreerd voor vandaag.');
        }
        updateHome();
    }

    function quickAdd(euros) {
        const today = getNLDate();
        const todayStr = formatDate(today);
        const mk = getMonthKeyForDate(today);
        if (!appData.groceries[mk]) appData.groceries[mk] = {};
        if (!appData.groceries[mk][todayStr]) appData.groceries[mk][todayStr] = [];
        appData.groceries[mk][todayStr].push({
            amountCents: toCents(euros),
            note: '',
            timestamp: new Date().toISOString()
        });
        saveData();
        updateHome();
    }

    function toggleInlineInput() {
        const area = document.getElementById('inlineInputArea');
        const isOpen = area.classList.contains('open');
        if (isOpen) {
            area.classList.remove('open');
        } else {
            area.classList.add('open');
            setTimeout(() => {
                const input = document.getElementById('inlineAmount');
                if (input) {
                    input.focus({ preventScroll: true });
                    // Let iOS handle scroll naturally after keyboard opens
                    setTimeout(() => {
                        input.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 300);
                }
            }, 150);
        }
    }

    function addInlineExpense() {
        const amountEl = document.getElementById('inlineAmount');
        const noteEl = document.getElementById('inlineNote');
        const hintEl = document.getElementById('inlineHint');
        const amount = parseNum(amountEl?.value || 0);

        if (!amount || amount <= 0) {
            hintEl?.classList.add('visible');
            amountEl?.classList.add('caution');
            setTimeout(() => { hintEl?.classList.remove('visible'); amountEl?.classList.remove('caution'); }, 2000);
            return;
        }

        const today = getNLDate();
        const todayStr = formatDate(today);
        const mk = getMonthKeyForDate(today);
        if (!appData.groceries[mk]) appData.groceries[mk] = {};
        if (!appData.groceries[mk][todayStr]) appData.groceries[mk][todayStr] = [];
        appData.groceries[mk][todayStr].push({
            amountCents: toCents(amount),
            note: noteEl?.value?.trim() || '',
            timestamp: new Date().toISOString()
        });
        saveData();

        // Reset input
        amountEl.value = '';
        noteEl.value = '';
        document.getElementById('inlineInputArea').classList.remove('open');

        updateHome();
    }

    // Enter key support
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const area = document.getElementById('inlineInputArea');
            if (area?.classList.contains('open') && (document.activeElement?.id === 'inlineAmount' || document.activeElement?.id === 'inlineNote')) {
                addInlineExpense();
            }
            // Onboarding: Enter advances step on text/number inputs
            const obEl = document.getElementById('onboarding');
            if (obEl && !obEl.classList.contains('hidden') && document.activeElement?.classList.contains('grip-input')) {
                obNext();
            }
        }
    });

    let editingGroceryKey = null; // 'mk|dateStr|idx'

    function renderTodayList(entries, mk, todayStr) {
        const section = document.getElementById('homeTodaySection');
        const list = document.getElementById('homeTodayList');
        if (!list) return;

        if (entries.length === 0) {
            list.innerHTML = `<div class="empty-state">Nog niets uitgegeven vandaag.</div>`;
            return;
        }

        list.innerHTML = entries.map((e, i) => {
            const editKey = `${mk}|${todayStr}|${i}`;
            const isEditing = editingGroceryKey === editKey;
            if (isEditing) {
                return `<div class="tx-item" style="flex-direction:column;gap:var(--space-sm)">
                    <div style="display:flex;gap:var(--space-sm);width:100%">
                        <input type="text" class="grip-input grip-input-sm" id="editGrocAmount" value="${fromCents(e.amountCents)}" inputmode="decimal" style="flex:1">
                        <input type="text" class="grip-input grip-input-sm" id="editGrocNote" value="${e.note || ''}" placeholder="Notitie" style="flex:2">
                    </div>
                    <div style="display:flex;gap:var(--space-sm);width:100%">
                        <button class="btn-add" onclick="saveEditGrocery('${mk}','${todayStr}',${i})" style="flex:1">Opslaan</button>
                        <button class="btn-add" onclick="cancelEditGrocery()" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                    </div>
                </div>`;
            }
            return `<div class="tx-item">
                <div class="tx-info">
                    <div class="tx-note">${e.note || 'Uitgave'}</div>
                    <div class="tx-time">${getTimeStr(e.timestamp)}</div>
                </div>
                <div class="tx-amount">${e.amountCents === 0 ? '' : '-'}${formatEuro(e.amountCents)}</div>
                <button class="tx-delete" onclick="startEditGrocery('${mk}','${todayStr}',${i})" title="Bewerken" aria-label="Bewerk uitgave">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
                <button class="tx-delete" onclick="deleteGrocery('${mk}','${todayStr}',${i})" title="Verwijder" aria-label="Verwijder uitgave">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
            </div>`;
        }).join('');
    }

    function startEditGrocery(mk, dateStr, idx) {
        editingGroceryKey = `${mk}|${dateStr}|${idx}`;
        updateHome();
    }

    function cancelEditGrocery() {
        editingGroceryKey = null;
        updateHome();
    }

    function saveEditGrocery(mk, dateStr, idx) {
        const entry = appData.groceries[mk]?.[dateStr]?.[idx];
        if (!entry) return;
        const amount = parseNum(document.getElementById('editGrocAmount')?.value) || 0;
        const note = document.getElementById('editGrocNote')?.value?.trim() || '';
        entry.amountCents = toCents(amount);
        entry.note = note;
        saveData();
        editingGroceryKey = null;
        updateHome();
        showToast('Aangepast.');
    }

    function deleteGrocery(mk, dateStr, idx) {
        const entries = appData.groceries[mk]?.[dateStr];
        if (!entries || !entries[idx]) return;

        // Save for undo
        const removed = { ...entries[idx] };
        entries.splice(idx, 1);
        if (entries.length === 0) delete appData.groceries[mk][dateStr];
        saveData();
        updateHome();

        showToast('Verwijderd.', function() {
            // Undo: restore
            if (!appData.groceries[mk]) appData.groceries[mk] = {};
            if (!appData.groceries[mk][dateStr]) appData.groceries[mk][dateStr] = [];
            appData.groceries[mk][dateStr].splice(idx, 0, removed);
            saveData();
            updateHome();
        });
    }

    function renderPeriodStatus(mk, period) {
        const labelEl = document.getElementById('periodLabel');
        const statusEl = document.getElementById('periodStatus');
        const dotsEl = document.getElementById('periodDots');

        // Period label
        const startStr = formatDateNL(period.startDate);
        const endStr = formatDateNL(period.endDate);
        labelEl.textContent = `${startStr} – ${endStr}`;

        // Calculate period budget status
        const grocBudgetTotal = (appData.dailyGroceryBudget || 3500) * (Math.round((period.endDate - period.startDate) / (1000*60*60*24)) + 1);
        const grocSpent = calculateMonthGroceriesCents(mk);
        const diff = grocBudgetTotal - grocSpent;

        if (diff >= 0) {
            statusEl.textContent = `${formatEuro(diff)} onder budget`;
            statusEl.style.color = 'var(--green)';
        } else {
            statusEl.textContent = `${formatEuro(Math.abs(diff))} boven budget`;
            statusEl.style.color = 'var(--red)';
        }

        // Dots
        if (dotsEl) {
            const today = startOfDay(getNLDate());
            const pStart = startOfDay(period.startDate);
            const appStart = appData.appStartDate ? startOfDay(parseLocalDate(appData.appStartDate)) : pStart;
            let dots = '';
            const d = new Date(pStart);
            while (d <= today && d <= startOfDay(period.endDate)) {
                if (d >= appStart) {
                    const dStr = formatDate(d);
                    const entries = appData.groceries[mk]?.[dStr] || [];
                    const isToday = d.getTime() === today.getTime();
                    let cls = 'dot';
                    if (entries.length > 0) {
                        const dayTotal = entries.reduce((s,e) => s + (Number(e.amountCents)||0), 0);
                        cls += dayTotal <= (appData.dailyGroceryBudget || 3500) ? ' green' : ' caution';
                    }
                    if (isToday) cls += ' today';
                    dots += `<div class="${cls}"></div>`;
                }
                d.setDate(d.getDate() + 1);
            }
            dotsEl.innerHTML = dots;
        }
    }

    function renderSavingsCompact(activeMK) {
        try { premRenderExtraGoals(); } catch(e) {}
        const totalEl = document.getElementById('homeSavingsTotal');
        const changeEl = document.getElementById('homeSavingsChange');
        const labelEl = document.getElementById('homeSavingsLabel');

        const realtimeTotal = calculateRealtimeSavingsCents();
        const periodStart = calculateSavingsAtPeriodStartCents(activeMK);
        const change = realtimeTotal - periodStart;

        if (labelEl) labelEl.textContent = 'Huidig spaarsaldo';
        totalEl.textContent = formatEuro(realtimeTotal);
        const sign = change >= 0 ? '+' : '';
        changeEl.textContent = `${sign}${formatEuro(change)} ${t('thisPeriod').toLowerCase()}`;
        changeEl.style.color = change >= 0 ? 'var(--green)' : 'var(--red)';
    }

    // ═══════════════════════════════════════════════════════════════
    // PIN SYSTEM
    // ═══════════════════════════════════════════════════════════════
    let pinValue = '';

    function initPinScreen() {
        pinValue = '';
        // Avatar
        const avatarEl = document.getElementById('pinAvatar');
        if (avatarEl) {
            if (appData.avatarPhoto) {
                avatarEl.innerHTML = '<img src="' + appData.avatarPhoto + '" style="width:100%;height:100%;border-radius:50%;object-fit:cover">';
            } else {
                const initials = (appData.userName || '').split(' ').map(w => (w[0] || '')).join('').toUpperCase().substring(0,2) || '?';
                avatarEl.textContent = initials;
            }
        }

        // Dots
        const dotsEl = document.getElementById('pinDots');
        if (dotsEl) dotsEl.innerHTML = [0,1,2,3].map(i => '<div class="pin-dot"></div>').join('');
        // Keypad
        const keypadEl = document.getElementById('pinKeypad');
        if (keypadEl) keypadEl.innerHTML = [1,2,3,4,5,6,7,8,9,'del',0,''].map(k => {
            if (k === 'del') return '<button class="pin-key" onclick="pinClear()" style="font-size:1.1rem">&#9003;</button>';
            if (k === '') return '<div></div>';
            return '<button class="pin-key" onclick="pinInput(\'' + k + '\')">' + k + '</button>';
        }).join('');
        document.getElementById('pinError')?.classList.remove('show');
    }

    function pinInput(digit) {
        if (pinValue.length >= 4) return;
        pinValue += digit;
        updatePinDots();
        if (pinValue.length === 4) {
            setTimeout(pinSubmit, 150);
        }
    }

    function pinClear() {
        if (pinValue.length > 0) {
            pinValue = pinValue.slice(0, -1);
            updatePinDots();
        }
    }

    function updatePinDots() {
        const dots = document.querySelectorAll('#pinDots .pin-dot');
        dots.forEach((dot, i) => {
            dot.classList.toggle('filled', i < pinValue.length);
        });
    }

    function pinSubmit() {
        if (pinValue === appData.pin) {
            document.getElementById('pinScreen').classList.add('hidden');
            ensureActiveMonthSynced();
            showWelcomeSplash();
        } else {
            const error = document.getElementById('pinError');
            if (error) { error.textContent = 'Onjuiste pincode'; error.classList.add('show'); setTimeout(() => error.classList.remove('show'), 2000); }
            const dotsContainer = document.getElementById('pinDots');
            if (dotsContainer) { dotsContainer.classList.add('pin-shake'); setTimeout(() => dotsContainer.classList.remove('pin-shake'), 500); }
            pinValue = '';
            updatePinDots();
        }
    }


    // ═══════════════════════════════════════════════════════════════
    // MENU
    // ═══════════════════════════════════════════════════════════════
    function updateMenu() {
        try {
            const activeMK = getActiveMonthKey();
            const greetEl = document.getElementById('menuGreeting');
            if (greetEl) greetEl.textContent = getGreeting();

            const freeEl = document.getElementById('menuFreeStatus');
            if (freeEl) {
                const freeBudget = getFreeBudgetCents(activeMK);
                const freeSpent = calculateMonthSpendingCents(activeMK);
                const remaining = freeBudget - freeSpent;
                freeEl.textContent = formatEuro(remaining);
                freeEl.style.color = remaining >= 0 ? 'var(--green)' : 'var(--red)';
            }
            const fixEl = document.getElementById('menuFixedTotal');
            if (fixEl) fixEl.textContent = '−' + formatEuro(calculateFixedCostsTotalCents(activeMK));
            const savEl = document.getElementById('menuSavingsStatus');
            if (savEl) savEl.textContent = formatEuro(calculateRealtimeSavingsCents());
            const incEl = document.getElementById('menuIncomeVal');
            if (incEl) incEl.textContent = formatEuro(appData.monthlyIncome || 0);
            const budEl = document.getElementById('menuBudgetVal');
            if (budEl) budEl.textContent = formatEuro(appData.dailyGroceryBudget || 3500) + '/dag';
        } catch(e) { console.error('Menu error:', e); }
    }

    // ═══════════════════════════════════════════════════════════════
    // INSTELLINGEN
    // ═══════════════════════════════════════════════════════════════
    function updateInkomen() {
        // Populate year selector
        const yearSel = document.getElementById('salaryYearSelect');
        if (yearSel && yearSel.options.length === 0) {
            const cy = new Date().getFullYear();
            for (let y = cy; y <= cy + 3; y++) {
                const o = document.createElement('option');
                o.value = y; o.textContent = y;
                yearSel.appendChild(o);
            }
        }
        // Original code continues below
        void 0; // placeholder
        try {
            const incEl = document.getElementById('instIncome');
            if (incEl && !incEl.matches(':focus')) incEl.value = fromCents(appData.monthlyIncome || 0);
            const sdEl = document.getElementById('instSalaryDay');
            if (sdEl && !sdEl.matches(':focus')) sdEl.value = appData.defaultSalaryDay || 24;
            populateInstPeriodDropdowns();
            renderInstIncomeOverrides();
            renderSalaryDayGrid();

            // Summary card
            const summaryAmt = document.getElementById('inkomenSummaryAmount');
            const summarySub = document.getElementById('inkomenSummarySub');
            if (summaryAmt) summaryAmt.textContent = formatEuro(appData.monthlyIncome || 0);
            if (summarySub) summarySub.textContent = `Uitbetalingsdag: ${appData.defaultSalaryDay || 24}e van de maand`;
        } catch(e) { console.error('Inkomen error:', e); }
    }

    function spOpenGoalInput() {
        const section = document.getElementById('spGoalInput');
        if (section) {
            section.classList.remove('hidden');
            // Scroll section into view first, then focus after keyboard settles
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        const input = document.getElementById('spGoalInput2');
        if (input) {
            input.value = appData.savingsGoalCents ? fromCents(appData.savingsGoalCents) : '';
            // Delay focus to prevent double-scroll with iOS keyboard
            setTimeout(() => input.focus({ preventScroll: true }), 400);
        }
    }

    function spSaveGoalInline() {
        const val = parseNum(document.getElementById('spGoalInput2')?.value);
        appData.savingsGoalCents = (val && val > 0) ? toCents(val) : 0;
        saveData();
        document.getElementById('spGoalInput')?.classList.add('hidden');
        try { updateSparen(); } catch(e) {}
        showToast(appData.savingsGoalCents > 0 ? 'Spaardoel: ' + formatEuro(appData.savingsGoalCents) : 'Spaardoel verwijderd.');
    }

    function dsSaveCorrection() {
        const inputEl = document.getElementById('dsCorrectionInput');
        const desiredTotal = parseNum(inputEl?.value);
        if (isNaN(desiredTotal)) { showToast('Vul een bedrag in.'); return; }
        const desiredCents = toCents(desiredTotal);
        const currentCalc = calculateRealtimeSavingsCents();
        const diff = desiredCents - currentCalc;
        appData.startSavingsCents = (appData.startSavingsCents || 0) + diff;
        if (!appData.savingsCorrections) appData.savingsCorrections = [];
        appData.savingsCorrections.push({ date: new Date().toISOString(), fromCents: currentCalc, toCents: desiredCents, adjustmentCents: diff });
        saveData();
        if (inputEl) inputEl.value = '';
        try { updateSparen(); } catch(e) {}
        try { renderSavingsCompact(getActiveMonthKey()); } catch(e) {}
        try { updateDagSparen(); } catch(e) {}
        try { updateMenu(); } catch(e) {}
        showToast('Saldo aangepast naar ' + formatEuro(desiredCents));
    }

    function updateDagSparen() {
        try {
            const dbEl = document.getElementById('instBudget');
            if (dbEl && !dbEl.matches(':focus')) dbEl.value = fromCents(appData.dailyGroceryBudget || 3500);
            const asEl = document.getElementById('instAutoSave');
            if (asEl && !asEl.matches(':focus')) asEl.value = fromCents(appData.autoSaveCents || 0);
            const goalEl = document.getElementById('instGoal');
            if (goalEl && !goalEl.matches(':focus')) goalEl.value = appData.savingsGoalCents ? fromCents(appData.savingsGoalCents) : '';

            // Hero displays
            const dbDisp = document.getElementById('dsDagbudgetDisplay');
            if (dbDisp) dbDisp.textContent = formatEuro(appData.dailyGroceryBudget || 3500);
            const asDisp = document.getElementById('dsAutoSaveDisplay');
            if (asDisp) asDisp.textContent = formatEuro(appData.autoSaveCents || 0);
            const goalDisp = document.getElementById('dsGoalDisplay');
            if (goalDisp) goalDisp.textContent = appData.savingsGoalCents ? formatEuro(appData.savingsGoalCents) : 'Geen doel';
            const curDisp = document.getElementById('dsCurrentSavings');
            if (curDisp) curDisp.textContent = formatEuro(calculateRealtimeSavingsCents());
        } catch(e) { console.error('DagSparen error:', e); }
    }

    function correctSavingsFromSettings() {
        const inputEl = document.getElementById('instCorrectSavings');
        const desiredTotal = parseNum(inputEl?.value);
        if (isNaN(desiredTotal)) { showToast(t('enterAmount')); return; }
        const desiredCents = toCents(desiredTotal);
        const currentCalc = calculateRealtimeSavingsCents();
        const diff = desiredCents - currentCalc;
        appData.startSavingsCents = (appData.startSavingsCents || 0) + diff;
        if (!appData.savingsCorrections) appData.savingsCorrections = [];
        appData.savingsCorrections.push({ date: new Date().toISOString(), fromCents: currentCalc, toCents: desiredCents, adjustmentCents: diff });
        saveData();
        if (inputEl) inputEl.value = '';
        updateDagSparen();
        showToast(t('adjusted'));
    }

    function saveSalaryDayGridAll() {
        const inputs = document.querySelectorAll('#salaryDayGrid input[data-salkey]');
        if (!appData.salaryDates) appData.salaryDates = {};
        inputs.forEach(inp => {
            const key = inp.dataset.salkey;
            const val = parseInt(inp.value);
            if (val && val >= 1 && val <= 31) {
                appData.salaryDates[key] = val;
            } else {
                delete appData.salaryDates[key];
            }
        });
        saveData();
        generateSalaryPeriods();
        showToast('Salarisdagen opgeslagen.');
    }

    function updateVasteLasten() {
        try {
            populateInstPeriodDropdowns();
            renderInstFixedCosts();
            renderFcDonut();
            // i18n labels
            const s = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
            s('fcAddBtn', t('add'));
            // Populate category dropdown with i18n
            const catSel = document.getElementById('instFcCat');
            if (catSel && catSel.options.length === 0) {
                const cats = Object.keys(CAT_LABELS);
                cats.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = getCatLabel(c); catSel.appendChild(o); });
            }
        } catch(e) { console.error('VasteLasten error:', e); }
    }

    // ═══════════════════════════════════════
    // VASTE LASTEN VIEW (standalone page)
    // ═══════════════════════════════════════
    let vlEditingId = null;

    let vlSelectedMK = null;

    function updateVasteLastenView() {
        try {
            ensureFixedCostsIds();
            const activeMK = getActiveMonthKey();
            if (!vlSelectedMK) vlSelectedMK = activeMK;
            
            // Render period strip
            vlRenderPeriodStrip();
            
            // Category dropdown for adding
            const catSel = document.getElementById('vlAddCat');
            if (catSel) {
                catSel.innerHTML = '';
                Object.keys(CAT_LABELS).forEach(c => {
                    const o = document.createElement('option');
                    o.value = c; o.textContent = getCatLabel(c);
                    catSel.appendChild(o);
                });
            }

            vlRenderCategories(vlSelectedMK);
            vlRenderDonut(vlSelectedMK);
        } catch(e) { console.error('VasteLastenView error:', e); }
    }

    function vlSelectPeriod(mk) {
        vlSelectedMK = mk;
        vlEditingId = null;
        vlRenderPeriodStrip();
        vlRenderCategories(mk);
        vlRenderDonut(mk);
    }

    function vlRenderPeriodStrip() {
        const dd = document.getElementById('vlPeriodDropdown');
        if (!dd) return;
        const activeMK = getActiveMonthKey();
        const hasOverridesFor = (mk) => appData.fixedCostOverrides?.[mk]?.length > 0;
        
        let opts = '<option value="base"' + (vlSelectedMK === 'base' ? ' selected' : '') + '>Standaard (alle periodes)</option>';
        salaryPeriods.forEach(p => {
            const startStr = formatDateNL(p.startDate);
            const endStr = formatDateNL(p.endDate);
            const isCurrent = p.key === activeMK;
            const adjusted = hasOverridesFor(p.key);
            const label = startStr + ' – ' + endStr + (isCurrent ? ' (huidig)' : '') + (adjusted ? ' ✱' : '');
            opts += '<option value="' + p.key + '"' + (vlSelectedMK === p.key ? ' selected' : '') + '>' + label + '</option>';
        });
        dd.innerHTML = opts;
    }

    function vlRenderCategories(mk) {
        setTimeout(function(){ try{premEnhanceVasteLasten();}catch(e){} }, 100);
        const el = document.getElementById('vlCatList');
        if (!el) return;
        const isBase = mk === 'base';
        const q = String.fromCharCode(39);
        
        let html = '';
        if (!isBase) {
            html += '<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:var(--space-lg);padding:var(--space-sm) var(--space-md);background:var(--glass);border-radius:var(--radius-sm)">Tik op een bedrag om het <strong>alleen voor deze periode</strong> aan te passen.</div>';
        }
        
        let grandTotal = 0;
        const cats = Object.keys(appData.fixedCosts || {});
        const catIcon = {huis:'\u{1F3E0}', energie:'\u26A1', water:'\u{1F4A7}', verzekeringen:'\u{1F6E1}\uFE0F', telefoon:'\u{1F4F1}', internet:'\u{1F4E1}', abonnementen:'\u{1F3AC}', sport:'\u{1F4AA}', leningen:'\u{1F4B3}', verzorging:'\u{1F487}', vliegtuig:'\u2708\uFE0F', overig:'\u{1F4CC}'};
        
        cats.forEach(cat => {
            const items = appData.fixedCosts[cat] || [];
            if (items.length === 0) return;
            
            let catTotal = 0;
            let itemsHtml = '';
            
            items.forEach(item => {
                const override = !isBase ? (appData.fixedCostOverrides?.[mk]?.find(o => o.id === item.id)) : null;
                const amt = override ? override.amountCents : item.amountCents;
                catTotal += amt;
                
                if (vlEditingId === item.id) {
                    const editName = override ? (override.name || item.name) : item.name || '';
                    itemsHtml += '<div class="tx-item" style="flex-direction:column;gap:var(--space-sm);padding:var(--space-sm) 0">' +
                        '<div style="display:flex;gap:var(--space-sm);width:100%">' +
                        '<input type="text" class="grip-input grip-input-sm" id="vlEditName" value="' + editName + '" placeholder="Naam" style="flex:2">' +
                        '<input type="text" class="grip-input grip-input-sm" id="vlEditAmount" value="' + fromCents(amt) + '" inputmode="decimal" style="flex:1">' +
                        '</div>' +
                        '<div style="display:flex;gap:var(--space-sm);width:100%">' +
                        '<button class="btn-add" onclick="vlSaveEdit(' + q+cat+q + ',' + q+item.id+q + ',' + q+mk+q + ')" style="flex:1;background:var(--green);color:#000">Opslaan</button>' +
                        '<button class="btn-add" onclick="vlEditingId=null;vlRenderCategories(' + q+mk+q + ')" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>' +
                        (override ? '<button class="btn-add" onclick="vlResetOverride(' + q+cat+q + ',' + q+item.id+q + ',' + q+mk+q + ')" style="flex:1;background:rgba(248,113,113,0.1);color:var(--red)">Reset</button>' : '') +
                        '</div></div>';
                } else {
                    const overrideTag = override ? '<span style="font-size:0.6rem;background:var(--accent-dim);color:var(--accent);padding:1px 6px;border-radius:8px;margin-left:6px">aangepast</span>' : '';
                    const amtChanged = override && override.amountCents !== item.amountCents;
                    const baseAmt = amtChanged ? '<span style="font-size:0.65rem;color:var(--text-muted);text-decoration:line-through;margin-right:4px">' + formatEuro(item.amountCents) + '</span>' : '';
                    
                    itemsHtml += '<div class="tx-item" data-vl-item-id="' + item.id + '" style="padding:var(--space-xs) 0">' +
                        '<div class="tx-info"><div class="tx-note">' + (item.name || getCatLabel(cat)) + overrideTag + '</div></div>' +
                        '<div class="tx-amount" style="color:var(--red)">' + baseAmt + '\u2212' + formatEuro(amt) + '</div>' +
                        '<button class="tx-delete" onclick="vlEditingId=' + q+item.id+q + ';vlRenderCategories(' + q+mk+q + ')" title="Bewerken"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>' +
                        (isBase ? '<button class="tx-delete" onclick="vlDelete(' + q+cat+q + ',' + q+item.id+q + ',' + q+mk+q + ')" title="Verwijder"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>' : '') +
                        '</div>';
                }
            });
            
            grandTotal += catTotal;
            
            html += '<div style="margin-bottom:var(--space-xl)">' +
                '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-sm)">' +
                '<div style="font-size:0.82rem;font-weight:700">' + (catIcon[cat] || '\u{1F4CC}') + ' ' + getCatLabel(cat) + '</div>' +
                '<div style="font-size:0.82rem;font-weight:700;color:var(--red);font-variant-numeric:var(--tabular)">\u2212' + formatEuro(catTotal) + '</div>' +
                '</div>' +
                '<div class="tx-list">' + itemsHtml + '</div></div>';
        });
        
        el.innerHTML = html || '<div class="empty-state">Nog geen vaste lasten.</div>';
        
        const totalEl = document.getElementById('vlDonutTotal');
        if (totalEl) totalEl.textContent = '\u2212' + formatEuro(grandTotal);
    }

    function vlSaveEdit(cat, id, mk) {
        const name = document.getElementById('vlEditName')?.value?.trim() || '';
        const amount = toCents(parseNum(document.getElementById('vlEditAmount')?.value) || 0);
        const item = (appData.fixedCosts[cat] || []).find(x => x.id === id);
        if (!item) return;

        if (mk === 'base') {
            // Edit the base/standard item
            item.name = name || item.name;
            item.amountCents = amount;
        } else {
            // Save as per-period override
            if (!appData.fixedCostOverrides) appData.fixedCostOverrides = {};
            if (!appData.fixedCostOverrides[mk]) appData.fixedCostOverrides[mk] = [];
            const existing = appData.fixedCostOverrides[mk].find(o => o.id === id);
            if (existing) {
                existing.amountCents = amount;
                if (name) existing.name = name;
            } else {
                appData.fixedCostOverrides[mk].push({ id, name: name || item.name, amountCents: amount });
            }
        }
        
        saveData();
        vlEditingId = null;
        vlRenderCategories(mk);
        vlRenderDonut(mk);
        showToast(mk === 'base' ? 'Standaard aangepast.' : 'Aangepast voor deze periode.');
    }

    const EMOJI_OPTIONS = ['🏠','⚡','💧','🛡️','📱','📡','🎬','💪','💳','👨‍👩‍👧','📋','🚗','💇','✈️','🐾','🎓','🎵','🍽️','🏥','🎁','👕','💻','🏋️','📦','🔧','🌍','☕','📚','🎮','💊'];

    function renderEmojiGrid() {
        const grid = document.getElementById('vlEmojiGrid');
        if (!grid) return;
        const selected = document.getElementById('vlNewCatEmoji')?.value || '📌';
        grid.innerHTML = EMOJI_OPTIONS.map(e =>
            '<button onclick="selectNewCatEmoji(\'' + e + '\')" style="width:40px;height:40px;border-radius:var(--radius-sm);border:2px solid ' + (e === selected ? 'var(--accent)' : 'transparent') + ';background:' + (e === selected ? 'var(--accent-dim)' : 'var(--glass)') + ';font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center">' + e + '</button>'
        ).join('');
    }

    function selectNewCatEmoji(emoji) {
        const input = document.getElementById('vlNewCatEmoji');
        if (input) input.value = emoji;
        renderEmojiGrid();
    }

    function vlToggleNewCat() {
        const section = document.getElementById('vlNewCatSection');
        if (!section) return;
        const isHidden = section.classList.contains('hidden');
        section.classList.toggle('hidden');
        if (isHidden) renderEmojiGrid();
    }

    function vlAddNewCategory() {
        const emoji = document.getElementById('vlNewCatEmoji')?.value?.trim() || '📌';
        const name = document.getElementById('vlNewCatName')?.value?.trim();
        if (!name) { showToast('Vul een naam in.'); return; }
        // Create a key from the name (lowercase, no spaces)
        const key = 'custom_' + name.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_').substring(0, 20);
        if (CAT_LABELS[key]) { showToast('Deze categorie bestaat al.'); return; }
        // Add to CAT_LABELS
        CAT_LABELS[key] = name;
        // Save custom categories in appData
        if (!appData.customCategories) appData.customCategories = {};
        appData.customCategories[key] = { name, emoji };
        // Add empty array to fixedCosts
        if (!appData.fixedCosts[key]) appData.fixedCosts[key] = [];
        saveData();
        // Clear inputs
        document.getElementById('vlNewCatEmoji').value = '';
        document.getElementById('vlNewCatName').value = '';
        document.getElementById('vlNewCatSection')?.classList.add('hidden');
        // Refresh
        try { updateVasteLastenView(); } catch(e) {}
        showToast('Categorie "' + name + '" toegevoegd.');
    }

    // Restore custom categories on load
    function restoreCustomCategories() {
        if (!appData.customCategories) return;
        Object.entries(appData.customCategories).forEach(([key, data]) => {
            if (!CAT_LABELS[key]) CAT_LABELS[key] = data.name;
            if (!appData.fixedCosts[key]) appData.fixedCosts[key] = [];
        });
    }

    function getCustomEmoji(cat) {
        return appData.customCategories?.[cat]?.emoji || null;
    }

    function vlToggleCatEdit() {
        const section = document.getElementById('vlCatEditSection');
        if (!section) return;
        const isHidden = section.classList.contains('hidden');
        section.classList.toggle('hidden');
        if (isHidden) vlRenderCatEditList();
    }

    function vlRenderCatEditList() {
        const el = document.getElementById('vlCatEditList');
        if (!el) return;
        const catIcon = {huis:'🏠', energie:'⚡', water:'💧', verzekeringen:'🛡️', telefoon:'📱', internet:'📡', abonnementen:'🎬', sport:'💪', leningen:'💳', gezin:'👨‍👩‍👧', belastingen:'📋', vervoer:'🚗', verzorging:'💇', vliegtuig:'✈️', overig:'📌'};
        const cats = Object.keys(CAT_LABELS);
        el.innerHTML = cats.map(cat => {
            const icon = catIcon[cat] || '📌';
            const currentLabel = getCatLabel(cat);
            return '<div style="display:flex;gap:var(--space-sm);align-items:center;margin-bottom:6px">' +
                '<span style="font-size:1.1rem;width:28px;text-align:center;flex-shrink:0">' + icon + '</span>' +
                '<input type="text" class="grip-input grip-input-sm" data-catkey="' + cat + '" value="' + currentLabel + '" style="flex:1">' +
                '</div>';
        }).join('');
    }

    function vlSaveCatLabels() {
        const inputs = document.querySelectorAll('#vlCatEditList input[data-catkey]');
        if (!inputs || inputs.length === 0) { showToast('Geen categorieën gevonden.'); return; }
        appData.customCatLabels = appData.customCatLabels || {};
        let changed = 0;
        inputs.forEach(inp => {
            const cat = inp.getAttribute('data-catkey');
            if (!cat) return;
            const val = inp.value.trim();
            const defaultLabel = CAT_LABELS[cat] || cat;
            if (val && val !== defaultLabel) {
                appData.customCatLabels[cat] = val;
                changed++;
            } else {
                delete appData.customCatLabels[cat];
            }
        });
        saveData();
        // Force close and full re-render
        const section = document.getElementById('vlCatEditSection');
        if (section) section.classList.add('hidden');
        // Re-populate category dropdown
        const catSel = document.getElementById('vlAddCat');
        if (catSel) {
            catSel.innerHTML = '';
            Object.keys(CAT_LABELS).forEach(c => {
                const o = document.createElement('option');
                o.value = c; o.textContent = getCatLabel(c);
                catSel.appendChild(o);
            });
        }
        // Full re-render of the VL view
        try { updateVasteLastenView(); } catch(e) { console.error(e); }
        showToast(changed > 0 ? changed + ' categorie(ën) aangepast.' : 'Geen wijzigingen.');
    }

    function vlResetOverride(cat, id, mk) {
        if (appData.fixedCostOverrides?.[mk]) {
            appData.fixedCostOverrides[mk] = appData.fixedCostOverrides[mk].filter(o => o.id !== id);
            if (appData.fixedCostOverrides[mk].length === 0) delete appData.fixedCostOverrides[mk];
        }
        saveData();
        vlEditingId = null;
        vlRenderCategories(mk);
        vlRenderDonut(mk);
        showToast('Teruggezet naar standaard.');
    }

    function vlDelete(cat, id, mk) {
        const items = appData.fixedCosts[cat];
        if (!items) return;
        const idx = items.findIndex(x => x.id === id);
        if (idx < 0) return;
        const removed = items.splice(idx, 1)[0];
        saveData();
        vlRenderCategories(mk);
        vlRenderDonut(mk);
        showToast('Verwijderd.', function() {
            if (!appData.fixedCosts[cat]) appData.fixedCosts[cat] = [];
            appData.fixedCosts[cat].push(removed);
            saveData();
            vlRenderCategories(mk);
            vlRenderDonut(mk);
        });
    }

    function vlClearAddForm() {
        const n = document.getElementById('vlAddName');
        const a = document.getElementById('vlAddAmount');
        if (n) n.value = '';
        if (a) a.value = '';
    }

    function vlAddFixedCost() {
        const name = document.getElementById('vlAddName')?.value?.trim() || '';
        const amount = parseNum(document.getElementById('vlAddAmount')?.value) || 0;
        const cat = document.getElementById('vlAddCat')?.value || 'overig';
        if (amount <= 0) { showToast('Vul een bedrag in.'); return; }
        if (!appData.fixedCosts[cat]) appData.fixedCosts[cat] = [];
        appData.fixedCosts[cat].push({ id: genId('fc'), name: name || CAT_LABELS[cat], amountCents: toCents(amount) });
        saveData();
        document.getElementById('vlAddName').value = '';
        document.getElementById('vlAddAmount').value = '';
        const mk = document.getElementById('vlPeriod')?.value || getActiveMonthKey();
        vlRenderCategories(mk);
        vlRenderDonut(mk);
        showToast('Toegevoegd.');
    }

    function vlRenderDonut(mk) {
        const donutEl = document.getElementById('vlDonut');
        const legendEl = document.getElementById('vlDonutLegend');
        if (!donutEl || !legendEl) return;
        ensureFixedCostsIds();
        const catTotals = {};
        Object.keys(appData.fixedCosts || {}).forEach(cat => {
            (appData.fixedCosts[cat] || []).forEach(item => {
                const override = appData.fixedCostOverrides?.[mk]?.find(o => o.id === item.id);
                const amt = override ? override.amountCents : item.amountCents;
                catTotals[cat] = (catTotals[cat] || 0) + amt;
            });
        });
        const fcColors = {
            huis: '#8b5cf6', energie: '#f59e0b', water: '#38bdf8', verzekeringen: '#3b82f6', telefoon: '#06b6d4', internet: '#0891b2',
            abonnementen: '#ec4899', sport: '#22c55e', leningen: '#ef4444', gezin: '#a855f7',
            belastingen: '#64748b', vervoer: '#14b8a6', verzorging: '#f472b6', vliegtuig: '#0ea5e9', overig: '#6b7280'
        };
        const segments = Object.entries(catTotals).filter(([,v]) => v > 0).map(([cat, value]) => ({
            label: getCatLabel(cat), value, color: fcColors[cat] || '#6b7280'
        }));
        const total = segments.reduce((s, seg) => s + seg.value, 0);
        const size = 100, cx = size/2, cy = size/2, r = 38, sw = 14;
        let svg = '<svg width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '">';
        let angle = -90;
        segments.forEach(seg => {
            const pct = seg.value / total;
            const a = pct * 360;
            const s1 = angle * Math.PI / 180, e1 = (angle + a) * Math.PI / 180;
            const large = a > 180 ? 1 : 0;
            if (a > 0.5) svg += '<path d="M' + (cx+r*Math.cos(s1)) + ',' + (cy+r*Math.sin(s1)) + ' A' + r + ',' + r + ' 0 ' + large + ',1 ' + (cx+r*Math.cos(e1)) + ',' + (cy+r*Math.sin(e1)) + '" fill="none" stroke="' + seg.color + '" stroke-width="' + sw + '" stroke-linecap="round"/>';
            angle += a;
        });
        svg += '</svg>';
        donutEl.innerHTML = svg;
        legendEl.innerHTML = segments.map(s =>
            '<div style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:8px;border-radius:50%;background:' + s.color + ';flex-shrink:0"></span>' + s.label + ': ' + formatEuro(s.value) + '</div>'
        ).join('');
    }

    function vlRenderOverrides(mk) {
        const el = document.getElementById('vlOverrideList');
        if (!el) return;
        const overrideMK = document.getElementById('vlOverridePeriod')?.value || mk;
        const overrides = appData.fixedCostOverrides?.[overrideMK] || [];
        if (overrides.length === 0) { el.innerHTML = ''; return; }
        el.innerHTML = overrides.map((o, i) =>
            '<div class="tx-item" style="padding:var(--space-xs) 0">' +
            '<div class="tx-info"><div class="tx-note">' + (o.name || 'Afwijking') + '</div></div>' +
            '<div class="tx-amount" style="color:var(--accent)">' + formatEuro(o.amountCents) + '</div>' +
            '<button class="tx-delete" onclick="vlDeleteOverride(\'' + overrideMK + '\',' + i + ')" title="Verwijder"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>' +
            '</div>'
        ).join('');
    }

    function vlAddOverride() {
        const mk = document.getElementById('vlOverridePeriod')?.value;
        const name = document.getElementById('vlOverrideName')?.value?.trim() || '';
        const amount = parseNum(document.getElementById('vlOverrideAmount')?.value) || 0;
        if (!mk || amount <= 0) { showToast('Vul een bedrag in.'); return; }
        if (!appData.fixedCostOverrides) appData.fixedCostOverrides = {};
        if (!appData.fixedCostOverrides[mk]) appData.fixedCostOverrides[mk] = [];
        appData.fixedCostOverrides[mk].push({ id: genId('fco'), name: name || 'Extra kost', amountCents: toCents(amount) });
        saveData();
        document.getElementById('vlOverrideName').value = '';
        document.getElementById('vlOverrideAmount').value = '';
        vlRenderOverrides(mk);
        showToast('Afwijking toegevoegd.');
    }

    function vlDeleteOverride(mk, idx) {
        if (!appData.fixedCostOverrides?.[mk]) return;
        appData.fixedCostOverrides[mk].splice(idx, 1);
        if (appData.fixedCostOverrides[mk].length === 0) delete appData.fixedCostOverrides[mk];
        saveData();
        vlRenderOverrides(mk);
        showToast('Verwijderd.');
    }


    function renderSalaryDayGrid() {
        setTimeout(function(){ try{premCheckSalaryOverrides();}catch(e){} }, 100);
        const el = document.getElementById('salaryDayGrid');
        if (!el) return;
        const MONTHS_SHORT = ['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];
        const salaryDates = appData.salaryDates || {};
        const defaultDay = appData.defaultSalaryDay || 24;
        const currentYear = new Date().getFullYear();
        const selectedYear = parseInt(document.getElementById('salaryYearSelect')?.value) || currentYear;
        
        let html = '<div class="salary-grid">';
        MONTHS_SHORT.forEach((m, i) => {
            const dateKey = `${selectedYear}-${String(i + 1).padStart(2, '0')}`;
            const savedVal = salaryDates[dateKey];
            const hasOverride = savedVal !== undefined && savedVal !== defaultDay;
            const displayVal = hasOverride ? savedVal : '';
            html += `<div class="salary-grid-item${hasOverride ? ' has-override' : ''}">
                <div class="month-label">${m}</div>
                <input type="number" class="grip-input grip-input-sm" style="text-align:center;padding:6px;font-size:1rem;font-weight:700;border:none;background:transparent;color:${hasOverride ? 'var(--accent)' : 'var(--text-primary)'};width:100%" min="1" max="31" inputmode="numeric" placeholder="${defaultDay}" value="${displayVal}" data-salkey="${dateKey}" onchange="markSalaryDayChanged(this)">
                ${hasOverride ? '<span class="override-badge" style="margin-top:4px">afwijkend</span>' : ''}
            </div>`;
        });
        html += '</div>';
        el.innerHTML = html;
    }

    function markSalaryDayChanged(input) {
        const defaultDay = appData.defaultSalaryDay || 24;
        const val = parseInt(input.value);
        const item = input.closest('.salary-grid-item');
        if (val && val !== defaultDay) {
            item.classList.add('has-override');
            input.style.color = 'var(--accent)';
        } else {
            item.classList.remove('has-override');
            input.style.color = 'var(--text-primary)';
        }
    }

    function saveSalaryDayOverride(month, val) {
        if (!appData.salaryDayOverrides) appData.salaryDayOverrides = {};
        const v = parseInt(val);
        if (v > 0 && v <= 31) {
            appData.salaryDayOverrides[String(month)] = v;
        } else {
            delete appData.salaryDayOverrides[String(month)];
        }
        saveData();
        generateSalaryPeriods();
    }

    function renderFcDonut() {
        const donutEl = document.getElementById('fcDonut');
        const legendEl = document.getElementById('fcDonutLegend');
        const totalEl = document.getElementById('fcDonutTotal');
        if (!donutEl || !legendEl) return;

        const mk = document.getElementById('instFixedPeriod')?.value || getActiveMonthKey();
        ensureFixedCostsIds();

        // Gather by category
        const catTotals = {};
        const cats = Object.keys(appData.fixedCosts || {});
        cats.forEach(cat => {
            (appData.fixedCosts[cat] || []).forEach(item => {
                const override = appData.fixedCostOverrides?.[mk]?.find(o => o.id === item.id);
                const amt = override ? override.amountCents : item.amountCents;
                catTotals[cat] = (catTotals[cat] || 0) + amt;
            });
        });

        const total = Object.values(catTotals).reduce((s, v) => s + v, 0);
        if (totalEl) totalEl.textContent = '−' + formatEuro(total);

        const fcColors = {
            huis: '#8b5cf6', energie: '#f59e0b', water: '#38bdf8', verzekeringen: '#3b82f6', telefoon: '#06b6d4', internet: '#0891b2',
            abonnementen: '#ec4899', sport: '#22c55e', leningen: '#ef4444', gezin: '#a855f7',
            belastingen: '#64748b', vervoer: '#14b8a6', verzorging: '#f472b6', vliegtuig: '#0ea5e9', overig: '#6b7280'
        };

        const segments = Object.entries(catTotals).filter(([,v]) => v > 0).map(([cat, value]) => ({
            label: getCatLabel(cat), value, color: fcColors[cat] || '#6b7280'
        }));

        if (segments.length === 0) { donutEl.innerHTML = ''; legendEl.innerHTML = ''; return; }

        // Draw donut
        const size = 100, cx = size/2, cy = size/2, r = 38, sw = 14;
        let svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
        let angle = -90;
        segments.forEach(seg => {
            const pct = seg.value / total;
            const a = pct * 360;
            const s1 = angle * Math.PI / 180, e1 = (angle + a) * Math.PI / 180;
            const large = a > 180 ? 1 : 0;
            if (a > 0.5) svg += `<path d="M${cx+r*Math.cos(s1)},${cy+r*Math.sin(s1)} A${r},${r} 0 ${large},1 ${cx+r*Math.cos(e1)},${cy+r*Math.sin(e1)}" fill="none" stroke="${seg.color}" stroke-width="${sw}"/>`;
            angle += a;
        });
        svg += '</svg>';
        donutEl.innerHTML = svg;
        legendEl.innerHTML = segments.map(s =>
            `<div style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:8px;border-radius:50%;background:${s.color};flex-shrink:0"></span>${s.label}: ${formatEuro(s.value)}</div>`
        ).join('');
    }

    function populateInstPeriodDropdowns() {
        const today = startOfDay(getNLDate());
        const activeMK = getActiveMonthKey();

        // Build list: all existing periods + 6 future months
        const allPeriods = [...salaryPeriods];
        const lastP = allPeriods[allPeriods.length - 1];
        if (lastP) {
            const lastEnd = lastP.endDate;
            for (let i = 1; i <= 6; i++) {
                const futureDate = new Date(lastEnd.getFullYear(), lastEnd.getMonth() + i, 1);
                const fKey = `${futureDate.getFullYear()}-${String(futureDate.getMonth() + 1).padStart(2, '0')}`;
                if (!allPeriods.find(p => p.key === fKey)) {
                    allPeriods.push({ key: fKey, name: tMonth(futureDate.getMonth()) + ' ' + futureDate.getFullYear(), startDate: futureDate, endDate: futureDate });
                }
            }
        }

        ['instIncomeOverridePeriod', 'instFixedPeriod'].forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            const currentVal = sel.value;
            sel.innerHTML = '';
            allPeriods.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.name + (p.key === activeMK ? ` (${t('currentPeriod').toLowerCase()})` : '');
                sel.appendChild(opt);
            });
            sel.value = currentVal || activeMK;
        });
    }

    // ─── SAVE FUNCTIONS ───
    function saveInstIncome() {
        const v = toCents(parseNum(document.getElementById('instIncome')?.value) || 0);
        appData.monthlyIncome = v;
        // Reset income entries for current period so they get recalculated
        const mk = getActiveMonthKey();
        delete appData.income[mk];
        saveData();
        generateSalaryPeriods();
        showToast('Inkomen opgeslagen.');
        updateInkomen();
    }

    function saveInstSalaryDay() {
        const v = parseInt(document.getElementById('instSalaryDay')?.value) || 24;
        appData.defaultSalaryDay = Math.max(1, Math.min(31, v));
        saveData();
        generateSalaryPeriods();
        showToast('Salarisdag opgeslagen.');
        updateInkomen();
    }

    function saveInstBudget() {
        const db = parseNum(document.getElementById('instBudget')?.value) || 35;
        appData.dailyGroceryBudget = toCents(db);
        saveData();
        updateDagSparen();
        showToast('Dagbudget opgeslagen: ' + formatEuro(appData.dailyGroceryBudget));
    }

    function saveInstAutoSave() {
        const as2 = parseNum(document.getElementById('instAutoSave')?.value) || 0;
        appData.autoSaveCents = toCents(as2);
        saveData();
        updateDagSparen();
        showToast('Auto-sparen opgeslagen: ' + formatEuro(appData.autoSaveCents) + '/mnd');
    }

    function saveInstGoal() {
        const goalEl = document.getElementById('instGoal');
        if (goalEl) {
            const goalVal = parseNum(goalEl.value);
            appData.savingsGoalCents = (goalVal && goalVal > 0) ? toCents(goalVal) : 0;
        }
        saveData();
        try { updateDagSparen(); } catch(e) {}
        try { updateSparen(); } catch(e) {}
        try { renderSavingsCompact(getActiveMonthKey()); } catch(e) {}
        showToast(appData.savingsGoalCents > 0 ? 'Spaardoel ingesteld: ' + formatEuro(appData.savingsGoalCents) : 'Spaardoel verwijderd.');
    }

    // ─── INCOME OVERRIDES ───
    function saveInstIncomeOverride() {
        const mk = document.getElementById('instIncomeOverridePeriod')?.value;
        const val = parseNum(document.getElementById('instIncomeOverrideVal')?.value);
        if (!mk || isNaN(val) || val <= 0) { showToast('Vul een bedrag in.'); return; }
        if (!appData.incomeByMonth) appData.incomeByMonth = {};
        appData.incomeByMonth[mk] = toCents(val);
        // Reset income entries so they get recalculated
        delete appData.income[mk];
        saveData();
        document.getElementById('instIncomeOverrideVal').value = '';
        renderInstIncomeOverrides();
        showToast('Afwijkend inkomen opgeslagen.');
    }

    function deleteInstIncomeOverride(mk) {
        delete appData.incomeByMonth[mk];
        delete appData.income[mk];
        saveData();
        renderInstIncomeOverrides();
        showToast('Afwijking verwijderd.');
    }

    function renderInstIncomeOverrides() {
        const el = document.getElementById('instIncomeOverrideList');
        if (!el) return;
        const overrides = appData.incomeByMonth || {};
        const keys = Object.keys(overrides);
        if (keys.length === 0) { el.innerHTML = ''; return; }
        el.innerHTML = keys.map(mk => {
            const period = getPeriodInfo(mk);
            return `<div class="tx-item" style="padding:var(--space-xs) 0">
                <div class="tx-info"><div class="tx-note">${period?.name || mk}</div></div>
                <div class="tx-amount" style="color:var(--green)">${formatEuro(overrides[mk])}</div>
                <button class="tx-delete" onclick="deleteInstIncomeOverride('${mk}')" title="Verwijder"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>`;
        }).join('');
    }

    // ─── FIXED COSTS INLINE ───
    let editingInstFixedId = null;

    function renderInstFixedCosts() {
        const el = document.getElementById('instFixedList');
        const totalEl = document.getElementById('instFixedTotal');
        if (!el) return;

        const mk = document.getElementById('instFixedPeriod')?.value || getActiveMonthKey();
        ensureFixedCostsIds();

        // Gather all base fixed costs
        let allItems = [];
        const cats = Object.keys(appData.fixedCosts || {});
        cats.forEach(cat => {
            (appData.fixedCosts[cat] || []).forEach(item => {
                // Check if there's an override for this item in this period
                const override = appData.fixedCostOverrides?.[mk]?.find(o => o.id === item.id);
                allItems.push({
                    ...item, cat,
                    displayAmount: override ? override.amountCents : item.amountCents,
                    hasOverride: !!override
                });
            });
        });

        if (allItems.length === 0) {
            el.innerHTML = '<div class="empty-state" style="font-size:0.82rem;padding:var(--space-md) 0">Nog geen vaste lasten.</div>';
            if (totalEl) totalEl.textContent = formatEuro(0);
            return;
        }

        let total = 0;
        let html = '';
        allItems.forEach(item => {
            total += item.displayAmount;
            if (editingInstFixedId === item.id) {
                html += `<div class="tx-item" style="flex-direction:column;gap:var(--space-sm);padding:var(--space-sm) 0">
                    <div style="display:flex;gap:var(--space-sm);width:100%">
                        <input type="text" class="grip-input grip-input-sm" id="editInstFcName" value="${item.name || ''}" placeholder="Naam" style="flex:2">
                        <input type="text" class="grip-input grip-input-sm" id="editInstFcAmount" value="${fromCents(item.displayAmount)}" inputmode="decimal" style="flex:1">
                    </div>
                    <div style="display:flex;gap:var(--space-sm);width:100%">
                        <button class="btn-add" onclick="saveInstFixedEdit('${item.cat}','${item.id}','${mk}')" style="flex:1;background:var(--green);color:#fff">Opslaan</button>
                        <button class="btn-add" onclick="editingInstFixedId=null;renderInstFixedCosts()" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                    </div>
                </div>`;
            } else {
                const overrideTag = item.hasOverride ? '<span style="font-size:0.65rem;background:var(--accent-dim);color:var(--accent);padding:1px 6px;border-radius:8px;margin-left:6px">afwijkend</span>' : '';
                html += `<div class="tx-item" style="padding:var(--space-xs) 0">
                    <div class="tx-info"><div class="tx-note">${item.name || getCatLabel(item.cat)}${overrideTag}</div><div class="tx-time">${getCatLabel(item.cat)}</div></div>
                    <div class="tx-amount" style="color:var(--red)">−${formatEuro(item.displayAmount)}</div>
                    <button class="tx-delete" onclick="editingInstFixedId='${item.id}';renderInstFixedCosts()" title="Bewerken"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                    <button class="tx-delete" onclick="deleteInstFixed('${item.cat}','${item.id}')" title="Verwijder"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                </div>`;
            }
        });
        el.innerHTML = html;
        if (totalEl) totalEl.textContent = '−' + formatEuro(total);
    }

    function saveInstFixedEdit(cat, id, mk) {
        const name = document.getElementById('editInstFcName')?.value?.trim() || '';
        const amount = toCents(parseNum(document.getElementById('editInstFcAmount')?.value) || 0);
        const activeMK = getActiveMonthKey();

        // Find base item
        const item = (appData.fixedCosts[cat] || []).find(x => x.id === id);
        if (!item) return;

        if (mk === activeMK || mk === 'base') {
            // Update base item
            item.name = name || item.name;
            item.amountCents = amount;
            // Remove any override for this period
            if (appData.fixedCostOverrides?.[mk]) {
                appData.fixedCostOverrides[mk] = appData.fixedCostOverrides[mk].filter(o => o.id !== id);
                if (appData.fixedCostOverrides[mk].length === 0) delete appData.fixedCostOverrides[mk];
            }
        } else {
            // Create/update override for this specific period
            if (!appData.fixedCostOverrides) appData.fixedCostOverrides = {};
            if (!appData.fixedCostOverrides[mk]) appData.fixedCostOverrides[mk] = [];
            const existing = appData.fixedCostOverrides[mk].find(o => o.id === id);
            if (existing) {
                existing.amountCents = amount;
                existing.name = name || existing.name;
            } else {
                appData.fixedCostOverrides[mk].push({ id, name: name || item.name, amountCents: amount });
            }
        }

        saveData();
        editingInstFixedId = null;
        renderInstFixedCosts();
        showToast('Opgeslagen.');
    }

    function deleteInstFixed(cat, id) {
        const items = appData.fixedCosts[cat];
        if (!items) return;
        const idx = items.findIndex(x => x.id === id);
        if (idx < 0) return;
        items.splice(idx, 1);
        saveData();
        renderInstFixedCosts();
        showToast('Verwijderd.');
    }

    function addInstFixedCost() {
        const name = document.getElementById('instFcName')?.value?.trim() || '';
        const amount = parseNum(document.getElementById('instFcAmount')?.value) || 0;
        const cat = document.getElementById('instFcCat')?.value || 'overig';
        if (amount <= 0) { showToast('Vul een bedrag in.'); return; }
        if (!appData.fixedCosts[cat]) appData.fixedCosts[cat] = [];
        appData.fixedCosts[cat].push({ id: genId('fc'), name: name || CAT_LABELS[cat] || 'Vaste last', amountCents: toCents(amount) });
        saveData();
        document.getElementById('instFcName').value = '';
        document.getElementById('instFcAmount').value = '';
        renderInstFixedCosts();
        showToast('Toegevoegd.');
    }

    // ═══════════════════════════════════════════════════════════════
    // VRIJ BUDGET
    // ═══════════════════════════════════════════════════════════════
    let vbViewedMK = null;
    let editingVBSpendKey = null;

    function updateVrijBudget() {
        try {
            const activeMK = getActiveMonthKey();
            if (!vbViewedMK) vbViewedMK = activeMK;

            // Budget card
            const freeBudget = getFreeBudgetCents(vbViewedMK);
            const freeSpent = calculateMonthSpendingCents(vbViewedMK);
            const remaining = freeBudget - freeSpent;

            const amountEl = document.getElementById('vbBudgetLeft');
            const subEl = document.getElementById('vbBudgetSub');
            if (amountEl) {
                amountEl.textContent = formatEuro(remaining);
                amountEl.style.color = remaining >= 0 ? 'var(--green)' : 'var(--red)';
            }
            if (subEl) {
                subEl.textContent = `${formatEuro(freeSpent)} uitgegeven van ${formatEuro(freeBudget)}`;
            }

            // Spending list
            renderVBSpendingList(vbViewedMK);
            renderVBDonut(vbViewedMK);
        } catch(e) { console.error('VrijBudget error:', e); }
    }

    function renderVBDonut(mk) {
        const donutEl = document.getElementById('vbDonut');
        const legendEl = document.getElementById('vbDonutLegend');
        const card = document.getElementById('vbDonutCard');
        if (!donutEl || !legendEl) return;

        const items = appData.spending[mk] || [];
        if (items.length === 0) { if (card) card.style.display = 'none'; return; }
        if (card) card.style.display = '';

        const catTotals = {};
        items.forEach(it => {
            const c = it.cat || 'overig_vrij';
            catTotals[c] = (catTotals[c] || 0) + (Number(it.amountCents) || 0);
        });

        const vbColors = {
            kleding: '#ec4899', elektronica: '#3b82f6', horeca: '#f59e0b', cadeaus: '#a855f7',
            gezondheid: '#22c55e', hobby: '#06b6d4', vakantie: '#ef4444', huishouden: '#8b5cf6',
            auto: '#14b8a6', overig_vrij: '#6b7280'
        };

        const total = Object.values(catTotals).reduce((s, v) => s + v, 0);
        const segments = Object.entries(catTotals).filter(([,v]) => v > 0).map(([cat, value]) => ({
            label: getCatLabel(cat), value, color: vbColors[cat] || '#6b7280'
        }));

        const size = 100, cx = size/2, cy = size/2, r = 38, sw = 14;
        let svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
        let angle = -90;
        segments.forEach(seg => {
            const pct = seg.value / total;
            const a = pct * 360;
            const s1 = angle * Math.PI / 180, e1 = (angle + a) * Math.PI / 180;
            const large = a > 180 ? 1 : 0;
            if (a > 0.5) svg += `<path d="M${cx+r*Math.cos(s1)},${cy+r*Math.sin(s1)} A${r},${r} 0 ${large},1 ${cx+r*Math.cos(e1)},${cy+r*Math.sin(e1)}" fill="none" stroke="${seg.color}" stroke-width="${sw}"/>`;
            angle += a;
        });
        svg += '</svg>';
        donutEl.innerHTML = svg;
        legendEl.innerHTML = segments.map(s =>
            `<div style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:8px;border-radius:50%;background:${s.color};flex-shrink:0"></span>${s.label}: ${formatEuro(s.value)}</div>`
        ).join('');
    }

    function renderVBSpendingList(mk) {
        const el = document.getElementById('vbSpendingList');
        if (!el) return;
        const items = appData.spending[mk] || [];
        if (items.length === 0) {
            el.innerHTML = '<div class="empty-state" style="padding:var(--space-sm) 0;font-size:0.82rem">Nog geen uitgaven uit vrij budget.</div>';
            return;
        }
        let html = '';
        items.forEach((item, i) => {
            const editKey = `${mk}|${i}`;
            if (editingVBSpendKey === editKey) {
                html += `<div class="tx-item" style="flex-direction:column;gap:var(--space-sm)">
                    <div style="display:flex;gap:var(--space-sm);width:100%">
                        <input type="text" class="grip-input grip-input-sm" id="editVBAmount" value="${fromCents(item.amountCents)}" inputmode="decimal" style="flex:1">
                        <input type="text" class="grip-input grip-input-sm" id="editVBName" value="${item.name || ''}" placeholder="Omschrijving" style="flex:2">
                    </div>
                    <div style="display:flex;gap:var(--space-sm);width:100%">
                        <button class="btn-add" onclick="saveEditVBSpend('${mk}',${i})" style="flex:1">Opslaan</button>
                        <button class="btn-add" onclick="editingVBSpendKey=null;updateVrijBudget()" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                    </div>
                </div>`;
            } else {
                html += `<div class="tx-item">
                    <div class="tx-info"><div class="tx-note">${item.name}<span class="tx-tag free">${SPENDING_CAT_LABELS[item.cat] || item.cat}</span></div><div class="tx-time">${getTimeStr(item.date)}</div></div>
                    <div class="tx-amount">-${formatEuro(item.amountCents)}</div>
                    <button class="tx-delete" onclick="editingVBSpendKey='${editKey}';updateVrijBudget()" title="Bewerken"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                    <button class="tx-delete" onclick="deleteVBSpending('${mk}',${i})" title="Verwijder"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </div>`;
            }
        });
        el.innerHTML = html;
    }

    function saveEditVBSpend(mk, idx) {
        const item = appData.spending[mk]?.[idx];
        if (!item) return;
        item.amountCents = toCents(parseNum(document.getElementById('editVBAmount')?.value) || 0);
        item.name = document.getElementById('editVBName')?.value?.trim() || item.name;
        saveData();
        editingVBSpendKey = null;
        updateVrijBudget();
        showToast('Aangepast.');
    }

    function vbClearSpendForm() {
        const a = document.getElementById('vbSpendAmount');
        const n = document.getElementById('vbSpendName');
        if (a) a.value = '';
        if (n) n.value = '';
    }

    function vbClearCustomDate() {
        const s = document.getElementById('ovCustomStart');
        const e = document.getElementById('ovCustomEnd');
        const r = document.getElementById('ovCustomResult');
        if (s) s.value = '';
        if (e) e.value = '';
        if (r) r.innerHTML = '';
    }

    function addFreeSpendingVB() {
        const mk = vbViewedMK || getActiveMonthKey();
        const name = document.getElementById('vbSpendName')?.value?.trim() || '';
        const amount = parseNum(document.getElementById('vbSpendAmount')?.value) || 0;
        const cat = document.getElementById('vbSpendCat')?.value || 'overig_vrij';
        if (amount <= 0) { showToast('Vul een bedrag in.'); return; }
        if (!appData.spending[mk]) appData.spending[mk] = [];
        appData.spending[mk].push({
            id: genId('sp'), name: name || SPENDING_CAT_LABELS[cat] || 'Uitgave', amountCents: toCents(amount), cat,
            date: new Date().toISOString()
        });
        saveData();
        document.getElementById('vbSpendName').value = '';
        document.getElementById('vbSpendAmount').value = '';
        updateVrijBudget();
        showToast(`${formatEuro(toCents(amount))} toegevoegd.`);
    }

    function deleteVBSpending(mk, idx) {
        const items = appData.spending[mk];
        if (!items || !items[idx]) return;
        const removed = { ...items[idx] };
        items.splice(idx, 1);
        saveData();
        updateVrijBudget();
        showToast('Verwijderd.', function() {
            if (!appData.spending[mk]) appData.spending[mk] = [];
            appData.spending[mk].splice(idx, 0, removed);
            saveData();
            updateVrijBudget();
        });
    }
    // ═══════════════════════════════════════════════════════════════
    // OVERZICHT (Periode)
    // ═══════════════════════════════════════════════════════════════
    let viewedMonthKey = null;

    function updateOverzicht() {
        try {
            const activeMK = getActiveMonthKey();
            if (!viewedMonthKey) viewedMonthKey = activeMK;

            // i18n section titles
            const s = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
            s('ovDailyTitle', t('dailySpending'));
            s('ovDistTitle', t('distribution'));
            s('ovCalTitle', t('calendar'));
            s('ovSavingsLabel', t('savingsBalance'));
            s('ovAvgLabel', t('avgPerDay'));

            renderPeriodStrip(viewedMonthKey);
            renderOvStats(viewedMonthKey);
            renderOvDailyChart(viewedMonthKey);
            renderOvDonut(viewedMonthKey);
            renderOvCalendar(viewedMonthKey);
        } catch(e) { console.error('Overzicht error:', e); }
    }

    function renderOvStats(mk) {
        const period = getPeriodInfo(mk);
        const today = startOfDay(getNLDate());
        const budget = appData.dailyGroceryBudget || 3500;

        ensureIncomeForMonth(mk);
        const incomeCents = calculateIncomeTotalCents(mk);
        const fixedCents = calculateFixedCostsTotalCents(mk);
        const autoSave = getAutoSaveForMonthCents(mk);
        const daysInPeriod = Math.round((period.endDate - period.startDate) / (1000*60*60*24)) + 1;
        const grocSpent = calculateMonthGroceriesCents(mk);
        const freeSpent = calculateMonthSpendingCents(mk);
        const freeBudget = getFreeBudgetCents(mk);
        const daysPassed = Math.max(1, Math.min(daysInPeriod, Math.round((today - startOfDay(period.startDate)) / (1000*60*60*24)) + 1));
        const dailyAvg = daysPassed > 0 ? Math.round(grocSpent / daysPassed) : 0;

        // Savings
        const savEl = document.getElementById('ovSavingsAmount');
        if (savEl) savEl.textContent = formatEuro(calculateRealtimeSavingsCents());
        const avgEl = document.getElementById('ovDailyAvg');
        if (avgEl) {
            avgEl.textContent = formatEuro(dailyAvg);
            avgEl.style.color = dailyAvg <= budget ? 'var(--green)' : 'var(--red)';
        }

        // Stats
        const statsEl = document.getElementById('ovStatsRows');
        const titleEl = document.getElementById('ovStatsTitle');
        if (titleEl) titleEl.textContent = period.name || mk;
        if (statsEl) {
            const grocBudgetTotal = budget * daysInPeriod;
            const grocSaved = grocBudgetTotal - grocSpent;
            statsEl.innerHTML = `
                <div class="summary-row"><span class="summary-label">${t('income')}</span><span class="summary-value" style="color:var(--green)">${formatEuro(incomeCents)}</span></div>
                <div class="summary-row"><span class="summary-label">${t('fixedCosts')}</span><span class="summary-value" style="color:var(--red)">−${formatEuro(fixedCents)}</span></div>
                <div class="summary-row"><span class="summary-label">${t('autoSave')}</span><span class="summary-value" style="color:var(--accent)">−${formatEuro(autoSave)}</span></div>
                <div class="summary-row"><span class="summary-label">${t('dailyBudget')} (${daysInPeriod}d × ${formatEuro(budget)})</span><span class="summary-value" style="color:var(--text-secondary)">−${formatEuro(grocBudgetTotal)}</span></div>
                <hr class="summary-divider">
                <div class="summary-row summary-total"><span class="summary-label">${t('freeToSpend')}</span><span class="summary-value" style="color:${freeBudget >= 0 ? 'var(--green)' : 'var(--red)'}">${formatEuro(freeBudget)}</span></div>
                <hr class="summary-divider">
                <div style="font-size:0.78rem;font-weight:600;color:var(--text-tertiary);margin:var(--space-sm) 0 var(--space-xs)">${t('actual')}</div>
                <div class="summary-row"><span class="summary-label">${t('dailySpending')}</span><span class="summary-value" style="color:${grocSpent <= grocBudgetTotal ? 'var(--green)' : 'var(--red)'}">−${formatEuro(grocSpent)}</span></div>
                <div class="summary-row"><span class="summary-label">${t('dailySaved')}</span><span class="summary-value" style="color:${grocSaved >= 0 ? 'var(--green)' : 'var(--red)'}">${grocSaved >= 0 ? '+' : ''}${formatEuro(grocSaved)}</span></div>
                <div class="summary-row"><span class="summary-label">${t('freeSpent')}</span><span class="summary-value" style="color:var(--red)">−${formatEuro(freeSpent)}</span></div>
                <div class="summary-row"><span class="summary-label">${t('freeRemaining')}</span><span class="summary-value" style="color:${(freeBudget - freeSpent) >= 0 ? 'var(--green)' : 'var(--red)'}">${formatEuro(freeBudget - freeSpent)}</span></div>
            `;
        }
    }

    function renderOvDailyChart(mk) {
        const el = document.getElementById('ovDailyChart');
        if (!el) return;
        const period = getPeriodInfo(mk);
        const budget = appData.dailyGroceryBudget || 3500;
        const today = startOfDay(getNLDate());
        const daysInPeriod = Math.round((period.endDate - period.startDate) / (1000*60*60*24)) + 1;
        const maxDays = Math.min(daysInPeriod, 31);

        let bars = [];
        let maxAmount = budget;
        for (let d = 0; d < maxDays; d++) {
            const day = new Date(period.startDate);
            day.setDate(day.getDate() + d);
            if (startOfDay(day) > today) break;
            const dateStr = formatDate(day);
            const entries = appData.groceries[mk]?.[dateStr] || [];
            const total = entries.reduce((s, e) => s + (Number(e.amountCents) || 0), 0);
            maxAmount = Math.max(maxAmount, total);
            bars.push({ day: day.getDate(), total, dateStr, isToday: startOfDay(day).getTime() === today.getTime() });
        }

        if (bars.length === 0) { el.innerHTML = '<div class="empty-state">Nog geen data.</div>'; return; }

        const barW = Math.max(14, Math.min(28, Math.floor(280 / bars.length)));
        const gap = 3;
        const chartH = 80;
        const svgW = bars.length * (barW + gap);
        const scale = maxAmount > 0 ? (chartH - 4) / maxAmount : 1;
        const budgetY = chartH - (budget * scale);

        let svg = `<svg width="${svgW}" height="${chartH + 20}" viewBox="0 0 ${svgW} ${chartH + 20}" style="display:block">`;
        // Budget line
        svg += `<line x1="0" y1="${budgetY}" x2="${svgW}" y2="${budgetY}" stroke="var(--accent)" stroke-width="1" stroke-dasharray="4 3" opacity="0.5"/>`;
        bars.forEach((b, i) => {
            const x = i * (barW + gap);
            const h = Math.max(2, b.total * scale);
            const y = chartH - h;
            const fill = b.total > budget ? 'var(--red)' : b.isToday ? 'var(--accent)' : 'var(--green)';
            svg += `<rect x="${x}" y="${y}" width="${barW}" height="${h}" rx="3" fill="${fill}" opacity="${b.isToday ? 1 : 0.7}"/>`;
            svg += `<text x="${x + barW/2}" y="${chartH + 14}" text-anchor="middle" fill="var(--text-muted)" font-size="9" font-family="var(--font)">${b.day}</text>`;
        });
        svg += '</svg>';
        el.innerHTML = svg;
    }

    function renderOvDonut(mk) {
        const donutEl = document.getElementById('ovDonut');
        const legendEl = document.getElementById('ovDonutLegend');
        if (!donutEl || !legendEl) return;

        ensureIncomeForMonth(mk);
        const income = calculateIncomeTotalCents(mk);
        if (income <= 0) { donutEl.innerHTML = ''; legendEl.innerHTML = ''; return; }

        const fixed = calculateFixedCostsTotalCents(mk);
        const autoSave = getAutoSaveForMonthCents(mk);
        const p = getPeriodInfo(mk);
        const daysInPeriod = Math.round((p.endDate - p.startDate) / (1000*60*60*24)) + 1;
        const dagBudgetTotal = (appData.dailyGroceryBudget || 3500) * daysInPeriod;
        const grocSpent = calculateMonthGroceriesCents(mk);
        const freeSpent = calculateMonthSpendingCents(mk);
        const freeBudget = getFreeBudgetCents(mk);
        const rest = Math.max(0, income - fixed - autoSave - dagBudgetTotal - freeSpent);

        const segments = [
            { label: t('fixedCosts'), value: fixed, color: '#8b5cf6' },
            { label: t('autoSave'), value: autoSave, color: '#3b82f6' },
            { label: t('dailyBudget'), value: dagBudgetTotal, color: '#fb923c' },
            { label: t('freeSpent'), value: freeSpent, color: '#f43f5e' },
            { label: 'Resterend', value: rest, color: '#22c55e' },
        ].filter(s => s.value > 0);

        const total = segments.reduce((s, seg) => s + seg.value, 0);
        const size = 100;
        const cx = size / 2, cy = size / 2, r = 38, sw = 14;
        let svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
        let angle = -90;
        segments.forEach(seg => {
            const pct = seg.value / total;
            const a = pct * 360;
            const startAngle = angle * Math.PI / 180;
            const endAngle = (angle + a) * Math.PI / 180;
            const large = a > 180 ? 1 : 0;
            const x1 = cx + r * Math.cos(startAngle);
            const y1 = cy + r * Math.sin(startAngle);
            const x2 = cx + r * Math.cos(endAngle);
            const y2 = cy + r * Math.sin(endAngle);
            if (a > 0.5) {
                svg += `<path d="M${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2}" fill="none" stroke="${seg.color}" stroke-width="${sw}" stroke-linecap="round"/>`;
            }
            angle += a;
        });
        svg += '</svg>';
        donutEl.innerHTML = svg;

        legendEl.innerHTML = segments.map(s =>
            `<div style="display:flex;align-items:center;gap:6px"><span style="width:10px;height:10px;border-radius:50%;background:${s.color};flex-shrink:0"></span>${s.label}: ${formatEuro(s.value)}</div>`
        ).join('');
    }

    function toggleOvPeriod() { /* legacy no-op */ }

    function selectPeriod(mk) {
        viewedMonthKey = mk;
        closeDayDetail();
        updateOverzicht();
    }

    function renderPeriodStrip(selectedMK) {
        const strip = document.getElementById('periodStrip');
        if (!strip) return;
        const today = startOfDay(getNLDate());
        const activeMK = getActiveMonthKey();

        const available = salaryPeriods.filter(p => startOfDay(p.startDate) <= today);
        strip.innerHTML = available.map(p => {
            const isActive = p.key === activeMK;
            const isSelected = p.key === selectedMK;
            const startStr = formatDateNL(p.startDate);
            const endStr = formatDateNL(p.endDate);
            return `<button class="period-chip${isSelected ? ' active' : ''}" onclick="selectPeriod('${p.key}')">
                ${startStr} – ${endStr}${isActive ? '<span class="period-chip-sub">Huidige periode</span>' : ''}
            </button>`;
        }).reverse().join('');

        requestAnimationFrame(() => {
            const activeChip = strip.querySelector('.period-chip.active');
            if (activeChip) activeChip.scrollIntoView({ inline: 'center', block: 'nearest' });
        });
    }



    function renderOvCalendar(mk) {
        const cal = document.getElementById('ovCalendar');
        if (!cal) return;

        const period = getPeriodInfo(mk);
        const pStart = startOfDay(period.startDate);
        const pEnd = startOfDay(period.endDate);
        const today = startOfDay(getNLDate());
        const budget = appData.dailyGroceryBudget || 3500;

        const headers = ['ma','di','wo','do','vr','za','zo'];
        let html = headers.map(h => `<div class="cal-header">${h}</div>`).join('');

        let dow = pStart.getDay();
        dow = dow === 0 ? 6 : dow - 1;
        for (let i = 0; i < dow; i++) html += '<div class="cal-day"></div>';

        const d = new Date(pStart);
        while (d <= pEnd) {
            const dStr = formatDate(d);
            const isToday = d.getTime() === today.getTime();
            const isFuture = d > today;
            const entries = appData.groceries[mk]?.[dStr] || [];
            const hasEntries = entries.length > 0;
            const dayTotal = entries.reduce((s, e) => s + (Number(e.amountCents) || 0), 0);

            let dotClass = 'cal-dot';
            if (isFuture) dotClass += ' empty';
            else if (hasEntries) dotClass += dayTotal <= budget ? ' green' : ' caution';

            const dayClass = 'cal-day' + (isToday ? ' today' : '');
            html += `<div class="${dayClass}" onclick="openDayDetail('${dStr}','${mk}')"><div class="${dotClass}"></div></div>`;
            d.setDate(d.getDate() + 1);
        }

        cal.innerHTML = html;
    }

    let editingOvGrocKey = null;

    function openDayDetail(dateStr, mk) {
        const detail = document.getElementById('ovDayDetail');
        const titleEl = document.getElementById('ovDayTitle');
        const entriesEl = document.getElementById('ovDayEntries');
        if (!detail || !titleEl || !entriesEl) return;

        const date = parseLocalDate(dateStr);
        titleEl.textContent = formatDateNLFull(date);

        const entries = appData.groceries[mk]?.[dateStr] || [];
        const budget = appData.dailyGroceryBudget || 3500;
        const dayTotal = entries.reduce((s, e) => s + (Number(e.amountCents) || 0), 0);
        const diff = budget - dayTotal;

        if (entries.length === 0) {
            entriesEl.innerHTML = `<div class="empty-state" style="padding:var(--space-md) 0">Geen uitgaven op deze dag.</div>`;
        } else {
            let html = `<div style="font-size:0.78rem;color:var(--text-tertiary);margin-bottom:var(--space-sm)">Totaal: ${formatEuro(dayTotal)} van ${formatEuro(budget)} — <span style="color:${diff >= 0 ? 'var(--green)' : 'var(--red)'}">${diff >= 0 ? formatEuro(diff) + ' bespaard' : formatEuro(Math.abs(diff)) + ' over'}</span></div>`;
            html += entries.map((e, i) => {
                const editKey = `${mk}|${dateStr}|${i}`;
                if (editingOvGrocKey === editKey) {
                    return `<div class="tx-item" style="flex-direction:column;gap:var(--space-sm)">
                        <div style="display:flex;gap:var(--space-sm);width:100%">
                            <input type="text" class="grip-input grip-input-sm" id="editOvGrocAmount" value="${fromCents(e.amountCents)}" inputmode="decimal" style="flex:1">
                            <input type="text" class="grip-input grip-input-sm" id="editOvGrocNote" value="${e.note || ''}" placeholder="Notitie" style="flex:2">
                        </div>
                        <div style="display:flex;gap:var(--space-sm);width:100%">
                            <button class="btn-add" onclick="saveEditOvGroc('${mk}','${dateStr}',${i})" style="flex:1">Opslaan</button>
                            <button class="btn-add" onclick="editingOvGrocKey=null;openDayDetail('${dateStr}','${mk}')" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                        </div>
                    </div>`;
                }
                return `<div class="tx-item">
                    <div class="tx-info">
                        <div class="tx-note">${e.note || 'Uitgave'}</div>
                        <div class="tx-time">${getTimeStr(e.timestamp)}</div>
                    </div>
                    <div class="tx-amount">-${formatEuro(e.amountCents)}</div>
                    <button class="tx-delete" onclick="editingOvGrocKey='${editKey}';openDayDetail('${dateStr}','${mk}')" title="Bewerken">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </button>
                </div>`;
            }).join('');
            entriesEl.innerHTML = html;
        }
        detail.classList.add('open');
    }

    function saveEditOvGroc(mk, dateStr, idx) {
        const entry = appData.groceries[mk]?.[dateStr]?.[idx];
        if (!entry) return;
        entry.amountCents = toCents(parseNum(document.getElementById('editOvGrocAmount')?.value) || 0);
        entry.note = document.getElementById('editOvGrocNote')?.value?.trim() || '';
        saveData();
        editingOvGrocKey = null;
        updateOverzicht();
        openDayDetail(dateStr, mk);
        showToast('Aangepast.');
    }

    function closeDayDetail() {
        document.getElementById('ovDayDetail')?.classList.remove('open');
    }

    function deleteGroceryOv(mk, dateStr, idx) {
        const entries = appData.groceries[mk]?.[dateStr];
        if (!entries || !entries[idx]) return;
        const removed = { ...entries[idx] };
        entries.splice(idx, 1);
        if (entries.length === 0) delete appData.groceries[mk][dateStr];
        saveData();
        updateOverzicht();
        openDayDetail(dateStr, mk);
        showToast('Verwijderd.', function() {
            if (!appData.groceries[mk]) appData.groceries[mk] = {};
            if (!appData.groceries[mk][dateStr]) appData.groceries[mk][dateStr] = [];
            appData.groceries[mk][dateStr].splice(idx, 0, removed);
            saveData();
            updateOverzicht();
            openDayDetail(dateStr, mk);
        });
    }

    const SPENDING_CAT_LABELS = {
        kleding: 'Kleding', elektronica: 'Elektronica', horeca: 'Uit eten/drinken',
        cadeaus: 'Cadeaus', gezondheid: 'Gezondheid', hobby: 'Hobby',
        vakantie: 'Vakantie', huishouden: 'Huishouden', auto: 'Auto/vervoer', overig_vrij: 'Overig'
    };

    function showCustomDateRange() {
        const startStr = document.getElementById('ovCustomStart')?.value;
        const endStr = document.getElementById('ovCustomEnd')?.value;
        const resultEl = document.getElementById('ovCustomResult');
        if (!startStr || !endStr || !resultEl) { showToast('Kies een start- en einddatum.'); return; }
        const start = parseLocalDate(startStr);
        const end = parseLocalDate(endStr);
        if (end < start) { showToast('Einddatum moet na startdatum liggen.'); return; }

        // Calculate totals across the date range
        let grocTotal = 0, spendTotal = 0, daysCount = 0;
        const budget = appData.dailyGroceryBudget || 3500;
        const d = new Date(start);
        while (d <= end) {
            daysCount++;
            const dStr = formatDate(d);
            // Check all periods for this date
            for (const period of salaryPeriods) {
                const entries = appData.groceries[period.key]?.[dStr] || [];
                grocTotal += entries.reduce((s, e) => s + (Number(e.amountCents) || 0), 0);
            }
            d.setDate(d.getDate() + 1);
        }
        // Spending per period that overlaps
        for (const period of salaryPeriods) {
            const pStart = startOfDay(period.startDate);
            const pEnd = startOfDay(period.endDate);
            if (pEnd < start || pStart > end) continue;
            spendTotal += calculateMonthSpendingCents(period.key);
        }

        const dailyBudgetTotal = budget * daysCount;
        const grocSaved = dailyBudgetTotal - grocTotal;

        resultEl.innerHTML = `
            <div style="background:var(--glass);border-radius:var(--radius-md);padding:var(--space-lg)">
                <div style="font-size:0.82rem;font-weight:700;margin-bottom:var(--space-sm)">${formatDateNL(start)} – ${formatDateNL(end)} (${daysCount} dagen)</div>
                <div class="summary-row"><span class="summary-label">Dagbudget totaal</span><span class="summary-value">${formatEuro(dailyBudgetTotal)}</span></div>
                <div class="summary-row"><span class="summary-label">Dagelijks uitgegeven</span><span class="summary-value">-${formatEuro(grocTotal)}</span></div>
                <div class="summary-row"><span class="summary-label">Dagelijks bespaard</span><span class="summary-value" style="color:${grocSaved >= 0 ? 'var(--green)' : 'var(--red)'}">${formatEuro(grocSaved)}</span></div>
                <hr class="summary-divider">
                <div class="summary-row"><span class="summary-label">Vrij budget uitgegeven</span><span class="summary-value">-${formatEuro(spendTotal)}</span></div>
            </div>
        `;
    }

    // ═══════════════════════════════════════════════════════════════
    // SPAREN
    // ═══════════════════════════════════════════════════════════════
    function updateSparen() {
        try {
            const activeMK = getActiveMonthKey();
            const realtimeTotal = calculateRealtimeSavingsCents();
            const periodStart = calculateSavingsAtPeriodStartCents(activeMK);
            const periodChange = realtimeTotal - periodStart;

            // i18n labels
            const s = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
            s('sparenViewTitle', t('savingsRace'));
            s('spCardLabel', t('myBalance'));
            s('spMilestonesTitle', t('milestones'));
            s('spBreakdownTitle', t('thisPeriod'));
            s('spCollapseLabel', t('howGripCalc'));
            s('spCorrTitle', t('correctBalanceTitle'));
            s('spCorrExplain', t('correctBalanceExplain'));
            s('spCorrBtn', t('correct'));
            s('spNoGoalText', t('noGoalSet'));
            s('spNoGoalBtn', t('setGoal'));

            // Primary card
            const spTotalEl = document.getElementById('spSavingsTotal');
            spTotalEl.textContent = formatEuro(realtimeTotal);
            spTotalEl.style.color = realtimeTotal < 0 ? 'var(--red)' : '';
            const changeEl = document.getElementById('spSavingsChange');
            const sign = periodChange >= 0 ? '+' : '';
            changeEl.textContent = `${sign}${formatEuro(periodChange)} ${t('thisPeriod').toLowerCase()}`;
            changeEl.style.color = periodChange >= 0 ? 'var(--green)' : 'var(--red)';

            // Has goal?
            const hasGoal = appData.savingsGoalCents && appData.savingsGoalCents > 0;
            const goalReached = hasGoal && realtimeTotal >= appData.savingsGoalCents;

            document.getElementById('spGoalSection').classList.toggle('hidden', !hasGoal || goalReached);
            document.getElementById('spGoalReached').classList.toggle('hidden', !goalReached);
            document.getElementById('spNoGoal').classList.toggle('hidden', hasGoal);

            if (goalReached) {
                s('goalReachedTitle', t('goalReached'));
                s('goalReachedSub', t('goalReachedSub'));
                s('goalReachedNewBtn', t('setNewGoal'));
                s('goalReachedKeep', t('keepGoing'));
                const amtEl = document.getElementById('goalReachedAmount');
                if (amtEl) amtEl.textContent = `${formatEuro(realtimeTotal)} / ${formatEuro(appData.savingsGoalCents)}`;
            } else if (hasGoal) {
                renderSpaarRing(realtimeTotal);
                renderPrediction();
                renderMilestones();
            }

            renderSpBreakdown(activeMK);

        } catch(e) { console.error('Sparen error:', e); }
    }

    function renderSpaarRing(currentCents) {
        const goalCents = appData.savingsGoalCents || 1;
        const pct = Math.min(100, Math.max(0, Math.round((currentCents / goalCents) * 100)));
        const circumference = 2 * Math.PI * 68;

        const ringFill = document.getElementById('spRingFill');
        const ringPct = document.getElementById('spRingPct');
        const ringLabel = document.getElementById('spRingLabel');

        if (ringFill) {
            const offset = circumference - (pct / 100) * circumference;
            ringFill.style.strokeDasharray = circumference;
            ringFill.style.strokeDashoffset = offset;
        }
        if (ringPct) ringPct.textContent = pct + '%';
        if (ringLabel) ringLabel.textContent = `van ${formatEuro(goalCents)}`;
    }

    function calculateSavingsPrediction() {
        const currentCents = calculateRealtimeSavingsCents();
        const goalCents = appData.savingsGoalCents;
        if (!goalCents || goalCents <= 0) return null;
        if (currentCents >= goalCents) return { reached: true, currentCents, goalCents };

        const remainingCents = goalCents - currentCents;
        const today = startOfDay(getNLDate());

        const monthlyData = [];
        for (let i = 0; i < salaryPeriods.length; i++) {
            const p = salaryPeriods[i];
            const pEnd = startOfDay(p.endDate);
            if (pEnd >= today) continue;
            let mSav = 0;
            if (p.salaryDate) mSav += (appData.autoSaveCents || 0);
            mSav += calculateMonthGrocerySavingsCents(p.key);
            mSav += (getFreeBudgetCents(p.key) - calculateMonthSpendingCents(p.key));
            const days = Math.round((pEnd - startOfDay(p.startDate)) / (1000*60*60*24)) + 1;
            monthlyData.push({ key: p.key, savings: mSav, days });
        }

        const activeMK = getActiveMonthKey();
        const activePeriod = getPeriodInfo(activeMK);
        const pStart = startOfDay(activePeriod.startDate);
        const pEnd = startOfDay(activePeriod.endDate);
        const totalDays = Math.round((pEnd - pStart) / (1000*60*60*24)) + 1;
        const elapsedDays = Math.max(1, Math.round((today - pStart) / (1000*60*60*24)) + 1);

        let curSav = 0;
        if (activePeriod.salaryDate) curSav += (appData.autoSaveCents || 0);
        curSav += calculateMonthGrocerySavingsCents(activeMK);
        curSav += (getFreeBudgetCents(activeMK) - calculateMonthSpendingCents(activeMK));
        const extrapolated = Math.round(curSav * (totalDays / elapsedDays));

        let avgMonthlySavings = 0;
        if (monthlyData.length === 0) {
            avgMonthlySavings = elapsedDays >= 3 ? extrapolated : (appData.autoSaveCents || 0) + Math.round(getFreeBudgetCents(activeMK) * 0.5);
        } else {
            let totalWeight = 0, weightedSum = 0;
            const all = [...monthlyData];
            if (elapsedDays >= 5) all.push({ key: activeMK, savings: extrapolated, days: totalDays });
            all.forEach((m, i) => {
                const weight = Math.pow(1.5, i);
                weightedSum += m.savings * weight;
                totalWeight += weight;
            });
            avgMonthlySavings = Math.round(weightedSum / totalWeight);
        }

        if (avgMonthlySavings <= 0) {
            return { reachable: false, currentCents, goalCents, remainingCents, avgMonthlySavings: 0, monthlyData };
        }

        const monthsNeeded = remainingCents / avgMonthlySavings;
        const estimatedDate = new Date(today);
        estimatedDate.setDate(estimatedDate.getDate() + Math.ceil(monthsNeeded * 30.44));

        const pctNow = Math.round((currentCents / goalCents) * 100);
        const milestones = [];
        [25, 50, 75, 100].forEach(pct => {
            const targetCents = Math.round(goalCents * pct / 100);
            if (targetCents <= currentCents) {
                milestones.push({ pct, reached: true, date: null });
            } else {
                const needed = targetCents - currentCents;
                const months = needed / avgMonthlySavings;
                const d = new Date(today);
                d.setDate(d.getDate() + Math.ceil(months * 30.44));
                milestones.push({ pct, reached: false, date: d });
            }
        });

        let confidence = 'laag';
        if (monthlyData.length >= 3) confidence = 'hoog';
        else if (monthlyData.length >= 1 || elapsedDays >= 14) confidence = 'gemiddeld';

        return { reachable: true, currentCents, goalCents, remainingCents, avgMonthlySavings, estimatedDate, monthsNeeded: Math.ceil(monthsNeeded), milestones, pctNow, confidence, dataPoints: monthlyData.length + (elapsedDays >= 5 ? 1 : 0) };
    }

    function renderPrediction() {
        const el = document.getElementById('spPrediction');
        if (!el) return;
        const pred = calculateSavingsPrediction();

        if (!pred) { el.innerHTML = ''; return; }

        if (pred.reached) {
            el.innerHTML = ''; // Goal reached UI handled by updateSparen celebration card
            return;
        }

        if (!pred.reachable) {
            el.innerHTML = `<div class="pred-sub">${t('spendingOverBudget')}</div>`;
            return;
        }

        const dateStr = tMonth(pred.estimatedDate.getMonth()).toLowerCase() + ' ' + pred.estimatedDate.getFullYear();

        const confColors = { hoog: 'var(--green)', gemiddeld: 'var(--accent)', laag: 'var(--text-tertiary)' };
        const confLabels = { hoog: t('highConf'), gemiddeld: t('medConf'), laag: t('lowConf') };

        el.innerHTML = `
            <div class="pred-date">${t('estimated')}: ${dateStr}</div>
            <div class="pred-sub">~${formatEuro(pred.avgMonthlySavings)} ${t('perMonthAvg')}</div>
            <div class="pred-confidence" style="color:${confColors[pred.confidence]}">● ${confLabels[pred.confidence]}</div>
        `;
    }

    function renderMilestones() {
        const el = document.getElementById('spMilestones');
        const card = document.getElementById('spMilestonesCard');
        if (!el || !card) return;

        const pred = calculateSavingsPrediction();
        if (!pred || !pred.milestones) { card.classList.add('hidden'); return; }
        card.classList.remove('hidden');

        const months = MONTH_NAMES_NL;
        el.innerHTML = pred.milestones.map(m => {
            if (m.reached) {
                return `<div class="milestone-item">
                    <div class="milestone-pct">${m.pct}%</div>
                    <div class="milestone-status">Behaald</div>
                    <div class="milestone-check">✓</div>
                </div>`;
            } else if (m.date) {
                const dateStr = months[m.date.getMonth()].toLowerCase() + ' ' + m.date.getFullYear();
                return `<div class="milestone-item">
                    <div class="milestone-pct">${m.pct}%</div>
                    <div class="milestone-status">${dateStr}</div>
                </div>`;
            }
            return '';
        }).join('');
    }

    function renderSpBreakdown(mk) {
        const el = document.getElementById('spBreakdown');
        if (!el) return;

        const autoSave = getAutoSaveForMonthCents(mk);
        const grocSav = calculateMonthGrocerySavingsCents(mk);
        const freeLeft = getFreeBudgetCents(mk) - calculateMonthSpendingCents(mk);
        const total = autoSave + grocSav + freeLeft;

        el.innerHTML = `
            <div class="breakdown-row"><span class="breakdown-label">Auto-sparen</span><span class="breakdown-value">${formatEuro(autoSave)}</span></div>
            <div class="breakdown-row"><span class="breakdown-label">Dagelijks bespaard</span><span class="breakdown-value" style="color:${grocSav >= 0 ? 'var(--green)' : 'var(--red)'}">${grocSav >= 0 ? '+' : ''}${formatEuro(grocSav)}</span></div>
            <div class="breakdown-row"><span class="breakdown-label">Vrij budget over</span><span class="breakdown-value" style="color:${freeLeft >= 0 ? 'var(--green)' : 'var(--red)'}">${freeLeft >= 0 ? '+' : ''}${formatEuro(freeLeft)}</span></div>
            <hr class="summary-divider">
            <div class="breakdown-row"><span class="breakdown-label" style="font-weight:700;color:var(--text-primary)">Totaal deze periode</span><span class="breakdown-value" style="color:var(--accent)">${formatEuro(total)}</span></div>
        `;
    }

    function toggleCollapse(btn) {
        const isOpen = btn.classList.toggle('open');
        btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        document.getElementById('spCollapseContent')?.classList.toggle('open');
    }

    // ═══════════════════════════════════════════════════════════════
    // PROFIEL
    // ═══════════════════════════════════════════════════════════════
    function updateProfiel() {
        const av = document.getElementById('profAvatar');
        if (av) av.innerHTML = appData.avatarPhoto ? `<img src="${appData.avatarPhoto}">` : getInitialsHTML(appData.userName, 24);
        const n = document.getElementById('profName');
        if (n) n.textContent = appData.userName || 'Gebruiker';
        const s = document.getElementById('profSince');
        if (s) {
            const d = appData.appStartDate ? parseLocalDate(appData.appStartDate) : new Date();
            const months = ['jan','feb','mrt','apr','mei','jun','jul','aug','sep','okt','nov','dec'];
            s.textContent = `Lid sinds ${months[d.getMonth()]} ${d.getFullYear()}`;
        }
        const pi = document.getElementById('prIncome');
        if (pi) pi.textContent = formatEuro(appData.monthlyIncome || 0);
        const pf = document.getElementById('prFixed');
        if (pf) pf.textContent = formatEuro(calculateFixedCostsTotalCents());
        const pb = document.getElementById('prBudget');
        if (pb) pb.textContent = formatEuro(appData.dailyGroceryBudget || 3500);
        const pg = document.getElementById('prGoal');
        if (pg) pg.textContent = appData.savingsGoalCents ? formatEuro(appData.savingsGoalCents) : 'Geen doel';
        const pas = document.getElementById('prAutoSave');
        if (pas) pas.textContent = formatEuro(appData.autoSaveCents || 0) + '/mnd';
        const ps = document.getElementById('prSalary');
        if (ps) ps.textContent = (appData.defaultSalaryDay || 24) + 'e';
        const pn = document.getElementById('prNameVal');
        if (pn) pn.textContent = appData.userName || '';
        const pt = document.getElementById('prTheme');
        if (pt) pt.textContent = appData.theme === 'dark' ? 'Donker' : 'Licht';
        const bt = document.getElementById('biometrieToggle');
        if (bt) bt.classList.toggle('on', !!appData.biometrie);
    }

    function openSub(id) {
        const panel = document.getElementById(id);
        if (!panel) return;
        // Pre-fill fields
        if (id === 'subIncome') {
            document.getElementById('subIncomeVal').value = fromCents(appData.monthlyIncome || 0);
            document.getElementById('subSalaryDay').value = appData.defaultSalaryDay || 24;
        } else if (id === 'subBudget') {
            document.getElementById('subDailyBudget').value = fromCents(appData.dailyGroceryBudget || 3500);
        } else if (id === 'subAutoSave') {
            document.getElementById('subAutoSave2').value = fromCents(appData.autoSaveCents || 0);
        } else if (id === 'subGoal') {
            document.getElementById('subCurrentSavings').textContent = formatEuro(calculateRealtimeSavingsCents());
            document.getElementById('subStartSavings').value = fromCents(appData.startSavingsCents || 0);
            document.getElementById('subSavingsGoal').value = appData.savingsGoalCents ? fromCents(appData.savingsGoalCents) : '';
        } else if (id === 'subPersonal') {
            document.getElementById('subUserName').value = appData.userName || '';
            renderAvatarGrid();
            const tt = document.getElementById('themeToggle');
            if (tt) tt.classList.toggle('on', appData.theme === 'dark');
        } else if (id === 'subFixed') {
            renderFixedCostsList();
        } else if (id === 'subSecurity') {
            initSecurityPanel();
        } else if (id === 'subData') {
            document.getElementById('confirmWipe').value = '';
            document.getElementById('btnWipe').disabled = true;
        }
        panel.classList.add('open');
    }

    function closeSub(id) {
        document.getElementById(id)?.classList.remove('open');
        updateProfiel();
    }

    function saveSubIncome() {
        const inc = parseNum(document.getElementById('subIncomeVal')?.value) || 0;
        const day = parseInt(document.getElementById('subSalaryDay').value) || 24;
        appData.monthlyIncome = toCents(inc);
        appData.defaultSalaryDay = Math.max(1, Math.min(31, day));
        // Save salary date overrides
        saveSalaryOverrides();
        generateSalaryPeriods();
        saveData(); closeSub('subIncome'); showToast('Opgeslagen.');
    }

    function toggleSalaryOverrides(btn) {
        const isOpen = btn.classList.toggle('open');
        btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        const content = document.getElementById('salaryOverrideContent');
        if (content) {
            content.classList.toggle('open');
            if (isOpen) renderSalaryOverrideGrid();
        }
    }

    function renderSalaryOverrideGrid() {
        const grid = document.getElementById('salaryOverrideGrid');
        if (!grid) return;
        const today = new Date();
        const months = MONTH_NAMES_NL;
        const overrides = appData.salaryDates || {};
        let html = '';
        for (let i = 0; i < 12; i++) {
            // Show months starting from current month - 1, up to +11
            const mIdx = (today.getMonth() - 1 + i + 12) % 12;
            const yr = today.getFullYear() + (today.getMonth() - 1 + i < 0 ? -1 : (today.getMonth() - 1 + i >= 12 ? 1 : 0));
            const key = `${yr}-${String(mIdx + 1).padStart(2, '0')}`;
            const val = overrides[key] || '';
            html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--glass-border)">
                <span style="font-size:0.82rem;min-width:80px">${months[mIdx].substring(0, 3)} ${yr}</span>
                <input type="number" class="grip-input grip-input-sm" data-salkey="${key}" value="${val}" min="1" max="31" inputmode="numeric" placeholder="${appData.defaultSalaryDay || 24}" style="width:64px;text-align:center;flex:none">
            </div>`;
        }
        grid.innerHTML = html;
    }

    function saveSalaryOverrides() {
        const inputs = document.querySelectorAll('#salaryOverrideGrid input[data-salkey]');
        if (!inputs.length) return;
        if (!appData.salaryDates) appData.salaryDates = {};
        inputs.forEach(inp => {
            const key = inp.dataset.salkey;
            const val = parseInt(inp.value);
            if (val && val >= 1 && val <= 31) {
                appData.salaryDates[key] = val;
            } else {
                delete appData.salaryDates[key];
            }
        });
    }

    function saveSubBudget() {
        const db = parseNum(document.getElementById('subDailyBudget')?.value) || 35;
        appData.dailyGroceryBudget = toCents(db);
        saveData(); closeSub('subBudget'); showToast('Opgeslagen.');
    }

    function saveSubAutoSave() {
        const as = parseNum(document.getElementById('subAutoSave2')?.value) || 0;
        appData.autoSaveCents = toCents(as);
        saveData(); closeSub('subAutoSave'); showToast('Opgeslagen. Geldt vanaf deze periode.');
    }

    function saveSubGoal() {
        const start = parseNum(document.getElementById('subStartSavings')?.value) || 0;
        const goal = parseNum(document.getElementById('subSavingsGoal')?.value) || 0;
        appData.startSavingsCents = toCents(start);
        appData.savingsGoalCents = goal > 0 ? toCents(goal) : 0;
        saveData(); closeSub('subGoal'); showToast('Opgeslagen.');
    }

    function applySavingsCorrection() {
        const inputEl = document.getElementById('spCorrectionVal') || document.getElementById('subSavingsCorrection');
        const desiredTotal = parseNum(inputEl?.value);
        if (isNaN(desiredTotal)) { showToast(t('enterAmount')); return; }
        const desiredCents = toCents(desiredTotal);
        const currentCalc = calculateRealtimeSavingsCents();
        const diff = desiredCents - currentCalc;
        appData.startSavingsCents = (appData.startSavingsCents || 0) + diff;
        if (!appData.savingsCorrections) appData.savingsCorrections = [];
        appData.savingsCorrections.push({
            date: new Date().toISOString(),
            fromCents: currentCalc,
            toCents: desiredCents,
            adjustmentCents: diff
        });
        saveData();
        if (inputEl) inputEl.value = '';
        // Refresh all views that show savings
        try { updateSparen(); } catch(e) {}
        try { renderSavingsCompact(getActiveMonthKey()); } catch(e) {}
        try { updateDagSparen(); } catch(e) {}
        try { updateMenu(); } catch(e) {}
        showToast(`${t('adjusted')} ${formatEuro(desiredCents)}`);
    }

    function saveSubPersonal() {
        const name = document.getElementById('subUserName').value.trim();
        if (name) appData.userName = name;
        saveData(); closeSub('subPersonal'); showToast('Opgeslagen.');
    }

    function renderAvatarGrid() {
        const grid = document.getElementById('subAvatarGrid');
        if (!grid) return;
        const preview = appData.avatarPhoto
            ? `<img src="${appData.avatarPhoto}">`
            : getInitialsHTML(appData.userName, 24);
        grid.innerHTML = `
            <div class="avatar-upload-area">
                <div class="avatar-preview">${preview}</div>
                <div class="avatar-upload-info">
                    <div style="font-size:0.85rem;font-weight:600;margin-bottom:var(--space-xs)">${appData.avatarPhoto ? 'Foto ingesteld' : 'Initialen als avatar'}</div>
                    <div class="field-helper" style="margin:0">Upload een foto (max 5 MB) of gebruik je initialen.</div>
                    <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-md)">
                        <button class="avatar-upload-btn" onclick="document.getElementById('avatarFileInput').click()">Foto kiezen</button>
                        ${appData.avatarPhoto ? '<button class="avatar-upload-btn" onclick="removeAvatarPhoto()" style="color:var(--caution)">Verwijderen</button>' : ''}
                    </div>
                    <input type="file" id="avatarFileInput" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
                </div>
            </div>
        `;
    }

    function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (file.size > 5 * 1024 * 1024) {
            showToast('Bestand te groot. Maximaal 5 MB.');
            return;
        }
        if (!file.type.startsWith('image/')) {
            showToast('Alleen afbeeldingen zijn toegestaan.');
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            // Resize to max 256px to keep localStorage small
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const max = 256;
                let w = img.width, h = img.height;
                if (w > max || h > max) {
                    if (w > h) { h = Math.round(h * max / w); w = max; }
                    else { w = Math.round(w * max / h); h = max; }
                }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                appData.avatarPhoto = canvas.toDataURL('image/jpeg', 0.8);
                saveData();
                renderAvatarGrid();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function removeAvatarPhoto() {
        appData.avatarPhoto = '';
        saveData();
        renderAvatarGrid();
    }

    function selectAvatar() { /* Legacy no-op */ }

    function toggleTheme() {
        appData.theme = appData.theme === 'dark' ? 'light' : 'dark';
        applyTheme(); saveData();
        document.getElementById('themeToggle')?.classList.toggle('on', appData.theme === 'dark');
    }

    function toggleBiometrie() {
        appData.biometrie = !appData.biometrie;
        saveData();
        document.getElementById('biometrieToggle')?.classList.toggle('on', !!appData.biometrie);
        showToast(appData.biometrie ? 'Biometrie ingeschakeld.' : 'Biometrie uitgeschakeld.');
    }

    function renderFixedCostsList() {
        const el = document.getElementById('subFixedList');
        if (!el) return;
        ensureFixedCostsIds();
        let html = '';
        let total = 0;
        Object.keys(CAT_LABELS).forEach(cat => {
            const items = appData.fixedCosts[cat] || [];
            if (items.length === 0) return;
            html += `<div class="fc-cat-title">${CAT_LABELS[cat]}</div>`;
            items.forEach(item => {
                total += Number(item.amountCents) || 0;
                const isEditing = editingFixedCostId === item.id;
                if (isEditing) {
                    html += `<div class="fc-item" style="flex-direction:column;gap:var(--space-sm)">
                        <div style="display:flex;gap:var(--space-sm);width:100%">
                            <input type="text" class="grip-input grip-input-sm" id="editFcName" value="${item.name}" style="flex:2">
                            <input type="text" class="grip-input grip-input-sm" id="editFcAmount" value="${fromCents(item.amountCents)}" inputmode="decimal" style="flex:1">
                        </div>
                        <div style="display:flex;gap:var(--space-sm);width:100%">
                            <button class="btn-add" onclick="saveEditFixedCost('${cat}','${item.id}')" style="flex:1">Opslaan</button>
                            <button class="btn-add" onclick="cancelEditFixedCost()" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                        </div>
                    </div>`;
                } else {
                    html += `<div class="fc-item">
                        <div class="fc-item-name">${item.name}</div>
                        <div style="display:flex;align-items:center;gap:var(--space-sm)">
                            <span class="fc-item-amount" style="cursor:pointer" onclick="startEditFixedCost('${item.id}')" title="Tik om te bewerken">${formatEuro(item.amountCents)}</span>
                            <button class="tx-delete" onclick="startEditFixedCost('${item.id}')" title="Bewerken" aria-label="Bewerk ${item.name}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                            <button class="tx-delete" onclick="deleteFixedCost('${cat}','${item.id}')" title="Verwijder" aria-label="Verwijder ${item.name}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>`;
                }
            });
        });
        if (total > 0) html += `<div style="padding:var(--space-md) 0;font-weight:700;text-align:right;font-variant-numeric:var(--tabular)">Totaal: ${formatEuro(total)}/maand</div>`;
        if (!html) html = '<div class="empty-state">Nog geen vaste lasten.</div>';
        el.innerHTML = html;
    }

    let editingFixedCostId = null;

    function startEditFixedCost(id) {
        editingFixedCostId = id;
        renderFixedCostsList();
    }

    function cancelEditFixedCost() {
        editingFixedCostId = null;
        renderFixedCostsList();
    }

    function saveEditFixedCost(cat, id) {
        const name = document.getElementById('editFcName')?.value?.trim();
        const amount = parseNum(document.getElementById('editFcAmount')?.value) || 0;
        if (!name || amount <= 0) { showToast('Vul naam en bedrag in.'); return; }
        const items = appData.fixedCosts[cat] || [];
        const item = items.find(x => x.id === id);
        if (item) {
            item.name = name;
            item.amountCents = toCents(amount);
            saveData();
            showToast('Aangepast.');
        }
        editingFixedCostId = null;
        renderFixedCostsList();
    }

    function addFixedCost() {
        const name = document.getElementById('subFcName').value.trim();
        const amount = parseNum(document.getElementById('subFcAmount')?.value) || 0;
        const cat = document.getElementById('subFcCat').value || 'overig';
        if (!name || amount <= 0) { showToast('Vul naam en bedrag in.'); return; }
        ensureFixedCostsIds();
        if (!Array.isArray(appData.fixedCosts[cat])) appData.fixedCosts[cat] = [];
        appData.fixedCosts[cat].push({ id: genId('fix'), name, amountCents: toCents(amount) });
        saveData();
        document.getElementById('subFcName').value = '';
        document.getElementById('subFcAmount').value = '';
        renderFixedCostsList();
        showToast('Toegevoegd.');
    }

    function deleteFixedCost(cat, id) {
        const items = appData.fixedCosts[cat] || [];
        const idx = items.findIndex(x => x.id === id);
        if (idx === -1) return;
        const removed = items.splice(idx, 1)[0];
        saveData();
        renderFixedCostsList();
        showToast('Verwijderd.', function() {
            appData.fixedCosts[cat].splice(idx, 0, removed);
            saveData(); renderFixedCostsList();
        });
    }

    // ─── FIXED COST PER-PERIOD OVERRIDES ───
    function toggleFixedOverrides(btn) {
        const isOpen = btn.classList.toggle('open');
        btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        const content = document.getElementById('fixedOverrideContent');
        if (content) {
            content.classList.toggle('open');
            if (isOpen) renderFixedOverrides();
        }
    }

    function renderFixedOverrides() {
        // Populate period selector
        const select = document.getElementById('fcOverridePeriod');
        if (select) {
            select.innerHTML = salaryPeriods.map(p =>
                `<option value="${p.key}">${p.name}</option>`
            ).join('');
            // Default to active period
            const activeMK = getActiveMonthKey();
            select.value = activeMK;
        }
        renderFixedOverrideList();
        // Listen for changes
        select?.addEventListener('change', renderFixedOverrideList);
    }

    function renderFixedOverrideList() {
        const el = document.getElementById('fcOverrideList');
        const mk = document.getElementById('fcOverridePeriod')?.value;
        if (!el || !mk) return;
        if (!appData.fixedCostOverrides) appData.fixedCostOverrides = {};
        const items = appData.fixedCostOverrides[mk] || [];
        if (items.length === 0) {
            el.innerHTML = `<div class="empty-state" style="padding:var(--space-sm) 0;font-size:0.78rem">Geen afwijkingen voor deze periode. Standaard vaste lasten gelden.</div>`;
            return;
        }
        let html = '';
        items.forEach((item, i) => {
            html += `<div class="tx-item">
                <div class="tx-info"><div class="tx-note">${item.name}</div></div>
                <div class="tx-amount">${formatEuro(item.amountCents)}</div>
                <button class="tx-delete" onclick="deleteFixedOverride('${mk}',${i})" title="Verwijder" aria-label="Verwijder afwijking">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
            </div>`;
        });
        const total = items.reduce((s, it) => s + (Number(it.amountCents) || 0), 0);
        html += `<div style="padding:var(--space-xs) 0;font-size:0.78rem;font-weight:700;text-align:right">Afwijking totaal: ${formatEuro(total)}</div>`;
        el.innerHTML = html;
    }

    function addFixedCostOverride() {
        const mk = document.getElementById('fcOverridePeriod')?.value;
        const name = document.getElementById('fcOverrideName')?.value?.trim();
        const amount = parseNum(document.getElementById('fcOverrideAmount')?.value) || 0;
        if (!mk || !name || amount <= 0) { showToast('Vul periode, naam en bedrag in.'); return; }
        if (!appData.fixedCostOverrides) appData.fixedCostOverrides = {};
        if (!appData.fixedCostOverrides[mk]) appData.fixedCostOverrides[mk] = [];
        appData.fixedCostOverrides[mk].push({ id: genId('fco'), name, amountCents: toCents(amount) });
        saveData();
        document.getElementById('fcOverrideName').value = '';
        document.getElementById('fcOverrideAmount').value = '';
        renderFixedOverrideList();
        showToast('Afwijking toegevoegd voor deze periode.');
    }

    function deleteFixedOverride(mk, idx) {
        if (!appData.fixedCostOverrides?.[mk]) return;
        appData.fixedCostOverrides[mk].splice(idx, 1);
        if (appData.fixedCostOverrides[mk].length === 0) delete appData.fixedCostOverrides[mk];
        saveData();
        renderFixedOverrideList();
        showToast('Afwijking verwijderd.');
    }

    // ─── INCOME PER-PERIOD OVERRIDES ───
    function toggleIncomeOverrides(btn) {
        const isOpen = btn.classList.toggle('open');
        btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        const content = document.getElementById('incomeOverrideContent');
        if (content) {
            content.classList.toggle('open');
            if (isOpen) renderIncomeOverrideGrid();
        }
    }

    function renderIncomeOverrideGrid() {
        const grid = document.getElementById('incomeOverrideGrid');
        if (!grid) return;
        if (!appData.incomeByMonth) appData.incomeByMonth = {};
        const defaultIncome = fromCents(appData.monthlyIncome || 0);
        let html = '';
        salaryPeriods.forEach(p => {
            const override = appData.incomeByMonth[p.key];
            const val = override !== undefined ? fromCents(override) : '';
            html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--glass-border)">
                <span style="font-size:0.82rem;min-width:100px">${p.name}</span>
                <input type="text" class="grip-input grip-input-sm" data-inckey="${p.key}" value="${val}" inputmode="decimal" placeholder="${defaultIncome}" style="width:80px;text-align:center;flex:none">
            </div>`;
        });
        html += `<button class="btn-add" onclick="saveIncomeOverrides()" style="width:100%;margin-top:var(--space-md)">Afwijkingen opslaan</button>`;
        grid.innerHTML = html;
    }

    function saveIncomeOverrides() {
        const inputs = document.querySelectorAll('#incomeOverrideGrid input[data-inckey]');
        if (!inputs.length) return;
        if (!appData.incomeByMonth) appData.incomeByMonth = {};
        inputs.forEach(inp => {
            const key = inp.dataset.inckey;
            const val = parseNum(inp.value);
            if (!isNaN(val) && val > 0) {
                appData.incomeByMonth[key] = toCents(val);
            } else {
                delete appData.incomeByMonth[key];
            }
        });
        // Re-generate income entries for affected months
        inputs.forEach(inp => {
            const key = inp.dataset.inckey;
            if (appData.income?.[key]) {
                delete appData.income[key]; // Force regeneration
            }
        });
        saveData();
        showToast('Inkomen-afwijkingen opgeslagen.');
    }

    function initSecurityPanel() {
        const el = document.getElementById('securityContent');
        if (!el) return;
        el.innerHTML = `
            <div class="field-group"><div class="field-label">PIN wijzigen</div>
            <div class="field-helper" style="margin-bottom:var(--space-md)">Voer eerst je huidige PIN in.</div>
            <div id="secPinFlow"></div></div>
        `;
        secPinState = 'current';
        secPinValue = '';
        renderSecPinFlow();
    }

    let secPinState = 'current'; // current → new → confirm
    let secPinValue = '';
    let secNewPin = '';

    function renderSecPinFlow() {
        const el = document.getElementById('secPinFlow');
        if (!el) return;
        const labels = { current: 'Huidige PIN', 'new': 'Nieuwe PIN', confirm: 'Bevestig nieuwe PIN' };
        el.innerHTML = `
            <div style="text-align:center;margin-bottom:var(--space-lg)">
                <div style="font-size:0.82rem;color:var(--text-tertiary);margin-bottom:var(--space-md)">${labels[secPinState]}</div>
                <div class="pin-dots" style="justify-content:center">${[0,1,2,3].map(i => `<div class="pin-dot${i < secPinValue.length ? ' filled' : ''}"></div>`).join('')}</div>
                <div class="pin-error" id="secPinError"></div>
            </div>
            <div class="pin-keypad" style="margin:0 auto">${[1,2,3,4,5,6,7,8,9,'⌫',0,''].map(k => {
                if (k === '⌫') return `<button class="pin-key" onclick="secPinKey('del')" style="font-size:1.1rem">&#9003;</button>`;
                if (k === '') return '<div></div>';
                return `<button class="pin-key" onclick="secPinKey('${k}')">${k}</button>`;
            }).join('')}</div>
        `;
    }

    function secPinKey(k) {
        if (k === 'del') { secPinValue = secPinValue.slice(0, -1); renderSecPinFlow(); return; }
        if (secPinValue.length >= 4) return;
        secPinValue += k;
        renderSecPinFlow();
        if (secPinValue.length === 4) {
            setTimeout(() => {
                if (secPinState === 'current') {
                    if (secPinValue === appData.pin) {
                        secPinState = 'new'; secPinValue = ''; renderSecPinFlow();
                    } else {
                        document.getElementById('secPinError').textContent = 'Onjuiste PIN.';
                        document.getElementById('secPinError').classList.add('show');
                        secPinValue = ''; renderSecPinFlow();
                    }
                } else if (secPinState === 'new') {
                    secNewPin = secPinValue; secPinState = 'confirm'; secPinValue = ''; renderSecPinFlow();
                } else if (secPinState === 'confirm') {
                    if (secPinValue === secNewPin) {
                        appData.pin = secNewPin; saveData();
                        showToast('PIN gewijzigd.');
                        closeSub('subSecurity');
                    } else {
                        document.getElementById('secPinError').textContent = 'PINs komen niet overeen.';
                        document.getElementById('secPinError').classList.add('show');
                        secPinState = 'new'; secPinValue = ''; renderSecPinFlow();
                    }
                }
            }, 200);
        }
    }

    function downloadBackup() {
        const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'grip-backup-' + formatDate(new Date()) + '.json';
        a.click(); URL.revokeObjectURL(url);
        showToast('Backup gedownload.');
    }

    function checkWipeConfirm() {
        const val = document.getElementById('confirmWipe')?.value || '';
        document.getElementById('btnWipe').disabled = val !== 'GRIP';
    }

    function wipeData() {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem('budgetAppData_v18b');
        location.reload();
    }

    // ═══════════════════════════════════════════════════════════════
    // ONBOARDING (8 steps)
    // ═══════════════════════════════════════════════════════════════
    const OB_STEPS = 9;
    let obStep = 0;
    let obData = {
        name:'', pin:'', pinConfirm:'',
        appStartDate: formatDate(new Date()),
        salaryMode: 'fixed',
        salaryDay: 24,
        salaryByMonth: {},
        income: 0, dailyBudget: 35,
        fixedMode: 'total',
        householdType: '', // alone, couple, family
        region: '', // randstad, rest
        personaQ4: '',
        personaQ5: '',
        fixedTotal: 0,
        fixedItems: [],
        autoSave: 100, startSavings: 0, savingsGoal: 0
    };
    let obPinPhase = 'choose';

    const MONTH_DAYS = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

    function obSaveIncome() {
        const el = document.getElementById('obIncome');
        if (el) { const v = parseNum(el.value); if (v > 0) obData.income = v; }
    }

    function startOnboarding() {
        obStep = 0;
        obData = {
            name:'', pin:'', pinConfirm:'',
            appStartDate: formatDate(new Date()),
            salaryMode: 'fixed', salaryDay: 24, salaryByMonth: {},
            income: 0, dailyBudget: 35,
            fixedMode: 'total', fixedTotal: 0, fixedItems: [],
            householdType: '', region: '',
            personaQ4: '', personaQ5: '',
            autoSave: 100, startSavings: 0, savingsGoal: 0
        };
        obPinPhase = 'choose';
        document.getElementById('onboarding').classList.remove('hidden');
        renderObStep();
    }

    function renderObStep() {
        const prog = document.getElementById('obProgress');
        prog.innerHTML = Array.from({length: OB_STEPS}, (_, i) =>
            `<div class="ob-progress-dot${i < obStep ? ' done' : ''}${i === obStep ? ' current' : ''}"></div>`
        ).join('');

        document.getElementById('obStepLabel').textContent = `${obStep + 1} / ${OB_STEPS}`;

        const content = document.getElementById('obContent');
        const nav = document.getElementById('obNav');
        const backBtn = `<button class="ob-nav-back" onclick="obBack()">${t('back')}</button>`;
        const nextBtn = `<button class="ob-nav-next" onclick="obNext()">${t('next')}</button>`;

        if (obStep === 0) {
            // WELKOM + NAAM
            content.innerHTML = `
                <div class="ob-step-title">${t('welcomeTitle')}</div>
                <div class="ob-step-sub">${t('welcomeSub')}</div>
                <div class="field-group"><div class="field-label">${t('yourName')}</div>
                <input type="text" class="grip-input" id="obName" placeholder="${t('namePlaceholder')}" value="${obData.name}"></div>
            `;
            nav.innerHTML = `${nextBtn}`;

        } else if (obStep === 1) {
            // PIN
            const label = obPinPhase === 'choose' ? t('pinChoose') : t('pinConfirm');
            const dots = obPinPhase === 'choose' ? obData.pin : obData.pinConfirm;
            content.innerHTML = `
                <div class="ob-step-title">${t('choosePIN')}</div>
                <div class="ob-step-sub">${t('pinSub')}</div>
                <div style="text-align:center">
                    <div style="font-size:0.82rem;color:var(--text-tertiary);margin-bottom:var(--space-md)">${label}</div>
                    <div class="pin-dots" style="justify-content:center">${[0,1,2,3].map(i => `<div class="pin-dot${i < dots.length ? ' filled' : ''}"></div>`).join('')}</div>
                    <div class="pin-error" id="obPinError"></div>
                </div>
                <div class="pin-keypad" style="margin:var(--space-xl) auto 0">${[1,2,3,4,5,6,7,8,9,'⌫',0,''].map(k => {
                    if (k === '⌫') return `<button class="pin-key" onclick="obPinKey('del')" style="font-size:1.1rem">&#9003;</button>`;
                    if (k === '') return '<div></div>';
                    return `<button class="pin-key" onclick="obPinKey('${k}')">${k}</button>`;
                }).join('')}</div>
            `;
            nav.innerHTML = `${backBtn}<div style="flex:1"></div>`;

        } else if (obStep === 2) {
            // STARTDATUM
            content.innerHTML = `
                <div class="ob-step-title">${t('whenStart')}</div>
                <div class="field-group"><div class="field-label">${t('startDate')}</div>
                <input type="date" class="grip-input" id="obStartDate" value="${obData.appStartDate}">
                <div class="field-helper">${t('startDateHelper')}</div></div>
            `;
            nav.innerHTML = `${backBtn}${nextBtn}`;

        } else if (obStep === 3) {
            // SALARISDAG - simplified: just one day
            content.innerHTML = `
                <div class="ob-step-title">Wanneer krijg je salaris?</div>
                <div class="ob-step-sub">GRIP rekent vanaf je salarisdag. Zo weet je precies wat je tot de volgende kunt uitgeven.</div>
                <div class="field-group">
                    <div class="field-label">Dag van de maand</div>
                    <input type="text" class="grip-input" id="obSalaryDay" value="${obData.salaryDay}" inputmode="numeric" placeholder="bijv. 24" style="text-align:center;font-size:1.2rem;font-weight:700">
                    <div class="field-helper" style="margin-top:var(--space-sm);color:var(--accent)">Wordt je salaris soms een dag eerder of later gestort? Geen probleem, dat kun je later per maand aanpassen.</div>
                </div>
            `;
            nav.innerHTML = `${backBtn}${nextBtn}`;

        } else if (obStep === 4) {
            // JE SITUATIE
            const hhVal = obData.householdType || '';
            const regVal = obData.region || '';
            const q4Val = obData.personaQ4 || '';

            const hhOptions = [
                { key: 'alone', text: 'Alleenstaand' },
                { key: 'couple', text: 'Samenwonend' },
                { key: 'family', text: 'Gezin met kinderen' }
            ];
            const regOptions = [
                { key: 'randstad', text: 'Randstad' },
                { key: 'rest', text: 'Buiten de Randstad' }
            ];
            const q4Options = [
                { key: 'very_predictable', text: 'Heel vast' },
                { key: 'mostly_predictable', text: 'Redelijk vast' },
                { key: 'often_surprises', text: 'Wisselend' },
                { key: 'chaotic', text: 'Heel wisselend' }
            ];

            content.innerHTML = `
                <div class="ob-step-title">Je situatie</div>
                <div class="ob-step-sub">Dit helpt GRIP om een realistisch budget voor te stellen.</div>

                <div class="field-group">
                    <div class="field-label">Netto inkomen per maand</div>
                    <input type="text" class="grip-input" id="obIncome" value="${obData.income || ''}" inputmode="decimal" placeholder="0,00">
                    <div class="field-helper" style="margin-top:var(--space-xs);color:var(--accent)">Verdien je niet elke maand hetzelfde? Vul een gemiddelde in. Je kunt dit later per maand aanpassen.</div>
                </div>

                <div class="field-group" style="margin-top:var(--space-lg)">
                    <div class="field-label">Huishouden</div>
                    <div style="display:flex;gap:var(--space-xs);margin-top:var(--space-xs)">
                        ${hhOptions.map(o => `<button class="quick-chip${hhVal===o.key?' edit-chip':''}" style="flex:1;${hhVal===o.key?'background:var(--accent-dim);border-color:var(--accent);color:var(--accent)':''}" onclick="obSaveIncome();obData.householdType='${o.key}';renderObStep()">${o.text}</button>`).join('')}
                    </div>
                </div>

                <div class="field-group" style="margin-top:var(--space-lg)">
                    <div class="field-label">Regio</div>
                    <div style="display:flex;gap:var(--space-xs);margin-top:var(--space-xs)">
                        ${regOptions.map(o => `<button class="quick-chip${regVal===o.key?' edit-chip':''}" style="flex:1;${regVal===o.key?'background:var(--accent-dim);border-color:var(--accent);color:var(--accent)':''}" onclick="obSaveIncome();obData.region='${o.key}';renderObStep()">${o.text}</button>`).join('')}
                    </div>
                </div>

                <div class="field-group" style="margin-top:var(--space-lg)">
                    <div class="field-label">Hoe voorspelbaar zijn je uitgaven?</div>
                    <div style="display:flex;flex-wrap:wrap;gap:var(--space-xs);margin-top:var(--space-xs)">
                        ${q4Options.map(o => `<button class="quick-chip${q4Val===o.key?' edit-chip':''}" style="flex:1;min-width:45%;${q4Val===o.key?'background:var(--accent-dim);border-color:var(--accent);color:var(--accent)':''}" onclick="obSaveIncome();obData.personaQ4='${o.key}';renderObStep()">${o.text}</button>`).join('')}
                    </div>
                </div>
            `;
            nav.innerHTML = `${backBtn}${nextBtn}`;

        } else if (obStep === 5) {
            // VASTE LASTEN - simplified: default to total
            content.innerHTML = `
                <div class="ob-step-title">${t('fixedCostsTitle')}</div>
                <div class="ob-step-sub">Huur, energie, verzekeringen, abonnementen. Alles wat elke maand automatisch afgaat.</div>
                <div class="field-group">
                    <div class="field-label">Totaal vaste lasten per maand</div>
                    <input type="text" class="grip-input" id="obFixed" value="${obData.fixedTotal || ''}" inputmode="decimal" placeholder="0,00">
                    <div class="field-helper" style="margin-top:var(--space-sm)">Tip: kijk in je bankapp wat er vorige maand is afgeschreven. Een schatting is ook prima.</div>
                    <div class="field-helper" style="margin-top:var(--space-xs);color:var(--accent)">Hoe nauwkeuriger, hoe beter je profiel. Later kun je dit per categorie uitsplitsen.</div>
                </div>

                <div style="background:var(--glass);border-radius:var(--radius-md);padding:var(--space-md);margin-top:var(--space-xl)">
                    <div style="font-size:0.72rem;font-weight:700;margin-bottom:var(--space-xs)">Wat is gemiddeld?</div>
                    <div style="font-size:0.72rem;color:var(--text-secondary);line-height:1.6">
                        ${obData.householdType === 'alone' ? 'Nibud: een alleenstaande is gemiddeld €950 tot €1.200 kwijt aan vaste lasten.' : obData.householdType === 'family' ? 'Nibud: een gezin met kinderen is gemiddeld €1.600 tot €2.100 kwijt aan vaste lasten.' : 'Nibud: een stel zonder kinderen is gemiddeld €1.300 tot €1.700 kwijt aan vaste lasten.'}
                        ${obData.region === 'randstad' ? ' In de Randstad liggen woonlasten gemiddeld hoger.' : ''}
                    </div>
                </div>
            `;
            nav.innerHTML = `${backBtn}${nextBtn}`;

        } else if (obStep === 6) {
            // SPAREN
            content.innerHTML = `
                <div class="ob-step-title">${t('savingsTitle')}</div>
                <div class="ob-step-sub">${t('savingsSub2')}</div>
                <div class="field-group"><div class="field-label">${t('autoSavePerMonth')}</div>
                <input type="text" class="grip-input" id="obAutoSave" value="${obData.autoSave || 100}" inputmode="decimal">
                <div class="field-helper" style="margin-top:var(--space-xs);color:var(--accent)">Geef hier een goede indicatie. GRIP stemt je dagbudget en profiel hierop af. Je kunt dit later altijd aanpassen.</div></div>
                <div class="field-group"><div class="field-label">${t('currentSavings')}</div>
                <input type="text" class="grip-input" id="obStartSavings" value="${obData.startSavings || ''}" inputmode="decimal" placeholder="0,00">
                <div class="field-helper">${t('howMuchSaved')}</div></div>
                <div class="field-group"><div class="field-label">${t('savingsGoalOpt')}</div>
                <input type="text" class="grip-input" id="obGoal" value="${obData.savingsGoal || ''}" inputmode="decimal" placeholder=""></div>
            `;
            nav.innerHTML = `${backBtn}${nextBtn}`;

        } else if (obStep === 7) {
            // DAGBUDGET VOORSTEL
            const incomeCents = toCents(obData.income);
            const fixedCents = toCents(obData.fixedTotal || 0);
            const autoSaveCents = toCents(obData.autoSave || 0);
            const salDay = obData.salaryDay || 24;
            const now = new Date();
            const periodStart = new Date(now.getFullYear(), now.getMonth(), salDay);
            const periodEnd = new Date(now.getFullYear(), now.getMonth() + 1, salDay - 1);
            const periodDays = Math.max(1, Math.round((periodEnd - periodStart) / (1000*60*60*24)) + 1);

            const suggestion = suggestDailyBudgetCents({
                incomeCents, fixedCostsCents: fixedCents,
                autoSaveCents, periodDays,
                persona: 'bewuste', q4: obData.personaQ4 || '',
                householdType: obData.householdType || 'couple',
                region: obData.region || 'rest'
            });

            obData.dailyBudget = fromCents(suggestion.suggestedCents);

            const available = incomeCents - fixedCents - autoSaveCents;
            const hhLabel = { alone: 'alleenstaande', couple: 'stel', family: 'gezin' }[obData.householdType] || 'huishouden';
            const q4Label = { very_predictable: 'heel voorspelbaar', mostly_predictable: 'redelijk voorspelbaar', often_surprises: 'wisselend', chaotic: 'heel wisselend' }[obData.personaQ4] || '';

            // Build personal explanation
            let explanation = `Van je inkomen van <strong style="color:var(--accent)">${formatEuro(incomeCents)}</strong> gaat <strong style="color:var(--red)">${formatEuro(fixedCents)}</strong> <span style="color:var(--red)">af</span> aan vaste lasten`;
            if (autoSaveCents > 0) explanation += ` en <strong style="color:#60A5FA">${formatEuro(autoSaveCents)}</strong> naar sparen`;
            explanation += `. Dat laat <strong style="color:var(--green)">${formatEuro(available)}</strong> over voor <strong>${periodDays} dagen</strong>.`;

            let bufferExplain = `GRIP houdt ${suggestion.bufferPct}% daarvan apart als buffer. `;
            if (obData.personaQ4 === 'often_surprises' || obData.personaQ4 === 'chaotic') {
                bufferExplain += `Omdat je aangaf dat je uitgaven ${q4Label} zijn, is de buffer iets groter. Zo kom je niet voor verrassingen te staan.`;
            } else {
                bufferExplain += `Dit is voor onverwachte uitgaven, zoals een kapot apparaat of een etentje dat je niet had gepland.`;
            }

            let extraExplain = '';
            if (suggestion.householdExtraCents > 0 || suggestion.regionExtraCents > 0) {
                extraExplain = 'Daarnaast rekent GRIP met hogere dagelijkse basiskosten';
                if (suggestion.householdExtraCents > 0) extraExplain += ` als ${hhLabel} (Nibud-richtbedragen)`;
                if (suggestion.regionExtraCents > 0) extraExplain += `${suggestion.householdExtraCents > 0 ? ' en' : ''} in de Randstad`;
                extraExplain += '.';
            }

            content.innerHTML = `
                <div class="ob-step-title">Je dagbudget</div>

                <div style="background:rgba(226,169,59,0.06);border:1px solid rgba(226,169,59,0.15);border-radius:var(--radius-lg);padding:var(--space-xl);text-align:center;margin-bottom:var(--space-lg)">
                    <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:var(--accent);margin-bottom:var(--space-xs)">Voorgesteld dagbudget</div>
                    <div style="font-size:2rem;font-weight:900;color:var(--text-primary);font-variant-numeric:var(--tabular)">${formatEuro(suggestion.suggestedCents)}</div>
                    <div style="font-size:0.72rem;color:var(--text-muted);margin-top:var(--space-xs)">per dag, ${periodDays} dagen deze periode</div>
                </div>

                <div style="background:var(--glass);border-radius:var(--radius-md);padding:var(--space-md);margin-bottom:var(--space-lg)">
                    <div style="font-size:0.78rem;color:var(--text-secondary);line-height:1.7">
                        ${explanation}
                    </div>
                </div>

                <div class="field-group">
                    <div class="field-label">Pas aan als je wilt</div>
                    <input type="text" class="grip-input" id="obBudget" value="${obData.dailyBudget}" inputmode="decimal">
                    <div class="field-helper" style="margin-top:var(--space-xs);color:var(--accent)">Na de onboarding zie je een uitgebreide uitleg van hoe dit bedrag is berekend.</div>
                </div>
            `;
            nav.innerHTML = `${backBtn}${nextBtn}`;

        } else if (obStep === 8) {
            // AHA-MOMENT
            renderAhaStep();
            nav.innerHTML = `${backBtn}<button class="ob-nav-next" onclick="obFinish()" style="font-size:1rem">${t('startGrip')}</button>`;
        }
    }

    function obAddFixed() {
        const name = document.getElementById('obFcName')?.value?.trim() || '';
        const amount = parseNum(document.getElementById('obFcAmount')?.value) || 0;
        const cat = document.getElementById('obFcCat')?.value || 'overig';
        if (amount <= 0) { showToast('Vul een bedrag in.'); return; }
        obData.fixedItems.push({ name: name || CAT_LABELS[cat] || 'Vaste last', amountCents: toCents(amount), cat });
        renderObStep();
    }

    function obEditFixed(idx) {
        const item = obData.fixedItems[idx];
        if (!item) return;
        const newAmount = prompt(`Nieuw bedrag voor "${item.name || 'Vaste last'}" (huidig: ${fromCents(item.amountCents)}):`);
        if (newAmount === null) return;
        const parsed = parseNum(newAmount);
        if (!isNaN(parsed) && parsed > 0) {
            item.amountCents = toCents(parsed);
            const newName = prompt(`Naam (huidige: "${item.name}"):\n(Druk op OK om te behouden)`, item.name);
            if (newName !== null && newName.trim()) item.name = newName.trim();
            renderObStep();
        } else {
            showToast('Ongeldig bedrag.');
        }
    }

    function obRemoveFixed(idx) {
        obData.fixedItems.splice(idx, 1);
        renderObStep();
    }

    function obPinKey(k) {
        if (obPinPhase === 'choose') {
            if (k === 'del') { obData.pin = obData.pin.slice(0, -1); renderObStep(); return; }
            if (obData.pin.length >= 4) return;
            obData.pin += k;
            renderObStep();
            if (obData.pin.length === 4) {
                setTimeout(() => { obPinPhase = 'confirm'; obData.pinConfirm = ''; renderObStep(); }, 200);
            }
        } else {
            if (k === 'del') { obData.pinConfirm = obData.pinConfirm.slice(0, -1); renderObStep(); return; }
            if (obData.pinConfirm.length >= 4) return;
            obData.pinConfirm += k;
            renderObStep();
            if (obData.pinConfirm.length === 4) {
                setTimeout(() => {
                    if (obData.pin === obData.pinConfirm) {
                        obStep = 2; renderObStep();
                    } else {
                        const err = document.getElementById('obPinError');
                        if (err) { err.textContent = t('pinMismatch'); err.classList.add('show'); }
                        obPinPhase = 'choose'; obData.pin = ''; obData.pinConfirm = '';
                        setTimeout(() => renderObStep(), 1200);
                    }
                }, 200);
            }
        }
    }

    function obNext() {
        if (obStep === 0) {
            const name = document.getElementById('obName')?.value?.trim();
            if (!name) { showToast(t('enterName')); return; }
            obData.name = name;
        } else if (obStep === 1) {
            // PIN — self-advances via obPinKey, skip
        } else if (obStep === 2) {
            const dateVal = document.getElementById('obStartDate')?.value;
            if (dateVal) obData.appStartDate = dateVal;
        } else if (obStep === 3) {
            obData.salaryMode = 'fixed';
            obData.salaryDay = Math.max(1, Math.min(31, parseInt(document.getElementById('obSalaryDay')?.value) || 24));
        } else if (obStep === 4) {
            const inc = parseNum(document.getElementById('obIncome')?.value) || 0;
            if (inc <= 0) { showToast(t('enterIncome')); return; }
            obData.income = inc;
        } else if (obStep === 5) {
            obData.fixedMode = 'total';
            obData.fixedTotal = parseNum(document.getElementById('obFixed')?.value) || 0;
        } else if (obStep === 6) {
            obData.autoSave = parseNum(document.getElementById('obAutoSave')?.value) || 0;
            obData.startSavings = parseNum(document.getElementById('obStartSavings')?.value) || 0;
            obData.savingsGoal = parseNum(document.getElementById('obGoal')?.value) || 0;
        } else if (obStep === 7) {
            obData.dailyBudget = parseNum(document.getElementById('obBudget')?.value) || 35;
        }
        obStep++;
        renderObStep();
    }

    function obBack() {
        if (obStep === 1 || obStep === 2) { obPinPhase = 'choose'; obData.pin = ''; obData.pinConfirm = ''; }
        if (obStep > 0) { obStep--; renderObStep(); }
    }

    function renderAhaStep() {
        const content = document.getElementById('obContent');
        const monthlyAutoSave = toCents(obData.autoSave);
        const dailyBudgetCents = toCents(obData.dailyBudget);
        const incomeCents = toCents(obData.income);
        const fixedCents = toCents(obData.fixedTotal || 0);

        // Use actual period days based on salary day
        const salDay = obData.salaryMode === 'fixed' ? obData.salaryDay : (Object.values(obData.salaryByMonth)[0] || 24);
        const now = new Date();
        const periodStart = new Date(now.getFullYear(), now.getMonth(), salDay);
        const periodEnd = new Date(now.getFullYear(), now.getMonth() + 1, salDay - 1);
        const daysInPeriod = Math.round((periodEnd - periodStart) / (1000*60*60*24)) + 1;
        const dailyBudgetTotal = dailyBudgetCents * daysInPeriod;

        const overig = incomeCents - fixedCents - dailyBudgetTotal - monthlyAutoSave;
        const monthlyDisplay = Math.max(0, monthlyAutoSave + Math.max(0, overig));

        let goalLine = '';
        if (obData.savingsGoal > 0) {
            const goalCents = toCents(obData.savingsGoal);
            const startCents = toCents(obData.startSavings);
            const remaining = goalCents - startCents;
            if (monthlyDisplay > 0 && remaining > 0) {
                const months = remaining / monthlyDisplay;
                const estDate = new Date();
                estDate.setDate(estDate.getDate() + Math.ceil(months * 30.44));
                const mn = MONTH_NAMES_NL[estDate.getMonth()].toLowerCase();
                goalLine = `<div class="aha-line">Je bereikt ${formatEuro(goalCents)} rond <strong style="color:var(--accent)">${mn} ${estDate.getFullYear()}</strong></div>`;
            } else {
                goalLine = `<div class="aha-line">Na een jaar spaar je naar verwachting ${formatEuro(monthlyDisplay * 12)}</div>`;
            }
        } else {
            goalLine = `<div class="aha-line">Over een jaar heb je naar verwachting <strong style="color:var(--accent)">${formatEuro(monthlyDisplay * 12)}</strong> opzij</div>`;
        }

        content.innerHTML = `
            <div class="ob-step-title" style="text-align:center">Dit is wat GRIP voor je uitrekent</div>
            <div class="aha-amount">${formatEuro(monthlyDisplay)}</div>
            <div class="aha-line" style="font-weight:600">Dit kun je elke maand opzij zetten</div>
            ${goalLine}

            <div style="background:var(--glass);border-radius:var(--radius-md);padding:var(--space-lg);margin-top:var(--space-xl);text-align:left">
                <div style="font-size:0.78rem;color:var(--text-secondary);line-height:1.6">
                    <div style="display:flex;justify-content:space-between;margin-bottom:var(--space-xs)"><span>Inkomen</span><strong style="color:var(--accent)">${formatEuro(incomeCents)}</strong></div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:var(--space-xs)"><span>Vaste lasten</span><strong style="color:var(--red)">-${formatEuro(fixedCents)}</strong></div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:var(--space-xs)"><span>Dagbudget (${daysInPeriod}d)</span><strong style="color:var(--green)">-${formatEuro(dailyBudgetTotal)}</strong></div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:var(--space-sm)"><span>Sparen</span><strong style="color:#60A5FA">-${formatEuro(monthlyAutoSave)}</strong></div>
                    <hr style="border:none;border-top:1px solid var(--glass-border);margin:var(--space-sm) 0">
                    <div style="display:flex;justify-content:space-between"><span style="font-weight:700">Resterend</span><strong style="color:var(--accent)">${formatEuro(overig)}</strong></div>
                    <div style="font-size:0.72rem;color:var(--text-muted);margin-top:var(--space-sm)">Wat je niet uitgeeft, telt GRIP automatisch als groei.</div>
                </div>
            </div>

            <div class="aha-closing" style="margin-top:var(--space-xl)">Klaar om te beginnen?</div>
        `;
    }

    function obFinish() {
        appData.userName = obData.name;
        appData.pin = obData.pin;
        appData.appStartDate = obData.appStartDate || formatDate(new Date());
        appData.dailyGroceryBudget = toCents(obData.dailyBudget);
        appData.autoSaveCents = toCents(obData.autoSave);
        appData.startSavingsCents = toCents(obData.startSavings);
        appData.savingsGoalCents = obData.savingsGoal > 0 ? toCents(obData.savingsGoal) : 0;
        appData.monthlyIncome = toCents(obData.income);
        appData.theme = 'dark';
        appData.defaultSalaryDay = obData.salaryDay;
        appData.salaryDates = {};

        // Fixed costs
        ensureFixedCostsIds();
        if (obData.fixedTotal > 0) {
            appData.fixedCosts.overig = [{ id: genId('fix'), name: 'Vaste lasten (totaal)', amountCents: toCents(obData.fixedTotal) }];
        }

        appData.setupComplete = true;
        appData._showWelcome = true;

        // Save persona data
        var fullPersona = computePersona({
            q1: cinChoices.goal || '', q2: cinChoices.self || '', q3: cinChoices.focus || '',
            q4: obData.personaQ4 || '', q5: ''
        });
        appData.personaArchetype = fullPersona.archetype;
        appData.personaScores = fullPersona.scores;
        appData.personaQ4 = obData.personaQ4 || '';
        appData.personaQ5 = '';
        appData.householdType = obData.householdType || 'couple';
        appData.region = obData.region || 'rest';
        appData.dailyBudgetUserCents = toCents(obData.dailyBudget);

        generateSalaryPeriods();
        ensureActiveMonthSynced();
        saveData();

        // Show profile creation animation
        obShowProfileCreation(fullPersona);
    }

    function obShowProfileCreation(persona) {
        const ob = document.getElementById('onboarding');
        if (!ob) return;

        const firstName = (obData.name || '').split(' ')[0];
        const hhType = obData.householdType || 'couple';
        const region = obData.region || 'rest';
        const hhLabel = { alone: 'Alleenstaand', couple: 'Samenwonend', family: 'Gezin' }[hhType] || '';
        const regLabel = { randstad: 'Randstad', rest: 'Buiten de Randstad' }[region] || '';
        const dailyBudget = formatEuro(toCents(obData.dailyBudget));
        const income = formatEuro(toCents(obData.income));
        const savePer = formatEuro(toCents(obData.autoSave));
        const incomeCents = toCents(obData.income);
        const fixedCents = toCents(obData.fixedTotal || 0);
        const autoSaveCents = toCents(obData.autoSave);
        const availableCents = incomeCents - fixedCents - autoSaveCents;
        const fixedPct = incomeCents > 0 ? Math.round((fixedCents / incomeCents) * 100) : 0;
        const yearSavings = autoSaveCents * 12;
        const situationKey = hhType + '_' + region;
        const arch = persona.archetype;

        // ── Nibud benchmarks ──
        const nibudRanges = { alone: { low: 95000, high: 120000 }, couple: { low: 130000, high: 170000 }, family: { low: 160000, high: 210000 } };
        const nibudRange = nibudRanges[hhType] || nibudRanges.couple;
        let fixedComparison = '';
        if (fixedCents < nibudRange.low) fixedComparison = 'onder het gemiddelde. Goed bezig.';
        else if (fixedCents > nibudRange.high) fixedComparison = 'boven het gemiddelde. GRIP houdt daar rekening mee.';
        else fixedComparison = 'rond het gemiddelde.';

        let savingsComparison = '';
        if (yearSavings >= 600000) savingsComparison = 'Meer dan een volledig maandsalaris per jaar aan groei.';
        else if (yearSavings >= 300000) savingsComparison = 'Genoeg voor een flinke stap richting je buffer of een mooie vakantie.';
        else if (yearSavings >= 120000) savingsComparison = 'Een goed begin. Elk bedrag telt, en GRIP laat zien hoe het groeit.';
        else savingsComparison = 'Klein beginnen is ook beginnen. Consistentie is wat telt.';

        // ── Situatieteksten ──
        const situationTexts = {
            alone_randstad: 'Alleenstaand in de Randstad. Het leven gaat snel, er is altijd iets te doen en jij wilt niks missen. Dat mag ook.',
            alone_rest: 'Alleenstaand en je eigen koers varen. Niemand die meekijkt, jij bepaalt waar je geld naartoe gaat.',
            couple_randstad: 'Samen in de Randstad. Overal iets te beleven, altijd iemand die iets voorstelt. Het is druk, het is leuk, en het gaat snel.',
            couple_rest: 'Samen bouwen aan iets moois. Jullie vullen elkaar aan en maken bewuste keuzes. Dat is jullie kracht.',
            family_randstad: 'Een gezin in de Randstad. De mooiste chaos die er is. Er is altijd wat, en er is altijd iets dat geld kost. Zo werkt dat.',
            family_rest: 'Een gezin draait op ritme. Schoolweken, weekenden, vakanties. En overal zitten keuzes die geld raken.'
        };
        const situationText = situationTexts[situationKey] || situationTexts.couple_rest;

        // ── Archetype data ──
        const archetypeLabels = { genieter: 'De Genieter', bewuste: 'De Bewuste', planner: 'De Planner', optimist: 'De Optimist' };
        const archetypeTaglines = {
            genieter: 'Het goede leven hoeft niet duur te zijn. Het moet alleen van jou zijn.',
            bewuste: 'De meeste mensen gokken met hun geld. Jij niet.',
            planner: 'Financi\u00eble rust is geen toeval. Het is een keuze die jij elke dag maakt.',
            optimist: 'De meeste mensen zien hun geld verdwijnen. Jij ziet waar het naartoe kan.'
        };

        // ── Persoonlijke beschrijvingen per archetype × situatie ──
        const personalTexts = {
            genieter: {
                alone_randstad: 'Een vriend appt of je meegaat eten. Een collega tipt een nieuwe plek. Er is altijd wel iets en jij zegt niet snel nee. Dat hoeft ook niet. Dat is waarvoor je werkt. Met ' + dailyBudget + ' per dag weet je voortaan precies wat erin zit. Zodat "ja" zeggen nooit verandert in spijt de dag erna.',
                alone_rest: 'Je gunt jezelf wat en daar hoef je je niet voor te verantwoorden. Een goed etentje, een spontaan weekend, iets moois voor in huis. Dat zijn geen foute keuzes, dat is leven. Met ' + dailyBudget + ' per dag houdt GRIP simpelweg bij hoeveel ruimte je hebt. Zodat genieten nooit verandert in piekeren.',
                couple_randstad: 'Vrienden die langskomen, een nieuwe plek om te proberen, kaartjes voor iets wat je eigenlijk niet wilt missen. Samen in de Randstad is er altijd een reden om geld uit te geven. En meestal is het het waard. Met ' + dailyBudget + ' per dag weten jullie gewoon wat er kan. Geen gedoe, alleen duidelijkheid.',
                couple_rest: 'Jullie hoeven niet ver te zoeken om er iets moois van te maken. Een goed diner, een dagje eropuit, iets nieuws voor het huis. Het zit in de kleine dingen. Met ' + dailyBudget + ' per dag weten jullie wat er kan. Zodat "zullen we..." nooit verandert in "kunnen we dat wel?"',
                family_randstad: 'Zwemles, de nieuwe sneakers die ze per se willen, een verjaardag waar je iets voor moet regelen. Met een gezin in de Randstad is er altijd een volgende uitgave. En jij wilt daar voluit in meegaan zonder halverwege de maand te twijfelen. Met ' + dailyBudget + ' per dag weet je wanneer er ruimte is en wanneer je even wacht.',
                family_rest: 'Verjaardagsfeestjes, een dag naar het bos, ijs halen op zondag. De mooiste momenten met je gezin kosten niet altijd veel, maar ze tellen wel op. Met ' + dailyBudget + ' per dag houdt GRIP dat bij. Zodat jij kunt focussen op het enige dat ertoe doet: er zijn.'
            },
            bewuste: {
                alone_randstad: 'Om je heen bestelt iedereen brunch voor dertig euro en haalt koffie van zes. Jij denkt even na voor je dat doet. Niet omdat je het niet kunt, maar omdat je bewust kiest waar je geld naartoe gaat. Met ' + dailyBudget + ' per dag bevestigt GRIP wat je al weet: je bent beter met geld dan de meeste mensen om je heen.',
                alone_rest: 'Je houdt bij wat er binnenkomt en wat eruit gaat. Niet obsessief, maar bewust. Het geeft je een gevoel van controle dat veel mensen missen. Met ' + dailyBudget + ' per dag maakt GRIP dat gevoel concreet. Zwart op wit, elke dag opnieuw. Niet om je te controleren, maar om te bevestigen wat je al doet.',
                couple_randstad: 'Samen bewust leven terwijl om jullie heen iedereen maar uitgeeft. Dat vraagt iets van jullie allebei. Het vraagt gesprekken, keuzes, soms even nee zeggen tegen weer een Tikkie. Met ' + dailyBudget + ' per dag hoeven jullie niet te gissen. GRIP laat zien dat het klopt wat jullie doen.',
                couple_rest: 'Jullie letten op de details. De energierekening die je hebt vergeleken, het abonnement dat je hebt opgezegd, de boodschappen die je slim inkoopt. Het zijn kleine dingen die samen een groot verschil maken. Met ' + dailyBudget + ' per dag brengt GRIP daar structuur in. Jullie voelen het al, nu zien jullie het ook.',
                family_randstad: 'Met een gezin en een Randstad-leven bewust omgaan met geld is bijna een tweede baan. Toch doe je het. Je vergelijkt, je plant vooruit, je maakt keuzes waar je gezin beter van wordt. Met ' + dailyBudget + ' per dag laat GRIP zien hoe goed jullie het eigenlijk al doen. Soms heb je die bevestiging nodig.',
                family_rest: 'Met een gezin maak je tientallen financi\u00eble keuzes per week. Van welke boodschappen je koopt tot welke jas nog een seizoen meekan. Jij maakt die keuzes bewust en dat werpt zijn vruchten af. Met ' + dailyBudget + ' per dag maakt GRIP zichtbaar wat anders onzichtbaar blijft: dat het werkt.'
            },
            planner: {
                alone_randstad: 'Jij opent je bankapp niet uit angst, maar uit gewoonte. Je wilt weten waar je staat, niet omdat je je zorgen maakt, maar omdat het je rust geeft. In een stad die altijd trekt aan je portemonnee is dat een zeldzame kracht. Met ' + dailyBudget + ' per dag en ' + savePer + ' per maand opzij wordt die rust tastbaar.',
                alone_rest: 'Je weet wat er binnenkomt, wat eruit gaat en wat er overblijft. Niet bij benadering, maar precies. Dat geeft je een vrijheid die anderen niet hebben. Met ' + dailyBudget + ' per dag maakt GRIP van dat inzicht een dagelijks overzicht dat je nergens anders vindt.',
                couple_randstad: 'Financi\u00ebn in een relatie kunnen een bron van spanning zijn. Bij jullie niet. Jullie plannen, verdelen en weten waar jullie aan toe zijn. Met ' + dailyBudget + ' per dag en ' + savePer + ' per maand opzij hoeft er nooit discussie te zijn over wat kan en wat niet. Alleen duidelijkheid.',
                couple_rest: 'Jullie hebben een systeem en het werkt. Je weet wat de vaste lasten zijn, wat er overblijft en waar het naartoe gaat. Met ' + dailyBudget + ' per dag en ' + savePer + ' per maand bouwt GRIP daar een dagelijks overzicht omheen. Zodat jullie planning niet in je hoofd zit maar op je scherm staat.',
                family_randstad: 'Met een gezin in de Randstad is er altijd een volgende uitgave die je niet had voorzien. Sportclub, nieuwe schoenen, schoolreisje. Jij loopt daar niet achteraan, jij loopt ervoor. Met ' + dailyBudget + ' per dag en ' + savePer + ' sparen laat GRIP zien dat je plan klopt. Elke dag opnieuw.',
                family_rest: 'Met een gezin plan je niet omdat het leuk is. Je plant omdat het werkt. Het geeft je de rust om ja te zeggen als het kan en nee als het moet. Met ' + dailyBudget + ' per dag en ' + savePer + ' per maand opzij maakt GRIP dat plan levend. Altijd actueel, nooit een verrassing.'
            },
            optimist: {
                alone_randstad: 'Je hebt ' + savePer + ' per maand opzij staan en je vraagt je af: kan er meer? Dat is niet hebzuchtig, dat is slim. Jij kijkt naar je financi\u00ebn als een puzzel die je wilt kraken. Met ' + dailyBudget + ' per dag geeft GRIP je het ontbrekende stukje: dagelijks inzicht in waar de ruimte zit.',
                alone_rest: 'Je spaart, je vergelijkt, je optimaliseert. Niet omdat het moet, maar omdat je het leuk vindt om het maximale uit je situatie te halen. Met ' + dailyBudget + ' per dag en ' + savePer + ' per maand toont GRIP je precies waar nog ruimte zit. Niet door harder te werken, maar door scherper te kijken.',
                couple_randstad: 'Jullie doen het al goed. Dat weten jullie. Maar "goed" is niet genoeg als je weet dat "beter" mogelijk is. Met ' + dailyBudget + ' per dag en ' + savePer + ' per maand laat GRIP zien waar de kansen liggen die jullie nog niet pakken. Kleine verschuivingen, groot verschil op jaarbasis.',
                couple_rest: 'Jullie hebben het fundament al gelegd. Vast inkomen, bewuste keuzes, structureel sparen. Nu willen jullie weten hoe ver jullie kunnen komen. Met ' + dailyBudget + ' per dag laat GRIP zien hoe jullie van goed naar uitstekend gaan. Stap voor stap, zonder in te leveren op wat jullie belangrijk vinden.',
                family_randstad: 'Met een gezin in de Randstad is elke euro die je slim inzet er twee waard. Jullie weten dat en jullie handelen ernaar. Met ' + dailyBudget + ' per dag laat GRIP zien welke keuzes het meeste opleveren. Niet in theorie, maar in jullie eigen cijfers.',
                family_rest: 'Met een gezin wil je niet alleen rondkomen, je wilt vooruit. Sparen voor later, ruimte voor nu, en het gevoel dat je het maximale eruit haalt. Met ' + dailyBudget + ' per dag en ' + savePer + ' sparen per maand maakt GRIP dat zichtbaar. Concreet, persoonlijk, elke dag.'
            }
        };
        const personalText = (personalTexts[arch] && personalTexts[arch][situationKey]) || personalTexts[arch]?.couple_rest || '';

        const archetypePromises = {
            genieter: 'GRIP houdt op de achtergrond bij wat er kan. Jij geniet op de voorgrond van wat er is.',
            bewuste: 'GRIP bevestigt elke dag dat jouw aanpak werkt. Zodat twijfel plaatsmaakt voor vertrouwen.',
            planner: 'GRIP vertaalt jouw planning naar een dagelijks overzicht. Altijd actueel, nooit een verrassing.',
            optimist: 'GRIP toont elke dag waar ruimte zit. Zodat jij kunt doen waar je goed in bent: het maximale eruit halen.'
        };

        const archetypeLabel = archetypeLabels[arch] || 'De Bewuste';
        const archetypeTagline = archetypeTaglines[arch] || '';
        const archetypePromise = archetypePromises[arch] || '';

        // ── State ──
        let profPage = 0;
        ob.style.overflow = 'hidden';
        ob.innerHTML = '<div id="profRevealRoot" style="position:relative;width:100%;min-height:100vh"></div>';
        const root = document.getElementById('profRevealRoot');

        function profRender() {
            if (profPage === 0) profRenderPage1();
            else if (profPage === 1) profRenderPage2();
            else if (profPage === 2) profRenderPage3();
            else if (profPage === 3) profRenderPage4();
        }

        // ═══ PAGE 1: ANALYSEREN ═══
        function profRenderPage1() {
            ob.style.overflow = 'hidden';
            root.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:40px var(--space-lg);text-align:center">' +
                '<div id="profRing" style="width:88px;height:88px;border-radius:50%;border:3px solid var(--glass-border);position:relative;margin-bottom:var(--space-xl)">' +
                    '<svg width="88" height="88" style="position:absolute;top:-3px;left:-3px;transform:rotate(-90deg)">' +
                        '<circle cx="44" cy="44" r="41" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="257.6" stroke-dashoffset="257.6" stroke-linecap="round" id="profProgress"/>' +
                    '</svg>' +
                    '<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center" id="profRingInner">' +
                        '<div style="font-size:1.5rem;font-weight:900;color:var(--accent);opacity:0;transition:opacity 0.4s" id="profInitial">' + firstName.charAt(0).toUpperCase() + '</div>' +
                    '</div>' +
                '</div>' +
                '<div id="profStatus" style="font-size:0.82rem;color:var(--text-muted);min-height:24px;transition:opacity 0.25s;margin-bottom:var(--space-lg)"></div>' +
                '<div id="profSubStatus" style="font-size:0.68rem;color:var(--text-tertiary);min-height:18px;opacity:0;transition:opacity 0.3s"></div>' +
                '<div id="profCta" style="margin-top:var(--space-2xl);opacity:0;transform:translateY(8px);transition:all 0.5s ease"></div>' +
            '</div>';

            const circle = document.getElementById('profProgress');
            const status = document.getElementById('profStatus');
            const subStatus = document.getElementById('profSubStatus');
            const initial = document.getElementById('profInitial');
            const ringTotal = 257.6;

            const procesSteps = [
                { main: 'Even kijken, ' + firstName + '...', sub: '' },
                { main: 'Inkomen analyseren...', sub: income },
                { main: 'Vaste lasten categoriseren...', sub: formatEuro(fixedCents) },
                { main: 'Spaarruimte berekenen...', sub: savePer + ' per maand' },
                { main: 'Regio-correctie toepassen...', sub: regLabel },
                { main: 'Nibud-richtlijnen vergelijken...', sub: hhLabel.toLowerCase() },
                { main: 'Huishoudprofiel matchen...', sub: '' },
                { main: 'Bufferpercentage bepalen...', sub: '' },
                { main: 'Bestedingspatroon herkennen...', sub: '' },
                { main: 'Dagbudget optimaliseren...', sub: dailyBudget + ' per dag' },
                { main: 'Persoonlijkheidsprofiel samenstellen...', sub: '' },
                { main: 'Laatste checks uitvoeren...', sub: '' },
                { main: 'Klaar.', sub: '' }
            ];

            let sIdx = 0;
            let progress = 0;

            // Ring fills
            const ringInterval = setInterval(function() {
                progress += 0.7;
                if (progress > ringTotal) progress = ringTotal;
                if (circle) circle.setAttribute('stroke-dashoffset', ringTotal - progress);
            }, 20);

            // Initial letter appears
            setTimeout(function() {
                if (initial) initial.style.opacity = '1';
            }, 600);

            // Process steps cycle
            function showStep() {
                if (sIdx >= procesSteps.length) return;
                var step = procesSteps[sIdx];
                if (status) { status.style.opacity = '0'; }
                if (subStatus) { subStatus.style.opacity = '0'; }
                setTimeout(function() {
                    if (status) { status.textContent = step.main; status.style.opacity = '1'; }
                    if (subStatus && step.sub) {
                        subStatus.textContent = step.sub;
                        setTimeout(function() { subStatus.style.opacity = '1'; }, 150);
                    }
                    sIdx++;
                    if (sIdx < procesSteps.length - 2) {
                        setTimeout(showStep, 500 + Math.random() * 200);
                    } else if (sIdx === procesSteps.length - 2) {
                        setTimeout(showStep, 900);
                    } else if (sIdx === procesSteps.length - 1) {
                        setTimeout(showStep, 1200);
                    }
                }, 120);
            }
            showStep();

            // Complete ring + show checkmark + CTA
            setTimeout(function() {
                clearInterval(ringInterval);
                if (circle) circle.setAttribute('stroke-dashoffset', '0');
                var ring = document.getElementById('profRing');
                if (ring) ring.style.borderColor = 'var(--accent)';
                // Replace initial with checkmark
                if (initial) {
                    initial.style.opacity = '0';
                    setTimeout(function() {
                        initial.innerHTML = '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
                        initial.style.opacity = '1';
                    }, 200);
                }
                // Show CTA
                setTimeout(function() {
                    var cta = document.getElementById('profCta');
                    if (cta) {
                        cta.innerHTML = '<button onclick="profGoPage(1)" style="padding:14px 48px;background:var(--accent);color:#000;font-size:0.92rem;font-weight:800;font-family:var(--font);border:none;border-radius:var(--radius-md);cursor:pointer;box-shadow:0 4px 24px rgba(226,169,59,0.25)">Bekijk je profiel</button>';
                        cta.style.opacity = '1';
                        cta.style.transform = 'translateY(0)';
                    }
                }, 500);
            }, 8500);
        }

        // ═══ PAGE 2: SITUATIE & CIJFERS ═══
        function profRenderPage2() {
            ob.style.overflow = 'hidden auto';
            root.style.opacity = '0';
            root.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:60px var(--space-lg) 40px">' +
                '<button onclick="profGoPage(0)" style="position:absolute;top:20px;left:16px;background:none;border:none;color:var(--text-muted);font-size:0.78rem;font-family:var(--font);cursor:pointer;padding:8px">&larr; Terug</button>' +
                '<div style="display:flex;gap:6px;margin-bottom:var(--space-3xl)">' +
                    '<div style="width:24px;height:3px;border-radius:2px;background:var(--accent)"></div>' +
                    '<div style="width:24px;height:3px;border-radius:2px;background:var(--glass-border)"></div>' +
                    '<div style="width:24px;height:3px;border-radius:2px;background:var(--glass-border)"></div>' +
                '</div>' +

                // Situatie
                '<div id="p2Sit" style="opacity:0;transform:translateY(12px);transition:all 0.6s ease;max-width:340px;text-align:center;margin-bottom:var(--space-3xl)">' +
                    '<div style="font-size:0.62rem;text-transform:uppercase;letter-spacing:2px;font-weight:700;color:var(--accent);margin-bottom:var(--space-md)">Jouw situatie</div>' +
                    '<div style="font-size:1rem;color:var(--text-primary);line-height:1.8;font-weight:500">' + situationText + '</div>' +
                '</div>' +

                // Cijfer 1: Vaste lasten met visuele balk
                '<div id="p2C1" style="opacity:0;transform:translateY(12px);transition:all 0.5s ease;max-width:340px;width:100%;margin-bottom:var(--space-md)">' +
                    '<div style="background:var(--glass);border-radius:var(--radius-md);padding:var(--space-lg);text-align:left">' +
                        '<div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:var(--space-sm)">' +
                            '<span style="font-size:0.72rem;color:var(--text-muted)">Vaste lasten</span>' +
                            '<span style="font-size:1.1rem;font-weight:800;color:var(--red);font-variant-numeric:tabular-nums">' + formatEuro(fixedCents) + '</span>' +
                        '</div>' +
                        '<div style="width:100%;height:6px;border-radius:3px;background:rgba(255,255,255,0.06);margin-bottom:var(--space-sm);overflow:hidden">' +
                            '<div id="p2Bar" style="height:100%;border-radius:3px;background:var(--red);width:0%;transition:width 1s cubic-bezier(0.4,0,0.2,1)"></div>' +
                        '</div>' +
                        '<div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.7">' +
                            '<span style="color:var(--red);font-weight:700">' + fixedPct + '%</span> van je inkomen. Dat is ' + fixedComparison +
                        '</div>' +
                    '</div>' +
                '</div>' +

                // Cijfer 2: Beschikbaar
                '<div id="p2C2" style="opacity:0;transform:translateY(12px);transition:all 0.5s ease;max-width:340px;width:100%;margin-bottom:var(--space-md)">' +
                    '<div style="background:var(--glass);border-radius:var(--radius-md);padding:var(--space-lg);text-align:left">' +
                        '<div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:var(--space-sm)">' +
                            '<span style="font-size:0.72rem;color:var(--text-muted)">Beschikbaar per maand</span>' +
                            '<span style="font-size:1.1rem;font-weight:800;color:var(--green);font-variant-numeric:tabular-nums">' + formatEuro(availableCents) + '</span>' +
                        '</div>' +
                        '<div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.7">' +
                            'Dit is wat je overhoudt voor boodschappen, kleding, uitjes en alles tussendoor.' +
                        '</div>' +
                    '</div>' +
                '</div>' +

                // Cijfer 3: Sparen
                '<div id="p2C3" style="opacity:0;transform:translateY(12px);transition:all 0.5s ease;max-width:340px;width:100%;margin-bottom:var(--space-2xl)">' +
                    '<div style="background:var(--glass);border-radius:var(--radius-md);padding:var(--space-lg);text-align:left">' +
                        '<div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:var(--space-sm)">' +
                            '<span style="font-size:0.72rem;color:var(--text-muted)">Sparen per jaar</span>' +
                            '<span style="font-size:1.1rem;font-weight:800;color:#60A5FA;font-variant-numeric:tabular-nums">' + formatEuro(yearSavings) + '</span>' +
                        '</div>' +
                        '<div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.7">' +
                            savePer + ' per maand. ' + savingsComparison +
                        '</div>' +
                    '</div>' +
                '</div>' +

                '<div id="p2Cta" style="opacity:0;transform:translateY(8px);transition:all 0.5s ease;width:100%;max-width:340px">' +
                    '<button onclick="profGoPage(2)" style="width:100%;padding:15px 24px;background:var(--accent);color:#000;font-size:0.92rem;font-weight:800;font-family:var(--font);border:none;border-radius:var(--radius-md);cursor:pointer;box-shadow:0 4px 24px rgba(226,169,59,0.25)">Volgende</button>' +
                '</div>' +
            '</div>';

            setTimeout(function() { root.style.transition = 'opacity 0.4s ease'; root.style.opacity = '1'; }, 30);
            setTimeout(function() { var el = document.getElementById('p2Sit'); if(el){el.style.opacity='1';el.style.transform='translateY(0)';} }, 300);
            setTimeout(function() {
                var el = document.getElementById('p2C1'); if(el){el.style.opacity='1';el.style.transform='translateY(0)';}
                setTimeout(function() { var bar = document.getElementById('p2Bar'); if(bar) bar.style.width = Math.min(fixedPct, 100) + '%'; }, 200);
            }, 800);
            setTimeout(function() { var el = document.getElementById('p2C2'); if(el){el.style.opacity='1';el.style.transform='translateY(0)';} }, 1400);
            setTimeout(function() { var el = document.getElementById('p2C3'); if(el){el.style.opacity='1';el.style.transform='translateY(0)';} }, 2000);
            setTimeout(function() { var el = document.getElementById('p2Cta'); if(el){el.style.opacity='1';el.style.transform='translateY(0)';} }, 2600);
        }

        // ═══ PAGE 3: ARCHETYPE REVEAL ═══
        function profRenderPage3() {
            ob.style.overflow = 'hidden auto';
            root.style.opacity = '0';
            root.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:60px var(--space-lg) 40px">' +
                '<button onclick="profGoPage(1)" style="position:absolute;top:20px;left:16px;background:none;border:none;color:var(--text-muted);font-size:0.78rem;font-family:var(--font);cursor:pointer;padding:8px">&larr; Terug</button>' +
                '<div style="display:flex;gap:6px;margin-bottom:var(--space-3xl)">' +
                    '<div style="width:24px;height:3px;border-radius:2px;background:var(--accent)"></div>' +
                    '<div style="width:24px;height:3px;border-radius:2px;background:var(--accent)"></div>' +
                    '<div style="width:24px;height:3px;border-radius:2px;background:var(--glass-border)"></div>' +
                '</div>' +

                // Reveal: naam
                '<div id="p3Name" style="opacity:0;transition:opacity 0.8s ease;margin-top:48px;margin-bottom:var(--space-lg)">' +
                    '<div style="font-size:1.1rem;font-weight:600;color:var(--text-secondary)">' + firstName + ', jij bent...</div>' +
                '</div>' +

                // Reveal: archetype label
                '<div id="p3Label" style="opacity:0;transform:scale(0.8);transition:all 0.7s cubic-bezier(0.34,1.56,0.64,1);margin-bottom:var(--space-md)">' +
                    '<div style="font-size:2rem;font-weight:900;color:var(--accent);letter-spacing:1px">' + archetypeLabel + '</div>' +
                '</div>' +

                // Tagline
                '<div id="p3Tag" style="opacity:0;transform:translateY(8px);transition:all 0.6s ease;max-width:300px;margin-bottom:var(--space-3xl)">' +
                    '<div style="font-size:0.85rem;color:var(--text-muted);font-style:italic;line-height:1.7">"' + archetypeTagline + '"</div>' +
                '</div>' +

                // Persoonlijke beschrijving
                '<div id="p3Personal" style="opacity:0;transform:translateY(12px);transition:all 0.7s ease;max-width:340px;width:100%;margin-bottom:var(--space-xl)">' +
                    '<div style="background:rgba(226,169,59,0.04);border:1px solid rgba(226,169,59,0.10);border-radius:var(--radius-lg);padding:var(--space-lg)">' +
                        '<div style="font-size:0.82rem;color:var(--text-secondary);line-height:1.85;text-align:left">' + personalText + '</div>' +
                    '</div>' +
                '</div>' +

                // GRIP belofte
                '<div id="p3Promise" style="opacity:0;transform:translateY(12px);transition:all 0.6s ease;max-width:340px;width:100%;text-align:center;margin-bottom:var(--space-2xl)">' +
                    '<div style="font-size:0.62rem;text-transform:uppercase;letter-spacing:2px;font-weight:700;color:var(--accent);margin-bottom:var(--space-sm)">Zo helpt GRIP jou</div>' +
                    '<div style="font-size:0.85rem;color:var(--text-primary);line-height:1.8;font-weight:500">' + archetypePromise + '</div>' +
                '</div>' +

                '<div id="p3Cta" style="opacity:0;transform:translateY(8px);transition:all 0.5s ease;width:100%;max-width:340px">' +
                    '<button onclick="profGoPage(3)" style="width:100%;padding:15px 24px;background:var(--accent);color:#000;font-size:0.92rem;font-weight:800;font-family:var(--font);border:none;border-radius:var(--radius-md);cursor:pointer;box-shadow:0 4px 24px rgba(226,169,59,0.25)">Volgende</button>' +
                '</div>' +
            '</div>';

            setTimeout(function() { root.style.transition = 'opacity 0.4s ease'; root.style.opacity = '1'; }, 30);
            // Timed reveal
            setTimeout(function() { var el = document.getElementById('p3Name'); if(el) el.style.opacity='1'; }, 400);
            setTimeout(function() {
                var el = document.getElementById('p3Label');
                if(el){el.style.opacity='1';el.style.transform='scale(1)';}
                cinVibrate(25);
            }, 1400);
            setTimeout(function() { var el = document.getElementById('p3Tag'); if(el){el.style.opacity='1';el.style.transform='translateY(0)';} }, 2200);
            setTimeout(function() { var el = document.getElementById('p3Personal'); if(el){el.style.opacity='1';el.style.transform='translateY(0)';} }, 3200);
            setTimeout(function() { var el = document.getElementById('p3Promise'); if(el){el.style.opacity='1';el.style.transform='translateY(0)';} }, 4200);
            setTimeout(function() { var el = document.getElementById('p3Cta'); if(el){el.style.opacity='1';el.style.transform='translateY(0)';} }, 5000);
        }

        // ═══ PAGE 4: PROFIELKAART + CTA ═══
        function profRenderPage4() {
            ob.style.overflow = 'hidden auto';
            root.style.opacity = '0';
            root.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:40px var(--space-lg)">' +

                '<div style="font-size:0.62rem;text-transform:uppercase;letter-spacing:2px;font-weight:700;color:var(--accent);margin-bottom:var(--space-xl)">Jouw GRIP-profiel</div>' +

                // Profielkaart
                '<div id="p4Card" style="opacity:0;transform:translateY(16px) scale(0.97);transition:all 0.7s cubic-bezier(0.34,1.56,0.64,1);width:100%;max-width:340px;margin-bottom:var(--space-xl)">' +
                    '<div style="background:var(--bg-card);border:1px solid var(--glass-border);border-radius:var(--radius-xl);padding:var(--space-xl);position:relative;overflow:hidden">' +
                        '<div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent-bright))"></div>' +

                        '<div style="display:flex;align-items:center;gap:var(--space-md);margin-bottom:var(--space-lg)">' +
                            '<div style="width:48px;height:48px;border-radius:50%;background:var(--accent-dim);border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:900;color:var(--accent)">' + firstName.charAt(0).toUpperCase() + '</div>' +
                            '<div style="text-align:left">' +
                                '<div style="font-size:1rem;font-weight:800;color:var(--text-primary)">' + firstName + '</div>' +
                                '<div style="font-size:0.72rem;color:var(--accent);font-weight:600">' + archetypeLabel + '</div>' +
                            '</div>' +
                        '</div>' +

                        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-sm)">' +
                            '<div style="background:var(--glass);border-radius:var(--radius-sm);padding:var(--space-sm) var(--space-md)">' +
                                '<div style="font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Dagbudget</div>' +
                                '<div style="font-size:0.92rem;font-weight:800;color:var(--accent);margin-top:2px;font-variant-numeric:tabular-nums">' + dailyBudget + '</div>' +
                            '</div>' +
                            '<div style="background:var(--glass);border-radius:var(--radius-sm);padding:var(--space-sm) var(--space-md)">' +
                                '<div style="font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Inkomen</div>' +
                                '<div style="font-size:0.92rem;font-weight:800;color:var(--text-primary);margin-top:2px;font-variant-numeric:tabular-nums">' + income + '</div>' +
                            '</div>' +
                            '<div style="background:var(--glass);border-radius:var(--radius-sm);padding:var(--space-sm) var(--space-md)">' +
                                '<div style="font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Sparen /mnd</div>' +
                                '<div style="font-size:0.92rem;font-weight:800;color:var(--green);margin-top:2px;font-variant-numeric:tabular-nums">' + savePer + '</div>' +
                            '</div>' +
                            '<div style="background:var(--glass);border-radius:var(--radius-sm);padding:var(--space-sm) var(--space-md)">' +
                                '<div style="font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">' + hhLabel + '</div>' +
                                '<div style="font-size:0.92rem;font-weight:800;color:var(--text-primary);margin-top:2px">' + regLabel + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +

                '<div id="p4Cta" style="opacity:0;transform:translateY(8px);transition:all 0.5s ease;width:100%;max-width:340px">' +
                    '<button onclick="profRevealFinish()" style="width:100%;padding:16px 24px;background:var(--accent);color:#000;font-size:1rem;font-weight:800;font-family:var(--font);border:none;border-radius:var(--radius-md);cursor:pointer;letter-spacing:0.5px;box-shadow:0 4px 24px rgba(226,169,59,0.3)">Start met GRIP</button>' +
                '</div>' +
            '</div>';

            setTimeout(function() { root.style.transition = 'opacity 0.4s ease'; root.style.opacity = '1'; }, 30);
            setTimeout(function() { var el = document.getElementById('p4Card'); if(el){el.style.opacity='1';el.style.transform='translateY(0) scale(1)';} }, 400);
            setTimeout(function() { var el = document.getElementById('p4Cta'); if(el){el.style.opacity='1';el.style.transform='translateY(0)';} }, 1000);
        }

        // Navigation
        window.profGoPage = function(n) {
            profPage = n;
            root.style.transition = 'opacity 0.25s ease';
            root.style.opacity = '0';
            setTimeout(function() {
                profRender();
            }, 260);
        };

        // Start on page 1
        profRender();
    }

    function profRevealFinish() {
        var ob = document.getElementById('onboarding');
        if (!ob) return;
        ob.style.transition = 'opacity 0.4s ease';
        ob.style.opacity = '0';
        setTimeout(function() {
            ob.classList.add('hidden');
            ob.style.opacity = '';
            ob.style.overflow = '';
            initPinScreen();
            document.getElementById('pinScreen')?.classList.remove('hidden');
        }, 400);
    }

    function showWelcomeSplash() {
        const firstName = (appData.userName || '').split(' ')[0] || '';
        const splash = document.createElement('div');
        splash.id = 'welcomeSplash';
        splash.style.cssText = 'position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:var(--space-2xl);text-align:center;overflow:hidden';
        splash.innerHTML =
            '<div id="wsWelkom" style="font-size:1.8rem;font-weight:900;color:var(--accent);letter-spacing:2px;opacity:0;transform:scale(0.3);transition:none"></div>' +
            '<div id="wsName" style="font-size:1.3rem;font-weight:700;color:var(--text-primary);margin-top:var(--space-sm);opacity:0;transform:translateY(30px);transition:none"></div>' +
            '<div id="wsSlogan" style="font-size:0.82rem;color:var(--text-muted);margin-top:var(--space-lg);opacity:0;transform:translateY(20px);transition:none"></div>';
        document.body.appendChild(splash);

        // Phase 1: "Welkom" pops in (0ms)
        setTimeout(() => {
            const w = document.getElementById('wsWelkom');
            if (w) {
                w.style.transition = 'opacity 0.6s ease, transform 0.6s cubic-bezier(0.34,1.56,0.64,1)';
                w.textContent = 'WELKOM';
                w.style.opacity = '1';
                w.style.transform = 'scale(1)';
            }
        }, 100);

        // Phase 2: name slides up (800ms)
        setTimeout(() => {
            const n = document.getElementById('wsName');
            if (n) {
                n.style.transition = 'opacity 0.5s ease, transform 0.5s cubic-bezier(0.16,1,0.3,1)';
                n.textContent = firstName || '';
                n.style.opacity = '1';
                n.style.transform = 'translateY(0)';
            }
        }, 900);

        // Phase 3: slogan fades in (1400ms)
        setTimeout(() => {
            const s = document.getElementById('wsSlogan');
            if (s) {
                s.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                s.textContent = 'Weet wat je kunt sparen';
                s.style.opacity = '1';
                s.style.transform = 'translateY(0)';
            }
        }, 1500);

        // Phase 4: fade out everything (3000ms)
        setTimeout(() => {
            splash.style.transition = 'opacity 0.5s ease';
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.remove();
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('app').style.display = '';
                showView('home');
            }, 500);
        }, 3200);
    }

    function dismissIntro() {
        document.getElementById('introSplash')?.classList.add('hidden');
        startOnboarding();
    }

    // ═══════════════════════════════════════════════════════════════
    // INIT
    // ═══════════════════════════════════════════════════════════════


    // ═══════════════════════════════════════════════════════════════
    // PREMIUM SYSTEM
    // ═══════════════════════════════════════════════════════════════
    let isPremium = false;
    let premSelectedPlan = 'year';
    let premModalThrottle = {};

    function premLog(event, context) {
        const logs = JSON.parse(localStorage.getItem('grip_prem_log') || '[]');
        logs.push({ t: new Date().toISOString(), e: event, c: context || null });
        localStorage.setItem('grip_prem_log', JSON.stringify(logs));
    }

    function premCheck() {
        isPremium = appData.isPremium || false;
        premUpdateUI();
    }

    function premUpdateUI() {
        // Toggle in profiel
        const toggle = document.getElementById('premiumToggle');
        if (toggle) {
            toggle.classList.toggle('active', isPremium);
        }
        const label = document.getElementById('premStatusLabel');
        if (label) label.textContent = isPremium ? 'GRIP Premium actief' : 'Gratis versie';
        const helper = document.getElementById('premStatusHelper');
        if (helper) helper.textContent = isPremium
            ? 'Je hebt toegang tot alle premium functies.'
            : 'Schakel Premium in om alle functies te testen.';
        const viewRow = document.getElementById('premViewPaywallRow');
        if (viewRow) viewRow.style.display = isPremium ? 'none' : '';

        // Dashboard teaser: controlled by premRenderHome, just hide if premium
        const teaser = document.getElementById('premTeaser');
        if (teaser && isPremium) teaser.style.display = 'none';

        // Premium badge in header (optional subtle indicator)
        updatePremBadges();
    }

    function updatePremBadges() {
        // Add/remove premium badges on locked features
        document.querySelectorAll('[data-prem]').forEach(el => {
            if (isPremium) {
                el.classList.remove('prem-lock');
                const lockLabel = el.querySelector('.prem-lock-label');
                if (lockLabel) lockLabel.remove();
            }
        });
    }

    function premToggle() {
        isPremium = !isPremium;
        appData.isPremium = isPremium;
        saveData();
        premLog(isPremium ? 'premium_enabled' : 'premium_disabled', 'dev_toggle');
        premUpdateUI();
        showToast(isPremium ? 'Premium geactiveerd' : 'Premium uitgeschakeld');
    }

    function premSelectPlan(plan) {
        premSelectedPlan = plan;
        document.getElementById('premPlanMonth')?.classList.toggle('selected', plan === 'month');
        document.getElementById('premPlanYear')?.classList.toggle('selected', plan === 'year');
        premLog('paywall_plan_select', plan);
    }

    function premShowPaywall(trigger) {
        premLog('paywall_view', trigger);
        premUpdatePricing();
        const pw = document.getElementById('premPaywall');
        if (pw) { pw.classList.add('show'); }
    }

    function premClosePaywall() {
        const pw = document.getElementById('premPaywall');
        if (pw) pw.classList.remove('show');
    }

    function premMockPurchase() {
        premLog('paywall_cta_click', premSelectedPlan);
        isPremium = true;
        appData.isPremium = true;
        saveData();
        premClosePaywall();
        premUpdateUI();
        showToast('Premium geactiveerd!');
    }

    function premRestorePurchase() {
        showToast('Geen eerdere aankoop gevonden');
    }

    // Context modals
    function premShowModal(type) {
        // Throttle: don't show same modal within 5 minutes
        const now = Date.now();
        if (premModalThrottle[type] && now - premModalThrottle[type] < 300000) return;
        premModalThrottle[type] = now;

        premLog('premium_modal_shown', type);

        const modals = {
            goals: {
                icon: '🎯',
                title: 'Meerdere spaardoelen met prioriteit',
                body: 'Met Premium kun je tegelijk sparen voor verschillende doelen. GRIP verdeelt je spaarruimte automatisch: eerst je <em>buffer</em>, dan de rest.',
                cta: 'Bekijk Premium'
            },
            salary_planning: {
                icon: '📅',
                title: 'Salarisplanning per maand',
                body: 'Wisselende betaaldag, 4-wekelijks of een bonusmaand? Premium laat je dit <em>per maand instellen</em> zodat je budget altijd klopt.',
                cta: 'Bekijk Premium'
            },
            active_user: {
                icon: '⭐',
                title: 'Je gebruikt GRIP goed',
                body: 'Je houdt je uitgaven bij. Premium geeft je er <em>cashflow-planning, waarschuwingen en scenario&#39;s</em> bij.',
                cta: 'Bekijk Premium'
            },
            scenario: {
                icon: '🔮',
                title: 'Scenario&#39;s doorrekenen',
                body: 'Wat als je salaris later komt? Of je minder uitgeeft per week? Premium laat je <em>doorrekenen wat dat betekent</em> voor je spaardoel.',
                cta: 'Bekijk Premium'
            },
            waarschuwing: {
                icon: '⚠️',
                title: 'Waarschuwing voor je krap komt',
                body: 'GRIP ziet het eerder dan jij. Premium waarschuwt je als je <em>onder je veilige buffer dreigt te komen</em> voor salarisdag.',
                cta: 'Bekijk Premium'
            }
        };

        const m = modals[type];
        if (!m) return;

        const content = document.getElementById('premModalContent');
        if (content) {
            content.innerHTML =
                '<div class="prem-modal-icon">' + m.icon + '</div>' +
                '<div class="prem-modal-title">' + m.title + '</div>' +
                '<div class="prem-modal-body">' + m.body + '</div>' +
                '<div class="prem-modal-btns">' +
                    '<button class="prem-modal-btn-primary" onclick="premModalCTA(\'' + type + '\')">' + m.cta + '</button>' +
                    '<button class="prem-modal-btn-secondary" onclick="premCloseModal()">Niet nu</button>' +
                '</div>';
        }

        const overlay = document.getElementById('premModal');
        if (overlay) overlay.classList.add('show');
    }

    function premModalCTA(type) {
        premLog('premium_modal_cta_click', type);
        premCloseModal();
        premShowPaywall('modal_' + type);
    }

    function premCloseModal() {
        const overlay = document.getElementById('premModal');
        if (overlay) overlay.classList.remove('show');
        premLog('premium_modal_close');
    }

    // Gate check: call before premium features
    function premGate(feature) {
        if (isPremium) return true;
        premShowModal(feature);
        return false;
    }

    // Teaser visibility on home
    function premCheckTeaser() {
        // Teaser visibility is now controlled by premRenderHome (max 1 upsell slot)
        // This function only logs the view if teaser becomes visible
        const teaser = document.getElementById('premTeaser');
        if (!teaser || isPremium) { if (teaser) teaser.style.display = 'none'; return; }
        // Don't show here; premRenderHome decides
    }

    // Active user prompt (after 7+ expense entries)
    function premCheckActiveUser() {
        if (isPremium) return;
        const mk = getCurrentMonthKey();
        const spending = appData.spending?.[mk] || [];
        const groceries = appData.groceries?.[mk] || {};
        let count = spending.length;
        for (const d in groceries) count += (groceries[d]?.length || 0);
        if (count >= 12 && !premModalThrottle['active_user_done']) {
            premModalThrottle['active_user_done'] = true;
            setTimeout(() => premShowModal('active_user'), 1500);
        }
    }

    // Event log viewer
    function premShowEventLog() {
        const logs = JSON.parse(localStorage.getItem('grip_prem_log') || '[]');
        const overlay = document.getElementById('premModal');
        const content = document.getElementById('premModalContent');
        if (!content || !overlay) return;

        let logHtml = '<div style="font-size:0.82rem;font-weight:800;margin-bottom:var(--space-md)">Premium Event Log</div>';
        if (logs.length === 0) {
            logHtml += '<div style="font-size:0.78rem;color:var(--text-muted)">Nog geen events gelogd.</div>';
        } else {
            logHtml += '<div style="max-height:50vh;overflow-y:auto;-webkit-overflow-scrolling:touch">';
            for (let i = logs.length - 1; i >= 0; i--) {
                const l = logs[i];
                const time = new Date(l.t).toLocaleString('nl-NL', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
                logHtml += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:0.72rem">' +
                    '<div><span style="color:var(--accent);font-weight:700">' + l.e + '</span>' +
                    (l.c ? ' <span style="color:var(--text-muted)">(' + l.c + ')</span>' : '') + '</div>' +
                    '<div style="color:var(--text-muted);flex-shrink:0;margin-left:8px">' + time + '</div></div>';
            }
            logHtml += '</div>';
        }
        logHtml += '<div style="margin-top:var(--space-lg);display:flex;gap:var(--space-sm)">' +
            '<button class="prem-modal-btn-secondary" style="flex:1;background:rgba(255,255,255,0.04);border-radius:10px" onclick="premClearLog()">Log wissen</button>' +
            '<button class="prem-modal-btn-primary" style="flex:1;border-radius:10px" onclick="premCloseModal()">Sluiten</button></div>';
        content.innerHTML = logHtml;
        overlay.classList.add('show');
    }

    // Get current month key helper (may already exist)
    function premClearLog() {
        localStorage.removeItem('grip_prem_log');
        premShowEventLog();
    }

    function getCurrentMonthKey() {
        return appData.currentMonth || appData.lastActiveMonthKey || '';
    }


    // ═══════════════════════════════════════════════════════════════
    // PREMIUM V2: CASHFLOW, ALERTS, SCENARIOS
    // ═══════════════════════════════════════════════════════════════

    function premGetFixedCostMeta(itemId) {
        if (!appData.fixedCostsMeta) appData.fixedCostsMeta = {};
        return appData.fixedCostsMeta[itemId] || {};
    }

    function premSetFixedCostMeta(itemId, key, val) {
        if (!appData.fixedCostsMeta) appData.fixedCostsMeta = {};
        if (!appData.fixedCostsMeta[itemId]) appData.fixedCostsMeta[itemId] = {};
        appData.fixedCostsMeta[itemId][key] = val;
        saveData();
    }

    function premGetUpcomingBills(mk) {
        if (!isPremium) return [];
        const period = getPeriodInfo(mk);
        if (!period) return [];
        const today = startOfDay(new Date());
        const endDate = period.endDate;
        const bills = [];
        const overrides = (appData.fixedCostOverrides && appData.fixedCostOverrides[mk]) || [];
        Object.keys(appData.fixedCosts || {}).forEach(function(cat) {
            (appData.fixedCosts[cat] || []).forEach(function(item) {
                const meta = premGetFixedCostMeta(item.id);
                if (meta.paid) return;
                const dueDay = meta.dueDay || 0;
                if (dueDay === 0) return;
                let dueDate = new Date(today.getFullYear(), today.getMonth(), dueDay);
                if (dueDate < today) dueDate.setMonth(dueDate.getMonth() + 1);
                if (dueDate > endDate || dueDate < today) return;
                const override = overrides.find(function(o) { return o.id === item.id; });
                const amountCents = override ? (Number(override.amountCents) || 0) : (Number(item.amountCents) || 0);
                const daysUntil = Math.ceil((dueDate - today) / (1000*60*60*24));
                bills.push({ name: item.name || catLabel(cat), amountCents: amountCents, dueDate: dueDate, daysUntil: daysUntil, cat: cat, id: item.id });
            });
        });
        bills.sort(function(a,b) { return a.daysUntil - b.daysUntil; });
        return bills;
    }

    function premGetSafeToSpend(mk) {
        const period = getPeriodInfo(mk);
        if (!period) return { safe: 0, daily: 0, upcoming: 0, daysLeft: 1 };
        const today = startOfDay(new Date());
        const endDate = period.endDate;
        const daysLeft = Math.max(1, Math.ceil((endDate - today) / (1000*60*60*24)) + 1);
        const incomeCents = calculateIncomeTotalCents(mk);
        const allFixedCents = calculateFixedCostsTotalCents(mk);
        const autoSaveCents = getAutoSaveForMonthCents(mk);
        const grocSpent = calculateMonthGroceriesCents(mk);
        const otherSpent = calculateMonthSpendingCents(mk);
        const spentCents = grocSpent + otherSpent;
        const safe = incomeCents - allFixedCents - autoSaveCents - spentCents;
        const daily = Math.round(safe / daysLeft);
        const upcoming = isPremium ? premGetUpcomingBills(mk).reduce(function(s,b){return s+b.amountCents;}, 0) : 0;
        return { safe: safe, daily: daily, upcoming: upcoming, daysLeft: daysLeft };
    }

    function premRenderHome(mk) {
        var waarschuwingBanner = document.getElementById('premAlertBanner');
        var cashflowCard = document.getElementById('premCashflowCard');
        var waarschuwingTeaser = document.getElementById('premAlertTeaser');
        var premTeaser = document.getElementById('premTeaser');
        if (waarschuwingBanner) waarschuwingBanner.style.display = 'none';
        if (cashflowCard) cashflowCard.style.display = 'none';
        if (waarschuwingTeaser) waarschuwingTeaser.style.display = 'none';
        if (premTeaser) premTeaser.style.display = 'none';
        if (!mk) return;
        var sts = premGetSafeToSpend(mk);
        var hasRisk = sts.safe < 0 || (sts.daily < 500 && sts.daysLeft > 3);
        if (!hasRisk) {
            var bills = isPremium ? premGetUpcomingBills(mk) : [];
            var bigBill = bills.find(function(b){ return b.daysUntil <= 5 && b.amountCents > 5000; });
            if (bigBill) hasRisk = true;
        }
        if (isPremium) {
            // Premium: show cashflow card always, waarschuwing banner if risk
            if (cashflowCard) {
                cashflowCard.style.display = '';
                var safeEl = document.getElementById('premSafeAmount');
                var subEl = document.getElementById('premSafeSub');
                var billsEl = document.getElementById('premUpcomingBills');
                if (safeEl) { safeEl.textContent = formatEuro(sts.safe); safeEl.style.color = sts.safe >= 0 ? 'var(--green)' : 'var(--red)'; }
                if (subEl) subEl.textContent = formatEuro(sts.daily) + '/dag over ' + sts.daysLeft + ' dagen tot salarisdag';
                var bills = premGetUpcomingBills(mk);
                if (billsEl) {
                    if (bills.length > 0) {
                        billsEl.innerHTML = '<div style="font-size:0.68rem;font-weight:700;color:var(--text-muted);margin-bottom:6px">Komende rekeningen</div>' +
                            bills.slice(0,3).map(function(b){
                                return '<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:0.75rem"><span style="color:var(--text-secondary)">' + b.name + ' <span style="color:var(--text-muted)">over ' + b.daysUntil + ' dag' + (b.daysUntil!==1?'en':'') + '</span></span><span style="font-weight:700;font-variant-numeric:var(--tabular)">' + formatEuro(b.amountCents) + '</span></div>';
                            }).join('') + (bills.length > 3 ? '<div style="font-size:0.68rem;color:var(--text-muted);margin-top:4px">+ ' + (bills.length-3) + ' meer</div>' : '');
                    } else { billsEl.innerHTML = ''; }
                }
            }
            premCheckWaarschuwing(mk, sts);
        } else {
            // Free: max 1 upsell slot
            if (hasRisk) {
                // Show waarschuwing-teaser only (no premium teaser)
                if (waarschuwingTeaser) waarschuwingTeaser.style.display = '';
            } else {
                // Show premium teaser only (no waarschuwing-teaser)
                if (premTeaser) premTeaser.style.display = '';
            }
        }
        var scenBadge = document.getElementById('scenarioPremBadge');
        var trendsBadge = document.getElementById('trendsPremBadge');
        if (trendsBadge) trendsBadge.style.display = isPremium ? 'none' : '';
        if (scenBadge) scenBadge.style.display = isPremium ? 'none' : '';
    }

    function premCheckWaarschuwing(mk, sts) {
        var banner = document.getElementById('premAlertBanner');
        if (!banner || !isPremium) return;
        var titleEl = document.getElementById('premAlertTitle');
        var bodyEl = document.getElementById('premAlertBody');
        var alert = null;
        if (sts.safe < 0) {
            alert = { title: 'Je komt waarschijnlijk krap te zitten', body: 'Op basis van je huidige uitgaven hou je ' + formatEuro(sts.safe) + ' over tot salarisdag.' };
        } else if (sts.daily < 500 && sts.daysLeft > 3) {
            alert = { title: 'Je dagbudget staat onder druk', body: 'Je kunt nog ' + formatEuro(sts.daily) + ' per dag uitgeven de komende ' + sts.daysLeft + ' dagen.' };
        } else {
            var bills = premGetUpcomingBills(mk);
            var bigBill = bills.find(function(b){ return b.daysUntil <= 5 && b.amountCents > 5000; });
            if (bigBill) {
                alert = { title: bigBill.name + ' over ' + bigBill.daysUntil + ' dag' + (bigBill.daysUntil!==1?'en':''), body: formatEuro(bigBill.amountCents) + ' wordt binnenkort afgeschreven.' };
            }
        }
        if (alert) { banner.style.display = ''; if(titleEl) titleEl.textContent = alert.title; if(bodyEl) bodyEl.textContent = alert.body; }
        else { banner.style.display = 'none'; }
    }

    function premShowWaarschuwingDetail() { premLog('waarschuwing_detail_view'); }

    // ═══ PRICING A/B (charm vs rounded) ═══
    function premInitPricing() {
        if (!appData.priceStyle) {
            appData.priceStyle = Math.random() < 0.5 ? 'charm' : 'rounded';
            saveData();
            premLog('price_variant', { style: appData.priceStyle });
        }
    }
    function premGetPrices() {
        var charm = appData.priceStyle === 'charm';
        return {
            monthCents: charm ? 699 : 700,
            yearCents: charm ? 4999 : 5000,
            monthLabel: charm ? '€6,99' : '€7,00',
            yearLabel: charm ? '€49,99' : '€50,00'
        };
    }
    function premUpdatePricing() {
        var p = premGetPrices();
        var mEl = document.getElementById('premPriceMonth');
        var yEl = document.getElementById('premPriceYear');
        if (mEl) mEl.textContent = p.monthLabel;
        if (yEl) yEl.textContent = p.yearLabel;
    }

    // ═══ PERSONA ENGINE ═══
    function computePersona(q) {
        // q = {q1, q2, q3, q4}
        var scores = { genieter: 0, bewuste: 0, planner: 0, optimist: 0 };

        // q1: motivatie
        if (q.q1 === 'save') { scores.bewuste += 2; scores.planner += 1; }
        else if (q.q1 === 'overview') { scores.bewuste += 2; scores.genieter += 1; }
        else if (q.q1 === 'goal') { scores.planner += 2; scores.optimist += 1; }
        else if (q.q1 === 'peace') { scores.optimist += 2; scores.bewuste += 1; }

        // q2: zelfbeeld
        if (q.q2 === 'spender') { scores.genieter += 3; }
        else if (q.q2 === 'frugal') { scores.bewuste += 3; }
        else if (q.q2 === 'structure') { scores.planner += 3; }
        else if (q.q2 === 'optimizer') { scores.optimist += 3; }

        // q3: focus
        if (q.q3 === 'daily') { scores.genieter += 1; scores.bewuste += 1; }
        else if (q.q3 === 'saving') { scores.planner += 1; scores.optimist += 1; }
        else if (q.q3 === 'fixed') { scores.bewuste += 1; scores.planner += 1; }
        else if (q.q3 === 'all') { scores.optimist += 2; }

        // q4: voorspelbaarheid
        if (q.q4 === 'very_predictable') { scores.bewuste += 2; scores.planner += 1; }
        else if (q.q4 === 'mostly_predictable') { scores.planner += 1; }
        else if (q.q4 === 'often_surprises') { scores.genieter += 1; }
        else if (q.q4 === 'chaotic') { scores.genieter += 2; }

        // Determine winner
        var sorted = Object.entries(scores).sort(function(a,b){ return b[1] - a[1]; });
        var top = sorted[0][1];
        var tied = sorted.filter(function(s){ return s[1] === top; });
        var archetype;
        if (tied.length === 1) {
            archetype = tied[0][0];
        } else {
            var tiebreakMap = { daily: 'genieter', saving: 'planner', fixed: 'bewuste', all: 'optimist' };
            var preferred = tiebreakMap[q.q3] || 'bewuste';
            archetype = tied.find(function(t){ return t[0] === preferred; }) ? preferred : tied[0][0];
        }

        var labels = { genieter: 'De Genieter', bewuste: 'De Bewuste', planner: 'De Planner', optimist: 'De Optimist' };

        return { archetype: archetype, label: labels[archetype], scores: scores };
    }

    function getPersonaDescription(archetype, firstName, householdType, region) {
        var ht = householdType || 'couple';
        var rg = region || 'rest';

        // Context lines per archetype × household × region
        var contextLines = {
            genieter: {
                alone_randstad: 'Als alleenstaande in de Randstad weet je hoe snel het gaat — en dat je ervan moet genieten.',
                alone_rest: 'Als alleenstaande heb je de vrijheid om je geld in te zetten waar jij blij van wordt.',
                couple_randstad: 'Samenwonen in de Randstad betekent hogere kosten, maar ook meer om samen van te genieten.',
                couple_rest: 'Samen leven is samen kiezen — en jullie kiezen graag voor de leuke dingen.',
                family_randstad: 'Met een gezin in de Randstad weet je als geen ander hoe snel kosten oplopen.',
                family_rest: 'Met een gezin draait alles om slim balanceren tussen genieten en vooruitdenken.'
            },
            bewuste: {
                alone_randstad: 'Als alleenstaande in de Randstad is bewust met geld omgaan een echte vaardigheid.',
                alone_rest: 'Als alleenstaande doe je het waarschijnlijk beter dan je denkt.',
                couple_randstad: 'Samen bewust leven in de Randstad vraagt aandacht — en die breng jij mee.',
                couple_rest: 'Samen bewust met geld omgaan is de sterkste financiële basis die er is.',
                family_randstad: 'Met een gezin in de Randstad is bewust omgaan met geld geen luxe, maar een skill.',
                family_rest: 'Met een gezin ben je gewend om overal bewust mee om te gaan — ook met geld.'
            },
            planner: {
                alone_randstad: 'Als alleenstaande in de Randstad geeft een goed plan je rust in de drukte.',
                alone_rest: 'Met je eigen huishouden heb je de controle om alles precies in te richten.',
                couple_randstad: 'Samen plannen in de Randstad? Met GRIP weten jullie exact waar jullie staan.',
                couple_rest: 'Samen plannen betekent samen weten — en dat geeft rust.',
                family_randstad: 'Als gezin in de Randstad is plannen niet optioneel — het is je superkracht.',
                family_rest: 'Met een gezin is een goed plan het verschil tussen stress en overzicht.'
            },
            optimist: {
                alone_randstad: 'Als alleenstaande in de Randstad heb je de snelheid om snel te optimaliseren.',
                alone_rest: 'Als alleenstaande heb je de flexibiliteit om snel resultaat te zien.',
                couple_randstad: 'Samen in de Randstad is elke euro die je slim inzet er twee waard.',
                couple_rest: 'Jullie doen het al goed — GRIP laat zien hoe jullie het nog beter kunnen.',
                family_randstad: 'Met een gezin in de Randstad is elke euro die je slim inzet er twee waard.',
                family_rest: 'Met een gezin tel je elke euro twee keer — en dat is precies je kracht.'
            }
        };

        var coreLines = {
            genieter: {
                intro: 'Je weet hoe je van geld moet genieten — en dat is een kwaliteit.',
                outro: 'GRIP zorgt ervoor dat je blijft genieten, zonder de twijfel achteraf.'
            },
            bewuste: {
                intro: 'Je bent zuiniger dan je denkt — wat je mist is niet discipline, maar bevestiging.',
                outro: 'GRIP laat je zien dat je het goed doet.'
            },
            planner: {
                intro: 'Structuur geeft jou geen beperking — het geeft je rust.',
                outro: 'GRIP maakt van je gevoel een concreet plan.'
            },
            optimist: {
                intro: 'Je spaart al en denkt vooruit — nu wil je het nog slimmer doen.',
                outro: 'GRIP toont je precies waar ruimte zit die je nog niet zag.'
            }
        };

        var key = ht + '_' + rg;
        var ctx = (contextLines[archetype] && contextLines[archetype][key]) || '';
        var core = coreLines[archetype] || coreLines.bewuste;

        return {
            title: firstName + ', jij bent ' + (labels_map[archetype] || 'De Bewuste'),
            intro: core.intro,
            context: ctx,
            outro: core.outro
        };
    }
    var labels_map = { genieter: 'De Genieter', bewuste: 'De Bewuste', planner: 'De Planner', optimist: 'De Optimist' };

    function suggestDailyBudgetCents(opts) {
        // DAGBUDGET BEREKENING
        //
        // Stap 1: Beschikbaar = inkomen - vaste lasten - sparen
        // Stap 2: Buffer = % van beschikbaar (gebaseerd op voorspelbaarheid uitgaven)
        // Stap 3: Nibud dagelijkse kosten correctie:
        //         Een gezin met kinderen heeft hogere dagelijkse basiskosten (boodschappen,
        //         verzorging, etc). Randstad heeft hogere discretionaire kosten.
        //         We trekken dit NIET af, maar we verlagen het suggestie-bedrag
        //         zodat er ruimte is voor die hogere kosten.
        //
        // Nibud minimale dagelijkse voedingskosten 2025 (per dag):
        //   Alleenstaand: ~€9,50 (man 14-50, +10% voor 1-persoons)
        //   Stel: ~€16,40 (man + vrouw 14-50)
        //   Gezin (2 volw + 2 kinderen): ~€20,90 (na 25% korting 4-persoons)
        //
        // De EXTRA kosten tov alleenstaand → stel = +€6,90/dag, gezin = +€11,40/dag
        // Randstad: +€2/dag gemiddeld hogere discretionaire kosten (CBS schatting)

        // Buffer: alleen gebaseerd op voorspelbaarheid (q4)
        var bufferPct = 0.05;
        if (opts.q4 === 'very_predictable') bufferPct = 0.03;
        else if (opts.q4 === 'mostly_predictable') bufferPct = 0.05;
        else if (opts.q4 === 'often_surprises') bufferPct = 0.07;
        else if (opts.q4 === 'chaotic') bufferPct = 0.10;

        var available = opts.incomeCents - opts.fixedCostsCents - opts.autoSaveCents;
        var bufferCents = Math.round(available * bufferPct);
        var afterBuffer = available - bufferCents;

        // Huishoudtype: extra dagelijkse kosten tov baseline (alleenstaand)
        var householdExtra = 0; // cents per dag
        if (opts.householdType === 'couple') householdExtra = 690;
        else if (opts.householdType === 'family') householdExtra = 1140;

        // Regio: Randstad hogere discretionaire kosten
        var regionExtra = 0;
        if (opts.region === 'randstad') regionExtra = 200;

        var dailyExtra = householdExtra + regionExtra;
        var totalExtraPerPeriod = dailyExtra * opts.periodDays;

        // Trek extra kosten af van beschikbaar, dan delen door dagen
        var forDaily = afterBuffer - totalExtraPerPeriod;
        var suggested = Math.round(forDaily / Math.max(opts.periodDays, 1));

        // Clamp: min €3/dag
        var maxDaily = Math.round(available / Math.max(opts.periodDays, 1));
        suggested = Math.max(300, Math.min(suggested, maxDaily));

        // Uitleg items
        var sources = [];
        if (householdExtra > 0) {
            var hhLabel = opts.householdType === 'family' ? 'gezin' : 'samenwonend';
            sources.push('Als ' + hhLabel + ' heb je hogere dagelijkse basiskosten dan een alleenstaande. GRIP houdt daar rekening mee.');
        }
        if (regionExtra > 0) {
            sources.push('In de Randstad liggen dagelijkse kosten gemiddeld iets hoger.');
        }
        if (bufferPct > 0.05) {
            sources.push('Omdat je uitgaven wisselend zijn, houdt GRIP een extra buffer aan.');
        }

        return {
            suggestedCents: suggested,
            bufferCents: bufferCents,
            bufferPct: Math.round(bufferPct * 100),
            householdExtraCents: householdExtra,
            regionExtraCents: regionExtra,
            totalExtraPerPeriod: totalExtraPerPeriod,
            explanationBullets: sources
        };
    }

    function premOpenScenario() {
        premLog('scenario_open');
        if (!premGate('scenario')) return;
        var mk = getCurrentMonthKey();
        var sts = premGetSafeToSpend(mk);
        var content = document.getElementById('premModalContent');
        var overlay = document.getElementById('premModal');
        if (!content || !overlay) return;
        content.innerHTML =
            '<div style="text-align:center;margin-bottom:var(--space-xl)"><div style="font-size:1.1rem;font-weight:800;margin-bottom:var(--space-xs)">Wat als...</div><div style="font-size:0.78rem;color:var(--text-muted)">Verschuif om het effect te zien</div></div>' +
            '<div style="margin-bottom:var(--space-xl)"><div style="font-size:0.78rem;font-weight:700;color:var(--text-secondary);margin-bottom:var(--space-sm)">Je geeft per week minder uit</div><input type="range" min="0" max="100" value="0" step="10" style="width:100%;accent-color:var(--accent)" id="scenSlider1" oninput="premUpdateScenario()"><div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--text-muted)"><span>&#8364;0</span><span id="scenVal1">&#8364;0/week</span><span>&#8364;100</span></div><div style="margin-top:var(--space-sm);font-size:0.82rem;color:var(--green);font-weight:700" id="scenResult1"></div></div>' +
            '<div style="margin-bottom:var(--space-xl)"><div style="font-size:0.78rem;font-weight:700;color:var(--text-secondary);margin-bottom:var(--space-sm)">Je zet extra opzij per maand</div><input type="range" min="0" max="200" value="0" step="25" style="width:100%;accent-color:var(--accent)" id="scenSlider2" oninput="premUpdateScenario()"><div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--text-muted)"><span>&#8364;0</span><span id="scenVal2">&#8364;0/maand</span><span>&#8364;200</span></div><div style="margin-top:var(--space-sm);font-size:0.82rem;color:var(--accent);font-weight:700" id="scenResult2"></div></div>' +
            '<div style="margin-bottom:var(--space-xl)"><div style="font-size:0.78rem;font-weight:700;color:var(--text-secondary);margin-bottom:var(--space-sm)">Je salaris komt later</div><input type="range" min="0" max="7" value="0" step="1" style="width:100%;accent-color:var(--accent)" id="scenSlider3" oninput="premUpdateScenario()"><div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--text-muted)"><span>Op tijd</span><span id="scenVal3">+0 dagen</span><span>+7 dagen</span></div><div style="margin-top:var(--space-sm);font-size:0.82rem;font-weight:700" id="scenResult3"></div></div>' +
            '<button class="prem-modal-btn-secondary" onclick="premCloseModal()" style="margin-top:var(--space-md)">Sluiten</button>';
        overlay.classList.add('show');
        premUpdateScenario();
    }

    function premUpdateScenario() {
        var mk = getCurrentMonthKey();
        var sts = premGetSafeToSpend(mk);
        var s1 = Number(document.getElementById('scenSlider1') ? document.getElementById('scenSlider1').value : 0);
        var s2 = Number(document.getElementById('scenSlider2') ? document.getElementById('scenSlider2').value : 0);
        var s3 = Number(document.getElementById('scenSlider3') ? document.getElementById('scenSlider3').value : 0);
        var v1 = document.getElementById('scenVal1'); if(v1) v1.textContent = '\u20ac' + s1 + '/week';
        var v2 = document.getElementById('scenVal2'); if(v2) v2.textContent = '\u20ac' + s2 + '/maand';
        var v3 = document.getElementById('scenVal3'); if(v3) v3.textContent = '+' + s3 + ' dagen';
        var weeksLeft = Math.max(1, Math.ceil(sts.daysLeft / 7));
        var r1 = document.getElementById('scenResult1');
        if(r1) r1.textContent = s1 > 0 ? '\u2192 ' + formatEuro(s1*100*weeksLeft) + ' extra over deze periode' : '';
        var r2 = document.getElementById('scenResult2');
        if(r2) r2.textContent = s2 > 0 ? '\u2192 ' + formatEuro(s2*12*100) + ' extra per jaar' : '';
        var newDaily = Math.round(sts.safe / Math.max(1, sts.daysLeft + s3));
        var r3 = document.getElementById('scenResult3');
        if(r3) { if(s3>0) { r3.textContent = '\u2192 Dagbudget daalt naar ' + formatEuro(newDaily); r3.style.color = newDaily < 0 ? 'var(--red)' : 'var(--text-secondary)'; } else { r3.textContent = ''; } }
    }

    // Session + cooldown throttle
    var premSessionPromptShown = false;
    var PREM_COOLDOWN_KEY = 'grip_prem_cooldowns';
    function premCanShowPrompt(type) {
        if (isPremium) return false;
        if (premSessionPromptShown) return false;
        var cds = JSON.parse(localStorage.getItem(PREM_COOLDOWN_KEY) || '{}');
        if (Date.now() - (cds[type]||0) < 172800000) return false;
        return true;
    }
    function premMarkPromptShown(type) {
        premSessionPromptShown = true;
        var cds = JSON.parse(localStorage.getItem(PREM_COOLDOWN_KEY) || '{}');
        cds[type] = Date.now();
        localStorage.setItem(PREM_COOLDOWN_KEY, JSON.stringify(cds));
    }

    // Premium: enhance vaste lasten items with due day + paid status
    function premEnhanceVasteLasten() {
        if (!isPremium) return;
        // Find all rendered VL item rows and add due date controls
        document.querySelectorAll('[data-vl-item-id]').forEach(function(row) {
            var id = row.getAttribute('data-vl-item-id');
            if (row.querySelector('.prem-due-row')) return; // already enhanced
            var meta = premGetFixedCostMeta(id);
            var dueRow = document.createElement('div');
            dueRow.className = 'prem-due-row';
            dueRow.innerHTML =
                '<span class="prem-due-label">Vervalt dag</span>' +
                '<input type="number" class="prem-due-input" min="1" max="31" placeholder="—" value="' + (meta.dueDay || '') + '" onchange="premSaveDueDay(\'' + id + '\', this.value)">' +
                '<div class="prem-paid-toggle" onclick="premTogglePaid(\'' + id + '\')">' +
                '<div class="prem-paid-dot ' + (meta.paid ? 'paid' : '') + '">' + (meta.paid ? '✓' : '') + '</div>' +
                '<span>' + (meta.paid ? 'Betaald' : 'Nog niet') + '</span></div>';
            row.appendChild(dueRow);
        });
    }

    function premSaveDueDay(id, val) {
        var day = parseInt(val);
        if (day >= 1 && day <= 31) {
            premSetFixedCostMeta(id, 'dueDay', day);
        } else if (!val) {
            premSetFixedCostMeta(id, 'dueDay', 0);
        }
        premLog('due_day_set', id);
    }

    function premTogglePaid(id) {
        var meta = premGetFixedCostMeta(id);
        premSetFixedCostMeta(id, 'paid', !meta.paid);
        premLog('paid_toggle', id);
        // Re-render
        if (typeof vlRenderCategories === 'function') {
            vlRenderCategories(getActiveMonthKey());
            setTimeout(premEnhanceVasteLasten, 50);
        }
        // Update home too
        if (currentViewName === 'home') updateHome();
    }

    // Premium gate for salary day per-month overrides
    function premCheckSalaryOverrides() {
        var grid = document.getElementById('salaryDayGrid');
        if (!grid) return;
        if (!isPremium) {
            // Add lock overlay on per-month salary grid
            var lockDiv = document.getElementById('premSalaryLock');
            if (!lockDiv) {
                lockDiv = document.createElement('div');
                lockDiv.id = 'premSalaryLock';
                lockDiv.style.cssText = 'position:relative;margin-top:var(--space-md);padding:var(--space-lg);background:rgba(226,169,59,0.04);border:1px solid rgba(226,169,59,0.12);border-radius:var(--radius-lg);text-align:center;cursor:pointer';
                lockDiv.onclick = function() { premShowModal('salary_planning'); };
                lockDiv.innerHTML = '<div style="font-size:0.82rem;font-weight:700;color:var(--text-secondary);margin-bottom:4px">Salarisdag per maand instellen</div>' +
                    '<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:var(--space-sm)">Wisselende betaaldag of bonusmaand?</div>' +
                    '<span class="prem-badge-sm">PREMIUM</span>';
                grid.parentElement.insertBefore(lockDiv, grid);
            }
            grid.style.display = 'none';
        } else {
            var lockDiv = document.getElementById('premSalaryLock');
            if (lockDiv) lockDiv.remove();
            grid.style.display = '';
        }
    }

    // Premium: multiple savings goals
    // Data: appData.extraGoals = [{ id, name, targetCents, priority }]
    function premRenderExtraGoals() {
        var container = document.getElementById('premExtraGoals');
        if (!container) return;
        if (!isPremium) {
            container.innerHTML = '<div class="card" style="border-color:rgba(226,169,59,0.12);cursor:pointer;text-align:center;padding:var(--space-xl)" onclick="premShowModal(\'goals\')">' +
                '<div style="font-size:0.82rem;font-weight:700;color:var(--text-secondary);margin-bottom:4px">Meerdere spaardoelen</div>' +
                '<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:var(--space-sm)">Spaar tegelijk voor vakantie, noodfonds en meer</div>' +
                '<span class="prem-badge-sm">PREMIUM</span></div>';
            return;
        }
        var goals = appData.extraGoals || [];
        var html = '';
        if (goals.length > 0) {
            goals.sort(function(a,b) { return (a.priority||99) - (b.priority||99); });
            goals.forEach(function(g, i) {
                html += '<div class="card" style="padding:var(--space-md) var(--space-lg);margin-bottom:var(--space-sm)">' +
                    '<div style="display:flex;justify-content:space-between;align-items:center">' +
                    '<div><div style="font-size:0.82rem;font-weight:700">' + (g.name || 'Doel ' + (i+1)) + '</div>' +
                    '<div style="font-size:0.72rem;color:var(--text-muted)">Prioriteit ' + (g.priority || (i+1)) + ' \u00b7 ' + formatEuro(g.targetCents || 0) + '</div></div>' +
                    '<button style="background:none;border:none;color:var(--red);font-size:0.75rem;cursor:pointer;padding:8px" onclick="premRemoveGoal(\'' + g.id + '\')">\u2715</button></div></div>';
            });
        }
        html += '<button class="btn-add" onclick="premAddGoalPrompt()" style="width:100%;padding:12px;font-size:0.82rem;border-radius:10px;margin-top:var(--space-sm)">+ Spaardoel toevoegen</button>';
        container.innerHTML = html;
    }

    function premAddGoalPrompt() {
        premLog('extra_goal_add');
        var name = prompt('Naam van je spaardoel:');
        if (!name) return;
        var amountStr = prompt('Doelbedrag (\u20ac):');
        if (!amountStr) return;
        var amount = toCents(amountStr);
        if (amount <= 0) return;
        if (!appData.extraGoals) appData.extraGoals = [];
        var priority = appData.extraGoals.length + 2; // main goal = 1
        appData.extraGoals.push({ id: genId('goal'), name: name, targetCents: amount, priority: priority });
        saveData();
        premRenderExtraGoals();
    }

    function premRemoveGoal(id) {
        if (!appData.extraGoals) return;
        appData.extraGoals = appData.extraGoals.filter(function(g) { return g.id !== id; });
        saveData();
        premRenderExtraGoals();
    }

    // Premium: Trends view
    function premOpenTrends() {
        premLog('trends_open');
        var content = document.getElementById('premModalContent');
        var overlay = document.getElementById('premModal');
        if (!content || !overlay) return;

        var periods = salaryPeriods || [];
        var maxPeriods = isPremium ? periods.length : Math.min(2, periods.length);
        var data = [];
        for (var i = 0; i < maxPeriods; i++) {
            var p = periods[i];
            if (!p) continue;
            var income = calculateIncomeTotalCents(p.key);
            var fixed = calculateFixedCostsTotalCents(p.key);
            var groceries = calculateMonthGroceriesCents(p.key);
            var spending = calculateMonthSpendingCents(p.key);
            var totalSpent = fixed + groceries + spending;
            var saved = income - totalSpent;
            data.push({ name: p.name || p.key, income: income, spent: totalSpent, saved: saved });
        }

        var html = '<div style="font-size:1.05rem;font-weight:800;margin-bottom:var(--space-lg);text-align:center">Trends</div>';

        if (data.length === 0) {
            html += '<div style="text-align:center;color:var(--text-muted);font-size:0.82rem;padding:var(--space-xl) 0">Nog niet genoeg data. Gebruik GRIP een maand en je trends verschijnen hier.</div>';
        } else {
            data.forEach(function(d) {
                var barMax = Math.max(d.income, d.spent, 1);
                var spentPct = Math.min(100, Math.round((d.spent / barMax) * 100));
                html += '<div style="margin-bottom:var(--space-lg)">' +
                    '<div style="font-size:0.78rem;font-weight:700;margin-bottom:var(--space-xs)">' + d.name + '</div>' +
                    '<div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--text-muted);margin-bottom:4px"><span>Uitgegeven: ' + formatEuro(d.spent) + '</span><span>Gespaard: <span style="color:' + (d.saved >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatEuro(d.saved) + '</span></span></div>' +
                    '<div style="height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden"><div style="height:100%;width:' + spentPct + '%;background:' + (d.saved >= 0 ? 'var(--accent)' : 'var(--red)') + ';border-radius:4px;transition:width 0.3s"></div></div></div>';
            });
        }

        if (!isPremium && periods.length > 2) {
            html += '<div style="text-align:center;margin-top:var(--space-lg);padding:var(--space-lg);background:rgba(226,169,59,0.04);border:1px solid rgba(226,169,59,0.12);border-radius:var(--radius-lg);cursor:pointer" onclick="premCloseModal();premShowPaywall(\'trends\')">' +
                '<div style="font-size:0.82rem;font-weight:700;color:var(--text-secondary);margin-bottom:4px">Onbeperkte historie</div>' +
                '<div style="font-size:0.72rem;color:var(--text-muted)">Je hebt ' + periods.length + ' periodes. Premium toont ze allemaal.</div>' +
                '<span class="prem-badge-sm" style="margin-top:8px;display:inline-block">PREMIUM</span></div>';
        }

        html += '<button class="prem-modal-btn-secondary" onclick="premCloseModal()" style="margin-top:var(--space-lg)">Sluiten</button>';
        content.innerHTML = html;
        overlay.classList.add('show');
    }

    // ═══════════════════════════════════════════════════════════════
    // CINEMATIC PRE-ONBOARDING INTRO
    // ═══════════════════════════════════════════════════════════════
    const CIN_PHASES = 6;
    let cinPhase = 0;
    let cinChoices = { goal: '', self: '', focus: '' };
    let cinPersonaResult = null;
    let cinAudioCtx = null;

    function cinInitAudio() {
        try {
            cinAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch(e) {}
    }

    function cinTick() {
        if (!cinAudioCtx) return;
        try {
            const t = cinAudioCtx.currentTime;
            // iPhone keyboard pop: quick sine pop + tiny noise transient
            const osc = cinAudioCtx.createOscillator();
            const oscGain = cinAudioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1400 + Math.random() * 200, t);
            osc.frequency.exponentialRampToValueAtTime(800, t + 0.008);
            oscGain.gain.setValueAtTime(0.12, t);
            oscGain.gain.exponentialRampToValueAtTime(0.001, t + 0.008);
            osc.connect(oscGain);
            oscGain.connect(cinAudioCtx.destination);
            osc.start(t);
            osc.stop(t + 0.01);
            // Tiny click transient
            const bufLen = Math.floor(cinAudioCtx.sampleRate * 0.004);
            const buf = cinAudioCtx.createBuffer(1, bufLen, cinAudioCtx.sampleRate);
            const d = buf.getChannelData(0);
            for (let i = 0; i < bufLen; i++) d[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufLen * 0.2));
            const click = cinAudioCtx.createBufferSource();
            click.buffer = buf;
            const hp = cinAudioCtx.createBiquadFilter();
            hp.type = 'highpass';
            hp.frequency.value = 4000;
            const cg = cinAudioCtx.createGain();
            cg.gain.setValueAtTime(0.08, t);
            cg.gain.exponentialRampToValueAtTime(0.001, t + 0.005);
            click.connect(hp);
            hp.connect(cg);
            cg.connect(cinAudioCtx.destination);
            click.start(t);
            click.stop(t + 0.005);
        } catch(e) {}
    }
    const cinReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    function cinVibrate(ms) {
        try { if (navigator.vibrate) navigator.vibrate(ms || 10); } catch(e) {}
    }

    function cinBackTo(n) {
        cinShowPhase(n);
    }

    function cinShowPhase(n) {
        cinPhase = n;
        document.querySelectorAll('.cin-phase').forEach(p => p.classList.remove('active'));
        const el = document.getElementById('cinP' + (n <= 3 ? (n === 3 ? '3a' : n) : (n === 4 ? '3b' : (n === 5 ? '4' : (n === 6 ? '5' : '6')))));
        // Map: cinPhase 1=P1, 2=P2, 3=P3a, 4=P3b, 5=P4, 6=P5, 7=P6
        // Simpler: use array
        const phaseMap = ['cinP0','cinP2','cinP3a','cinP3b','cinP3c','cinP4','cinP5','cinP6'];
        const target = document.getElementById(phaseMap[n]);
        if (target) target.classList.add('active');
        // Update pips
        const pips = document.getElementById('cinPips');
        if (pips) {
            pips.innerHTML = Array.from({length: 8}, (_, i) => {
                const idx = i;
                const cls = idx < n ? 'done' : idx === n ? 'current' : '';
                return '<div class="cin-pip ' + cls + '"></div>';
            }).join('');
        }
    }



    function cinSpawnPhoneMatrix() {
        const container = document.getElementById('cinPhoneMatrix');
        if (!container) return;
        // Mini canvas inside phone mockup
        const c = document.createElement('canvas');
        c.width = 124; c.height = 256;
        c.style.cssText = 'width:100%;height:100%';
        container.appendChild(c);
        const ctx = c.getContext('2d');
        const amounts = ['€8','€24','€1.2k','€4','€67','€350','€12','€890','€155','€42'];
        const drops = [];
        for (let i = 0; i < 15; i++) {
            drops.push({
                x: 8 + Math.random() * 108,
                y: -10 - Math.random() * 256,
                speed: 0.6 + Math.random() * 1.2,
                text: amounts[Math.floor(Math.random() * amounts.length)],
                alpha: 0.2 + Math.random() * 0.4
            });
        }
        function draw() {
            ctx.clearRect(0, 0, 124, 256);
            for (const d of drops) {
                d.y += d.speed;
                if (d.y > 270) { d.y = -15; d.text = amounts[Math.floor(Math.random() * amounts.length)]; }
                ctx.globalAlpha = d.alpha * (d.y < 20 ? d.y / 20 : d.y > 220 ? (256 - d.y) / 36 : 1);
                ctx.font = '7px Courier New';
                ctx.fillStyle = '#e2a93b';
                ctx.fillText(d.text, d.x, d.y);
            }
            requestAnimationFrame(draw);
        }
        draw();
    }

    function cinLaunchMatrix() {
        // Init audio on user gesture (required for iOS Safari)
        cinInitAudio();
        cinVibrate(15);
        // Go straight to typewriter
        cinRunPhase2();
    }

    function cinStart() {
        const intro = document.getElementById('cinIntro');
        if (!intro) return;
        intro.classList.remove('hidden');
        cinPhase = 0;
        cinShowPhase(0);

        // Spawn mini matrix inside phone mockup
        cinSpawnPhoneMatrix();

        // Show start button with delay
        setTimeout(() => {
            const btn = document.getElementById('cinStartBtn');
            if (btn) btn.classList.add('show');
        }, 100);
    }


    function cinRunPhase2() {
        cinShowPhase(1);
        const statements = [
            { text: 'Eén op de drie huishoudens heeft moeite om rond te komen. <em>Dat hoeft niet zo te zijn.</em>', src: 'Nibud, Geldzaken in de praktijk 2024' },
            { text: 'Wie dagelijks zijn uitgaven bijhoudt, <em>spaart aantoonbaar meer</em>. Kleine stappen, groot effect.', src: 'Frontiers in Behavioral Economics, 2024' },
            { text: 'Financiële stress komt zelden door te weinig verdienen. Bijna altijd door <em>te weinig overzicht</em>.', src: 'Nibud, 2022' },
            { text: 'Een slim dagbudget met automatische buffers, dat is <em>bewezen effectiever</em> dan alleen willskracht.', src: 'Thaler & Benartzi, Save More Tomorrow' },
            { text: 'Daarom hebben we <em>GRIP</em> gebouwd.', src: '' }
        ];
        // Pause after each statement (ms) — let it land
        const pauses = [1800, 2200, 2400, 2000, 1400];
        const el = document.getElementById('cinTypewriter');
        if (!el) return;
        let stIdx = 0;
        let chIdx = 0;

        function typeNext() {
            if (stIdx >= statements.length) {
                // Show continue button after final pause
                setTimeout(() => {
                    const btn = document.createElement('div');
                    btn.innerHTML = '<button class="btn-add" onclick="cinRunPhase3a()" style="margin-top:var(--space-xl);padding:14px 40px;font-size:0.88rem;border-radius:14px;opacity:0;transform:translateY(8px);transition:opacity 0.3s,transform 0.3s">Ga verder</button>';
                    el.parentElement.appendChild(btn);
                    setTimeout(() => { const b = btn.querySelector('button'); if(b){b.style.opacity='1';b.style.transform='translateY(0)';} }, 50);
                }, 600);
                return;
            }
            const st = statements[stIdx].text;
            const src = statements[stIdx].src;
            if (chIdx === 0) {
                // Fade in new statement
                el.style.opacity = '0';
                setTimeout(() => { el.style.opacity = '1'; }, 50);
            }
            if (chIdx < st.length) {
                // Skip HTML tags instantly
                if (st[chIdx] === '<') {
                    const closeIdx = st.indexOf('>', chIdx);
                    if (closeIdx !== -1) { chIdx = closeIdx + 1; setTimeout(typeNext, 0); return; }
                }
                chIdx++;
                el.innerHTML = st.substring(0, chIdx) + '<span class="cin-cursor"></span>';
                if (chIdx % 2 === 0) cinTick();
                if (chIdx % 3 === 0) cinVibrate(5);
                const ch = st[chIdx-1];
                const delay = cinReducedMotion ? 8 : (ch === '.' ? 220 : ch === ',' ? 110 : 22);
                setTimeout(typeNext, delay);
            } else {
                // End of statement — show full text + source, let it sink in
                el.innerHTML = st + (src ? '<span class="cin-source">' + src + '</span>' : '');
                const pause = cinReducedMotion ? 600 : (pauses[stIdx] || 1800);
                stIdx++;
                chIdx = 0;
                setTimeout(typeNext, pause);
            }
        }
        typeNext();
    }

    function cinRunPhase3a() {
        cinShowPhase(2);
        const options = [
            { key: 'save', text: 'Ik wil sparen, maar weet niet hoeveel ik kan missen' },
            { key: 'overview', text: 'Ik wil weten waar mijn geld elke maand blijft' },
            { key: 'goal', text: 'Ik wil ergens concreet naartoe sparen' },
            { key: 'peace', text: 'Ik wil gewoon rust in mijn geldzaken' }
        ];
        const container = document.getElementById('cinCards3a');
        if (!container) return;
        container.innerHTML = options.map(o =>
            '<div class="cin-card" onclick="cinSelect3a(this,\'' + o.key + '\')">' + o.text + '</div>'
        ).join('');
    }

    function cinSelect3a(el, key) {
        cinChoices.goal = key;
        document.querySelectorAll('#cinCards3a .cin-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        cinVibrate(10);
        setTimeout(() => cinRunPhase3b(), 400);
    }

    function cinRunPhase3b() {
        cinShowPhase(3);
        const options = [
            { key: 'spender', text: 'Ik geef makkelijk uit' },
            { key: 'frugal', text: 'Ik ben best zuinig maar mis overzicht' },
            { key: 'structure', text: 'Ik wil structuur en discipline' },
            { key: 'optimizer', text: 'Ik spaar al, maar wil het slimmer doen' }
        ];
        const container = document.getElementById('cinCards3b');
        if (!container) return;
        container.innerHTML = options.map(o =>
            '<div class="cin-card" onclick="cinSelect3b(this,\'' + o.key + '\')">' + o.text + '</div>'
        ).join('');
    }

    function cinSelect3b(el, key) {
        cinChoices.self = key;
        document.querySelectorAll('#cinCards3b .cin-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        cinVibrate(10);
        setTimeout(() => cinRunPhase3c(), 400);
    }

    function cinRunPhase3c() {
        cinShowPhase(4);
        const options = [
            { key: 'daily', text: 'Mijn dagelijks budget' },
            { key: 'saving', text: 'Structureel sparen' },
            { key: 'fixed', text: 'Mijn vaste lasten' },
            { key: 'all', text: 'Eigenlijk alles' }
        ];
        const container = document.getElementById('cinCards3c');
        if (!container) return;
        container.innerHTML = options.map(o =>
            '<div class="cin-card" onclick="cinSelect3c(this,\'' + o.key + '\')">' + o.text + '</div>'
        ).join('');
    }

    function cinSelect3c(el, key) {
        cinChoices.focus = key;
        document.querySelectorAll('#cinCards3c .cin-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        cinVibrate(10);
        setTimeout(() => cinRunPhase4(), 400);
    }

    function cinRunPhase4() {
        // Skip the old loader + verdict — go straight to CTA
        // Still compute persona silently for later use
        var persona = computePersona({ q1: cinChoices.goal, q2: cinChoices.self, q3: cinChoices.focus, q4: '', q5: '' });
        cinPersonaResult = persona;

        cinRunPhase6();
    }

    function cinRunPhase5() {
        // Unused - kept for phaseMap compatibility
        cinRunPhase6();
    }

    function cinRunPhase6() {
        cinShowPhase(7);
        const el = document.getElementById('cinPromise');
        const cta = document.getElementById('cinCta');
        if (el) {
            el.innerHTML = 'Klaar om grip te krijgen op je geld?';
            setTimeout(() => el.classList.add('show'), 100);
        }
        if (cta) setTimeout(() => cta.classList.add('show'), 400);
    }

    function cinSkip() {
        cinFinish();
    }

    function cinFinish() {
        appData.introSeen = true;
        saveData();
        const intro = document.getElementById('cinIntro');
        if (intro) {
            intro.style.transition = 'opacity 0.3s ease';
            intro.style.opacity = '0';
            setTimeout(() => {
                intro.classList.add('hidden');
                intro.style.opacity = '';
                // Skip intro splash, go straight to onboarding
                startOnboarding();
            }, 300);
        }
    }

    function startApp() {
        loadData();
        premCheck();
        premInitPricing();
        restoreCustomCategories();
        // Language: Dutch only
        applyTheme();
        generateSalaryPeriods();

        if (!appData.setupComplete) {
            if (!appData.introSeen) {
                cinStart();
            } else {
                document.getElementById('introSplash')?.classList.remove('hidden');
            }
        } else if (!appData.pin) {
            // Edge case: setupComplete but no PIN (corrupt state) — go to Home
            ensureActiveMonthSynced();
            document.getElementById('app')?.classList.remove('hidden');
            showView('home');
        } else {
            ensureActiveMonthSynced();
            initPinScreen();
            document.getElementById('pinScreen')?.classList.remove('hidden');
        }
    }

    // Boot
    startApp();

    // Generate PWA icon dynamically
    (function() {
        const canvas = document.createElement('canvas');
        canvas.width = 180; canvas.height = 180;
        const ctx = canvas.getContext('2d');
        // Black rounded rect background
        ctx.fillStyle = '#08080C';
        ctx.beginPath();
        ctx.roundRect(0, 0, 180, 180, 40);
        ctx.fill();
        // Gold text
        ctx.fillStyle = '#E2A93B';
        ctx.font = '900 44px -apple-system, system-ui, sans-serif';
        ctx.letterSpacing = '6px';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('GRIP', 90, 90);
        // Set as icon
        const url = canvas.toDataURL('image/png');
        const link = document.querySelector('link[rel="apple-touch-icon"]');
        if (link) link.href = url;
        const fav = document.querySelector('link[rel="icon"]');
        if (fav) fav.href = url;
    })();


    </script>

    <!-- ═══ PREMIUM PAYWALL ═══ -->
    <div id="premPaywall" class="prem-paywall" onclick="if(event.target===this)premClosePaywall()">
        <div class="prem-pw-sheet">
        <div class="prem-pw-top" style="position:relative">
            <div style="width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,0.15);margin:0 auto var(--space-md)"></div>
            <button class="prem-pw-close" onclick="premClosePaywall()">✕</button>
            <div style="margin-top:var(--space-lg)">
                <div class="prem-badge" style="margin-bottom:var(--space-md)">PREMIUM</div>
                <div class="prem-pw-headline">Weet wat je veilig<br>kunt uitgeven</div>
                <div class="prem-pw-sub">Premium rekent komende rekeningen mee<br>en waarschuwt voor je krap komt.</div>
            </div>
        </div>
        <div class="prem-pw-content">
            <div class="prem-pw-features">
                <div class="prem-pw-feat">
                    <div class="prem-pw-feat-icon">🛡️</div>
                    <div><div class="prem-pw-feat-text">Veilig te besteden, rekeningen meegerekend</div><div class="prem-pw-feat-sub">bv. Huur over 5 dagen, dagbudget daalt naar &#8364;31</div></div>
                </div>
                <div class="prem-pw-feat">
                    <div class="prem-pw-feat-icon">⚠️</div>
                    <div><div class="prem-pw-feat-text">Waarschuwing voordat je krap komt</div><div class="prem-pw-feat-sub">bv. Bij dit tempo kom je &#8364;42 tekort voor salarisdag</div></div>
                </div>
                <div class="prem-pw-feat">
                    <div class="prem-pw-feat-icon">🔮</div>
                    <div><div class="prem-pw-feat-text">Scenario&#39;s doorrekenen</div><div class="prem-pw-feat-sub">bv. &#8364;25/week minder, spaardoel 2 maanden eerder</div></div>
                </div>
                <div class="prem-pw-feat">
                    <div class="prem-pw-feat-icon">🎯</div>
                    <div><div class="prem-pw-feat-text">Meerdere spaardoelen met prioriteit</div><div class="prem-pw-feat-sub">bv. Eerst &#8364;1.000 buffer, dan vakantie</div></div>
                </div>
                <div class="prem-pw-feat">
                    <div class="prem-pw-feat-icon">📅</div>
                    <div><div class="prem-pw-feat-text">Salarisplanning per maand</div><div class="prem-pw-feat-sub">bv. December: salaris op de 20e + eindejaarsbonus</div></div>
                </div>
            </div>

            <!-- Comparison -->
            <div class="prem-compare">
                <div class="prem-compare-row prem-compare-head"><div></div><div>Gratis</div><div style="color:var(--accent)">Premium</div></div>
                <div class="prem-compare-row"><div>Uitgaven bijhouden</div><div class="prem-compare-check">✓</div><div class="prem-compare-check">✓</div></div>
                <div class="prem-compare-row"><div>1 spaardoel</div><div class="prem-compare-check">✓</div><div class="prem-compare-check">✓</div></div>
                <div class="prem-compare-row"><div>Spaardoelen + prioriteit</div><div class="prem-compare-x">—</div><div class="prem-compare-check">✓</div></div>
                <div class="prem-compare-row"><div>Salarisplanning per maand</div><div class="prem-compare-x">—</div><div class="prem-compare-check">✓</div></div>
                <div class="prem-compare-row"><div>Veilig te besteden incl. rekeningen</div><div style="text-align:center;font-size:0.65rem;color:var(--text-muted)">basis</div><div class="prem-compare-check">✓</div></div>
                <div class="prem-compare-row"><div>Waarschuwingen voor je krap komt</div><div class="prem-compare-x">—</div><div class="prem-compare-check">✓</div></div>
                <div class="prem-compare-row"><div>Scenario&#39;s doorrekenen</div><div class="prem-compare-x">—</div><div class="prem-compare-check">✓</div></div>
                <div class="prem-compare-row"><div>Trends en historie</div><div style="text-align:center;font-size:0.65rem;color:var(--text-muted)">2 mnd</div><div class="prem-compare-check">✓</div></div>
            </div>

            <!-- Plans -->
            <div style="font-size:0.72rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:var(--space-sm)">Kies je plan</div>
            <div class="prem-plans">
                <div class="prem-plan" id="premPlanMonth" onclick="premSelectPlan('month')">
                    <div class="prem-plan-period">Maand</div>
                    <div class="prem-plan-price" id="premPriceMonth">€6,99</div>
                    <div class="prem-plan-per">per maand</div>
                </div>
                <div class="prem-plan selected" id="premPlanYear" onclick="premSelectPlan('year')">
                    <div class="prem-plan-rec">Aanbevolen</div>
                    <div class="prem-plan-period">Jaar</div>
                    <div class="prem-plan-price" id="premPriceYear">€49,99</div>
                    <div class="prem-plan-per">per jaar</div>
                    <div class="prem-plan-save">Bespaar 40%</div>
                </div>
            </div>

            <button class="prem-pw-cta" onclick="premMockPurchase()">Probeer Premium</button>
            <button class="prem-pw-later" onclick="premClosePaywall()" style="width:100%;padding:12px;border:none;background:none;color:var(--text-muted);font-size:0.82rem;font-weight:600;cursor:pointer;font-family:var(--font);margin-top:var(--space-xs)">Misschien later</button>
            <div style="text-align:center;font-size:0.65rem;color:var(--text-muted);margin-top:var(--space-sm);opacity:0.6">Lokale opslag. Geen trackers. Opzeggen wanneer je wilt.</div>
        </div>
        <div class="prem-pw-footer">
            <a href="#">Privacy</a><span>·</span><a href="#">Voorwaarden</a><span>·</span><a href="#" onclick="premRestorePurchase();return false">Herstel aankopen</a>
        </div>
        </div>
    </div>

    <!-- ═══ PREMIUM CONTEXT MODAL ═══ -->
    <div id="premModal" class="prem-overlay" onclick="if(event.target===this)premCloseModal()">
        <div class="prem-sheet" style="position:relative">
            <div class="prem-sheet-handle"></div>
            <button class="prem-close" onclick="premCloseModal()">✕</button>
            <div id="premModalContent"></div>
        </div>
    </div>

</body>
</html>
