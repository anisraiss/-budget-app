<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GRIP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;0,9..40,900;1,9..40,400&display=swap" rel="stylesheet">
    <style>
    /* ═══════════════════════════════════════
       GRIP — DESIGN TOKENS
       ═══════════════════════════════════════ */
    :root {
        /* Brand */
        --accent: #E2A93B;
        --accent-rgb: 226, 169, 59;
        --accent-rgb: 226,169,59;
        --accent-dim: rgba(226,169,59,0.08);
        --accent-mid: rgba(226,169,59,0.20);
        --accent-glow: rgba(226,169,59,0.12);

        /* Status — locked tokens */
        --green: #3DD598;
        --green-dim: rgba(61,213,152,0.10);
        --red: #E85A5A;
        --red-dim: rgba(232,90,90,0.10);
        --caution: #E8965A;
        --caution-dim: rgba(232,150,90,0.10);
        --danger: #E85A5A;
        --danger-dim: rgba(232,90,90,0.10);

        /* Surfaces — Dark */
        --bg: #08080c;
        --bg-card: rgba(255,255,255,0.028);
        --bg-card-solid: #111116;
        --bg-elevated: #16161c;
        --bg-input: #0e0e14;
        --glass: rgba(255,255,255,0.035);
        --glass-border: rgba(255,255,255,0.07);

        /* Text */
        --text-primary: #f0f0f5;
        --text-secondary: rgba(255,255,255,0.55);
        --text-tertiary: rgba(255,255,255,0.50);
        --text-muted: rgba(255,255,255,0.25);

        /* Spacing */
        --space-xs: 4px;
        --space-sm: 8px;
        --space-md: 12px;
        --space-lg: 16px;
        --space-xl: 20px;
        --space-2xl: 24px;
        --space-3xl: 32px;

        /* Radius */
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 20px;
        --radius-full: 50%;

        /* Shadows */
        --shadow: 0 2px 16px rgba(0,0,0,0.3);
        --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);

        /* Motion */
        --ease: cubic-bezier(0.4, 0, 0.2, 1);
        --duration: 0.25s;

        /* Type */
        --font: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        --tabular: tabular-nums;
    }

    /* Light mode */
    [data-theme="light"] {
        --bg: #F3F1EC;
        --bg-card: rgba(255,255,255,0.65);
        --bg-card-solid: #FFFFFF;
        --bg-elevated: #FAFAFA;
        --bg-input: #EDE9E3;
        --glass: rgba(255,255,255,0.55);
        --glass-border: rgba(0,0,0,0.06);
        --text-primary: #1a1a1a;
        --text-secondary: rgba(0,0,0,0.55);
        --text-tertiary: rgba(0,0,0,0.50);
        --text-muted: rgba(0,0,0,0.20);
        --shadow: 0 2px 12px rgba(0,0,0,0.06);
        --shadow-lg: 0 8px 24px rgba(0,0,0,0.08);
        --accent-glow: rgba(226,169,59,0.06);
    }

    /* ═══════════════════════════════════════
       RESET & BASE
       ═══════════════════════════════════════ */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: var(--font);
        background: var(--bg);
        color: var(--text-primary);
        min-height: 100vh;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -webkit-tap-highlight-color: transparent;
    }

    .hidden { display: none !important; }

    /* ═══════════════════════════════════════
       PIN SCREEN
       ═══════════════════════════════════════ */
    .pin-screen {
        position: fixed;
        inset: 0;
        background: var(--bg);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .pin-logo {
        font-size: 1.6rem;
        font-weight: 900;
        letter-spacing: 6px;
        color: var(--accent);
        margin-bottom: 32px;
    }

    .pin-subtitle {
        font-size: 0.85rem;
        color: var(--text-tertiary);
        margin-bottom: 24px;
    }

    .pin-dots {
        display: flex;
        gap: 16px;
        margin-bottom: 32px;
    }

    .pin-dot {
        width: 14px;
        height: 14px;
        border-radius: var(--radius-full);
        border: 2px solid var(--text-muted);
        transition: all var(--duration) var(--ease);
    }

    .pin-dot.filled {
        background: var(--accent);
        border-color: var(--accent);
    }

    .pin-error {
        font-size: 0.82rem;
        color: var(--danger);
        margin-top: var(--space-md);
        opacity: 0;
        transition: opacity 0.3s;
    }
    .pin-error.show { opacity: 1; }

    .pin-keypad {
        display: grid;
        grid-template-columns: repeat(3, 72px);
        gap: 12px;
    }

    .pin-key {
        width: 72px;
        height: 72px;
        border-radius: var(--radius-full);
        border: 1px solid var(--glass-border);
        background: var(--glass);
        color: var(--text-primary);
        font-size: 1.4rem;
        font-weight: 600;
        font-family: var(--font);
        cursor: pointer;
        transition: all 0.15s var(--ease);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .pin-key:active { background: var(--accent-dim); transform: scale(0.95); }

    /* ═══════════════════════════════════════
       APP HEADER (glass)
       ═══════════════════════════════════════ */
    .app-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: calc(52px + env(safe-area-inset-top, 0px));
        padding-top: env(safe-area-inset-top, 0px);
        background: rgba(8,8,12,0.85);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-left: var(--space-lg);
        padding-right: var(--space-lg);
        z-index: 100;
    }
    [data-theme="light"] .app-header {
        background: rgba(243,241,236,0.88);
    }

    .header-logo {
        font-size: 1.1rem;
        font-weight: 900;
        letter-spacing: 4px;
        color: var(--accent);
    }

    .header-avatar {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-full);
        background: var(--accent-dim);
        border: 1.5px solid rgba(var(--accent-rgb), 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        cursor: pointer;
        overflow: hidden;
    }
    .header-avatar img { width:100%;height:100%;object-fit:cover; }

    /* ═══════════════════════════════════════
       TAB BAR (glass, bottom)
       ═══════════════════════════════════════ */
    .tab-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 64px;
        background: rgba(8,8,12,0.88);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border-top: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: space-around;
        z-index: 100;
        padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    [data-theme="light"] .tab-bar {
        background: rgba(243,241,236,0.90);
    }

    .tab-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3px;
        cursor: pointer;
        padding: 10px 0;
        min-height: 48px;
        -webkit-tap-highlight-color: transparent;
    }

    .tab-icon {
        width: 24px;
        height: 24px;
        color: var(--text-tertiary);
        transition: color var(--duration) var(--ease);
    }
    .tab-icon svg { width: 100%; height: 100%; }

    .tab-label {
        font-size: 0.65rem;
        font-weight: 600;
        color: var(--text-tertiary);
        letter-spacing: 0.3px;
        transition: color var(--duration) var(--ease);
    }

    .tab-item.active .tab-icon { color: var(--accent); }
    .tab-item.active .tab-label { color: var(--accent); }

    /* ═══════════════════════════════════════
       VIEWS
       ═══════════════════════════════════════ */
    #app {
        padding-top: calc(52px + env(safe-area-inset-top, 0px));
        padding-bottom: calc(72px + env(safe-area-inset-bottom, 0px));
    }

    .view {
        padding: var(--space-lg);
        animation: viewFadeIn 0.3s var(--ease);
    }

    @keyframes viewFadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ═══════════════════════════════════════
       CARDS
       ═══════════════════════════════════════ */
    .card {
        background: var(--bg-card);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        margin-bottom: var(--space-lg);
    }

    .card-primary {
        text-align: center;
        padding: var(--space-2xl) var(--space-xl);
        border-color: rgba(var(--accent-rgb), 0.10);
    }

    .card-label {
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--text-tertiary);
        letter-spacing: 0.5px;
        text-transform: uppercase;
        margin-bottom: var(--space-sm);
    }

    .card-amount {
        font-size: 2.8rem;
        font-weight: 900;
        font-variant-numeric: var(--tabular);
        line-height: 1;
        margin-bottom: var(--space-md);
        transition: color 0.3s var(--ease);
    }

    .card-sub {
        font-size: 0.8rem;
        color: var(--text-tertiary);
    }

    /* Progressbar */
    .progress-track {
        width: 100%;
        height: 6px;
        background: var(--text-muted);
        border-radius: 3px;
        margin: var(--space-md) 0 var(--space-sm);
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        border-radius: 3px;
        background: var(--accent);
        transition: width 0.5s var(--ease);
    }
    .progress-fill.caution { background: var(--caution); }

    /* ═══════════════════════════════════════
       QUICK-ADD
       ═══════════════════════════════════════ */
    .quick-add-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-sm);
        margin-bottom: var(--space-lg);
    }

    .quick-chip {
        padding: 14px 0;
        min-height: 44px;
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        background: var(--glass);
        color: var(--text-primary);
        font-size: 0.88rem;
        font-weight: 700;
        font-family: var(--font);
        font-variant-numeric: var(--tabular);
        cursor: pointer;
        transition: all 0.15s var(--ease);
        text-align: center;
    }
    .quick-chip:active {
        background: var(--accent-dim);
        border-color: var(--accent);
        transform: scale(0.96);
    }
    .quick-chip.edit-chip {
        color: var(--text-tertiary);
        font-weight: 600;
    }

    /* Inline manual input */
    .inline-input-area {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height 0.3s var(--ease), opacity 0.25s var(--ease), margin 0.3s var(--ease);
        margin-bottom: 0;
    }
    .inline-input-area.open {
        max-height: 200px;
        opacity: 1;
        margin-bottom: var(--space-lg);
    }
    .inline-input-row {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
    }
    .grip-input {
        flex: 1;
        padding: 12px 14px;
        background: var(--bg-input);
        border: 1.5px solid var(--glass-border);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 1rem;
        font-family: var(--font);
        font-variant-numeric: var(--tabular);
        outline: none;
        transition: border-color var(--duration) var(--ease);
    }
    .grip-input:focus { border-color: var(--accent); outline: none; }
    .grip-input:focus-visible { box-shadow: 0 0 0 2px rgba(var(--accent-rgb), 0.3); }
    .grip-input.caution { border-color: var(--caution); }
    .grip-input::placeholder { color: var(--text-muted); }
    select.grip-input { appearance: auto; }

    /* Focus-visible for all interactive elements */
    .pin-key:focus-visible,
    .quick-chip:focus-visible,
    .tab-item:focus-visible,
    .btn-add:focus-visible,
    .btn-save:focus-visible,
    .btn-danger:focus-visible,
    .ob-nav-next:focus-visible,
    .ob-nav-back:focus-visible,
    .prof-row:focus-visible,
    .collapse-toggle:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
            animation-duration: 0.01ms !important;
            transition-duration: 0.01ms !important;
        }
    }

    .grip-input-sm {
        padding: 10px 12px;
        font-size: 0.88rem;
    }

    .btn-add {
        padding: 12px 20px;
        background: var(--accent);
        color: #000;
        border: none;
        border-radius: var(--radius-md);
        font-size: 0.88rem;
        font-weight: 700;
        font-family: var(--font);
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.15s var(--ease);
    }
    .btn-add:active { transform: scale(0.96); }

    .inline-note-row {
        margin-top: var(--space-sm);
    }

    .input-hint {
        font-size: 0.72rem;
        color: var(--caution);
        margin-top: var(--space-xs);
        opacity: 0;
        transition: opacity 0.2s;
    }
    .input-hint.visible { opacity: 1; }

    /* ═══════════════════════════════════════
       TRANSACTION LIST
       ═══════════════════════════════════════ */
    .section-title {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: var(--space-md);
    }

    .tx-list {
        margin-bottom: var(--space-lg);
    }

    .tx-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-md) 0;
        border-bottom: 1px solid var(--glass-border);
    }
    .tx-item:last-child { border-bottom: none; }

    .tx-info { flex: 1; }
    .tx-note {
        font-size: 0.82rem;
        color: var(--text-secondary);
    }
    .tx-time {
        font-size: 0.72rem;
        color: var(--text-muted);
        margin-top: 2px;
    }
    .tx-amount {
        font-size: 0.92rem;
        font-weight: 700;
        font-variant-numeric: var(--tabular);
        margin-left: var(--space-md);
    }
    .tx-delete {
        margin-left: var(--space-sm);
        width: 36px;
        height: 36px;
        border: none;
        background: none;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        flex-shrink: 0;
    }
    .tx-delete:hover { background: var(--danger-dim); color: var(--danger); }

    /* ═══════════════════════════════════════
       STATUS CARD (periode + spaargeld)
       ═══════════════════════════════════════ */
    .status-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-lg);
        cursor: pointer;
    }

    .status-left { flex: 1; }
    .status-label {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        margin-bottom: 2px;
    }
    .status-value {
        font-size: 0.95rem;
        font-weight: 700;
    }
    .status-sub {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        margin-top: 2px;
    }

    .status-dots {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        max-width: 120px;
        justify-content: flex-end;
    }
    .dot {
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
        background: var(--text-muted);
    }
    .dot.green { background: var(--green); }
    .dot.caution { background: var(--caution); }
    .dot.today { box-shadow: 0 0 0 2px var(--accent); }

    /* ═══════════════════════════════════════
       UNDO TOAST
       ═══════════════════════════════════════ */
    .toast {
        position: fixed;
        bottom: calc(72px + env(safe-area-inset-bottom, 0px) + 8px);
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        padding: 12px 20px;
        background: var(--bg-card-solid);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 0.85rem;
        font-weight: 600;
        font-family: var(--font);
        z-index: 9000;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s var(--ease);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        box-shadow: var(--shadow);
        max-width: calc(100vw - 32px);
    }
    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
        pointer-events: auto;
    }
    .toast-undo {
        color: var(--accent);
        font-weight: 700;
        cursor: pointer;
        margin-left: var(--space-sm);
    }

    /* ═══════════════════════════════════════
       EMPTY STATES
       ═══════════════════════════════════════ */
    .empty-state {
        text-align: center;
        padding: var(--space-2xl) var(--space-lg);
        color: var(--text-tertiary);
        font-size: 0.88rem;
        line-height: 1.6;
    }

    /* ═══════════════════════════════════════
       GREETING
       ═══════════════════════════════════════ */
    .greeting {
        font-size: 0.82rem;
        color: var(--text-tertiary);
        margin-bottom: var(--space-lg);
    }

    /* ═══════════════════════════════════════
       PLACEHOLDER VIEWS
       ═══════════════════════════════════════ */
    .placeholder-view {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 50vh;
        text-align: center;
        color: var(--text-tertiary);
    }
    .placeholder-icon {
        font-size: 2.5rem;
        margin-bottom: var(--space-lg);
        opacity: 0.5;
    }
    .placeholder-title {
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: var(--space-sm);
        color: var(--text-secondary);
    }

    /* ═══════════════════════════════════════
       ONBOARDING BASE STYLES
       ═══════════════════════════════════════ */
    .ob-screen {
        position: fixed;
        inset: 0;
        background: var(--bg);
        z-index: 9998;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 24px;
        text-align: center;
    }
    .ob-title {
        font-size: 1.8rem;
        font-weight: 900;
        letter-spacing: 4px;
        color: var(--accent);
        margin-bottom: var(--space-md);
    }
    .ob-sub {
        font-size: 0.95rem;
        color: var(--text-secondary);
        margin-bottom: var(--space-3xl);
        line-height: 1.6;
    }
    .ob-btn {
        padding: 16px 48px;
        background: var(--accent);
        color: #000;
        border: none;
        border-radius: var(--radius-md);
        font-size: 1rem;
        font-weight: 700;
        font-family: var(--font);
        cursor: pointer;
    }

    /* ═══════════════════════════════════════
       PERIOD STRIP (horizontal scroll)
       ═══════════════════════════════════════ */
    .period-strip {
        display: flex;
        gap: var(--space-sm);
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        padding-bottom: var(--space-sm);
        margin: 0 calc(-1 * var(--space-lg)) var(--space-lg);
        padding-left: var(--space-lg);
        padding-right: var(--space-lg);
        scrollbar-width: none;
        -webkit-mask-image: linear-gradient(to right, transparent 0, #000 var(--space-lg), #000 calc(100% - var(--space-lg)), transparent 100%);
        mask-image: linear-gradient(to right, transparent 0, #000 var(--space-lg), #000 calc(100% - var(--space-lg)), transparent 100%);
    }
    .period-strip::-webkit-scrollbar { display: none; }

    .period-chip {
        flex-shrink: 0;
        scroll-snap-align: start;
        padding: 8px 16px;
        border-radius: 100px;
        border: 1.5px solid var(--glass-border);
        background: var(--glass);
        color: var(--text-tertiary);
        font-size: 0.78rem;
        font-weight: 600;
        font-family: var(--font);
        cursor: pointer;
        white-space: nowrap;
        transition: all var(--duration) var(--ease);
    }
    .period-chip.active {
        background: var(--accent-dim);
        border-color: var(--accent);
        color: var(--accent);
    }
    .period-chip-sub {
        display: block;
        font-size: 0.65rem;
        font-weight: 500;
        opacity: 0.7;
        margin-top: 1px;
    }

    /* ═══════════════════════════════════════
       SUMMARY TABLE
       ═══════════════════════════════════════ */
    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
    }
    .summary-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    .summary-value {
        font-size: 0.88rem;
        font-weight: 700;
        font-variant-numeric: var(--tabular);
    }
    .summary-divider {
        border: none;
        border-top: 1px solid var(--glass-border);
        margin: 4px 0;
    }
    .summary-total .summary-label { font-weight: 700; color: var(--text-primary); }
    .summary-total .summary-value { color: var(--accent); }

    /* ═══════════════════════════════════════
       PROGRESS BARS (overzicht)
       ═══════════════════════════════════════ */
    .budget-meter {
        margin-bottom: var(--space-lg);
    }
    .meter-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: var(--space-xs);
    }
    .meter-label {
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--text-secondary);
    }
    .meter-value {
        font-size: 0.78rem;
        font-weight: 700;
        font-variant-numeric: var(--tabular);
        color: var(--text-tertiary);
    }
    .meter-track {
        width: 100%;
        height: 8px;
        background: var(--text-muted);
        border-radius: 4px;
        overflow: hidden;
    }
    .meter-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s var(--ease);
    }
    .meter-fill.green { background: var(--green); }
    .meter-fill.accent { background: var(--accent); }
    .meter-fill.caution { background: var(--caution); }

    /* ═══════════════════════════════════════
       CALENDAR (compact dots grid)
       ═══════════════════════════════════════ */
    .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        margin-bottom: var(--space-lg);
    }
    .cal-header {
        font-size: 0.6rem;
        font-weight: 700;
        color: var(--text-muted);
        text-align: center;
        padding: 4px 0;
        text-transform: uppercase;
    }
    .cal-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: background 0.15s;
        position: relative;
    }
    .cal-day:hover { background: var(--glass); }
    .cal-dot {
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
        background: var(--text-muted);
    }
    .cal-dot.green { background: var(--green); }
    .cal-dot.caution { background: var(--caution); }
    .cal-dot.empty { background: transparent; border: 1.5px solid var(--text-muted); }
    .cal-day.today { background: var(--accent-dim); }
    .cal-day.today .cal-dot { box-shadow: 0 0 0 2px var(--accent); }

    /* Day detail inline */
    .day-detail {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height 0.3s var(--ease), opacity 0.25s var(--ease), margin 0.3s var(--ease);
        margin-bottom: 0;
    }
    .day-detail.open {
        max-height: 500px;
        opacity: 1;
        margin-bottom: var(--space-lg);
    }
    .day-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-sm) 0;
    }
    .day-detail-title {
        font-size: 0.82rem;
        font-weight: 700;
    }
    .day-detail-close {
        background: none;
        border: none;
        color: var(--text-tertiary);
        cursor: pointer;
        padding: 8px;
        min-width: 36px;
        min-height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* ═══════════════════════════════════════
       TRANSACTION LIST (Overzicht grouped)
       ═══════════════════════════════════════ */
    .tx-day-group {
        margin-bottom: var(--space-md);
    }
    .tx-day-header {
        font-size: 0.72rem;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        padding: var(--space-sm) 0 var(--space-xs);
    }
    .tx-tag {
        display: inline-block;
        font-size: 0.6rem;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: var(--space-sm);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .tx-tag.daily { background: var(--accent-dim); color: var(--accent); }
    .tx-tag.free { background: rgba(52,211,153,0.1); color: var(--green); }

    /* ═══════════════════════════════════════
       SPAREN — RING
       ═══════════════════════════════════════ */
    .save-ring-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: var(--space-2xl) 0;
    }
    .save-ring {
        position: relative;
        width: 160px;
        height: 160px;
        margin-bottom: var(--space-lg);
    }
    .save-ring svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
    }
    .save-ring-bg {
        fill: none;
        stroke: var(--text-muted);
        stroke-width: 8;
    }
    .save-ring-fill {
        fill: none;
        stroke: var(--accent);
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 1s var(--ease);
    }
    .save-ring-text {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .save-ring-pct {
        font-size: 2rem;
        font-weight: 900;
        font-variant-numeric: var(--tabular);
    }
    .save-ring-label {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        margin-top: 2px;
    }

    /* Prediction card */
    .pred-card {
        text-align: center;
        padding: var(--space-lg);
    }
    .pred-date {
        font-size: 1.1rem;
        font-weight: 800;
        color: var(--accent);
        margin-bottom: var(--space-xs);
    }
    .pred-sub {
        font-size: 0.8rem;
        color: var(--text-tertiary);
    }
    .pred-confidence {
        display: inline-flex;
        align-items: center;
        gap: var(--space-xs);
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 100px;
        background: var(--glass);
        margin-top: var(--space-md);
    }

    /* Milestones */
    .milestone-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }
    .milestone-item {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        padding: var(--space-md);
        border-radius: var(--radius-md);
        background: var(--glass);
    }
    .milestone-pct {
        font-size: 0.82rem;
        font-weight: 800;
        min-width: 40px;
        font-variant-numeric: var(--tabular);
    }
    .milestone-status {
        flex: 1;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    .milestone-check {
        color: var(--green);
        font-weight: 700;
        font-size: 0.8rem;
    }

    /* Collapsible info */
    .collapse-toggle {
        width: 100%;
        padding: var(--space-md) var(--space-lg);
        background: var(--glass);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: 0.82rem;
        font-weight: 600;
        font-family: var(--font);
        cursor: pointer;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-sm);
    }
    .collapse-toggle .arrow {
        transition: transform 0.3s var(--ease);
        color: var(--text-muted);
    }
    .collapse-toggle.open .arrow { transform: rotate(180deg); }
    .collapse-content {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.4s var(--ease), opacity 0.3s var(--ease);
    }
    .collapse-content.open {
        max-height: 600px;
        opacity: 1;
    }
    .collapse-inner {
        padding: var(--space-lg);
        font-size: 0.8rem;
        color: var(--text-tertiary);
        line-height: 1.7;
    }
    .collapse-inner p { margin-bottom: var(--space-md); }
    .collapse-inner p:last-child { margin-bottom: 0; }
    .collapse-inner strong { color: var(--text-primary); }

    /* Breakdown rows */
    .breakdown-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        font-size: 0.85rem;
    }
    .breakdown-label { color: var(--text-secondary); }
    .breakdown-value { font-weight: 700; font-variant-numeric: var(--tabular); }

    /* Spending add (Overzicht) */
    .add-spending-row {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
        margin-top: var(--space-md);
    }

    /* ═══════════════════════════════════════
       MENU TILES
       ═══════════════════════════════════════ */
    .menu-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-md);
        padding: var(--space-md) 0;
    }
    .menu-tile {
        background: var(--glass);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: var(--space-xl) var(--space-lg);
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
        min-height: 100px;
    }
    .menu-tile:active { transform: scale(0.97); }
    .menu-tile:hover {
        border-color: var(--accent);
        background: var(--accent-dim);
        box-shadow: 0 0 0 2px rgba(var(--accent-rgb), 0.25), 0 8px 24px rgba(var(--accent-rgb), 0.15);
        transform: translateY(-2px);
    }
    .menu-tile-icon {
        width: 36px; height: 36px;
        border-radius: var(--radius-md);
        background: var(--accent-dim);
        display: flex; align-items: center; justify-content: center;
        color: var(--accent);
    }
    .menu-tile-title {
        font-size: 0.92rem;
        font-weight: 700;
        color: var(--text-primary);
    }
    .menu-tile-sub {
        font-size: 0.72rem;
        color: var(--text-muted);
        line-height: 1.4;
    }
    .menu-tile-value {
        font-size: 0.82rem;
        font-weight: 700;
        color: var(--accent);
        font-variant-numeric: var(--tabular);
        margin-top: auto;
    }

    /* View back header */
    .view-header {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        padding: var(--space-sm) 0 var(--space-lg);
    }
    .view-back-btn {
        width: 36px; height: 36px;
        border-radius: var(--radius-full);
        background: var(--glass);
        border: 1px solid var(--glass-border);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        color: var(--text-secondary);
        flex-shrink: 0;
        font-family: var(--font);
    }
    .view-back-btn:active { transform: scale(0.93); }
    .view-title {
        font-size: 1.1rem;
        font-weight: 800;
        color: var(--text-primary);
    }

    /* ═══════════════════════════════════════
       PROFIEL
       ═══════════════════════════════════════ */
    .prof-header {
        display: flex;
        align-items: center;
        gap: var(--space-lg);
        margin-bottom: var(--space-2xl);
        padding: var(--space-lg) 0;
    }
    .prof-avatar {
        width: 52px; height: 52px;
        border-radius: var(--radius-full);
        background: var(--accent-dim);
        border: 2px solid rgba(var(--accent-rgb), 0.25);
        display: flex; align-items: center; justify-content: center;
        font-size: 1rem;
        overflow: hidden;
    }
    .prof-avatar img { width:100%;height:100%;object-fit:cover; }
    .prof-name { font-size: 1.1rem; font-weight: 800; }
    .prof-since { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 2px; }

    .prof-group-title {
        font-size: 0.7rem; font-weight: 700; color: var(--text-muted);
        text-transform: uppercase; letter-spacing: 0.5px;
        padding: var(--space-lg) 0 var(--space-sm);
    }
    .prof-row {
        display: flex; align-items: center; justify-content: space-between;
        padding: var(--space-lg) 0;
        min-height: 44px;
        border-bottom: 1px solid var(--glass-border);
        cursor: pointer;
        transition: background 0.15s;
    }
    .prof-row:last-child { border-bottom: none; }
    .prof-row:active { background: var(--glass); }
    .prof-row-label { font-size: 0.88rem; color: var(--text-secondary); }
    .prof-row-value {
        font-size: 0.88rem; font-weight: 600;
        color: var(--text-tertiary);
        display: flex; align-items: center; gap: var(--space-sm);
        font-variant-numeric: var(--tabular);
    }
    .prof-row-arrow { color: var(--text-muted); flex-shrink: 0; }
    .prof-row.danger .prof-row-label { color: var(--danger); }
    .prof-footer {
        text-align: center; padding: var(--space-2xl) 0;
        font-size: 0.72rem; color: var(--text-muted);
    }

    /* Subscreen panel */
    .sub-panel {
        position: fixed; inset: 0; z-index: 200;
        background: var(--bg);
        transform: translateX(100%);
        transition: transform 0.3s var(--ease);
        overflow-y: auto;
        padding: env(safe-area-inset-top, 0px) var(--space-lg) calc(var(--space-3xl) + env(safe-area-inset-bottom, 0px));
    }
    .sub-panel.open { transform: translateX(0); }
    .sub-header {
        position: sticky; top: 0; background: var(--bg);
        padding: var(--space-lg) 0;
        display: flex; align-items: center; gap: var(--space-md);
        border-bottom: 1px solid var(--glass-border);
        margin-bottom: var(--space-lg); z-index: 1;
    }
    .sub-back {
        background: none; border: none; color: var(--text-secondary);
        cursor: pointer; padding: 8px; display: flex;
        min-width: 36px; min-height: 36px;
        align-items: center; justify-content: center;
    }
    .sub-title { font-size: 1rem; font-weight: 700; }

    .field-group { margin-bottom: var(--space-xl); }
    .field-label {
        font-size: 0.78rem; font-weight: 600;
        color: var(--text-secondary); margin-bottom: var(--space-xs);
    }
    .field-helper {
        font-size: 0.72rem; color: var(--text-muted);
        margin-top: var(--space-xs); line-height: 1.5;
    }
    .field-error {
        font-size: 0.72rem; color: var(--caution);
        margin-top: var(--space-xs);
    }

    .btn-save {
        width: 100%; padding: 14px;
        background: var(--accent); color: #000; border: none;
        border-radius: var(--radius-md);
        font-size: 0.92rem; font-weight: 700; font-family: var(--font);
        cursor: pointer; margin-top: var(--space-lg);
    }
    .btn-save:active { opacity: 0.85; }
    .btn-danger {
        width: 100%; padding: 14px;
        background: var(--danger-dim); color: var(--danger); border: 1.5px solid var(--danger);
        border-radius: var(--radius-md);
        font-size: 0.92rem; font-weight: 700; font-family: var(--font);
        cursor: pointer; margin-top: var(--space-lg);
    }
    .btn-danger:disabled { opacity: 0.3; cursor: not-allowed; }

    /* Toggle */
    .toggle-row {
        display: flex; align-items: center; justify-content: space-between;
        padding: var(--space-md) 0;
    }
    .toggle-track {
        width: 44px; height: 24px; border-radius: 12px;
        background: var(--text-muted); cursor: pointer;
        position: relative; transition: background 0.2s;
    }
    .toggle-track.on { background: var(--accent); }
    .toggle-thumb {
        width: 20px; height: 20px; border-radius: 50%;
        background: white; position: absolute; top: 2px; left: 2px;
        transition: left 0.2s var(--ease);
    }
    .toggle-track.on .toggle-thumb { left: 22px; }

    /* Fixed cost items */
    .fc-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: var(--space-sm) 0;
        border-bottom: 1px solid var(--glass-border);
    }
    .fc-item-name { font-size: 0.85rem; }
    .fc-item-amount { font-size: 0.85rem; font-weight: 700; font-variant-numeric: var(--tabular); }
    .fc-cat-title {
        font-size: 0.72rem; font-weight: 700; color: var(--text-muted);
        text-transform: uppercase; padding: var(--space-md) 0 var(--space-xs);
    }

    /* Avatar grid */
    .avatar-grid {
        display: flex; flex-direction: column; gap: var(--space-md);
    }
    .avatar-upload-area {
        display: flex; align-items: center; gap: var(--space-lg);
        padding: var(--space-lg);
        background: var(--glass);
        border-radius: var(--radius-lg);
        border: 1.5px dashed var(--glass-border);
    }
    .avatar-preview {
        width: 64px; height: 64px;
        border-radius: var(--radius-full);
        background: var(--accent-dim);
        border: 2px solid var(--accent);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.4rem; font-weight: 800; color: var(--accent);
        overflow: hidden; flex-shrink: 0;
    }
    .avatar-preview img { width:100%;height:100%;object-fit:cover; }
    .avatar-upload-info { flex:1; }
    .avatar-upload-btn {
        padding: 8px 16px;
        background: var(--glass);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: 0.82rem; font-weight: 600;
        font-family: var(--font); cursor: pointer;
    }

    /* ═══════════════════════════════════════
       ONBOARDING (7-step)
       ═══════════════════════════════════════ */
    .ob-container {
        position: fixed; inset: 0; background: var(--bg);
        z-index: 9998; overflow-y: auto;
        display: flex; flex-direction: column;
        padding: calc(var(--space-2xl) + env(safe-area-inset-top, 0px)) var(--space-2xl) calc(var(--space-2xl) + env(safe-area-inset-bottom, 0px));
    }
    .ob-progress {
        display: flex; gap: 4px; margin-bottom: var(--space-3xl);
    }
    .ob-progress-dot {
        flex: 1; height: 3px; border-radius: 2px;
        background: var(--text-muted); transition: background 0.3s;
    }
    .ob-progress-dot.done { background: var(--accent); }
    .ob-progress-dot.current { background: var(--accent); }

    .ob-step-title {
        font-size: 1.4rem; font-weight: 900; margin-bottom: var(--space-sm);
    }
    .ob-step-sub {
        font-size: 0.88rem; color: var(--text-secondary);
        line-height: 1.6; margin-bottom: var(--space-2xl);
    }
    .ob-step-content { flex: 1; }

    .ob-nav {
        display: flex; gap: var(--space-md);
        padding-top: var(--space-xl);
        margin-top: auto;
    }
    .ob-nav-back {
        padding: 14px 24px; background: var(--glass);
        border: 1px solid var(--glass-border); border-radius: var(--radius-md);
        color: var(--text-secondary); font-size: 0.92rem; font-weight: 600;
        font-family: var(--font); cursor: pointer;
    }
    .ob-nav-next {
        flex: 1; padding: 14px; background: var(--accent);
        color: #000; border: none; border-radius: var(--radius-md);
        font-size: 0.92rem; font-weight: 700; font-family: var(--font);
        cursor: pointer;
    }
    .ob-nav-next:disabled { opacity: 0.4; cursor: not-allowed; }

    .lang-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); margin-top: var(--space-xl); }
    .lang-tile {
        display: flex; flex-direction: column; align-items: center; gap: var(--space-sm);
        padding: var(--space-lg) var(--space-sm); background: var(--glass);
        border: 2px solid var(--glass-border); border-radius: var(--radius-lg);
        cursor: pointer; transition: all 0.25s ease; position: relative;
    }
    .lang-tile:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
    .lang-tile.selected { border-color: var(--accent); background: var(--accent-dim); box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.25); }
    .lang-tile.selected::after {
        content: '✓'; position: absolute; top: 6px; right: 8px;
        width: 18px; height: 18px; background: var(--accent); border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 10px; font-weight: 900; color: #000;
    }
    .lang-flag-circle { width: 56px; height: 56px; border-radius: 50%; overflow: hidden; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: transform 0.25s; }
    .lang-tile:hover .lang-flag-circle { transform: scale(1.08); }
    .lang-name { font-size: 0.82rem; font-weight: 800; text-align: center; line-height: 1.2; }

    .ob-step-label {
        font-size: 0.72rem; color: var(--text-muted);
        margin-bottom: var(--space-lg);
    }

    /* Aha moment */
    .aha-amount {
        font-size: 2.4rem; font-weight: 900; color: var(--accent);
        text-align: center; margin: var(--space-2xl) 0 var(--space-md);
        font-variant-numeric: var(--tabular);
    }
    .aha-line {
        font-size: 0.95rem; text-align: center;
        color: var(--text-secondary); margin-bottom: var(--space-sm);
        line-height: 1.6;
    }
    .aha-closing {
        font-size: 1rem; text-align: center; font-weight: 600;
        color: var(--text-primary); margin-top: var(--space-2xl);
        line-height: 1.6;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 10px; }
    </style>
</head>
<body>
    <!-- ═══════════════════════════════════════
         ONBOARDING (7-step)
         ═══════════════════════════════════════ -->
    <div id="introSplash" class="ob-screen hidden">
        <div class="ob-title">GRIP</div>
        <div class="ob-sub">Grip op je geld. Zonder gedoe.</div>
        <button class="ob-btn" onclick="dismissIntro()">Aan de slag</button>
    </div>

    <!-- ═══════════════════════════════════════
         ONBOARDING (7-step)
         ═══════════════════════════════════════ -->
    <div id="onboarding" class="ob-container hidden">
        <div class="ob-progress" id="obProgress"></div>
        <div class="ob-step-label" id="obStepLabel"></div>
        <div class="ob-step-content" id="obContent"></div>
        <div class="ob-nav" id="obNav"></div>
    </div>

    <!-- ═══════════════════════════════════════
         PIN SCREEN
         ═══════════════════════════════════════ -->
    <div id="pinScreen" class="pin-screen hidden">
        <div class="pin-logo">GRIP</div>
        <div class="pin-subtitle">Voer je PIN in</div>
        <div class="pin-dots" id="pinDots">
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
        </div>
        <div class="pin-error" id="pinError">Onjuiste PIN. Probeer opnieuw.</div>
        <div class="pin-keypad">
            <button class="pin-key" onclick="pinInput('1')">1</button>
            <button class="pin-key" onclick="pinInput('2')">2</button>
            <button class="pin-key" onclick="pinInput('3')">3</button>
            <button class="pin-key" onclick="pinInput('4')">4</button>
            <button class="pin-key" onclick="pinInput('5')">5</button>
            <button class="pin-key" onclick="pinInput('6')">6</button>
            <button class="pin-key" onclick="pinInput('7')">7</button>
            <button class="pin-key" onclick="pinInput('8')">8</button>
            <button class="pin-key" onclick="pinInput('9')">9</button>
            <button class="pin-key" onclick="pinClear()" style="font-size:1.1rem">&#9003;</button>
            <button class="pin-key" onclick="pinInput('0')">0</button>
            <div></div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════
         MAIN APP
         ═══════════════════════════════════════ -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="header-logo">GRIP</div>
            <div class="header-avatar" id="headerAvatar" onclick="showView('menu')" role="button" aria-label="Menu"></div>
        </header>

        <!-- ═══ HOME VIEW ═══ -->
        <div id="homeView" class="view">
            <!-- Greeting -->
            <div class="greeting" id="homeGreeting"></div>

            <!-- Primary card: dagbudget resterend -->
            <div class="card card-primary">
                <div class="card-label">Vandaag</div>
                <div class="card-amount" id="homeBudgetLeft"></div>
                <div class="progress-track">
                    <div class="progress-fill" id="homeBudgetBar" style="width:0%"></div>
                </div>
                <div class="card-sub" id="homeBudgetSub"></div>
            </div>

            <!-- Quick-add grid -->
            <div style="margin-bottom:var(--space-xs)">
                <div class="section-title" style="margin-bottom:var(--space-sm)" id="homeDailyTitle">Dagelijkse uitgaven invoeren</div>
            </div>
            <div class="quick-add-grid" id="quickAddGrid"></div>

            <!-- Inline manual input -->
            <div class="inline-input-area" id="inlineInputArea">
                <div class="inline-input-row">
                    <span style="color:var(--text-tertiary);font-weight:700;font-size:1.1rem">€</span>
                    <input type="number" class="grip-input" id="inlineAmount" placeholder="Bedrag" step="0.01" min="0" inputmode="decimal">
                    <button class="btn-add" onclick="addInlineExpense()" id="inlineAddBtn">Toevoegen</button>
                </div>
                <div class="inline-note-row">
                    <input type="text" class="grip-input grip-input-sm" id="inlineNote" placeholder="" style="width:100%">
                </div>
                <div class="input-hint" id="inlineHint">Vul een bedrag in.</div>
            </div>

            <!-- Today's transactions -->
            <div id="homeTodaySection">
                <div class="section-title" id="homeTodaySectionTitle">Vandaag</div>
                <div class="tx-list" id="homeTodayList"></div>
            </div>

            <!-- Savings balance - prominent position -->
            <div class="card" style="background:var(--accent-dim);border-color:var(--accent);cursor:pointer" onclick="showView('sparen')">
                <div style="display:flex;align-items:center;gap:var(--space-md);justify-content:space-between">
                    <div>
                        <div style="font-size:0.72rem;text-transform:uppercase;font-weight:700;color:var(--accent);letter-spacing:0.5px" id="homeSavingsLabel">Mijn saldo</div>
                        <div style="font-size:1.4rem;font-weight:800;font-variant-numeric:var(--tabular);margin-top:2px" id="homeSavingsTotal"></div>
                        <div class="status-sub" id="homeSavingsChange"></div>
                    </div>
                    <div style="color:var(--accent)">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

            <!-- Period status card -->
            <div class="card status-card" id="periodStatusCard" onclick="showView('overzicht')">
                <div class="status-left">
                    <div class="status-label" id="periodLabel"></div>
                    <div class="status-value" id="periodStatus"></div>
                </div>
                <div class="status-dots" id="periodDots"></div>
            </div>
        </div>

        <!-- ═══ OVERZICHT VIEW ═══ -->
        <div id="overzichtView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title">Overzicht</div>
            </div>

            <!-- Period selector -->
            <div class="period-strip" id="periodStrip"></div>

            <!-- Savings highlight -->
            <div class="card" style="background:var(--accent-dim);border-color:var(--accent)">
                <div style="display:flex;align-items:center;justify-content:space-between">
                    <div>
                        <div style="font-size:0.72rem;text-transform:uppercase;font-weight:700;color:var(--accent);letter-spacing:0.5px" id="ovSavingsLabel">Spaargeld</div>
                        <div style="font-size:1.3rem;font-weight:800;font-variant-numeric:var(--tabular);margin-top:2px" id="ovSavingsAmount"></div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:0.72rem;color:var(--text-muted)" id="ovAvgLabel">Gem. per dag</div>
                        <div style="font-size:1rem;font-weight:700;font-variant-numeric:var(--tabular)" id="ovDailyAvg"></div>
                    </div>
                </div>
            </div>

            <!-- Daily spending chart (SVG bars) -->
            <div class="card">
                <div class="section-title" id="ovDailyTitle">Dagelijks uitgegeven</div>
                <div id="ovDailyChart" style="width:100%;overflow-x:auto"></div>
            </div>

            <!-- Budget donut -->
            <div class="card">
                <div class="section-title" id="ovDistTitle">Verdeling deze periode</div>
                <div style="display:flex;align-items:center;gap:var(--space-xl)">
                    <div id="ovDonut" style="flex-shrink:0"></div>
                    <div id="ovDonutLegend" style="font-size:0.78rem;line-height:1.8"></div>
                </div>
            </div>

            <!-- Key numbers -->
            <div class="card" id="ovStatsCard">
                <div class="section-title" id="ovStatsTitle">Cijfers</div>
                <div id="ovStatsRows"></div>
            </div>

            <!-- Calendar -->
            <div class="card">
                <div class="section-title" id="ovCalTitle">Kalender</div>
                <div class="cal-grid" id="ovCalendar"></div>
                <div class="day-detail" id="ovDayDetail">
                    <div class="day-detail-header">
                        <span class="day-detail-title" id="ovDayTitle"></span>
                        <button class="day-detail-close" onclick="closeDayDetail()" aria-label="Sluit dagdetail">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div id="ovDayEntries"></div>
                </div>
            </div>
        </div>

        <!-- ═══ SPAREN VIEW ═══ -->
        <div id="sparenView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title" id="sparenViewTitle">Spaarrace</div>
            </div>
            <!-- Primary: current savings -->
            <div class="card card-primary">
                <div class="card-label" id="spCardLabel">Mijn saldo</div>
                <div class="card-amount" id="spSavingsTotal"></div>
                <div class="card-sub" id="spSavingsChange"></div>
            </div>

            <!-- Goal ring + prediction (hidden if no goal) -->
            <div id="spGoalSection">
                <div class="card">
                    <div class="save-ring-container">
                        <div class="save-ring">
                            <svg viewBox="0 0 160 160">
                                <circle class="save-ring-bg" cx="80" cy="80" r="68"/>
                                <circle class="save-ring-fill" id="spRingFill" cx="80" cy="80" r="68" stroke-dasharray="427.3" stroke-dashoffset="427.3"/>
                            </svg>
                            <div class="save-ring-text">
                                <div class="save-ring-pct" id="spRingPct">0%</div>
                                <div class="save-ring-label" id="spRingLabel"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Prediction -->
                    <div class="pred-card" id="spPrediction"></div>
                </div>

                <!-- Milestones -->
                <div class="card" id="spMilestonesCard">
                    <div class="section-title" id="spMilestonesTitle">Mijlpalen</div>
                    <div class="milestone-list" id="spMilestones"></div>
                </div>
            </div>

            <!-- Goal reached celebration (hidden by default) -->
            <div id="spGoalReached" class="hidden">
                <div class="card" style="background:linear-gradient(135deg, rgba(61,213,152,0.12), rgba(var(--accent-rgb),0.12));border-color:var(--green)">
                    <div style="text-align:center;padding:var(--space-xl) 0">
                        <div style="font-size:2.4rem;margin-bottom:var(--space-md)">🏆</div>
                        <div style="font-size:1.2rem;font-weight:800;color:var(--green)" id="goalReachedTitle">🎉 Doel bereikt!</div>
                        <div style="font-size:0.88rem;color:var(--text-secondary);margin-top:var(--space-sm)" id="goalReachedSub">Gefeliciteerd!</div>
                        <div style="font-size:0.82rem;color:var(--text-muted);margin-top:var(--space-md)" id="goalReachedAmount"></div>
                        <div style="margin-top:var(--space-xl);display:flex;flex-direction:column;gap:var(--space-sm);align-items:center">
                            <button class="btn-add" onclick="showView('dagsparen')" id="goalReachedNewBtn" style="min-width:200px">Nieuw doel instellen</button>
                            <div style="font-size:0.75rem;color:var(--text-muted);margin-top:var(--space-xs)" id="goalReachedKeep">Of blijf gewoon sparen</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No goal prompt -->
            <div id="spNoGoal" class="hidden">
                <div class="card">
                    <div class="empty-state">
                        <span id="spNoGoalText">Stel een spaardoel in om je voortgang te volgen.</span>
                        <div style="margin-top:var(--space-lg)">
                            <button class="btn-add" onclick="showView('dagsparen')" id="spNoGoalBtn">Spaardoel instellen</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- How GRIP calculates -->
            <button class="collapse-toggle" onclick="toggleCollapse(this)" id="spCollapseBtn" aria-expanded="false" aria-controls="spCollapseContent">
                <span id="spCollapseLabel">Hoe berekent GRIP dit?</span>
                <svg class="arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="collapse-content" id="spCollapseContent">
                <div class="collapse-inner" id="spCollapseInner">
                    GRIP berekent je besparing per periode: auto-sparen + wat je dagelijks overhoudt + wat je van vrij budget niet uitgeeft. Op basis van een gewogen gemiddelde (recente periodes tellen zwaarder) schat GRIP wanneer je je doel bereikt. Hoe meer data, hoe betrouwbaarder de schatting.
                </div>
            </div>

            <!-- Period breakdown -->
            <div class="card" id="spBreakdownCard">
                <div class="section-title" id="spBreakdownTitle">Deze periode</div>
                <div id="spBreakdown"></div>
            </div>

            <!-- Spaarsaldo corrigeren -->
            <div class="card">
                <div class="section-title" id="spCorrTitle">Saldo corrigeren</div>
                <div class="field-helper" style="margin-bottom:var(--space-md)" id="spCorrExplain">Klopt je spaarsaldo niet meer? Dat kan gebeuren bij onvoorziene uitgaven (reparatie, boete, medische kosten) of juist een meevaller (bonus, belastingteruggave, cadeau). Vul je werkelijke saldo in en GRIP past alles automatisch aan.</div>
                <div style="display:flex;gap:var(--space-sm);align-items:center">
                    <input type="number" class="grip-input grip-input-sm" id="spCorrectionVal" inputmode="decimal" style="flex:1">
                    <button class="btn-save" onclick="applySavingsCorrection()" style="flex-shrink:0" id="spCorrBtn">Corrigeren</button>
                </div>
            </div>
        </div>

        <!-- ═══ MENU VIEW ═══ -->
        <div id="menuView" class="view hidden">
            <div class="greeting" id="menuGreeting"></div>
            <div class="menu-grid">
                <div class="menu-tile" onclick="showView('overzicht')">
                    <div class="menu-tile-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg></div>
                    <div class="menu-tile-title">Overzicht</div>
                    <div class="menu-tile-sub">Periodes, kalender, transacties</div>
                    <div class="menu-tile-value" id="menuOvStatus"></div>
                </div>
                <div class="menu-tile" onclick="showView('vrijbudget')">
                    <div class="menu-tile-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4h-4z"/></svg></div>
                    <div class="menu-tile-title">Vrij budget</div>
                    <div class="menu-tile-sub">Uitgaven uit vrij besteedbaar geld</div>
                    <div class="menu-tile-value" id="menuFreeStatus"></div>
                </div>
                <div class="menu-tile" onclick="showView('sparen')">
                    <div class="menu-tile-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-0.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2"/><path d="M2 9.1C1.1 11 2 12 2 12"/></svg></div>
                    <div class="menu-tile-title">Sparen</div>
                    <div class="menu-tile-sub">Spaardoel, prognose, saldo</div>
                    <div class="menu-tile-value" id="menuSavingsStatus"></div>
                </div>
                <div class="menu-tile" onclick="showView('inkomen')">
                    <div class="menu-tile-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
                    <div class="menu-tile-title" id="menuIncomeTitle">Inkomen & salaris</div>
                    <div class="menu-tile-sub" id="menuIncomeSub">Netto inkomen, salarisdag</div>
                </div>
                <div class="menu-tile" onclick="showView('dagsparen')">
                    <div class="menu-tile-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
                    <div class="menu-tile-title" id="menuDagTitle">Dagbudget & sparen</div>
                    <div class="menu-tile-sub" id="menuDagSub">Dagbudget, auto-sparen, doel</div>
                </div>
                <div class="menu-tile" onclick="showView('vastelasten')">
                    <div class="menu-tile-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></div>
                    <div class="menu-tile-title">Vaste lasten</div>
                    <div class="menu-tile-sub">Huur, energie, verzekeringen</div>
                    <div class="menu-tile-value" id="menuFixedTotal" style="color:var(--red)"></div>
                </div>
                <div class="menu-tile" onclick="showView('profiel')">
                    <div class="menu-tile-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <div class="menu-tile-title">Profiel</div>
                    <div class="menu-tile-sub">Naam, avatar, thema, beveiliging</div>
                </div>
                <div class="menu-tile" onclick="showView('dataview')">
                    <div class="menu-tile-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
                    <div class="menu-tile-title">Data & privacy</div>
                    <div class="menu-tile-sub">Backup, data wissen, privacy</div>
                </div>
            </div>
            <div class="prof-footer">GRIP v1.0</div>
        </div>

        <!-- ═══ VRIJ BUDGET VIEW ═══ -->
        <div id="vrijbudgetView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title">Vrij budget</div>
            </div>

            <!-- Budget status today -->
            <div class="card card-primary">
                <div class="card-label">Vrij te besteden deze periode</div>
                <div class="card-amount" id="vbBudgetLeft"></div>
                <div class="card-sub" id="vbBudgetSub"></div>
            </div>

            <!-- Add spending -->
            <div class="card">
                <div class="section-title">Uitgave toevoegen</div>
                <div class="add-spending-row">
                    <input type="number" class="grip-input grip-input-sm" id="vbSpendAmount" inputmode="decimal" placeholder="Bedrag" style="flex:1">
                    <select class="grip-input grip-input-sm" id="vbSpendCat" style="flex:1.2">
                        <option value="kleding">Kleding</option>
                        <option value="elektronica">Elektronica</option>
                        <option value="horeca">Uit eten/drinken</option>
                        <option value="cadeaus">Cadeaus</option>
                        <option value="gezondheid">Gezondheid</option>
                        <option value="hobby">Hobby</option>
                        <option value="vakantie">Vakantie</option>
                        <option value="huishouden">Huishouden</option>
                        <option value="auto">Auto/vervoer</option>
                        <option value="overig_vrij">Overig</option>
                    </select>
                </div>
                <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-sm)">
                    <input type="text" class="grip-input grip-input-sm" id="vbSpendName" placeholder="Omschrijving (optioneel)" style="flex:1">
                    <button class="btn-add" onclick="addFreeSpendingVB()" style="flex-shrink:0">Toevoegen</button>
                </div>
            </div>

            <!-- Spending list -->
            <div class="card">
                <div class="section-title">Uitgaven deze periode</div>
                <div id="vbSpendingList"></div>
            </div>

            <!-- Category donut -->
            <div class="card" id="vbDonutCard">
                <div class="section-title">Per categorie</div>
                <div style="display:flex;align-items:center;gap:var(--space-xl)">
                    <div id="vbDonut" style="flex-shrink:0"></div>
                    <div id="vbDonutLegend" style="font-size:0.72rem;line-height:1.8"></div>
                </div>
            </div>

            <!-- Custom date range -->
            <div class="card">
                <div class="section-title">Aangepast overzicht</div>
                <div class="field-helper" style="margin-bottom:var(--space-md)">Kies een eigen datumbereik.</div>
                <div style="display:flex;gap:var(--space-sm);align-items:center">
                    <input type="date" class="grip-input grip-input-sm" id="ovCustomStart" style="flex:1">
                    <span style="color:var(--text-muted);font-size:0.78rem">t/m</span>
                    <input type="date" class="grip-input grip-input-sm" id="ovCustomEnd" style="flex:1">
                    <button class="btn-add" onclick="showCustomDateRange()" style="flex-shrink:0">Toon</button>
                </div>
                <div id="ovCustomResult" style="margin-top:var(--space-md)"></div>
            </div>
        </div>

        <!-- ═══ INKOMEN & SALARIS VIEW ═══ -->
        <div id="inkomenView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title" id="inkomenViewTitle">Inkomen & salaris</div>
            </div>

            <!-- Inkomen -->
            <div class="card">
                <div class="section-title" id="inkomenSectionTitle">Inkomen</div>
                <div class="field-group">
                    <div class="field-label" id="inkomenNetLabel">Netto maandinkomen</div>
                    <div style="display:flex;gap:var(--space-sm);align-items:center">
                        <input type="number" class="grip-input" id="instIncome" inputmode="decimal" style="flex:1">
                        <button class="btn-save" onclick="saveInstIncome()" style="flex-shrink:0" id="inkomenSaveBtn">Opslaan</button>
                    </div>
                </div>
                <div class="field-group">
                    <div class="field-label" id="inkomenDiffLabel">Afwijkend inkomen</div>
                    <div class="field-helper" id="inkomenDiffHelper">Vakantiegeld, bonus, of minder uren?</div>
                    <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-sm)">
                        <select class="grip-input grip-input-sm" id="instIncomeOverridePeriod" style="flex:1.5"></select>
                        <input type="number" class="grip-input grip-input-sm" id="instIncomeOverrideVal" inputmode="decimal" placeholder="Bedrag" style="flex:1">
                        <button class="btn-add" onclick="saveInstIncomeOverride()" style="flex-shrink:0" id="inkomenDiffSave">Opslaan</button>
                    </div>
                    <div id="instIncomeOverrideList" style="margin-top:var(--space-sm)"></div>
                </div>
            </div>

            <!-- Salarisdag -->
            <div class="card">
                <div class="section-title" id="salaryDaySectionTitle">Salarisdag</div>
                <div class="field-group">
                    <div class="field-label" id="salaryDayDefaultLabel">Standaard salarisdag</div>
                    <div style="display:flex;gap:var(--space-sm);align-items:center">
                        <input type="number" class="grip-input" id="instSalaryDay" min="1" max="31" inputmode="numeric" style="flex:1">
                        <button class="btn-save" onclick="saveInstSalaryDay()" style="flex-shrink:0">Opslaan</button>
                    </div>
                </div>
                <div class="field-group">
                    <div class="field-label" id="salaryDayPerMonthLabel">Per maand een andere dag?</div>
                    <div class="field-helper" id="salaryDayGridHelper" style="margin-bottom:var(--space-sm)"></div>
                    <div id="salaryDayGrid" style="margin-top:var(--space-sm)"></div>
                    <button class="btn-save" onclick="saveSalaryDayGridAll()" style="width:100%;margin-top:var(--space-sm)" id="salaryDaySaveAll">Opslaan</button>
                </div>
            </div>
        </div>

        <!-- ═══ DAGBUDGET & SPAREN VIEW ═══ -->
        <div id="dagsparenView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title" id="dagsparenViewTitle">Dagbudget & sparen</div>
            </div>

            <!-- Dagbudget -->
            <div class="card">
                <div class="section-title" id="dagBudgetSectionTitle">Dagbudget</div>
                <div class="field-group">
                    <div class="field-label" id="dagLimitLabel">Limiet per dag</div>
                    <div style="display:flex;gap:var(--space-sm);align-items:center">
                        <input type="number" class="grip-input" id="instDailyBudget" inputmode="decimal" style="flex:1">
                        <button class="btn-save" onclick="saveInstBudget()" style="flex-shrink:0">Opslaan</button>
                    </div>
                    <div class="field-helper" id="dagBudgetHelper">Supermarkt, koffie, lunch. Wat je niet uitgeeft → besparing.</div>
                </div>
            </div>

            <!-- Auto-sparen -->
            <div class="card">
                <div class="section-title" id="autoSaveSectionTitle">Automatisch sparen</div>
                <div class="field-group">
                    <div class="field-label" id="autoSaveLabel">Vast spaarbedrag per maand</div>
                    <div style="display:flex;gap:var(--space-sm);align-items:center">
                        <input type="number" class="grip-input" id="instAutoSave" inputmode="decimal" style="flex:1">
                        <button class="btn-save" onclick="saveInstAutoSave()" style="flex-shrink:0">Opslaan</button>
                    </div>
                </div>
            </div>

            <!-- Spaardoel -->
            <div class="card">
                <div class="section-title" id="goalSectionTitle">Spaardoel</div>
                <div class="field-group">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-sm)">
                        <span class="field-label" style="margin:0" id="currentSavingsLabel">Huidig spaarsaldo</span>
                        <span style="font-size:1.1rem;font-weight:800;color:var(--green)" id="instCurrentSavings"></span>
                    </div>
                    <div style="display:flex;gap:var(--space-sm);align-items:center;margin-top:var(--space-sm)">
                        <input type="number" class="grip-input grip-input-sm" id="instCorrectSavings" inputmode="decimal" placeholder="Werkelijk saldo" style="flex:1">
                        <button class="btn-add" onclick="correctSavingsFromSettings()" style="flex-shrink:0" id="correctBtn">Corrigeren</button>
                    </div>
                    <div class="field-helper" id="correctHelper">Klopt je saldo niet? Vul je werkelijke bedrag in.</div>
                </div>
                <div class="field-group">
                    <div class="field-label" id="startBalanceLabel">Startsaldo</div>
                    <div style="display:flex;gap:var(--space-sm);align-items:center">
                        <input type="number" class="grip-input" id="instStartSavings" inputmode="decimal" style="flex:1">
                        <button class="btn-save" onclick="saveInstGoal()" style="flex-shrink:0">Opslaan</button>
                    </div>
                    <div class="field-helper" id="startBalanceHelper">Hoeveel spaargeld had je toen je GRIP begon?</div>
                </div>
                <div class="field-group">
                    <div class="field-label" id="goalLabel">Doel</div>
                    <input type="number" class="grip-input" id="instSavingsGoal" inputmode="decimal" placeholder="bijv. 10000">
                </div>
            </div>
        </div>

        <!-- ═══ VASTE LASTEN VIEW ═══ -->
        <div id="vastelastenView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title">Vaste lasten</div>
            </div>

            <!-- Donut chart -->
            <div class="card">
                <div style="display:flex;align-items:center;gap:var(--space-xl)">
                    <div id="fcDonut" style="flex-shrink:0"></div>
                    <div>
                        <div style="font-size:1.2rem;font-weight:800;color:var(--red)" id="fcDonutTotal"></div>
                        <div style="font-size:0.72rem;color:var(--text-muted)">per maand</div>
                        <div id="fcDonutLegend" style="font-size:0.72rem;line-height:1.8;margin-top:var(--space-sm)"></div>
                    </div>
                </div>
            </div>

            <!-- Period selector -->
            <div style="display:flex;gap:var(--space-sm);align-items:center;margin-bottom:var(--space-md);padding:var(--space-sm) var(--space-md);background:var(--glass);border-radius:var(--radius-md)">
                <span style="font-size:0.78rem;color:var(--text-muted);white-space:nowrap">Periode:</span>
                <select class="grip-input grip-input-sm" id="instFixedPeriod" onchange="renderInstFixedCosts();renderFcDonut()" style="flex:1"></select>
            </div>

            <!-- Fixed cost list -->
            <div class="card">
                <div id="instFixedList"></div>
                <hr style="border:none;border-top:1px solid var(--glass-border);margin:var(--space-md) 0">
                <div style="font-size:0.82rem;font-weight:600;color:var(--text-secondary);margin-bottom:var(--space-sm)">Toevoegen</div>
                <div style="display:flex;gap:var(--space-sm)">
                    <input type="text" class="grip-input grip-input-sm" id="instFcName" placeholder="Naam" style="flex:2">
                    <input type="number" class="grip-input grip-input-sm" id="instFcAmount" inputmode="decimal" placeholder="Bedrag" style="flex:1">
                </div>
                <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-sm)">
                    <select class="grip-input grip-input-sm" id="instFcCat" style="flex:1"></select>
                    <button class="btn-add" onclick="addInstFixedCost()" style="flex-shrink:0" id="fcAddBtn">Toevoegen</button>
                </div>
            </div>
        </div>

        <!-- ═══ PROFIEL VIEW (personal only) ═══ -->
        <div id="profielView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title">Profiel</div>
            </div>

            <div class="prof-header">
                <div class="prof-avatar" id="profAvatar"></div>
                <div>
                    <div class="prof-name" id="profName"></div>
                    <div class="prof-since" id="profSince"></div>
                </div>
            </div>

            <div class="prof-group-title">Persoonlijk</div>
            <div class="card" style="padding:0 var(--space-lg)">
                <div class="prof-row" onclick="openSub('subPersonal')"><span class="prof-row-label">Naam & avatar</span><span class="prof-row-value"><span id="prNameVal"></span><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></span></div>
                <div class="prof-row" onclick="openSub('subPersonal')"><span class="prof-row-label">Thema</span><span class="prof-row-value"><span id="prTheme"></span><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></span></div>
            </div>

            <div class="prof-group-title">Veiligheid</div>
            <div class="card" style="padding:0 var(--space-lg)">
                <div class="prof-row" onclick="openSub('subSecurity')"><span class="prof-row-label">PIN wijzigen</span><span class="prof-row-value"><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></span></div>
                <div class="prof-row"><span class="prof-row-label">Biometrie</span><span class="prof-row-value"><div class="toggle-track" id="biometrieToggle" onclick="toggleBiometrie()"><div class="toggle-thumb"></div></div></span></div>
                <div class="field-helper" style="padding:0 0 var(--space-md)">Ontgrendel GRIP met je vingerafdruk of gezichtsherkenning. Werkt alleen als je apparaat dit ondersteunt. Je PIN blijft altijd als backup beschikbaar.</div>
            </div>
        </div>

        <!-- ═══ DATA & PRIVACY VIEW ═══ -->
        <div id="dataviewView" class="view hidden">
            <div class="view-header">
                <button class="view-back-btn" onclick="showView('menu')" aria-label="Terug naar menu"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                <div class="view-title">Data & privacy</div>
            </div>

            <div class="card" style="padding:0 var(--space-lg)">
                <div class="prof-row" onclick="downloadBackup()"><span class="prof-row-label">Backup downloaden</span><span class="prof-row-value"><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></span></div>
                <div class="prof-row" onclick="openSub('subPrivacy')"><span class="prof-row-label">Hoe bewaart GRIP mijn data?</span><span class="prof-row-value"><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></span></div>
                <div class="prof-row danger" onclick="openSub('subData')"><span class="prof-row-label">Data wissen</span><span class="prof-row-value"><svg class="prof-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></span></div>
            </div>

            <div class="prof-footer">GRIP v1.0</div>
        </div>

        <!-- Sub-panels (slide over) -->
        <div class="sub-panel" id="subIncome">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subIncome')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Inkomen & salarisdag</span></div>

            <div style="background:var(--glass);padding:var(--space-md);border-radius:var(--radius-md);margin-bottom:var(--space-lg)">
                <div class="field-helper" style="margin:0;line-height:1.5">
                    Je <strong>standaard inkomen</strong> geldt voor elke salarisperiode. Krijg je in een bepaalde maand meer of minder? Gebruik <strong>Per-periode afwijkingen</strong> hieronder. Die gelden alleen voor die ene periode — andere maanden blijven ongewijzigd.
                </div>
            </div>

            <div class="field-group"><div class="field-label">Standaard netto inkomen per maand</div><input type="number" class="grip-input" id="subIncomeVal" inputmode="decimal"><div class="field-helper">Dit bedrag wordt gebruikt voor elke periode tenzij je hieronder een afwijking instelt.</div></div>
            <div class="field-group"><div class="field-label">Standaard salarisdag</div><input type="number" class="grip-input" id="subSalaryDay" min="1" max="31" inputmode="numeric"><div class="field-helper">Op welke dag ontvang je meestal salaris? Valt dit op een dag die niet bestaat (bijv. 31 februari), dan gebruikt GRIP de laatste dag van die maand.</div></div>

            <div class="field-group">
                <button class="collapse-toggle" onclick="toggleIncomeOverrides(this)" id="incomeOverrideToggle" aria-expanded="false" aria-controls="incomeOverrideContent" style="margin-top:var(--space-sm)">
                    Per-periode inkomen afwijkingen
                    <svg class="arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="collapse-content" id="incomeOverrideContent">
                    <div class="collapse-inner" style="padding:var(--space-md) 0">
                        <div class="field-helper" style="margin-bottom:var(--space-md)">Is je inkomen in een bepaalde maand anders? Bijv. vakantiegeld, bonus, minder uren. Dit geldt <strong>alleen</strong> voor de gekozen periode.</div>
                        <div id="incomeOverrideGrid"></div>
                    </div>
                </div>
            </div>

            <div class="field-group">
                <button class="collapse-toggle" onclick="toggleSalaryOverrides(this)" id="salaryOverrideToggle" aria-expanded="false" aria-controls="salaryOverrideContent" style="margin-top:var(--space-sm)">
                    Afwijkende salarisdagen per maand
                    <svg class="arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="collapse-content" id="salaryOverrideContent">
                    <div class="collapse-inner" style="padding:var(--space-md) 0">
                        <div class="field-helper" style="margin-bottom:var(--space-md)">Krijg je in bepaalde maanden op een andere dag betaald? Vul hier alleen de afwijkingen in. Leeg = standaarddag.</div>
                        <div id="salaryOverrideGrid"></div>
                    </div>
                </div>
            </div>
            <button class="btn-save" onclick="saveSubIncome()">Opslaan</button>
        </div>

        <div class="sub-panel" id="subFixed">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subFixed')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Vaste lasten</span></div>

            <div style="background:var(--glass);padding:var(--space-md);border-radius:var(--radius-md);margin-bottom:var(--space-lg)">
                <div class="field-helper" style="margin:0;line-height:1.5">
                    <strong>Standaard vaste lasten</strong> gelden voor elke salarisperiode. Tik op een bedrag om het aan te passen. Heb je in een bepaalde maand andere vaste lasten? Gebruik dan <strong>Per-periode afwijkingen</strong> hieronder. Die gelden alleen voor die ene periode — andere maanden blijven ongewijzigd.
                </div>
            </div>

            <div id="subFixedList"></div>
            <div style="margin-top:var(--space-lg)">
                <div class="field-group"><div class="field-label">Naam</div><input type="text" class="grip-input grip-input-sm" id="subFcName" placeholder="bijv. Huur"></div>
                <div class="field-group"><div class="field-label">Bedrag</div><input type="number" class="grip-input grip-input-sm" id="subFcAmount" inputmode="decimal" placeholder="0,00"></div>
                <div class="field-group"><div class="field-label">Categorie</div>
                    <select class="grip-input grip-input-sm" id="subFcCat">
                        <option value="huis">Wonen</option><option value="energie">Energie & water</option>
                        <option value="verzekeringen">Verzekeringen</option><option value="telefoon_internet">Telefoon & internet</option>
                        <option value="abonnementen">Abonnementen</option><option value="sport">Sport & bewegen</option>
                        <option value="leningen">Leningen & schulden</option><option value="gezin">Gezin & huishouden</option>
                        <option value="belastingen">Belastingen</option><option value="vervoer">Vervoer</option>
                        <option value="overig">Overig</option>
                    </select>
                </div>
                <button class="btn-save" onclick="addFixedCost()">Toevoegen</button>
            </div>

            <hr style="border:none;border-top:1px solid var(--glass-border);margin:var(--space-xl) 0">

            <div class="field-group">
                <button class="collapse-toggle" onclick="toggleFixedOverrides(this)" id="fixedOverrideToggle" aria-expanded="false" aria-controls="fixedOverrideContent">
                    Per-periode afwijkingen
                    <svg class="arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="collapse-content" id="fixedOverrideContent">
                    <div class="collapse-inner" style="padding:var(--space-md) 0">
                        <div class="field-helper" style="margin-bottom:var(--space-md)">Zijn je vaste lasten in een bepaalde maand anders? Kies de periode en voeg de afwijking toe. Dit overschrijft <strong>alleen</strong> het bedrag voor die ene periode.</div>
                        <div class="field-group">
                            <div class="field-label">Periode</div>
                            <select class="grip-input grip-input-sm" id="fcOverridePeriod"></select>
                        </div>
                        <div id="fcOverrideList"></div>
                        <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-sm)">
                            <input type="text" class="grip-input grip-input-sm" id="fcOverrideName" placeholder="Naam" style="flex:2">
                            <input type="number" class="grip-input grip-input-sm" id="fcOverrideAmount" inputmode="decimal" placeholder="Bedrag" style="flex:1">
                        </div>
                        <button class="btn-add" onclick="addFixedCostOverride()" style="width:100%;margin-top:var(--space-sm)">Afwijking toevoegen</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="sub-panel" id="subBudget">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subBudget')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Dagbudget</span></div>
            <div class="field-group"><div class="field-label">Dagbudget</div><input type="number" class="grip-input" id="subDailyBudget" inputmode="decimal"><div class="field-helper">Je dagelijkse limiet voor supermarkt, koffie, lunch en afhalen. Wat je niet uitgeeft, wordt automatisch als besparing geteld.</div></div>
            <button class="btn-save" onclick="saveSubBudget()">Opslaan</button>
        </div>

        <div class="sub-panel" id="subAutoSave">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subAutoSave')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Automatisch sparen</span></div>
            <div class="field-group">
                <div class="field-label">Vast spaarbedrag per maand</div>
                <input type="number" class="grip-input" id="subAutoSave2" inputmode="decimal">
                <div class="field-helper">Dit bedrag gaat elke salarisperiode automatisch opzij — alsof het een vaste overboeking naar je spaarrekening is. GRIP trekt dit af van je besteedbaar inkomen.</div>
            </div>
            <div class="field-group" style="background:var(--glass);padding:var(--space-lg);border-radius:var(--radius-md)">
                <div class="field-label" style="margin-bottom:var(--space-sm)">Wanneer gaat deze wijziging in?</div>
                <div class="field-helper">Je nieuwe bedrag geldt <strong>vanaf de huidige salarisperiode</strong>. Eerdere periodes blijven ongewijzigd, zodat je historie klopt.</div>
            </div>
            <button class="btn-save" onclick="saveSubAutoSave()">Opslaan</button>
        </div>

        <div class="sub-panel" id="subGoal">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subGoal')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Spaardoel & saldo</span></div>
            <div class="field-group"><div class="field-label">Berekend spaargeld</div><div class="card-amount" style="font-size:1.3rem;text-align:left;margin:var(--space-xs) 0" id="subCurrentSavings"></div><div class="field-helper">Dit is wat GRIP berekent op basis van je auto-sparen, dagelijkse besparingen en vrij budget.</div></div>
            <div class="field-group" style="background:var(--glass);padding:var(--space-lg);border-radius:var(--radius-md)">
                <div class="field-label">Spaarsaldo corrigeren</div>
                <input type="number" class="grip-input" id="subSavingsCorrection" inputmode="decimal" placeholder="Nieuw saldo">
                <div class="field-helper">Klopt je spaarsaldo niet meer? Vul hier je werkelijke spaargeld in. GRIP past het startsaldo aan zodat de berekening weer klopt. Gebruik dit als je geld hebt opgenomen of bijgestort buiten GRIP om.</div>
                <button class="btn-add" onclick="applySavingsCorrection()" style="width:100%;margin-top:var(--space-sm)">Saldo corrigeren</button>
            </div>
            <hr style="border:none;border-top:1px solid var(--glass-border);margin:var(--space-lg) 0">
            <div class="field-group">
                <div class="field-label">Startsaldo (geavanceerd)</div>
                <input type="number" class="grip-input" id="subStartSavings" inputmode="decimal">
                <div class="field-helper">Het onderliggende basisbedrag. Wordt automatisch aangepast als je bovenstaande correctie gebruikt.</div>
            </div>
            <div class="field-group">
                <div class="field-label">Spaardoel</div>
                <input type="number" class="grip-input" id="subSavingsGoal" inputmode="decimal">
                <div class="field-helper">Laat leeg als je geen specifiek doel hebt. GRIP berekent op basis van je spaargedrag wanneer je dit bedrag bereikt.</div>
            </div>
            <button class="btn-save" onclick="saveSubGoal()">Opslaan</button>
        </div>

        <div class="sub-panel" id="subPersonal">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subPersonal')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Persoonlijk</span></div>
            <div class="field-group"><div class="field-label">Naam</div><input type="text" class="grip-input" id="subUserName"></div>
            <div class="field-group"><div class="field-label">Avatar</div><div class="avatar-grid" id="subAvatarGrid"></div></div>
            <div class="field-group"><div class="field-label">Thema</div>
                <div class="toggle-row"><span style="font-size:0.88rem">Dark mode</span><div class="toggle-track" id="themeToggle" onclick="toggleTheme()"><div class="toggle-thumb"></div></div></div>
            </div>
            <div class="field-group"><div class="field-label">Quotes</div>
            </div>
            <button class="btn-save" onclick="saveSubPersonal()">Opslaan</button>
        </div>

        <div class="sub-panel" id="subSecurity">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subSecurity')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Veiligheid</span></div>
            <div id="securityContent"></div>
        </div>

        <div class="sub-panel" id="subData">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subData')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Data wissen</span></div>
            <div class="field-helper" style="padding:var(--space-lg) 0">Dit verwijdert al je gegevens permanent. Dit kan niet ongedaan worden gemaakt.</div>
            <div class="field-group"><div class="field-label">Typ GRIP om te bevestigen</div><input type="text" class="grip-input" id="confirmWipe" placeholder="GRIP" oninput="checkWipeConfirm()"></div>
            <button class="btn-danger" id="btnWipe" disabled onclick="wipeData()">Data wissen</button>
        </div>

        <div class="sub-panel" id="subPrivacy">
            <div class="sub-header"><button class="sub-back" aria-label="Terug" onclick="closeSub('subPrivacy')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button><span class="sub-title">Hoe bewaart GRIP mijn data?</span></div>
            <div class="collapse-inner">
                <p><strong>Alles blijft op je apparaat.</strong></p>
                <p>GRIP slaat al je gegevens lokaal op in je browser (localStorage). Er worden geen gegevens naar een server gestuurd.</p>
                <p>Dit betekent dat je data privé is, maar ook dat je verantwoordelijk bent voor het maken van backups. Als je je browsergegevens wist of een ander apparaat gebruikt, heb je geen toegang tot je data.</p>
                <p><strong>Tip:</strong> maak regelmatig een backup via Profiel → Backup downloaden.</p>
                <p>GRIP verzamelt geen analytics, plaatst geen cookies en deelt geen informatie met derden.</p>
            </div>
        </div>

        <!-- Tab bar -->
        <nav class="tab-bar" role="tablist" aria-label="Navigatie">
            <div class="tab-item active" onclick="showView('home')" data-tab="home" role="tab" aria-label="Vandaag" aria-selected="true">
                <div class="tab-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
                <div class="tab-label">Vandaag</div>
            </div>
            <div class="tab-item" onclick="showView('menu')" data-tab="menu" role="tab" aria-label="Menu">
                <div class="tab-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg></div>
                <div class="tab-label">Menu</div>
            </div>
        </nav>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
    // ═══════════════════════════════════════════════════════════════
    // i18n — TRANSLATION SYSTEM
    // ═══════════════════════════════════════════════════════════════
    let currentLang = 'nl';
    const LANGS = {
        nl: { name: 'Nederlands', svg: '<svg viewBox="0 0 56 56" width="56" height="56"><clipPath id="cn"><circle cx="28" cy="28" r="28"/></clipPath><g clip-path="url(#cn)"><rect y="0" width="56" height="18.7" fill="#AE1C28"/><rect y="18.7" width="56" height="18.7" fill="#FFF"/><rect y="37.3" width="56" height="18.7" fill="#21468B"/></g></svg>' },
        en: { name: 'English', svg: '<svg viewBox="0 0 56 56" width="56" height="56"><clipPath id="ce"><circle cx="28" cy="28" r="28"/></clipPath><g clip-path="url(#ce)"><rect width="56" height="56" fill="#012169"/><path d="M0 0L56 56M56 0L0 56" stroke="#FFF" stroke-width="9"/><path d="M0 0L56 56M56 0L0 56" stroke="#C8102E" stroke-width="5"/><path d="M28 0V56M0 28H56" stroke="#FFF" stroke-width="14"/><path d="M28 0V56M0 28H56" stroke="#C8102E" stroke-width="8"/></g></svg>' },
        ru: { name: 'Русский', svg: '<svg viewBox="0 0 56 56" width="56" height="56"><clipPath id="cr"><circle cx="28" cy="28" r="28"/></clipPath><g clip-path="url(#cr)"><rect y="0" width="56" height="18.7" fill="#FFF"/><rect y="18.7" width="56" height="18.7" fill="#0039A6"/><rect y="37.3" width="56" height="18.7" fill="#D52B1E"/></g></svg>' },
        es: { name: 'Español', svg: '<svg viewBox="0 0 56 56" width="56" height="56"><clipPath id="cs"><circle cx="28" cy="28" r="28"/></clipPath><g clip-path="url(#cs)"><rect y="0" width="56" height="14" fill="#AA151B"/><rect y="14" width="56" height="28" fill="#F1BF00"/><rect y="42" width="56" height="14" fill="#AA151B"/></g></svg>' },
        it: { name: 'Italiano', svg: '<svg viewBox="0 0 56 56" width="56" height="56"><clipPath id="ci"><circle cx="28" cy="28" r="28"/></clipPath><g clip-path="url(#ci)"><rect x="0" width="18.7" height="56" fill="#009246"/><rect x="18.7" width="18.7" height="56" fill="#FFF"/><rect x="37.3" width="18.7" height="56" fill="#CE2B37"/></g></svg>' }
    };
    const T = {
        // ─── GREETINGS ───
        morning:{nl:'Goedemorgen',en:'Good morning',ru:'Доброе утро',es:'Buenos días',it:'Buongiorno'},
        afternoon:{nl:'Goedemiddag',en:'Good afternoon',ru:'Добрый день',es:'Buenas tardes',it:'Buon pomeriggio'},
        evening:{nl:'Goedenavond',en:'Good evening',ru:'Добрый вечер',es:'Buenas noches',it:'Buonasera'},
        night:{nl:'Goedenacht',en:'Good night',ru:'Доброй ночи',es:'Buenas noches',it:'Buonanotte'},
        // ─── NAV ───
        today:{nl:'Vandaag',en:'Today',ru:'Сегодня',es:'Hoy',it:'Oggi'},
        menu:{nl:'Menu',en:'Menu',ru:'Меню',es:'Menú',it:'Menu'},
        back:{nl:'Terug',en:'Back',ru:'Назад',es:'Atrás',it:'Indietro'},
        save:{nl:'Opslaan',en:'Save',ru:'Сохранить',es:'Guardar',it:'Salva'},
        cancel:{nl:'Annuleren',en:'Cancel',ru:'Отмена',es:'Cancelar',it:'Annulla'},
        add:{nl:'Toevoegen',en:'Add',ru:'Добавить',es:'Añadir',it:'Aggiungi'},
        delete:{nl:'Verwijderen',en:'Delete',ru:'Удалить',es:'Eliminar',it:'Elimina'},
        edit:{nl:'Bewerken',en:'Edit',ru:'Редактировать',es:'Editar',it:'Modifica'},
        next:{nl:'Volgende',en:'Next',ru:'Далее',es:'Siguiente',it:'Avanti'},
        // ─── MENU TILES ───
        overview:{nl:'Overzicht',en:'Overview',ru:'Обзор',es:'Resumen',it:'Panoramica'},
        overviewSub:{nl:'Grafieken, kalender, cijfers',en:'Charts, calendar, numbers',ru:'Графики, календарь, цифры',es:'Gráficos, calendario, cifras',it:'Grafici, calendario, numeri'},
        freeBudget:{nl:'Vrij budget',en:'Free budget',ru:'Свободный бюджет',es:'Presupuesto libre',it:'Budget libero'},
        freeBudgetSub:{nl:'Uitgaven vrij besteedbaar',en:'Discretionary spending',ru:'Свободные расходы',es:'Gastos discrecionales',it:'Spese discrezionali'},
        savings:{nl:'Spaarrace',en:'Savings race',ru:'Гонка сбережений',es:'Carrera de ahorro',it:'Gara di risparmio'},
        savingsSub:{nl:'Doel, prognose, voortgang',en:'Goal, forecast, progress',ru:'Цель, прогноз, прогресс',es:'Meta, pronóstico, progreso',it:'Obiettivo, previsione, progresso'},
        incomeAndSalary:{nl:'Inkomen & salaris',en:'Income & salary',ru:'Доход и зарплата',es:'Ingresos y salario',it:'Reddito e stipendio'},
        incomeAndSalarySub:{nl:'Netto inkomen, salarisdag',en:'Net income, payday',ru:'Чистый доход, день зарплаты',es:'Ingreso neto, día de pago',it:'Reddito netto, giorno paga'},
        fixedCosts:{nl:'Vaste lasten',en:'Fixed costs',ru:'Постоянные расходы',es:'Gastos fijos',it:'Costi fissi'},
        fixedCostsSub:{nl:'Huur, energie, verzekeringen',en:'Rent, energy, insurance',ru:'Аренда, энергия, страховка',es:'Alquiler, energía, seguros',it:'Affitto, energia, assicurazioni'},
        budgetAndSaving:{nl:'Dagbudget & sparen',en:'Daily budget & saving',ru:'Дневной бюджет и сбережения',es:'Presupuesto diario y ahorro',it:'Budget giornaliero e risparmio'},
        budgetAndSavingSub:{nl:'Dagbudget, auto-sparen, doel',en:'Daily budget, auto-save, goal',ru:'Дневной бюджет, автосбережение, цель',es:'Presupuesto diario, auto-ahorro, meta',it:'Budget giornaliero, auto-risparmio, obiettivo'},
        profile:{nl:'Profiel',en:'Profile',ru:'Профиль',es:'Perfil',it:'Profilo'},
        profileSub:{nl:'Naam, avatar, thema',en:'Name, avatar, theme',ru:'Имя, аватар, тема',es:'Nombre, avatar, tema',it:'Nome, avatar, tema'},
        dataPrivacy:{nl:'Data & privacy',en:'Data & privacy',ru:'Данные и конфиденциальность',es:'Datos y privacidad',it:'Dati e privacy'},
        dataPrivacySub:{nl:'Backup, data wissen',en:'Backup, delete data',ru:'Резервное копирование, удаление данных',es:'Copia de seguridad, borrar datos',it:'Backup, cancella dati'},
        // ─── COMMON ───
        income:{nl:'Inkomen',en:'Income',ru:'Доход',es:'Ingresos',it:'Reddito'},
        expenses:{nl:'Uitgaven',en:'Expenses',ru:'Расходы',es:'Gastos',it:'Spese'},
        spent:{nl:'uitgegeven',en:'spent',ru:'потрачено',es:'gastado',it:'speso'},
        remaining:{nl:'over',en:'remaining',ru:'осталось',es:'restante',it:'rimanente'},
        perMonth:{nl:'per maand',en:'per month',ru:'в месяц',es:'por mes',it:'al mese'},
        perDay:{nl:'per dag',en:'per day',ru:'в день',es:'por día',it:'al giorno'},
        period:{nl:'Periode',en:'Period',ru:'Период',es:'Período',it:'Periodo'},
        currentPeriod:{nl:'Huidige periode',en:'Current period',ru:'Текущий период',es:'Período actual',it:'Periodo attuale'},
        dailyBudget:{nl:'Dagbudget',en:'Daily budget',ru:'Дневной бюджет',es:'Presupuesto diario',it:'Budget giornaliero'},
        autoSave:{nl:'Automatisch sparen',en:'Auto-save',ru:'Автосбережение',es:'Auto-ahorro',it:'Auto-risparmio'},
        savingsGoal:{nl:'Spaardoel',en:'Savings goal',ru:'Цель сбережений',es:'Meta de ahorro',it:'Obiettivo di risparmio'},
        savingsBalance:{nl:'Spaargeld',en:'Savings',ru:'Сбережения',es:'Ahorros',it:'Risparmi'},
        freeToSpend:{nl:'Vrij besteedbaar',en:'Free to spend',ru:'Свободно',es:'Libre para gastar',it:'Libero da spendere'},
        avgPerDay:{nl:'Gem. per dag',en:'Avg. per day',ru:'Сред. в день',es:'Prom. por día',it:'Media al giorno'},
        noData:{nl:'Nog geen data.',en:'No data yet.',ru:'Данных пока нет.',es:'Aún no hay datos.',it:'Nessun dato ancora.'},
        noExpenses:{nl:'Nog geen uitgaven.',en:'No expenses yet.',ru:'Расходов пока нет.',es:'Aún no hay gastos.',it:'Nessuna spesa ancora.'},
        total:{nl:'Totaal',en:'Total',ru:'Итого',es:'Total',it:'Totale'},
        saved:{nl:'bespaard',en:'saved',ru:'сэкономлено',es:'ahorrado',it:'risparmiato'},
        over:{nl:'over budget',en:'over budget',ru:'перерасход',es:'sobre presupuesto',it:'oltre budget'},
        adjusted:{nl:'Aangepast.',en:'Adjusted.',ru:'Изменено.',es:'Ajustado.',it:'Modificato.'},
        removed:{nl:'Verwijderd.',en:'Removed.',ru:'Удалено.',es:'Eliminado.',it:'Rimosso.'},
        added:{nl:'Toegevoegd.',en:'Added.',ru:'Добавлено.',es:'Añadido.',it:'Aggiunto.'},
        // ─── ONBOARDING ───
        chooseLang:{nl:'Kies je taal',en:'Choose your language',ru:'Выберите язык',es:'Elige tu idioma',it:'Scegli la tua lingua'},
        welcomeTitle:{nl:'Welkom bij GRIP',en:'Welcome to GRIP',ru:'Добро пожаловать в GRIP',es:'Bienvenido a GRIP',it:'Benvenuto in GRIP'},
        welcomeSub:{nl:'Grip op je geld. Zonder gedoe.',en:'Grip on your money. No hassle.',ru:'Контроль над деньгами. Без хлопот.',es:'Control de tu dinero. Sin complicaciones.',it:'Controllo sui tuoi soldi. Senza problemi.'},
        yourName:{nl:'Hoe heet je?',en:'What\'s your name?',ru:'Как тебя зовут?',es:'¿Cómo te llamas?',it:'Come ti chiami?'},
        namePlaceholder:{nl:'Jouw naam',en:'Your name',ru:'Ваше имя',es:'Tu nombre',it:'Il tuo nome'},
        choosePIN:{nl:'Kies een PIN',en:'Choose a PIN',ru:'Выберите PIN',es:'Elige un PIN',it:'Scegli un PIN'},
        pinSub:{nl:'4 cijfers om je gegevens te beschermen.',en:'4 digits to protect your data.',ru:'4 цифры для защиты данных.',es:'4 dígitos para proteger tus datos.',it:'4 cifre per proteggere i tuoi dati.'},
        pinChoose:{nl:'Kies je PIN',en:'Choose your PIN',ru:'Выберите PIN',es:'Elige tu PIN',it:'Scegli il tuo PIN'},
        pinConfirm:{nl:'Bevestig je PIN',en:'Confirm your PIN',ru:'Подтвердите PIN',es:'Confirma tu PIN',it:'Conferma il tuo PIN'},
        pinMismatch:{nl:'De PINs komen niet overeen. Probeer opnieuw.',en:'PINs don\'t match. Try again.',ru:'PIN-коды не совпадают. Попробуйте снова.',es:'Los PINs no coinciden. Inténtalo de nuevo.',it:'I PIN non corrispondono. Riprova.'},
        whenStart:{nl:'Wanneer gaat GRIP in?',en:'When does GRIP start?',ru:'Когда начать GRIP?',es:'¿Cuándo empieza GRIP?',it:'Quando inizia GRIP?'},
        startDate:{nl:'Startdatum',en:'Start date',ru:'Дата начала',es:'Fecha de inicio',it:'Data di inizio'},
        startDateHelper:{nl:'Standaard: vandaag.',en:'Default: today.',ru:'По умолчанию: сегодня.',es:'Por defecto: hoy.',it:'Predefinito: oggi.'},
        whenPaid:{nl:'Wanneer krijg je betaald?',en:'When do you get paid?',ru:'Когда вам платят?',es:'¿Cuándo te pagan?',it:'Quando vieni pagato?'},
        salaryDaySub:{nl:'GRIP rekent in salarisperiodes.',en:'GRIP calculates in salary periods.',ru:'GRIP считает по зарплатным периодам.',es:'GRIP calcula por períodos salariales.',it:'GRIP calcola per periodi salariali.'},
        fixedDay:{nl:'Vaste dag',en:'Fixed day',ru:'Фиксированный день',es:'Día fijo',it:'Giorno fisso'},
        perMonthDay:{nl:'Per maand',en:'Per month',ru:'По месяцам',es:'Por mes',it:'Per mese'},
        salaryDay:{nl:'Salarisdag',en:'Payday',ru:'День зарплаты',es:'Día de pago',it:'Giorno paga'},
        financialBase:{nl:'Je financiële basis',en:'Your financial base',ru:'Ваша финансовая база',es:'Tu base financiera',it:'La tua base finanziaria'},
        financialBaseSub:{nl:'Dit bepaalt hoeveel je per dag te besteden hebt.',en:'This determines your daily spending.',ru:'Это определяет ваши дневные расходы.',es:'Esto determina tu gasto diario.',it:'Questo determina le tue spese giornaliere.'},
        netIncome:{nl:'Netto inkomen per maand',en:'Net monthly income',ru:'Чистый месячный доход',es:'Ingreso mensual neto',it:'Reddito mensile netto'},
        fixedCostsTitle:{nl:'Vaste lasten',en:'Fixed costs',ru:'Постоянные расходы',es:'Gastos fijos',it:'Costi fissi'},
        fixedCostsSub2:{nl:'Hoeveel gaat er maandelijks af?',en:'How much goes out monthly?',ru:'Сколько уходит ежемесячно?',es:'¿Cuánto sale mensualmente?',it:'Quanto esce mensilmente?'},
        totalAmount:{nl:'Totaalbedrag',en:'Total amount',ru:'Общая сумма',es:'Importe total',it:'Importo totale'},
        perCategory:{nl:'Per categorie',en:'Per category',ru:'По категориям',es:'Por categoría',it:'Per categoria'},
        savingsTitle:{nl:'Sparen',en:'Savings',ru:'Сбережения',es:'Ahorros',it:'Risparmi'},
        savingsSub2:{nl:'Hoeveel gaat er automatisch opzij?',en:'How much is saved automatically?',ru:'Сколько откладывается автоматически?',es:'¿Cuánto se ahorra automáticamente?',it:'Quanto viene risparmiato automaticamente?'},
        autoSavePerMonth:{nl:'Automatisch sparen per maand',en:'Auto-save per month',ru:'Автосбережение в месяц',es:'Auto-ahorro mensual',it:'Auto-risparmio mensile'},
        currentSavings:{nl:'Huidig spaargeld',en:'Current savings',ru:'Текущие сбережения',es:'Ahorros actuales',it:'Risparmi attuali'},
        howMuchSaved:{nl:'Hoeveel heb je al gespaard?',en:'How much have you saved?',ru:'Сколько уже накоплено?',es:'¿Cuánto has ahorrado?',it:'Quanto hai risparmiato?'},
        savingsGoalOpt:{nl:'Spaardoel (optioneel)',en:'Savings goal (optional)',ru:'Цель сбережений (необязательно)',es:'Meta de ahorro (opcional)',it:'Obiettivo risparmio (opzionale)'},
        ahaTitle:{nl:'Dit is wat GRIP voor je uitrekent',en:'This is what GRIP calculates for you',ru:'Вот что GRIP рассчитал для вас',es:'Esto es lo que GRIP calcula para ti',it:'Questo è ciò che GRIP calcola per te'},
        maxGrowth:{nl:'Maximale groei per maand',en:'Maximum growth per month',ru:'Максимальный рост в месяц',es:'Crecimiento máximo mensual',it:'Crescita massima mensile'},
        readyToStart:{nl:'Klaar om te beginnen?',en:'Ready to start?',ru:'Готовы начать?',es:'¿Listo para empezar?',it:'Pronto per iniziare?'},
        startGrip:{nl:'Start GRIP',en:'Start GRIP',ru:'Начать GRIP',es:'Iniciar GRIP',it:'Inizia GRIP'},
        enterAmount:{nl:'Vul een bedrag in.',en:'Enter an amount.',ru:'Введите сумму.',es:'Introduce un importe.',it:'Inserisci un importo.'},
        enterName:{nl:'Vul je naam in om door te gaan.',en:'Enter your name to continue.',ru:'Введите имя чтобы продолжить.',es:'Introduce tu nombre para continuar.',it:'Inserisci il tuo nome per continuare.'},
        enterIncome:{nl:'Vul je inkomen in.',en:'Enter your income.',ru:'Введите доход.',es:'Introduce tus ingresos.',it:'Inserisci il tuo reddito.'},
        // ─── CATEGORIES ───
        catHuis:{nl:'Wonen',en:'Housing',ru:'Жильё',es:'Vivienda',it:'Abitazione'},
        catEnergie:{nl:'Energie & water',en:'Energy & water',ru:'Энергия и вода',es:'Energía y agua',it:'Energia e acqua'},
        catVerzekeringen:{nl:'Verzekeringen',en:'Insurance',ru:'Страховка',es:'Seguros',it:'Assicurazioni'},
        catTelefoon:{nl:'Telefoon & internet',en:'Phone & internet',ru:'Телефон и интернет',es:'Teléfono e internet',it:'Telefono e internet'},
        catAbonnementen:{nl:'Abonnementen',en:'Subscriptions',ru:'Подписки',es:'Suscripciones',it:'Abbonamenti'},
        catSport:{nl:'Sport & bewegen',en:'Sports & fitness',ru:'Спорт и фитнес',es:'Deporte y fitness',it:'Sport e fitness'},
        catLeningen:{nl:'Leningen & schulden',en:'Loans & debts',ru:'Кредиты и долги',es:'Préstamos y deudas',it:'Prestiti e debiti'},
        catGezin:{nl:'Gezin & huishouden',en:'Family & household',ru:'Семья и хозяйство',es:'Familia y hogar',it:'Famiglia e casa'},
        catBelastingen:{nl:'Belastingen',en:'Taxes',ru:'Налоги',es:'Impuestos',it:'Tasse'},
        catVervoer:{nl:'Vervoer',en:'Transport',ru:'Транспорт',es:'Transporte',it:'Trasporto'},
        catOverig:{nl:'Overig',en:'Other',ru:'Прочее',es:'Otros',it:'Altro'},
        // spending cats
        catKleding:{nl:'Kleding',en:'Clothing',ru:'Одежда',es:'Ropa',it:'Abbigliamento'},
        catElektronica:{nl:'Elektronica',en:'Electronics',ru:'Электроника',es:'Electrónica',it:'Elettronica'},
        catHoreca:{nl:'Uit eten/drinken',en:'Eating/drinking out',ru:'Рестораны/кафе',es:'Restaurantes/bares',it:'Ristoranti/bar'},
        catCadeaus:{nl:'Cadeaus',en:'Gifts',ru:'Подарки',es:'Regalos',it:'Regali'},
        catGezondheid:{nl:'Gezondheid',en:'Health',ru:'Здоровье',es:'Salud',it:'Salute'},
        catHobby:{nl:'Hobby',en:'Hobby',ru:'Хобби',es:'Hobby',it:'Hobby'},
        catVakantie:{nl:'Vakantie',en:'Vacation',ru:'Отпуск',es:'Vacaciones',it:'Vacanza'},
        catHuishouden:{nl:'Huishouden',en:'Household',ru:'Хозяйство',es:'Hogar',it:'Casa'},
        catAuto:{nl:'Auto/vervoer',en:'Car/transport',ru:'Авто/транспорт',es:'Auto/transporte',it:'Auto/trasporto'},
        catOverigVrij:{nl:'Overig',en:'Other',ru:'Прочее',es:'Otros',it:'Altro'},
        // ─── OVERVIEW ───
        dailySpending:{nl:'Dagelijks uitgegeven',en:'Daily spending',ru:'Ежедневные расходы',es:'Gasto diario',it:'Spesa giornaliera'},
        distribution:{nl:'Verdeling deze periode',en:'Distribution this period',ru:'Распределение за период',es:'Distribución este período',it:'Distribuzione questo periodo'},
        numbers:{nl:'Cijfers',en:'Numbers',ru:'Цифры',es:'Cifras',it:'Numeri'},
        calendar:{nl:'Kalender',en:'Calendar',ru:'Календарь',es:'Calendario',it:'Calendario'},
        dailySaved:{nl:'Dagelijks bespaard',en:'Daily saved',ru:'Сэкономлено за день',es:'Ahorro diario',it:'Risparmio giornaliero'},
        freeSpent:{nl:'Vrij budget uitgegeven',en:'Free budget spent',ru:'Потрачено из свободного бюджета',es:'Presupuesto libre gastado',it:'Budget libero speso'},
        freeRemaining:{nl:'Vrij budget over',en:'Free budget remaining',ru:'Остаток свободного бюджета',es:'Presupuesto libre restante',it:'Budget libero rimanente'},
        actual:{nl:'Actueel',en:'Actual',ru:'Факт',es:'Actual',it:'Attuale'},
        // ─── SPAREN ───
        adjustBalance:{nl:'Spaarsaldo aanpassen',en:'Adjust balance',ru:'Скорректировать баланс',es:'Ajustar saldo',it:'Regola saldo'},
        actualBalance:{nl:'Werkelijk saldo',en:'Actual balance',ru:'Фактический баланс',es:'Saldo real',it:'Saldo reale'},
        correct:{nl:'Corrigeren',en:'Correct',ru:'Скорректировать',es:'Corregir',it:'Correggi'},
        thisPeriod:{nl:'Deze periode',en:'This period',ru:'Этот период',es:'Este período',it:'Questo periodo'},
        // ─── SETTINGS ───
        netMonthlyIncome:{nl:'Netto maandinkomen',en:'Net monthly income',ru:'Чистый месячный доход',es:'Ingreso mensual neto',it:'Reddito mensile netto'},
        differentIncome:{nl:'Afwijkend inkomen',en:'Different income',ru:'Другой доход',es:'Ingreso diferente',it:'Reddito diverso'},
        differentIncomeSub:{nl:'Vakantiegeld, bonus, of minder uren?',en:'Holiday pay, bonus, or fewer hours?',ru:'Отпускные, бонус или меньше часов?',es:'Paga extra, bonus, ¿o menos horas?',it:'Ferie, bonus, o meno ore?'},
        defaultSalaryDay:{nl:'Standaard salarisdag',en:'Default payday',ru:'Стандартный день зарплаты',es:'Día de pago estándar',it:'Giorno paga predefinito'},
        differentDaysPerMonth:{nl:'Andere dag per maand?',en:'Different day per month?',ru:'Другой день по месяцам?',es:'¿Día diferente por mes?',it:'Giorno diverso per mese?'},
        dailyLimit:{nl:'Limiet per dag',en:'Daily limit',ru:'Дневной лимит',es:'Límite diario',it:'Limite giornaliero'},
        dailyBudgetHelper:{nl:'Supermarkt, koffie, lunch. Wat je niet uitgeeft → besparing.',en:'Groceries, coffee, lunch. What you don\'t spend → savings.',ru:'Продукты, кофе, обед. Что не потратите → сбережения.',es:'Supermercado, café, almuerzo. Lo que no gastes → ahorro.',it:'Spesa, caffè, pranzo. Quello che non spendi → risparmio.'},
        fixedSavingPerMonth:{nl:'Vast spaarbedrag per maand',en:'Fixed savings per month',ru:'Фиксированная сумма сбережений в месяц',es:'Ahorro fijo mensual',it:'Risparmio fisso mensile'},
        startBalance:{nl:'Startsaldo',en:'Start balance',ru:'Начальный баланс',es:'Saldo inicial',it:'Saldo iniziale'},
        startBalanceHelper:{nl:'Hoeveel spaargeld had je toen je GRIP begon?',en:'How much savings did you have when you started GRIP?',ru:'Сколько сбережений было, когда вы начали GRIP?',es:'¿Cuántos ahorros tenías al iniciar GRIP?',it:'Quanti risparmi avevi quando hai iniziato GRIP?'},
        goal:{nl:'Doel',en:'Goal',ru:'Цель',es:'Meta',it:'Obiettivo'},
        description:{nl:'Omschrijving',en:'Description',ru:'Описание',es:'Descripción',it:'Descrizione'},
        amount:{nl:'Bedrag',en:'Amount',ru:'Сумма',es:'Importe',it:'Importo'},
        optional:{nl:'optioneel',en:'optional',ru:'необязательно',es:'opcional',it:'opzionale'},
        viewFor:{nl:'Bekijk voor:',en:'View for:',ru:'Показать для:',es:'Ver para:',it:'Visualizza per:'},
        deviation:{nl:'afwijkend',en:'adjusted',ru:'изменено',es:'ajustado',it:'modificato'},
        undo:{nl:'Ongedaan maken',en:'Undo',ru:'Отменить',es:'Deshacer',it:'Annulla'},
        // ─── NEW: savings race, balance, corrections ───
        savingsRace:{nl:'Spaarrace',en:'Savings race',ru:'Гонка сбережений',es:'Carrera de ahorro',it:'Gara di risparmio'},
        savingsRaceSub:{nl:'Doel, prognose, voortgang',en:'Goal, forecast, progress',ru:'Цель, прогноз, прогресс',es:'Meta, pronóstico, progreso',it:'Obiettivo, previsione, progresso'},
        myBalance:{nl:'Huidig spaarsaldo',en:'Current savings',ru:'Текущий баланс',es:'Saldo de ahorro actual',it:'Saldo risparmio attuale'},
        balanceNow:{nl:'Saldo nu',en:'Balance now',ru:'Баланс сейчас',es:'Saldo ahora',it:'Saldo ora'},
        goalReached:{nl:'🎉 Doel bereikt!',en:'🎉 Goal reached!',ru:'🎉 Цель достигнута!',es:'🎉 ¡Meta alcanzada!',it:'🎉 Obiettivo raggiunto!'},
        goalReachedSub:{nl:'Gefeliciteerd! Je hebt je spaardoel behaald.',en:'Congratulations! You reached your savings goal.',ru:'Поздравляем! Вы достигли цели сбережений.',es:'¡Felicidades! Alcanzaste tu meta de ahorro.',it:'Congratulazioni! Hai raggiunto il tuo obiettivo di risparmio.'},
        setNewGoal:{nl:'Nieuw doel instellen',en:'Set new goal',ru:'Установить новую цель',es:'Establecer nueva meta',it:'Imposta nuovo obiettivo'},
        keepGoing:{nl:'Of blijf gewoon sparen — GRIP houdt bij hoe je saldo groeit.',en:'Or just keep saving — GRIP tracks your balance growth.',ru:'Или просто продолжайте копить — GRIP отслеживает рост баланса.',es:'O sigue ahorrando — GRIP sigue tu crecimiento.',it:'O continua a risparmiare — GRIP monitora la crescita.'},
        correctBalanceTitle:{nl:'Saldo corrigeren',en:'Correct balance',ru:'Скорректировать баланс',es:'Corregir saldo',it:'Correggi saldo'},
        correctBalanceExplain:{nl:'Klopt je spaarsaldo niet meer? Dat kan gebeuren bij onvoorziene uitgaven (reparatie, boete, medische kosten) of juist een meevaller (bonus, belastingteruggave, cadeau). Vul je werkelijke saldo in en GRIP past alles automatisch aan.',en:'Is your balance off? This can happen with unexpected expenses (repairs, fines, medical) or windfalls (bonus, tax refund, gift). Enter your actual balance and GRIP adjusts automatically.',ru:'Баланс не совпадает? Это может случиться из-за непредвиденных расходов (ремонт, штрафы, медицина) или неожиданных доходов (бонус, налоговый возврат, подарок). Введите реальный баланс и GRIP скорректирует автоматически.',es:'¿Tu saldo no coincide? Puede pasar por gastos imprevistos (reparaciones, multas, médicos) o ingresos inesperados (bonus, devolución de impuestos, regalo). Ingresa tu saldo real y GRIP ajusta automáticamente.',it:'Il saldo non corrisponde? Può succedere con spese impreviste (riparazioni, multe, mediche) o entrate inaspettate (bonus, rimborso tasse, regalo). Inserisci il saldo reale e GRIP si adegua automaticamente.'},
        salaryPerMonthExplain:{nl:'Dit toont de maanden tot december. Na december kun je het nieuwe jaar instellen via het menu onder Inkomen & salaris.',en:'This shows months until December. After December you can set up the new year in the menu under Income & salary.',ru:'Здесь показаны месяцы до декабря. После декабря вы можете настроить новый год в меню Доход и зарплата.',es:'Esto muestra los meses hasta diciembre. Después de diciembre puedes configurar el nuevo año en el menú Ingresos y salario.',it:'Questo mostra i mesi fino a dicembre. Dopo dicembre puoi impostare il nuovo anno nel menu Reddito e stipendio.'},
        incomeVariesHint:{nl:'Verschilt je inkomen per maand (vakantiegeld, bonus)? Dat kun je later aanpassen via het menu → Inkomen & salaris.',en:'Does your income vary monthly (holiday pay, bonus)? You can adjust this later in the menu → Income & salary.',ru:'Ваш доход меняется помесячно (отпускные, бонус)? Это можно изменить позже в меню → Доход и зарплата.',es:'¿Tu ingreso varía mensualmente (paga extra, bonus)? Puedes ajustarlo después en el menú → Ingresos y salario.',it:'Il tuo reddito varia mensilmente (ferie, bonus)? Puoi modificarlo dopo nel menu → Reddito e stipendio.'},
        fixedCostsAdjustHint:{nl:'Veranderen je vaste lasten per maand? Dat kun je later per maand aanpassen in het menu → Vaste lasten.',en:'Do your fixed costs change monthly? You can adjust them per month later in the menu → Fixed costs.',ru:'Постоянные расходы меняются помесячно? Можно изменить по месяцам в меню → Постоянные расходы.',es:'¿Cambian tus gastos fijos mensualmente? Puedes ajustarlos por mes en el menú → Gastos fijos.',it:'I costi fissi cambiano mensilmente? Puoi modificarli per mese nel menu → Costi fissi.'},
        estimated:{nl:'Geschat',en:'Estimated',ru:'Ожидается',es:'Estimado',it:'Stimato'},
        milestones:{nl:'Mijlpalen',en:'Milestones',ru:'Вехи',es:'Hitos',it:'Traguardi'},
        howGripCalc:{nl:'Hoe berekent GRIP dit?',en:'How does GRIP calculate this?',ru:'Как GRIP это считает?',es:'¿Cómo calcula GRIP esto?',it:'Come calcola GRIP questo?'},
        highConf:{nl:'Hoge betrouwbaarheid',en:'High confidence',ru:'Высокая точность',es:'Alta confianza',it:'Alta affidabilità'},
        medConf:{nl:'Gemiddelde betrouwbaarheid',en:'Medium confidence',ru:'Средняя точность',es:'Confianza media',it:'Affidabilità media'},
        lowConf:{nl:'Nog weinig data',en:'Little data yet',ru:'Мало данных',es:'Pocos datos aún',it:'Pochi dati ancora'},
        nothingSpent:{nl:'Niks uitgegeven',en:'Nothing spent',ru:'Ничего не потрачено',es:'Nada gastado',it:'Nulla speso'},
        otherAmount:{nl:'Anders',en:'Other',ru:'Другое',es:'Otro',it:'Altro'},
        addExpense:{nl:'Toevoegen',en:'Add',ru:'Добавить',es:'Añadir',it:'Aggiungi'},
        noteOptional:{nl:'Notitie (optioneel)',en:'Note (optional)',ru:'Заметка (необязательно)',es:'Nota (opcional)',it:'Nota (opzionale)'},
        enterAmountHint:{nl:'Vul een bedrag in.',en:'Enter an amount.',ru:'Введите сумму.',es:'Introduce un importe.',it:'Inserisci un importo.'},
        dailyExpenses:{nl:'Dagelijkse uitgaven invoeren',en:'Enter daily expenses',ru:'Ввести ежедневные расходы',es:'Introducir gastos diarios',it:'Inserire spese giornaliere'},
        perMonthAvg:{nl:'per maand gemiddeld',en:'per month average',ru:'в среднем в месяц',es:'promedio mensual',it:'media mensile'},
        noGoalSet:{nl:'Stel een spaardoel in om je voortgang te volgen.',en:'Set a savings goal to track your progress.',ru:'Установите цель сбережений для отслеживания прогресса.',es:'Establece una meta de ahorro para seguir tu progreso.',it:'Imposta un obiettivo di risparmio per monitorare i progressi.'},
        setGoal:{nl:'Spaardoel instellen',en:'Set savings goal',ru:'Установить цель',es:'Establecer meta',it:'Imposta obiettivo'},
        spendingOverBudget:{nl:'Je geeft momenteel meer uit dan je spaart.',en:'You\'re currently spending more than you save.',ru:'Вы сейчас тратите больше, чем сберегаете.',es:'Actualmente gastas más de lo que ahorras.',it:'Attualmente spendi più di quanto risparmi.'},
        // ─── MONTHS ───
        months:{
            nl:['Januari','Februari','Maart','April','Mei','Juni','Juli','Augustus','September','Oktober','November','December'],
            en:['January','February','March','April','May','June','July','August','September','October','November','December'],
            ru:['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'],
            es:['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'],
            it:['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre']
        },
        monthsShort:{
            nl:['jan','feb','mrt','apr','mei','jun','jul','aug','sep','okt','nov','dec'],
            en:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
            ru:['янв','фев','мар','апр','май','июн','июл','авг','сен','окт','ноя','дек'],
            es:['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'],
            it:['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic']
        },
        days:{nl:['zo','ma','di','wo','do','vr','za'],en:['Su','Mo','Tu','We','Th','Fr','Sa'],ru:['Вс','Пн','Вт','Ср','Чт','Пт','Сб'],es:['Do','Lu','Ma','Mi','Ju','Vi','Sá'],it:['Do','Lu','Ma','Me','Gi','Ve','Sa']},
    };
    function t(key) {
        const val = T[key];
        if (!val) return key;
        if (typeof val === 'string') return val;
        return val[currentLang] || val.nl || key;
    }
    function tMonth(i) { return (T.months[currentLang] || T.months.nl)[i] || ''; }
    function tMonthShort(i) { return (T.monthsShort[currentLang] || T.monthsShort.nl)[i] || ''; }
    function tDay(i) { return (T.days[currentLang] || T.days.nl)[i] || ''; }
    function getCatLabel(cat) {
        const map = {huis:'catHuis',energie:'catEnergie',verzekeringen:'catVerzekeringen',telefoon_internet:'catTelefoon',abonnementen:'catAbonnementen',sport:'catSport',leningen:'catLeningen',gezin:'catGezin',belastingen:'catBelastingen',vervoer:'catVervoer',overig:'catOverig',kleding:'catKleding',elektronica:'catElektronica',horeca:'catHoreca',cadeaus:'catCadeaus',gezondheid:'catGezondheid',hobby:'catHobby',vakantie:'catVakantie',huishouden:'catHuishouden',auto:'catAuto',overig_vrij:'catOverigVrij'};
        return t(map[cat] || 'catOverig');
    }
    /* ═══════════════════════════════════════════════════════════════
       GRIP v1 — Slice A
       Business logic preserved from Budget Tracker v16+
       New UI layer: 4-tab structure per GRIP blauwdruk
       ═══════════════════════════════════════════════════════════════ */

    // ─── CONSTANTS ───
    // No emoji avatars — using initials + photo upload

    const FIXED_COST_SUGGESTIONS = [
        { name:'Huur/Hypotheek', cat:'huis' },
        { name:'Servicekosten', cat:'huis' },
        { name:'Energie', cat:'energie' },
        { name:'Water', cat:'energie' },
        { name:'Zorgverzekering', cat:'verzekeringen' },
        { name:'Aanvullende verzekering', cat:'verzekeringen' },
        { name:'Inboedelverzekering', cat:'verzekeringen' },
        { name:'Autoverzekering', cat:'verzekeringen' },
        { name:'Reisverzekering', cat:'verzekeringen' },
        { name:'Telefoon', cat:'telefoon_internet' },
        { name:'Internet', cat:'telefoon_internet' },
        { name:'Spotify', cat:'abonnementen' },
        { name:'Netflix', cat:'abonnementen' },
        { name:'Disney+', cat:'abonnementen' },
        { name:'YouTube Premium', cat:'abonnementen' },
        { name:'iCloud / Google One', cat:'abonnementen' },
        { name:'Krant / Nieuwsapp', cat:'abonnementen' },
        { name:'Sportschool', cat:'sport' },
        { name:'Sportvereniging', cat:'sport' },
        { name:'Studiefinanciering', cat:'leningen' },
        { name:'Persoonlijke lening', cat:'leningen' },
        { name:'Creditcard', cat:'leningen' },
        { name:'Alimentatie', cat:'gezin' },
        { name:'Kinderopvang', cat:'gezin' },
        { name:'Schoolkosten', cat:'gezin' },
        { name:'Gezamenlijke rekening', cat:'gezin' },
        { name:'Gemeentebelasting', cat:'belastingen' },
        { name:'Waterschapsbelasting', cat:'belastingen' },
        { name:'OV-abonnement', cat:'vervoer' },
        { name:'Auto (lease/afbetaling)', cat:'vervoer' },
        { name:'Motorrijtuigenbelasting', cat:'vervoer' },
        { name:'Parkeervergunning', cat:'vervoer' },
        { name:'Overig', cat:'overig' }
    ];

    const CAT_LABELS = {
        huis: 'Wonen',
        energie: 'Energie & water',
        verzekeringen: 'Verzekeringen',
        telefoon_internet: 'Telefoon & internet',
        abonnementen: 'Abonnementen',
        sport: 'Sport & bewegen',
        leningen: 'Leningen & schulden',
        gezin: 'Gezin & huishouden',
        belastingen: 'Belastingen',
        vervoer: 'Vervoer',
        overig: 'Overig'
    };

    const MONTH_NAMES_NL = ['Januari','Februari','Maart','April','Mei','Juni','Juli','Augustus','September','Oktober','November','December'];
    const MONTH_KEYS_SHORT = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];

    // ─── APP DATA ───
    let appData = {
        setupComplete: false,
        appStartDate: '',
        userName: '',
        pin: '',
        avatar: '',
        avatarPhoto: '',
        theme: 'dark',
        accentIndex: 0,
        selectedQuoteIds: [],
        defaultSalaryDay: 24,
        salaryDates: {},
        monthlyIncome: 0,
        incomePerMonth: false,
        incomeByMonth: {},
        dailyGroceryBudget: 3500,
        autoSaveCents: 60000,
        startSavingsCents: 0,
        savingsGoalCents: 0,
        savingsCorrections: [],
        income: {},
        fixedCosts: { huis:[], energie:[], verzekeringen:[], telefoon_internet:[], abonnementen:[], sport:[], leningen:[], gezin:[], belastingen:[], vervoer:[], overig:[] },
        groceries: {},
        spending: {},
        fixedCostOverrides: {},
        incomeByMonth: {},
        freeBudgetOverride: {},
        currentMonth: null,
        lastActiveMonthKey: null,
        biometrie: false
    };

    let salaryPeriods = [];
    let currentViewName = 'home';
    let undoAction = null;
    let undoTimer = null;

    // ─── CENTS HELPERS ───
    function toCents(euros) {
        // Handle NL comma input: "27,50" → "27.50"
        const cleaned = String(euros).replace(',', '.');
        const num = Number(cleaned);
        if (isNaN(num)) return 0;
        return Math.round(num * 100);
    }
    function fromCents(cents) { return (Math.round(Number(cents) || 0)) / 100; }
    function formatEuro(cents) {
        const rounded = Math.round(Number(cents) || 0);
        const abs = Math.abs(rounded);
        const sign = rounded < 0 ? '-' : '';
        const euros = Math.floor(abs / 100);
        const cts = String(abs % 100).padStart(2, '0');
        const formatted = euros.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        return sign + '€' + formatted + ',' + cts;
    }

    // ─── DATE HELPERS ───
    function startOfDay(date) { return new Date(date.getFullYear(), date.getMonth(), date.getDate()); }
    function getNLDate() { return new Date(); }
    function formatDate(date) {
        return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    }
    function parseLocalDate(dateStr) {
        const [y, m, d] = String(dateStr).split('-').map(Number);
        return new Date(y, (m||1)-1, d||1);
    }
    function formatDateNL(date) {
        const months = ['jan','feb','mrt','apr','mei','jun','jul','aug','sep','okt','nov','dec'];
        return `${date.getDate()} ${months[date.getMonth()]}`;
    }
    function formatDateNLFull(date) {
        const days = ['zo','ma','di','wo','do','vr','za'];
        const months = ['jan','feb','mrt','apr','mei','jun','jul','aug','sep','okt','nov','dec'];
        return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
    }
    function genId(prefix) { return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`; }
    function getTimeStr(isoString) {
        if (!isoString) return '';
        const d = new Date(isoString);
        return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    // ─── THEME ───
    function applyTheme() {
        document.documentElement.setAttribute('data-theme', appData.theme);
    }

    // ─── DYNAMIC SALARY PERIODS ───
    function generateSalaryPeriods() {
        salaryPeriods = [];
        const today = startOfDay(getNLDate());
        const appStart = appData.appStartDate ? startOfDay(parseLocalDate(appData.appStartDate)) : today;
        const effectiveStart = appStart <= today ? appStart : today;
        const defaultDay = appData.defaultSalaryDay || 24;

        function getSalaryDayForMonth(year, month) {
            const key = `${year}-${String(month+1).padStart(2,'0')}`;
            let day = defaultDay;
            if (appData.salaryDates && appData.salaryDates[key]) day = appData.salaryDates[key];
            // Check per-month overrides (new system)
            if (appData.salaryDayOverrides && appData.salaryDayOverrides[String(month)]) day = appData.salaryDayOverrides[String(month)];
            const lastDay = new Date(year, month + 1, 0).getDate();
            return Math.min(day, lastDay);
        }

        let searchDate = new Date(effectiveStart.getFullYear(), effectiveStart.getMonth(), 1);
        let salDay = getSalaryDayForMonth(searchDate.getFullYear(), searchDate.getMonth());
        let salDate = new Date(searchDate.getFullYear(), searchDate.getMonth(), salDay);
        let foundSalary = null;

        if (salDate <= effectiveStart) {
            foundSalary = salDate;
        } else {
            searchDate.setMonth(searchDate.getMonth() - 1);
            salDay = getSalaryDayForMonth(searchDate.getFullYear(), searchDate.getMonth());
            salDate = new Date(searchDate.getFullYear(), searchDate.getMonth(), salDay);
            if (salDate <= effectiveStart) foundSalary = salDate;
        }

        if (!foundSalary) {
            searchDate = new Date(effectiveStart.getFullYear(), effectiveStart.getMonth(), 1);
            salDay = getSalaryDayForMonth(searchDate.getFullYear(), searchDate.getMonth());
            foundSalary = new Date(searchDate.getFullYear(), searchDate.getMonth(), salDay);
        }

        let nextMonth = new Date(foundSalary.getFullYear(), foundSalary.getMonth() + 1, 1);
        let nextSalDay = getSalaryDayForMonth(nextMonth.getFullYear(), nextMonth.getMonth());
        let nextSalDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), nextSalDay);

        if (effectiveStart > foundSalary && effectiveStart < nextSalDate) {
            const endDate = new Date(nextSalDate);
            endDate.setDate(endDate.getDate() - 1);
            const key = MONTH_KEYS_SHORT[foundSalary.getMonth()] + foundSalary.getFullYear();
            salaryPeriods.push({
                key, name: MONTH_NAMES_NL[foundSalary.getMonth()] + ' ' + foundSalary.getFullYear(),
                startDate: new Date(effectiveStart), endDate, salaryDate: null
            });
            foundSalary = nextSalDate;
        }

        let currentSalary = new Date(foundSalary);
        for (let i = 0; i < 14; i++) {
            const periodStart = new Date(currentSalary);
            nextMonth = new Date(currentSalary.getFullYear(), currentSalary.getMonth() + 1, 1);
            nextSalDay = getSalaryDayForMonth(nextMonth.getFullYear(), nextMonth.getMonth());
            nextSalDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), nextSalDay);
            const periodEnd = new Date(nextSalDate);
            periodEnd.setDate(periodEnd.getDate() - 1);

            const key = MONTH_KEYS_SHORT[periodStart.getMonth()] + periodStart.getFullYear();
            const name = MONTH_NAMES_NL[periodStart.getMonth()] + ' ' + periodStart.getFullYear();

            if (!salaryPeriods.find(p => p.key === key)) {
                salaryPeriods.push({ key, name, startDate: periodStart, endDate: periodEnd, salaryDate: periodStart });
            }
            currentSalary = nextSalDate;
        }
    }

    function getMonthKeyForDate(date) {
        const d = startOfDay(date);
        for (const period of salaryPeriods) {
            if (d >= startOfDay(period.startDate) && d <= startOfDay(period.endDate)) return period.key;
        }
        return salaryPeriods[0]?.key || 'unknown';
    }

    function getActiveMonthKey() { return getMonthKeyForDate(getNLDate()); }

    function getPeriodInfo(monthKey) {
        const found = salaryPeriods.find(p => p.key === monthKey) || salaryPeriods[0];
        if (!found) {
            // Fallback: generate a synthetic period so app never crashes
            const today = getNLDate();
            return { key: monthKey || 'fallback', name: 'Periode', startDate: today, endDate: today, salaryDate: null };
        }
        return found;
    }

    function ensureActiveMonthSynced() {
        const active = getActiveMonthKey();
        if (!appData.lastActiveMonthKey) {
            appData.lastActiveMonthKey = active;
            if (!appData.currentMonth) appData.currentMonth = active;
        }
        if (appData.lastActiveMonthKey !== active) {
            appData.lastActiveMonthKey = active;
            appData.currentMonth = active;
            saveData();
        }
    }

    // ─── MONEY CALCULATIONS ───
    function ensureFixedCostsIds() {
        if (!appData.fixedCosts || typeof appData.fixedCosts !== 'object') {
            appData.fixedCosts = {};
        }
        Object.keys(CAT_LABELS).forEach(cat => {
            if (!Array.isArray(appData.fixedCosts[cat])) appData.fixedCosts[cat] = [];
            appData.fixedCosts[cat].forEach(item => {
                if (!item.id) item.id = genId('fix');
                if (item.amountCents === undefined && item.amount !== undefined) { item.amountCents = toCents(item.amount); delete item.amount; }
            });
        });
    }

    function ensureIncomeForMonth(monthKey) {
        if (!appData.income || typeof appData.income !== 'object') appData.income = {};
        if (!Array.isArray(appData.income[monthKey])) {
            let incomeCents = appData.monthlyIncome || 0;
            // Per-period income override
            if (appData.incomeByMonth && appData.incomeByMonth[monthKey] !== undefined) {
                incomeCents = appData.incomeByMonth[monthKey];
            }
            appData.income[monthKey] = incomeCents > 0
                ? [{ id: genId('inc'), name: 'Salaris', amountCents: incomeCents, createdAt: new Date().toISOString() }]
                : [];
            saveData();
        }
        appData.income[monthKey].forEach(item => {
            if (!item.id) item.id = genId('inc');
            if (item.amountCents === undefined && item.amount !== undefined) { item.amountCents = toCents(item.amount); delete item.amount; }
        });
    }

    function calculateFixedCostsTotalCents(monthKey) {
        ensureFixedCostsIds();
        let total = 0;
        Object.keys(appData.fixedCosts || {}).forEach(cat => {
            (appData.fixedCosts[cat] || []).forEach(it => { total += Number(it.amountCents) || 0; });
        });
        // Add per-period overrides (extra costs for this specific period)
        if (monthKey && appData.fixedCostOverrides?.[monthKey]) {
            appData.fixedCostOverrides[monthKey].forEach(it => {
                total += Number(it.amountCents) || 0;
            });
        }
        return Math.round(total);
    }

    function calculateIncomeTotalCents(monthKey) {
        ensureIncomeForMonth(monthKey);
        return Math.round((appData.income[monthKey] || []).reduce((s, it) => s + (Number(it.amountCents) || 0), 0));
    }

    function getAutoSaveForMonthCents(monthKey) {
        return appData.autoSaveCents || 0;
    }

    function getFreeBudgetCents(monthKey) {
        if (appData.freeBudgetOverride && appData.freeBudgetOverride[monthKey] !== undefined) {
            return appData.freeBudgetOverride[monthKey];
        }
        const p = getPeriodInfo(monthKey);
        if (!p) return 0;
        const incomeCents = calculateIncomeTotalCents(monthKey);
        const fixedCents = calculateFixedCostsTotalCents(monthKey);
        const daysInPeriod = Math.round((p.endDate - p.startDate) / (1000*60*60*24)) + 1;
        const groceryCapCents = (appData.dailyGroceryBudget || 3500) * daysInPeriod;
        const autoSaveCents = getAutoSaveForMonthCents(monthKey);
        return Math.round(incomeCents - fixedCents - groceryCapCents - autoSaveCents);
    }

    function calculateMonthGroceriesCents(monthKey) {
        const monthGroceries = appData.groceries[monthKey] || {};
        let totalCents = 0;
        Object.values(monthGroceries).forEach(dayEntries => {
            if (Array.isArray(dayEntries)) dayEntries.forEach(e => { totalCents += Number(e.amountCents) || 0; });
        });
        return Math.round(totalCents);
    }

    function calculateMonthGrocerySavingsCents(monthKey) {
        const monthGroceries = appData.groceries[monthKey] || {};
        let savingsCents = 0;
        const budget = appData.dailyGroceryBudget || 3500;
        Object.keys(monthGroceries).forEach(dateStr => {
            const dayEntries = monthGroceries[dateStr];
            if (Array.isArray(dayEntries) && dayEntries.length > 0) {
                const dayTotal = dayEntries.reduce((s, e) => s + (Number(e.amountCents) || 0), 0);
                savingsCents += budget - Math.round(dayTotal);
            }
        });
        return Math.round(savingsCents);
    }

    function calculateMonthSpendingCents(monthKey) {
        return Math.round((appData.spending[monthKey] || []).reduce((s, e) => s + (Number(e.amountCents) || 0), 0));
    }

    function calculateRealtimeSavingsCents() {
        const today = startOfDay(getNLDate());
        let totalCents = appData.startSavingsCents || 0;
        for (const period of salaryPeriods) {
            const periodStart = startOfDay(period.startDate);
            if (periodStart > today) break;
            totalCents += (appData.autoSaveCents || 0);
            totalCents += calculateMonthGrocerySavingsCents(period.key);
            const spentCents = calculateMonthSpendingCents(period.key);
            totalCents += (getFreeBudgetCents(period.key) - spentCents);
        }
        return Math.round(totalCents);
    }

    function calculateSavingsAtPeriodStartCents(monthKey) {
        const target = getPeriodInfo(monthKey);
        const targetStart = startOfDay(target.startDate);
        let totalCents = appData.startSavingsCents || 0;
        for (const period of salaryPeriods) {
            const pStart = startOfDay(period.startDate);
            if (pStart > targetStart) break;
            if (period.key === monthKey) {
                totalCents += (appData.autoSaveCents || 0);
                break;
            }
            totalCents += (appData.autoSaveCents || 0);
            totalCents += calculateMonthGrocerySavingsCents(period.key);
            totalCents += (getFreeBudgetCents(period.key) - calculateMonthSpendingCents(period.key));
        }
        return Math.round(totalCents);
    }

    // ─── SAVE/LOAD ───
    const STORAGE_KEY = 'grip_v1';
    function saveData() {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); } catch(e) { console.error('Save:', e); }
    }
    function loadData() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed && typeof parsed === 'object') {
                    appData = { ...appData, ...parsed };
                    ensureFixedCostsIds();
                }
            }
            // Migration: try old key
            if (!appData.setupComplete) {
                try {
                    const old = localStorage.getItem('budgetAppData_v18b');
                    if (old) {
                        const parsed = JSON.parse(old);
                        if (parsed && typeof parsed === 'object') {
                            appData = { ...appData, ...parsed };
                            ensureFixedCostsIds();
                            saveData();
                        }
                    }
                } catch(me) { console.warn('Migration failed:', me); }
            }
            // Restore language
            if (appData.lang && LANGS[appData.lang]) currentLang = appData.lang;
        } catch(e) {
            console.error('Load failed, resetting:', e);
            // Corrupt data: remove and start fresh
            try { localStorage.removeItem(STORAGE_KEY); } catch(x) {}
        }
    }

    // ─── TOAST ───
    let toastTimer = null;
    function showToast(message, undoCallback) {
        const el = document.getElementById('toast');
        if (!el) return;
        if (toastTimer) clearTimeout(toastTimer);

        if (undoCallback) {
            el.innerHTML = `${message} <span class="toast-undo" onclick="executeUndo()">Ongedaan maken</span>`;
            undoAction = undoCallback;
        } else {
            el.textContent = message;
            undoAction = null;
        }

        el.classList.add('show');
        toastTimer = setTimeout(() => {
            el.classList.remove('show');
            undoAction = null;
        }, 3500);
    }

    function executeUndo() {
        if (undoAction) {
            undoAction();
            undoAction = null;
        }
        const el = document.getElementById('toast');
        if (el) el.classList.remove('show');
        if (toastTimer) clearTimeout(toastTimer);
    }

    // ─── GREETING ───
    function getGreeting() {
        const h = new Date().getHours();
        const name = appData.userName || '';
        let g;
        if (h >= 5 && h < 12) g = t('morning');
        else if (h >= 12 && h < 18) g = t('afternoon');
        else if (h >= 18 && h < 23) g = t('evening');
        else g = t('night');
        return name ? `${g}, ${name}` : g;
    }

    function getInitials(name) {
        if (!name) return '?';
        const parts = name.trim().split(/\s+/);
        if (parts.length >= 2) return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
        return name.substring(0, 2).toUpperCase();
    }

    function getInitialsHTML(name, fontSize) {
        const fs = fontSize || 16;
        return `<span style="font-size:${fs}px;font-weight:800;color:var(--accent);letter-spacing:1px">${getInitials(name)}</span>`;
    }

    // ═══════════════════════════════════════════════════════════════
    // VIEW SYSTEM
    // ═══════════════════════════════════════════════════════════════
    function showView(viewName) {
        currentViewName = viewName;

        // Hide all views
        document.querySelectorAll('.view').forEach(v => {
            v.classList.add('hidden');
            v.style.display = 'none';
        });

        // Show target
        const viewEl = document.getElementById(viewName + 'View');
        if (viewEl) {
            viewEl.classList.remove('hidden');
            viewEl.style.display = '';
        }

        // Update tab bar — both tabs map to either "home" or "menu" (all other views are menu children)
        const activeTab = viewName === 'home' ? 'home' : 'menu';
        document.querySelectorAll('.tab-item').forEach(t => {
            const isActive = t.dataset.tab === activeTab;
            t.classList.toggle('active', isActive);
            t.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });

        // Render view
        try {
            if (viewName === 'home') updateHome();
            else if (viewName === 'menu') updateMenu();
            else if (viewName === 'overzicht') updateOverzicht();
            else if (viewName === 'sparen') updateSparen();
            else if (viewName === 'profiel') updateProfiel();
            else if (viewName === 'inkomen') updateInkomen();
            else if (viewName === 'dagsparen') updateDagSparen();
            else if (viewName === 'vastelasten') updateVasteLasten();
            else if (viewName === 'vrijbudget') updateVrijBudget();
            else if (viewName === 'dataview') { /* static content */ }
        } catch(e) { console.error('View error:', e); }

        // Scroll top
        window.scrollTo(0, 0);
    }

    function updateAllViews() {
        ensureActiveMonthSynced();
        if (currentViewName === 'home') updateHome();
        else if (currentViewName === 'overzicht') updateOverzicht();
        else if (currentViewName === 'sparen') updateSparen();
    }

    // ═══════════════════════════════════════════════════════════════
    // HOME (GRIP Vandaag)
    // ═══════════════════════════════════════════════════════════════
    function updateHome() {
        try {
            const today = getNLDate();
            const todayStr = formatDate(today);
            const activeMK = getActiveMonthKey();
            const activePeriod = getPeriodInfo(activeMK);
            const budget = appData.dailyGroceryBudget || 3500;

            // Greeting
            document.getElementById('homeGreeting').textContent = getGreeting();

            // i18n labels
            const s = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
            s('homeDailyTitle', t('dailyExpenses'));
            s('inlineAddBtn', t('addExpense'));
            s('inlineHint', t('enterAmountHint'));
            const noteEl = document.getElementById('inlineNote');
            if (noteEl) noteEl.placeholder = t('noteOptional');
            s('homeTodaySectionTitle', t('today'));

            // Avatar
            const avatarEl = document.getElementById('headerAvatar');
            if (avatarEl) {
                avatarEl.innerHTML = appData.avatarPhoto
                    ? `<img src="${appData.avatarPhoto}">`
                    : getInitialsHTML(appData.userName, 16);
            }

            // Today entries
            const todayMK = getMonthKeyForDate(today);
            const todayEntries = (appData.groceries[todayMK]?.[todayStr]) || [];
            const todayTotal = todayEntries.reduce((s, e) => s + (Number(e.amountCents) || 0), 0);
            const remaining = budget - todayTotal;
            const pctSpent = Math.min(100, Math.max(0, (todayTotal / budget) * 100));

            // Primary card
            const amountEl = document.getElementById('homeBudgetLeft');
            const barEl = document.getElementById('homeBudgetBar');
            const subEl = document.getElementById('homeBudgetSub');

            amountEl.textContent = formatEuro(remaining);
            amountEl.style.color = remaining >= 0 ? 'var(--green)' : 'var(--red)';

            barEl.style.width = pctSpent + '%';
            barEl.className = 'progress-fill' + (remaining < 0 ? ' caution' : '');

            if (remaining < 0) {
                subEl.textContent = `${formatEuro(Math.abs(remaining))} ${t('over')}`;
                subEl.style.color = 'var(--red)';
            } else {
                subEl.textContent = `${formatEuro(todayTotal)} / ${formatEuro(budget)} ${t('dailyBudget').toLowerCase()}`;
                subEl.style.color = '';
            }

            // Quick-add grid
            buildQuickAddGrid();

            // Today list
            renderTodayList(todayEntries, todayMK, todayStr);

            // Period status
            renderPeriodStatus(activeMK, activePeriod);

            // Savings
            renderSavingsCompact(activeMK);

        } catch(e) { console.error('Home error:', e); }
    }

    function buildQuickAddGrid() {
        const grid = document.getElementById('quickAddGrid');
        if (!grid) return;
        const amounts = [5, 10, 15, 20, 25, 35, 50];
        grid.innerHTML = amounts.map(v =>
            `<button class="quick-chip" onclick="quickAdd(${v})">€${v}</button>`
        ).join('') +
        `<button class="quick-chip edit-chip" onclick="toggleInlineInput()">✎ ${t('otherAmount')}</button>` +
        `<button class="quick-chip" onclick="markNoSpending()" style="border-color:var(--green);color:var(--green)">✓ ${t('nothingSpent')}</button>`;
    }

    function markNoSpending() {
        const today = getNLDate();
        const todayStr = formatDate(today);
        const mk = getMonthKeyForDate(today);
        if (!appData.groceries[mk]) appData.groceries[mk] = {};
        if (!appData.groceries[mk][todayStr]) appData.groceries[mk][todayStr] = [];
        // Only mark if no entries yet
        if (appData.groceries[mk][todayStr].length === 0) {
            appData.groceries[mk][todayStr].push({
                amountCents: 0,
                note: t('nothingSpent'),
                timestamp: new Date().toISOString()
            });
            saveData();
            showToast('Mooi! Je volledige dagbudget is bespaard.');
        } else {
            showToast('Er zijn al uitgaven geregistreerd voor vandaag.');
        }
        updateHome();
    }

    function quickAdd(euros) {
        const today = getNLDate();
        const todayStr = formatDate(today);
        const mk = getMonthKeyForDate(today);
        if (!appData.groceries[mk]) appData.groceries[mk] = {};
        if (!appData.groceries[mk][todayStr]) appData.groceries[mk][todayStr] = [];
        appData.groceries[mk][todayStr].push({
            amountCents: toCents(euros),
            note: '',
            timestamp: new Date().toISOString()
        });
        saveData();
        updateHome();
    }

    function toggleInlineInput() {
        const area = document.getElementById('inlineInputArea');
        const isOpen = area.classList.contains('open');
        if (isOpen) {
            area.classList.remove('open');
        } else {
            area.classList.add('open');
            setTimeout(() => {
                const input = document.getElementById('inlineAmount');
                if (input) {
                    input.focus();
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 150);
        }
    }

    function addInlineExpense() {
        const amountEl = document.getElementById('inlineAmount');
        const noteEl = document.getElementById('inlineNote');
        const hintEl = document.getElementById('inlineHint');
        const amount = parseFloat(amountEl?.value || 0);

        if (!amount || amount <= 0) {
            hintEl?.classList.add('visible');
            amountEl?.classList.add('caution');
            setTimeout(() => { hintEl?.classList.remove('visible'); amountEl?.classList.remove('caution'); }, 2000);
            return;
        }

        const today = getNLDate();
        const todayStr = formatDate(today);
        const mk = getMonthKeyForDate(today);
        if (!appData.groceries[mk]) appData.groceries[mk] = {};
        if (!appData.groceries[mk][todayStr]) appData.groceries[mk][todayStr] = [];
        appData.groceries[mk][todayStr].push({
            amountCents: toCents(amount),
            note: noteEl?.value?.trim() || '',
            timestamp: new Date().toISOString()
        });
        saveData();

        // Reset input
        amountEl.value = '';
        noteEl.value = '';
        document.getElementById('inlineInputArea').classList.remove('open');

        updateHome();
    }

    // Enter key support
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const area = document.getElementById('inlineInputArea');
            if (area?.classList.contains('open') && (document.activeElement?.id === 'inlineAmount' || document.activeElement?.id === 'inlineNote')) {
                addInlineExpense();
            }
            // Onboarding: Enter advances step on text/number inputs
            const obEl = document.getElementById('onboarding');
            if (obEl && !obEl.classList.contains('hidden') && document.activeElement?.classList.contains('grip-input')) {
                obNext();
            }
        }
    });

    let editingGroceryKey = null; // 'mk|dateStr|idx'

    function renderTodayList(entries, mk, todayStr) {
        const section = document.getElementById('homeTodaySection');
        const list = document.getElementById('homeTodayList');
        if (!list) return;

        if (entries.length === 0) {
            list.innerHTML = `<div class="empty-state">Nog niets uitgegeven vandaag.</div>`;
            return;
        }

        list.innerHTML = entries.map((e, i) => {
            const editKey = `${mk}|${todayStr}|${i}`;
            const isEditing = editingGroceryKey === editKey;
            if (isEditing) {
                return `<div class="tx-item" style="flex-direction:column;gap:var(--space-sm)">
                    <div style="display:flex;gap:var(--space-sm);width:100%">
                        <input type="number" class="grip-input grip-input-sm" id="editGrocAmount" value="${fromCents(e.amountCents)}" inputmode="decimal" style="flex:1">
                        <input type="text" class="grip-input grip-input-sm" id="editGrocNote" value="${e.note || ''}" placeholder="Notitie" style="flex:2">
                    </div>
                    <div style="display:flex;gap:var(--space-sm);width:100%">
                        <button class="btn-add" onclick="saveEditGrocery('${mk}','${todayStr}',${i})" style="flex:1">Opslaan</button>
                        <button class="btn-add" onclick="cancelEditGrocery()" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                    </div>
                </div>`;
            }
            return `<div class="tx-item">
                <div class="tx-info">
                    <div class="tx-note">${e.note || 'Uitgave'}</div>
                    <div class="tx-time">${getTimeStr(e.timestamp)}</div>
                </div>
                <div class="tx-amount">${e.amountCents === 0 ? '' : '-'}${formatEuro(e.amountCents)}</div>
                <button class="tx-delete" onclick="startEditGrocery('${mk}','${todayStr}',${i})" title="Bewerken" aria-label="Bewerk uitgave">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
                <button class="tx-delete" onclick="deleteGrocery('${mk}','${todayStr}',${i})" title="Verwijder" aria-label="Verwijder uitgave">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
            </div>`;
        }).join('');
    }

    function startEditGrocery(mk, dateStr, idx) {
        editingGroceryKey = `${mk}|${dateStr}|${idx}`;
        updateHome();
    }

    function cancelEditGrocery() {
        editingGroceryKey = null;
        updateHome();
    }

    function saveEditGrocery(mk, dateStr, idx) {
        const entry = appData.groceries[mk]?.[dateStr]?.[idx];
        if (!entry) return;
        const amount = parseFloat(document.getElementById('editGrocAmount')?.value) || 0;
        const note = document.getElementById('editGrocNote')?.value?.trim() || '';
        entry.amountCents = toCents(amount);
        entry.note = note;
        saveData();
        editingGroceryKey = null;
        updateHome();
        showToast('Aangepast.');
    }

    function deleteGrocery(mk, dateStr, idx) {
        const entries = appData.groceries[mk]?.[dateStr];
        if (!entries || !entries[idx]) return;

        // Save for undo
        const removed = { ...entries[idx] };
        entries.splice(idx, 1);
        if (entries.length === 0) delete appData.groceries[mk][dateStr];
        saveData();
        updateHome();

        showToast('Verwijderd.', function() {
            // Undo: restore
            if (!appData.groceries[mk]) appData.groceries[mk] = {};
            if (!appData.groceries[mk][dateStr]) appData.groceries[mk][dateStr] = [];
            appData.groceries[mk][dateStr].splice(idx, 0, removed);
            saveData();
            updateHome();
        });
    }

    function renderPeriodStatus(mk, period) {
        const labelEl = document.getElementById('periodLabel');
        const statusEl = document.getElementById('periodStatus');
        const dotsEl = document.getElementById('periodDots');

        // Period label
        const startStr = formatDateNL(period.startDate);
        const endStr = formatDateNL(period.endDate);
        labelEl.textContent = `${startStr} – ${endStr}`;

        // Calculate period budget status
        const grocBudgetTotal = (appData.dailyGroceryBudget || 3500) * (Math.round((period.endDate - period.startDate) / (1000*60*60*24)) + 1);
        const grocSpent = calculateMonthGroceriesCents(mk);
        const diff = grocBudgetTotal - grocSpent;

        if (diff >= 0) {
            statusEl.textContent = `${formatEuro(diff)} onder budget`;
            statusEl.style.color = 'var(--green)';
        } else {
            statusEl.textContent = `${formatEuro(Math.abs(diff))} boven budget`;
            statusEl.style.color = 'var(--red)';
        }

        // Dots
        if (dotsEl) {
            const today = startOfDay(getNLDate());
            const pStart = startOfDay(period.startDate);
            const appStart = appData.appStartDate ? startOfDay(parseLocalDate(appData.appStartDate)) : pStart;
            let dots = '';
            const d = new Date(pStart);
            while (d <= today && d <= startOfDay(period.endDate)) {
                if (d >= appStart) {
                    const dStr = formatDate(d);
                    const entries = appData.groceries[mk]?.[dStr] || [];
                    const isToday = d.getTime() === today.getTime();
                    let cls = 'dot';
                    if (entries.length > 0) {
                        const dayTotal = entries.reduce((s,e) => s + (Number(e.amountCents)||0), 0);
                        cls += dayTotal <= (appData.dailyGroceryBudget || 3500) ? ' green' : ' caution';
                    }
                    if (isToday) cls += ' today';
                    dots += `<div class="${cls}"></div>`;
                }
                d.setDate(d.getDate() + 1);
            }
            dotsEl.innerHTML = dots;
        }
    }

    function renderSavingsCompact(activeMK) {
        const totalEl = document.getElementById('homeSavingsTotal');
        const changeEl = document.getElementById('homeSavingsChange');
        const labelEl = document.getElementById('homeSavingsLabel');

        const realtimeTotal = calculateRealtimeSavingsCents();
        const periodStart = calculateSavingsAtPeriodStartCents(activeMK);
        const change = realtimeTotal - periodStart;

        if (labelEl) labelEl.textContent = t('myBalance');
        totalEl.textContent = formatEuro(realtimeTotal);
        const sign = change >= 0 ? '+' : '';
        changeEl.textContent = `${sign}${formatEuro(change)} ${t('thisPeriod').toLowerCase()}`;
        changeEl.style.color = change >= 0 ? 'var(--green)' : 'var(--red)';
    }

    // ═══════════════════════════════════════════════════════════════
    // PIN SYSTEM
    // ═══════════════════════════════════════════════════════════════
    let pinValue = '';

    function initPinScreen() {
        pinValue = '';
        updatePinDots();
        document.getElementById('pinError')?.classList.remove('show');
    }

    function pinInput(digit) {
        if (pinValue.length >= 4) return;
        pinValue += digit;
        updatePinDots();
        if (pinValue.length === 4) {
            setTimeout(pinSubmit, 150);
        }
    }

    function pinClear() {
        if (pinValue.length > 0) {
            pinValue = pinValue.slice(0, -1);
            updatePinDots();
        }
    }

    function updatePinDots() {
        const dots = document.querySelectorAll('#pinDots .pin-dot');
        dots.forEach((dot, i) => {
            dot.classList.toggle('filled', i < pinValue.length);
        });
    }

    function pinSubmit() {
        if (pinValue === appData.pin) {
            document.getElementById('pinScreen').classList.add('hidden');
            ensureActiveMonthSynced();
            // Direct to Home — no welcome flash
            const app = document.getElementById('app');
            if (app) { app.classList.remove('hidden'); app.style.display = ''; }
            showView('home');
        } else {
            const error = document.getElementById('pinError');
            if (error) { error.classList.add('show'); setTimeout(() => error.classList.remove('show'), 2000); }
            pinValue = '';
            updatePinDots();
        }
    }


    // ═══════════════════════════════════════════════════════════════
    // MENU
    // ═══════════════════════════════════════════════════════════════
    function updateMenu() {
        try {
            const activeMK = getActiveMonthKey();
            const greetEl = document.getElementById('menuGreeting');
            if (greetEl) greetEl.textContent = getGreeting();

            // i18n — update all menu tile labels dynamically
            const tiles = document.querySelectorAll('.menu-tile');
            const tileData = [
                {view:'overzicht', title:t('overview'), sub:t('overviewSub')},
                {view:'vrijbudget', title:t('freeBudget'), sub:t('freeBudgetSub')},
                {view:'sparen', title:t('savings'), sub:t('savingsSub')},
                {view:'inkomen', title:t('incomeAndSalary'), sub:t('incomeAndSalarySub')},
                {view:'dagsparen', title:t('budgetAndSaving'), sub:t('budgetAndSavingSub')},
                {view:'vastelasten', title:t('fixedCosts'), sub:t('fixedCostsSub')},
                {view:'profiel', title:t('profile'), sub:t('profileSub')},
                {view:'dataview', title:t('dataPrivacy'), sub:t('dataPrivacySub')},
            ];
            tiles.forEach(tile => {
                const onclick = tile.getAttribute('onclick') || '';
                const td = tileData.find(d => onclick.includes(`'${d.view}'`));
                if (td) {
                    const titleEl = tile.querySelector('.menu-tile-title');
                    const subEl = tile.querySelector('.menu-tile-sub');
                    if (titleEl) titleEl.textContent = td.title;
                    if (subEl) subEl.textContent = td.sub;
                }
            });

            // Tab bar i18n
            const tabs = document.querySelectorAll('.tab-item');
            const tabLabels = [t('today'), t('menu')];
            tabs.forEach((tab, i) => {
                const label = tab.querySelector('.tab-label');
                if (label && tabLabels[i]) label.textContent = tabLabels[i];
            });

            // Overzicht status
            const ovEl = document.getElementById('menuOvStatus');
            if (ovEl) {
                const period = getPeriodInfo(activeMK);
                ovEl.textContent = period.name || activeMK;
            }

            // Free budget status
            const freeEl = document.getElementById('menuFreeStatus');
            if (freeEl) {
                const freeBudget = getFreeBudgetCents(activeMK);
                const freeSpent = calculateMonthSpendingCents(activeMK);
                const remaining = freeBudget - freeSpent;
                freeEl.textContent = `${formatEuro(remaining)} ${t('remaining')}`;
                freeEl.style.color = remaining >= 0 ? 'var(--green)' : 'var(--red)';
            }

            // Fixed costs total
            const fixEl = document.getElementById('menuFixedTotal');
            if (fixEl) fixEl.textContent = '−' + formatEuro(calculateFixedCostsTotalCents(activeMK));

            // Savings status
            const savEl = document.getElementById('menuSavingsStatus');
            if (savEl) savEl.textContent = formatEuro(calculateRealtimeSavingsCents());
        } catch(e) { console.error('Menu error:', e); }
    }

    // ═══════════════════════════════════════════════════════════════
    // INSTELLINGEN
    // ═══════════════════════════════════════════════════════════════
    function updateInkomen() {
        try {
            const incEl = document.getElementById('instIncome');
            if (incEl && !incEl.matches(':focus')) incEl.value = fromCents(appData.monthlyIncome || 0);
            const sdEl = document.getElementById('instSalaryDay');
            if (sdEl && !sdEl.matches(':focus')) sdEl.value = appData.defaultSalaryDay || 24;
            populateInstPeriodDropdowns();
            renderInstIncomeOverrides();
            renderSalaryDayGrid();
            // i18n labels
            const s = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
            s('inkomenViewTitle', t('incomeAndSalary'));
            s('inkomenSectionTitle', t('income'));
            s('inkomenNetLabel', t('netMonthlyIncome'));
            s('inkomenSaveBtn', t('save'));
            s('inkomenDiffLabel', t('differentIncome'));
            s('inkomenDiffHelper', t('differentIncomeSub'));
            s('inkomenDiffSave', t('save'));
            s('salaryDaySectionTitle', t('salaryDay'));
            s('salaryDayDefaultLabel', t('defaultSalaryDay'));
            s('salaryDayPerMonthLabel', t('differentDaysPerMonth'));
            s('salaryDayGridHelper', t('salaryPerMonthExplain'));
            s('salaryDaySaveAll', t('save'));
        } catch(e) { console.error('Inkomen error:', e); }
    }

    function updateDagSparen() {
        try {
            const dbEl = document.getElementById('instDailyBudget');
            if (dbEl && !dbEl.matches(':focus')) dbEl.value = fromCents(appData.dailyGroceryBudget || 3500);
            const asEl = document.getElementById('instAutoSave');
            if (asEl && !asEl.matches(':focus')) asEl.value = fromCents(appData.autoSaveCents || 0);
            const csEl = document.getElementById('instCurrentSavings');
            if (csEl) csEl.textContent = formatEuro(calculateRealtimeSavingsCents());
            const ssEl = document.getElementById('instStartSavings');
            if (ssEl && !ssEl.matches(':focus')) ssEl.value = fromCents(appData.startSavingsCents || 0);
            const sgEl = document.getElementById('instSavingsGoal');
            if (sgEl && !sgEl.matches(':focus')) sgEl.value = appData.savingsGoalCents ? fromCents(appData.savingsGoalCents) : '';
            // i18n labels
            const s = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
            s('dagsparenViewTitle', t('budgetAndSaving'));
            s('dagBudgetSectionTitle', t('dailyBudget'));
            s('dagLimitLabel', t('dailyLimit'));
            s('dagBudgetHelper', t('dailyBudgetHelper'));
            s('autoSaveSectionTitle', t('autoSave'));
            s('autoSaveLabel', t('fixedSavingPerMonth'));
            s('goalSectionTitle', t('savingsGoal'));
            s('currentSavingsLabel', t('savingsBalance'));
            s('correctBtn', t('correct'));
            s('correctHelper', t('adjustBalance'));
            s('startBalanceLabel', t('startBalance'));
            s('startBalanceHelper', t('startBalanceHelper'));
            s('goalLabel', t('goal'));
        } catch(e) { console.error('DagSparen error:', e); }
    }

    function correctSavingsFromSettings() {
        const inputEl = document.getElementById('instCorrectSavings');
        const desiredTotal = parseFloat(inputEl?.value);
        if (isNaN(desiredTotal)) { showToast(t('enterAmount')); return; }
        const desiredCents = toCents(desiredTotal);
        const currentCalc = calculateRealtimeSavingsCents();
        const diff = desiredCents - currentCalc;
        appData.startSavingsCents = (appData.startSavingsCents || 0) + diff;
        if (!appData.savingsCorrections) appData.savingsCorrections = [];
        appData.savingsCorrections.push({ date: new Date().toISOString(), fromCents: currentCalc, toCents: desiredCents, adjustmentCents: diff });
        saveData();
        if (inputEl) inputEl.value = '';
        updateDagSparen();
        showToast(t('adjusted'));
    }

    function saveSalaryDayGridAll() {
        if (!appData.salaryDayOverrides) appData.salaryDayOverrides = {};
        for (let m = 0; m < 12; m++) {
            const el = document.getElementById('salaryDayMonth' + m);
            if (!el) continue;
            const v = parseInt(el.value);
            if (v > 0 && v <= 31) {
                appData.salaryDayOverrides[String(m)] = v;
            } else {
                delete appData.salaryDayOverrides[String(m)];
            }
        }
        saveData();
        generateSalaryPeriods();
        showToast(t('adjusted'));
    }

    function updateVasteLasten() {
        try {
            populateInstPeriodDropdowns();
            renderInstFixedCosts();
            renderFcDonut();
            // i18n labels
            const s = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
            s('fcAddBtn', t('add'));
            // Populate category dropdown with i18n
            const catSel = document.getElementById('instFcCat');
            if (catSel && catSel.options.length === 0) {
                const cats = ['huis','energie','verzekeringen','telefoon_internet','abonnementen','sport','leningen','gezin','belastingen','vervoer','overig'];
                cats.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = getCatLabel(c); catSel.appendChild(o); });
            }
        } catch(e) { console.error('VasteLasten error:', e); }
    }

    function renderSalaryDayGrid() {
        const el = document.getElementById('salaryDayGrid');
        if (!el) return;
        const MONTHS_SHORT = ['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];
        const overrides = appData.salaryDayOverrides || {};
        const defaultDay = appData.defaultSalaryDay || 24;
        let html = '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:var(--space-xs)">';
        MONTHS_SHORT.forEach((m, i) => {
            const key = String(i);
            const val = overrides[key] || '';
            html += `<div style="text-align:center">
                <div style="font-size:0.68rem;color:var(--text-muted);margin-bottom:2px">${m}</div>
                <input type="number" class="grip-input grip-input-sm" style="text-align:center;padding:4px" min="1" max="31" inputmode="numeric" placeholder="${defaultDay}" value="${val}" onchange="saveSalaryDayOverride(${i},this.value)">
            </div>`;
        });
        html += '</div>';
        el.innerHTML = html;
    }

    function saveSalaryDayOverride(month, val) {
        if (!appData.salaryDayOverrides) appData.salaryDayOverrides = {};
        const v = parseInt(val);
        if (v > 0 && v <= 31) {
            appData.salaryDayOverrides[String(month)] = v;
        } else {
            delete appData.salaryDayOverrides[String(month)];
        }
        saveData();
        generateSalaryPeriods();
    }

    function renderFcDonut() {
        const donutEl = document.getElementById('fcDonut');
        const legendEl = document.getElementById('fcDonutLegend');
        const totalEl = document.getElementById('fcDonutTotal');
        if (!donutEl || !legendEl) return;

        const mk = document.getElementById('instFixedPeriod')?.value || getActiveMonthKey();
        ensureFixedCostsIds();

        // Gather by category
        const catTotals = {};
        const cats = Object.keys(appData.fixedCosts || {});
        cats.forEach(cat => {
            (appData.fixedCosts[cat] || []).forEach(item => {
                const override = appData.fixedCostOverrides?.[mk]?.find(o => o.id === item.id);
                const amt = override ? override.amountCents : item.amountCents;
                catTotals[cat] = (catTotals[cat] || 0) + amt;
            });
        });

        const total = Object.values(catTotals).reduce((s, v) => s + v, 0);
        if (totalEl) totalEl.textContent = '−' + formatEuro(total);

        const fcColors = {
            huis: '#8b5cf6', energie: '#f59e0b', verzekeringen: '#3b82f6', telefoon_internet: '#06b6d4',
            abonnementen: '#ec4899', sport: '#22c55e', leningen: '#ef4444', gezin: '#a855f7',
            belastingen: '#64748b', vervoer: '#14b8a6', overig: '#6b7280'
        };

        const segments = Object.entries(catTotals).filter(([,v]) => v > 0).map(([cat, value]) => ({
            label: getCatLabel(cat), value, color: fcColors[cat] || '#6b7280'
        }));

        if (segments.length === 0) { donutEl.innerHTML = ''; legendEl.innerHTML = ''; return; }

        // Draw donut
        const size = 100, cx = size/2, cy = size/2, r = 38, sw = 14;
        let svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
        let angle = -90;
        segments.forEach(seg => {
            const pct = seg.value / total;
            const a = pct * 360;
            const s1 = angle * Math.PI / 180, e1 = (angle + a) * Math.PI / 180;
            const large = a > 180 ? 1 : 0;
            if (a > 0.5) svg += `<path d="M${cx+r*Math.cos(s1)},${cy+r*Math.sin(s1)} A${r},${r} 0 ${large},1 ${cx+r*Math.cos(e1)},${cy+r*Math.sin(e1)}" fill="none" stroke="${seg.color}" stroke-width="${sw}"/>`;
            angle += a;
        });
        svg += '</svg>';
        donutEl.innerHTML = svg;
        legendEl.innerHTML = segments.map(s =>
            `<div style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:8px;border-radius:50%;background:${s.color};flex-shrink:0"></span>${s.label}: ${formatEuro(s.value)}</div>`
        ).join('');
    }

    function populateInstPeriodDropdowns() {
        const today = startOfDay(getNLDate());
        const activeMK = getActiveMonthKey();

        // Build list: all existing periods + 6 future months
        const allPeriods = [...salaryPeriods];
        const lastP = allPeriods[allPeriods.length - 1];
        if (lastP) {
            const lastEnd = lastP.endDate;
            for (let i = 1; i <= 6; i++) {
                const futureDate = new Date(lastEnd.getFullYear(), lastEnd.getMonth() + i, 1);
                const fKey = `${futureDate.getFullYear()}-${String(futureDate.getMonth() + 1).padStart(2, '0')}`;
                if (!allPeriods.find(p => p.key === fKey)) {
                    allPeriods.push({ key: fKey, name: tMonth(futureDate.getMonth()) + ' ' + futureDate.getFullYear(), startDate: futureDate, endDate: futureDate });
                }
            }
        }

        ['instIncomeOverridePeriod', 'instFixedPeriod'].forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            const currentVal = sel.value;
            sel.innerHTML = '';
            allPeriods.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.name + (p.key === activeMK ? ` (${t('currentPeriod').toLowerCase()})` : '');
                sel.appendChild(opt);
            });
            sel.value = currentVal || activeMK;
        });
    }

    // ─── SAVE FUNCTIONS ───
    function saveInstIncome() {
        const v = toCents(parseFloat(document.getElementById('instIncome')?.value) || 0);
        appData.monthlyIncome = v;
        // Reset income entries for current period so they get recalculated
        const mk = getActiveMonthKey();
        delete appData.income[mk];
        saveData();
        generateSalaryPeriods();
        showToast('Inkomen opgeslagen.');
        updateInstellingen();
    }

    function saveInstSalaryDay() {
        const v = parseInt(document.getElementById('instSalaryDay')?.value) || 24;
        appData.defaultSalaryDay = Math.max(1, Math.min(31, v));
        saveData();
        generateSalaryPeriods();
        showToast('Salarisdag opgeslagen.');
        updateInstellingen();
    }

    function saveInstBudget() {
        appData.dailyGroceryBudget = toCents(parseFloat(document.getElementById('instDailyBudget')?.value) || 35);
        saveData();
        showToast('Dagbudget opgeslagen.');
    }

    function saveInstAutoSave() {
        appData.autoSaveCents = toCents(parseFloat(document.getElementById('instAutoSave')?.value) || 0);
        saveData();
        showToast('Auto-sparen opgeslagen.');
    }

    function saveInstGoal() {
        appData.startSavingsCents = toCents(parseFloat(document.getElementById('instStartSavings')?.value) || 0);
        const goalVal = parseFloat(document.getElementById('instSavingsGoal')?.value);
        appData.savingsGoalCents = goalVal > 0 ? toCents(goalVal) : 0;
        saveData();
        updateInstellingen();
        showToast('Spaardoel opgeslagen.');
    }

    // ─── INCOME OVERRIDES ───
    function saveInstIncomeOverride() {
        const mk = document.getElementById('instIncomeOverridePeriod')?.value;
        const val = parseFloat(document.getElementById('instIncomeOverrideVal')?.value);
        if (!mk || isNaN(val) || val <= 0) { showToast('Vul een bedrag in.'); return; }
        if (!appData.incomeByMonth) appData.incomeByMonth = {};
        appData.incomeByMonth[mk] = toCents(val);
        // Reset income entries so they get recalculated
        delete appData.income[mk];
        saveData();
        document.getElementById('instIncomeOverrideVal').value = '';
        renderInstIncomeOverrides();
        showToast('Afwijkend inkomen opgeslagen.');
    }

    function deleteInstIncomeOverride(mk) {
        delete appData.incomeByMonth[mk];
        delete appData.income[mk];
        saveData();
        renderInstIncomeOverrides();
        showToast('Afwijking verwijderd.');
    }

    function renderInstIncomeOverrides() {
        const el = document.getElementById('instIncomeOverrideList');
        if (!el) return;
        const overrides = appData.incomeByMonth || {};
        const keys = Object.keys(overrides);
        if (keys.length === 0) { el.innerHTML = ''; return; }
        el.innerHTML = keys.map(mk => {
            const period = getPeriodInfo(mk);
            return `<div class="tx-item" style="padding:var(--space-xs) 0">
                <div class="tx-info"><div class="tx-note">${period?.name || mk}</div></div>
                <div class="tx-amount" style="color:var(--green)">${formatEuro(overrides[mk])}</div>
                <button class="tx-delete" onclick="deleteInstIncomeOverride('${mk}')" title="Verwijder"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>`;
        }).join('');
    }

    // ─── FIXED COSTS INLINE ───
    let editingInstFixedId = null;

    function renderInstFixedCosts() {
        const el = document.getElementById('instFixedList');
        const totalEl = document.getElementById('instFixedTotal');
        if (!el) return;

        const mk = document.getElementById('instFixedPeriod')?.value || getActiveMonthKey();
        ensureFixedCostsIds();

        // Gather all base fixed costs
        let allItems = [];
        const cats = Object.keys(appData.fixedCosts || {});
        cats.forEach(cat => {
            (appData.fixedCosts[cat] || []).forEach(item => {
                // Check if there's an override for this item in this period
                const override = appData.fixedCostOverrides?.[mk]?.find(o => o.id === item.id);
                allItems.push({
                    ...item, cat,
                    displayAmount: override ? override.amountCents : item.amountCents,
                    hasOverride: !!override
                });
            });
        });

        if (allItems.length === 0) {
            el.innerHTML = '<div class="empty-state" style="font-size:0.82rem;padding:var(--space-md) 0">Nog geen vaste lasten.</div>';
            if (totalEl) totalEl.textContent = formatEuro(0);
            return;
        }

        let total = 0;
        let html = '';
        allItems.forEach(item => {
            total += item.displayAmount;
            if (editingInstFixedId === item.id) {
                html += `<div class="tx-item" style="flex-direction:column;gap:var(--space-sm);padding:var(--space-sm) 0">
                    <div style="display:flex;gap:var(--space-sm);width:100%">
                        <input type="text" class="grip-input grip-input-sm" id="editInstFcName" value="${item.name || ''}" placeholder="Naam" style="flex:2">
                        <input type="number" class="grip-input grip-input-sm" id="editInstFcAmount" value="${fromCents(item.displayAmount)}" inputmode="decimal" style="flex:1">
                    </div>
                    <div style="display:flex;gap:var(--space-sm);width:100%">
                        <button class="btn-add" onclick="saveInstFixedEdit('${item.cat}','${item.id}','${mk}')" style="flex:1;background:var(--green);color:#fff">Opslaan</button>
                        <button class="btn-add" onclick="editingInstFixedId=null;renderInstFixedCosts()" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                    </div>
                </div>`;
            } else {
                const overrideTag = item.hasOverride ? '<span style="font-size:0.65rem;background:var(--accent-dim);color:var(--accent);padding:1px 6px;border-radius:8px;margin-left:6px">afwijkend</span>' : '';
                html += `<div class="tx-item" style="padding:var(--space-xs) 0">
                    <div class="tx-info"><div class="tx-note">${item.name || getCatLabel(item.cat)}${overrideTag}</div><div class="tx-time">${getCatLabel(item.cat)}</div></div>
                    <div class="tx-amount" style="color:var(--red)">−${formatEuro(item.displayAmount)}</div>
                    <button class="tx-delete" onclick="editingInstFixedId='${item.id}';renderInstFixedCosts()" title="Bewerken"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                    <button class="tx-delete" onclick="deleteInstFixed('${item.cat}','${item.id}')" title="Verwijder"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                </div>`;
            }
        });
        el.innerHTML = html;
        if (totalEl) totalEl.textContent = '−' + formatEuro(total);
    }

    function saveInstFixedEdit(cat, id, mk) {
        const name = document.getElementById('editInstFcName')?.value?.trim() || '';
        const amount = toCents(parseFloat(document.getElementById('editInstFcAmount')?.value) || 0);
        const activeMK = getActiveMonthKey();

        // Find base item
        const item = (appData.fixedCosts[cat] || []).find(x => x.id === id);
        if (!item) return;

        if (mk === activeMK || mk === 'base') {
            // Update base item
            item.name = name || item.name;
            item.amountCents = amount;
            // Remove any override for this period
            if (appData.fixedCostOverrides?.[mk]) {
                appData.fixedCostOverrides[mk] = appData.fixedCostOverrides[mk].filter(o => o.id !== id);
                if (appData.fixedCostOverrides[mk].length === 0) delete appData.fixedCostOverrides[mk];
            }
        } else {
            // Create/update override for this specific period
            if (!appData.fixedCostOverrides) appData.fixedCostOverrides = {};
            if (!appData.fixedCostOverrides[mk]) appData.fixedCostOverrides[mk] = [];
            const existing = appData.fixedCostOverrides[mk].find(o => o.id === id);
            if (existing) {
                existing.amountCents = amount;
                existing.name = name || existing.name;
            } else {
                appData.fixedCostOverrides[mk].push({ id, name: name || item.name, amountCents: amount });
            }
        }

        saveData();
        editingInstFixedId = null;
        renderInstFixedCosts();
        showToast('Opgeslagen.');
    }

    function deleteInstFixed(cat, id) {
        const items = appData.fixedCosts[cat];
        if (!items) return;
        const idx = items.findIndex(x => x.id === id);
        if (idx < 0) return;
        items.splice(idx, 1);
        saveData();
        renderInstFixedCosts();
        showToast('Verwijderd.');
    }

    function addInstFixedCost() {
        const name = document.getElementById('instFcName')?.value?.trim() || '';
        const amount = parseFloat(document.getElementById('instFcAmount')?.value) || 0;
        const cat = document.getElementById('instFcCat')?.value || 'overig';
        if (amount <= 0) { showToast('Vul een bedrag in.'); return; }
        if (!appData.fixedCosts[cat]) appData.fixedCosts[cat] = [];
        appData.fixedCosts[cat].push({ id: genId('fc'), name: name || CAT_LABELS[cat] || 'Vaste last', amountCents: toCents(amount) });
        saveData();
        document.getElementById('instFcName').value = '';
        document.getElementById('instFcAmount').value = '';
        renderInstFixedCosts();
        showToast('Toegevoegd.');
    }

    // ═══════════════════════════════════════════════════════════════
    // VRIJ BUDGET
    // ═══════════════════════════════════════════════════════════════
    let vbViewedMK = null;
    let editingVBSpendKey = null;

    function updateVrijBudget() {
        try {
            const activeMK = getActiveMonthKey();
            if (!vbViewedMK) vbViewedMK = activeMK;

            // Budget card
            const freeBudget = getFreeBudgetCents(vbViewedMK);
            const freeSpent = calculateMonthSpendingCents(vbViewedMK);
            const remaining = freeBudget - freeSpent;

            const amountEl = document.getElementById('vbBudgetLeft');
            const subEl = document.getElementById('vbBudgetSub');
            if (amountEl) {
                amountEl.textContent = formatEuro(remaining);
                amountEl.style.color = remaining >= 0 ? 'var(--green)' : 'var(--red)';
            }
            if (subEl) {
                subEl.textContent = `${formatEuro(freeSpent)} uitgegeven van ${formatEuro(freeBudget)}`;
            }

            // Spending list
            renderVBSpendingList(vbViewedMK);
            renderVBDonut(vbViewedMK);
        } catch(e) { console.error('VrijBudget error:', e); }
    }

    function renderVBDonut(mk) {
        const donutEl = document.getElementById('vbDonut');
        const legendEl = document.getElementById('vbDonutLegend');
        const card = document.getElementById('vbDonutCard');
        if (!donutEl || !legendEl) return;

        const items = appData.spending[mk] || [];
        if (items.length === 0) { if (card) card.style.display = 'none'; return; }
        if (card) card.style.display = '';

        const catTotals = {};
        items.forEach(it => {
            const c = it.cat || 'overig_vrij';
            catTotals[c] = (catTotals[c] || 0) + (Number(it.amountCents) || 0);
        });

        const vbColors = {
            kleding: '#ec4899', elektronica: '#3b82f6', horeca: '#f59e0b', cadeaus: '#a855f7',
            gezondheid: '#22c55e', hobby: '#06b6d4', vakantie: '#ef4444', huishouden: '#8b5cf6',
            auto: '#14b8a6', overig_vrij: '#6b7280'
        };

        const total = Object.values(catTotals).reduce((s, v) => s + v, 0);
        const segments = Object.entries(catTotals).filter(([,v]) => v > 0).map(([cat, value]) => ({
            label: getCatLabel(cat), value, color: vbColors[cat] || '#6b7280'
        }));

        const size = 100, cx = size/2, cy = size/2, r = 38, sw = 14;
        let svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
        let angle = -90;
        segments.forEach(seg => {
            const pct = seg.value / total;
            const a = pct * 360;
            const s1 = angle * Math.PI / 180, e1 = (angle + a) * Math.PI / 180;
            const large = a > 180 ? 1 : 0;
            if (a > 0.5) svg += `<path d="M${cx+r*Math.cos(s1)},${cy+r*Math.sin(s1)} A${r},${r} 0 ${large},1 ${cx+r*Math.cos(e1)},${cy+r*Math.sin(e1)}" fill="none" stroke="${seg.color}" stroke-width="${sw}"/>`;
            angle += a;
        });
        svg += '</svg>';
        donutEl.innerHTML = svg;
        legendEl.innerHTML = segments.map(s =>
            `<div style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:8px;border-radius:50%;background:${s.color};flex-shrink:0"></span>${s.label}: ${formatEuro(s.value)}</div>`
        ).join('');
    }

    function renderVBSpendingList(mk) {
        const el = document.getElementById('vbSpendingList');
        if (!el) return;
        const items = appData.spending[mk] || [];
        if (items.length === 0) {
            el.innerHTML = '<div class="empty-state" style="padding:var(--space-sm) 0;font-size:0.82rem">Nog geen uitgaven uit vrij budget.</div>';
            return;
        }
        let html = '';
        items.forEach((item, i) => {
            const editKey = `${mk}|${i}`;
            if (editingVBSpendKey === editKey) {
                html += `<div class="tx-item" style="flex-direction:column;gap:var(--space-sm)">
                    <div style="display:flex;gap:var(--space-sm);width:100%">
                        <input type="number" class="grip-input grip-input-sm" id="editVBAmount" value="${fromCents(item.amountCents)}" inputmode="decimal" style="flex:1">
                        <input type="text" class="grip-input grip-input-sm" id="editVBName" value="${item.name || ''}" placeholder="Omschrijving" style="flex:2">
                    </div>
                    <div style="display:flex;gap:var(--space-sm);width:100%">
                        <button class="btn-add" onclick="saveEditVBSpend('${mk}',${i})" style="flex:1">Opslaan</button>
                        <button class="btn-add" onclick="editingVBSpendKey=null;updateVrijBudget()" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                    </div>
                </div>`;
            } else {
                html += `<div class="tx-item">
                    <div class="tx-info"><div class="tx-note">${item.name}<span class="tx-tag free">${SPENDING_CAT_LABELS[item.cat] || item.cat}</span></div><div class="tx-time">${getTimeStr(item.date)}</div></div>
                    <div class="tx-amount">-${formatEuro(item.amountCents)}</div>
                    <button class="tx-delete" onclick="editingVBSpendKey='${editKey}';updateVrijBudget()" title="Bewerken"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                    <button class="tx-delete" onclick="deleteVBSpending('${mk}',${i})" title="Verwijder"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </div>`;
            }
        });
        el.innerHTML = html;
    }

    function saveEditVBSpend(mk, idx) {
        const item = appData.spending[mk]?.[idx];
        if (!item) return;
        item.amountCents = toCents(parseFloat(document.getElementById('editVBAmount')?.value) || 0);
        item.name = document.getElementById('editVBName')?.value?.trim() || item.name;
        saveData();
        editingVBSpendKey = null;
        updateVrijBudget();
        showToast('Aangepast.');
    }

    function addFreeSpendingVB() {
        const mk = vbViewedMK || getActiveMonthKey();
        const name = document.getElementById('vbSpendName')?.value?.trim() || '';
        const amount = parseFloat(document.getElementById('vbSpendAmount')?.value) || 0;
        const cat = document.getElementById('vbSpendCat')?.value || 'overig_vrij';
        if (amount <= 0) { showToast('Vul een bedrag in.'); return; }
        if (!appData.spending[mk]) appData.spending[mk] = [];
        appData.spending[mk].push({
            id: genId('sp'), name: name || SPENDING_CAT_LABELS[cat] || 'Uitgave', amountCents: toCents(amount), cat,
            date: new Date().toISOString()
        });
        saveData();
        document.getElementById('vbSpendName').value = '';
        document.getElementById('vbSpendAmount').value = '';
        updateVrijBudget();
        showToast(`${formatEuro(toCents(amount))} toegevoegd.`);
    }

    function deleteVBSpending(mk, idx) {
        const items = appData.spending[mk];
        if (!items || !items[idx]) return;
        const removed = { ...items[idx] };
        items.splice(idx, 1);
        saveData();
        updateVrijBudget();
        showToast('Verwijderd.', function() {
            if (!appData.spending[mk]) appData.spending[mk] = [];
            appData.spending[mk].splice(idx, 0, removed);
            saveData();
            updateVrijBudget();
        });
    }
    // ═══════════════════════════════════════════════════════════════
    // OVERZICHT (Periode)
    // ═══════════════════════════════════════════════════════════════
    let viewedMonthKey = null;

    function updateOverzicht() {
        try {
            const activeMK = getActiveMonthKey();
            if (!viewedMonthKey) viewedMonthKey = activeMK;

            // i18n section titles
            const s = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
            s('ovDailyTitle', t('dailySpending'));
            s('ovDistTitle', t('distribution'));
            s('ovCalTitle', t('calendar'));
            s('ovSavingsLabel', t('savingsBalance'));
            s('ovAvgLabel', t('avgPerDay'));

            renderPeriodStrip(viewedMonthKey);
            renderOvStats(viewedMonthKey);
            renderOvDailyChart(viewedMonthKey);
            renderOvDonut(viewedMonthKey);
            renderOvCalendar(viewedMonthKey);
        } catch(e) { console.error('Overzicht error:', e); }
    }

    function renderOvStats(mk) {
        const period = getPeriodInfo(mk);
        const today = startOfDay(getNLDate());
        const budget = appData.dailyGroceryBudget || 3500;

        ensureIncomeForMonth(mk);
        const incomeCents = calculateIncomeTotalCents(mk);
        const fixedCents = calculateFixedCostsTotalCents(mk);
        const autoSave = getAutoSaveForMonthCents(mk);
        const daysInPeriod = Math.round((period.endDate - period.startDate) / (1000*60*60*24)) + 1;
        const grocSpent = calculateMonthGroceriesCents(mk);
        const freeSpent = calculateMonthSpendingCents(mk);
        const freeBudget = getFreeBudgetCents(mk);
        const daysPassed = Math.max(1, Math.min(daysInPeriod, Math.round((today - startOfDay(period.startDate)) / (1000*60*60*24)) + 1));
        const dailyAvg = daysPassed > 0 ? Math.round(grocSpent / daysPassed) : 0;

        // Savings
        const savEl = document.getElementById('ovSavingsAmount');
        if (savEl) savEl.textContent = formatEuro(calculateRealtimeSavingsCents());
        const avgEl = document.getElementById('ovDailyAvg');
        if (avgEl) {
            avgEl.textContent = formatEuro(dailyAvg);
            avgEl.style.color = dailyAvg <= budget ? 'var(--green)' : 'var(--red)';
        }

        // Stats
        const statsEl = document.getElementById('ovStatsRows');
        const titleEl = document.getElementById('ovStatsTitle');
        if (titleEl) titleEl.textContent = period.name || mk;
        if (statsEl) {
            const grocBudgetTotal = budget * daysInPeriod;
            const grocSaved = grocBudgetTotal - grocSpent;
            statsEl.innerHTML = `
                <div class="summary-row"><span class="summary-label">${t('income')}</span><span class="summary-value" style="color:var(--green)">${formatEuro(incomeCents)}</span></div>
                <div class="summary-row"><span class="summary-label">${t('fixedCosts')}</span><span class="summary-value" style="color:var(--red)">−${formatEuro(fixedCents)}</span></div>
                <div class="summary-row"><span class="summary-label">${t('autoSave')}</span><span class="summary-value" style="color:var(--red)">−${formatEuro(autoSave)}</span></div>
                <div class="summary-row"><span class="summary-label">${t('dailyBudget')} (${daysInPeriod}d × ${formatEuro(budget)})</span><span class="summary-value" style="color:var(--red)">−${formatEuro(grocBudgetTotal)}</span></div>
                <hr class="summary-divider">
                <div class="summary-row summary-total"><span class="summary-label">${t('freeToSpend')}</span><span class="summary-value" style="color:${freeBudget >= 0 ? 'var(--green)' : 'var(--red)'}">${formatEuro(freeBudget)}</span></div>
                <hr class="summary-divider">
                <div style="font-size:0.78rem;font-weight:600;color:var(--text-tertiary);margin:var(--space-sm) 0 var(--space-xs)">${t('actual')}</div>
                <div class="summary-row"><span class="summary-label">${t('dailySpending')}</span><span class="summary-value" style="color:var(--red)">−${formatEuro(grocSpent)}</span></div>
                <div class="summary-row"><span class="summary-label">${t('dailySaved')}</span><span class="summary-value" style="color:${grocSaved >= 0 ? 'var(--green)' : 'var(--red)'}">${grocSaved >= 0 ? '+' : ''}${formatEuro(grocSaved)}</span></div>
                <div class="summary-row"><span class="summary-label">${t('freeSpent')}</span><span class="summary-value" style="color:var(--red)">−${formatEuro(freeSpent)}</span></div>
                <div class="summary-row"><span class="summary-label">${t('freeRemaining')}</span><span class="summary-value" style="color:${(freeBudget - freeSpent) >= 0 ? 'var(--green)' : 'var(--red)'}">${formatEuro(freeBudget - freeSpent)}</span></div>
            `;
        }
    }

    function renderOvDailyChart(mk) {
        const el = document.getElementById('ovDailyChart');
        if (!el) return;
        const period = getPeriodInfo(mk);
        const budget = appData.dailyGroceryBudget || 3500;
        const today = startOfDay(getNLDate());
        const daysInPeriod = Math.round((period.endDate - period.startDate) / (1000*60*60*24)) + 1;
        const maxDays = Math.min(daysInPeriod, 31);

        let bars = [];
        let maxAmount = budget;
        for (let d = 0; d < maxDays; d++) {
            const day = new Date(period.startDate);
            day.setDate(day.getDate() + d);
            if (startOfDay(day) > today) break;
            const dateStr = formatDate(day);
            const entries = appData.groceries[mk]?.[dateStr] || [];
            const total = entries.reduce((s, e) => s + (Number(e.amountCents) || 0), 0);
            maxAmount = Math.max(maxAmount, total);
            bars.push({ day: day.getDate(), total, dateStr, isToday: startOfDay(day).getTime() === today.getTime() });
        }

        if (bars.length === 0) { el.innerHTML = '<div class="empty-state">Nog geen data.</div>'; return; }

        const barW = Math.max(14, Math.min(28, Math.floor(280 / bars.length)));
        const gap = 3;
        const chartH = 80;
        const svgW = bars.length * (barW + gap);
        const scale = maxAmount > 0 ? (chartH - 4) / maxAmount : 1;
        const budgetY = chartH - (budget * scale);

        let svg = `<svg width="${svgW}" height="${chartH + 20}" viewBox="0 0 ${svgW} ${chartH + 20}" style="display:block">`;
        // Budget line
        svg += `<line x1="0" y1="${budgetY}" x2="${svgW}" y2="${budgetY}" stroke="var(--accent)" stroke-width="1" stroke-dasharray="4 3" opacity="0.5"/>`;
        bars.forEach((b, i) => {
            const x = i * (barW + gap);
            const h = Math.max(2, b.total * scale);
            const y = chartH - h;
            const fill = b.total > budget ? 'var(--red)' : b.isToday ? 'var(--accent)' : 'var(--green)';
            svg += `<rect x="${x}" y="${y}" width="${barW}" height="${h}" rx="3" fill="${fill}" opacity="${b.isToday ? 1 : 0.7}"/>`;
            svg += `<text x="${x + barW/2}" y="${chartH + 14}" text-anchor="middle" fill="var(--text-muted)" font-size="9" font-family="var(--font)">${b.day}</text>`;
        });
        svg += '</svg>';
        el.innerHTML = svg;
    }

    function renderOvDonut(mk) {
        const donutEl = document.getElementById('ovDonut');
        const legendEl = document.getElementById('ovDonutLegend');
        if (!donutEl || !legendEl) return;

        ensureIncomeForMonth(mk);
        const income = calculateIncomeTotalCents(mk);
        if (income <= 0) { donutEl.innerHTML = ''; legendEl.innerHTML = ''; return; }

        const fixed = calculateFixedCostsTotalCents(mk);
        const autoSave = getAutoSaveForMonthCents(mk);
        const p = getPeriodInfo(mk);
        const daysInPeriod = Math.round((p.endDate - p.startDate) / (1000*60*60*24)) + 1;
        const dagBudgetTotal = (appData.dailyGroceryBudget || 3500) * daysInPeriod;
        const grocSpent = calculateMonthGroceriesCents(mk);
        const freeSpent = calculateMonthSpendingCents(mk);
        const freeBudget = getFreeBudgetCents(mk);
        const rest = Math.max(0, income - fixed - autoSave - dagBudgetTotal - freeSpent);

        const segments = [
            { label: t('fixedCosts'), value: fixed, color: '#8b5cf6' },
            { label: t('autoSave'), value: autoSave, color: '#3b82f6' },
            { label: t('dailyBudget'), value: dagBudgetTotal, color: '#22c55e' },
            { label: t('freeSpent'), value: freeSpent, color: '#f59e0b' },
            { label: t('remaining'), value: rest, color: '#2dd4bf' },
        ].filter(s => s.value > 0);

        const total = segments.reduce((s, seg) => s + seg.value, 0);
        const size = 100;
        const cx = size / 2, cy = size / 2, r = 38, sw = 14;
        let svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
        let angle = -90;
        segments.forEach(seg => {
            const pct = seg.value / total;
            const a = pct * 360;
            const startAngle = angle * Math.PI / 180;
            const endAngle = (angle + a) * Math.PI / 180;
            const large = a > 180 ? 1 : 0;
            const x1 = cx + r * Math.cos(startAngle);
            const y1 = cy + r * Math.sin(startAngle);
            const x2 = cx + r * Math.cos(endAngle);
            const y2 = cy + r * Math.sin(endAngle);
            if (a > 0.5) {
                svg += `<path d="M${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2}" fill="none" stroke="${seg.color}" stroke-width="${sw}" stroke-linecap="round"/>`;
            }
            angle += a;
        });
        svg += '</svg>';
        donutEl.innerHTML = svg;

        legendEl.innerHTML = segments.map(s =>
            `<div style="display:flex;align-items:center;gap:6px"><span style="width:10px;height:10px;border-radius:50%;background:${s.color};flex-shrink:0"></span>${s.label}: ${formatEuro(s.value)}</div>`
        ).join('');
    }

    function toggleOvPeriod() { /* legacy no-op */ }

    function selectPeriod(mk) {
        viewedMonthKey = mk;
        closeDayDetail();
        updateOverzicht();
    }

    function renderPeriodStrip(selectedMK) {
        const strip = document.getElementById('periodStrip');
        if (!strip) return;
        const today = startOfDay(getNLDate());
        const activeMK = getActiveMonthKey();

        const available = salaryPeriods.filter(p => startOfDay(p.startDate) <= today);
        strip.innerHTML = available.map(p => {
            const isActive = p.key === activeMK;
            const isSelected = p.key === selectedMK;
            const startStr = formatDateNL(p.startDate);
            const endStr = formatDateNL(p.endDate);
            return `<button class="period-chip${isSelected ? ' active' : ''}" onclick="selectPeriod('${p.key}')">
                ${startStr} – ${endStr}${isActive ? '<span class="period-chip-sub">Huidige periode</span>' : ''}
            </button>`;
        }).reverse().join('');

        requestAnimationFrame(() => {
            const activeChip = strip.querySelector('.period-chip.active');
            if (activeChip) activeChip.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        });
    }



    function renderOvCalendar(mk) {
        const cal = document.getElementById('ovCalendar');
        if (!cal) return;

        const period = getPeriodInfo(mk);
        const pStart = startOfDay(period.startDate);
        const pEnd = startOfDay(period.endDate);
        const today = startOfDay(getNLDate());
        const budget = appData.dailyGroceryBudget || 3500;

        const headers = ['ma','di','wo','do','vr','za','zo'];
        let html = headers.map(h => `<div class="cal-header">${h}</div>`).join('');

        let dow = pStart.getDay();
        dow = dow === 0 ? 6 : dow - 1;
        for (let i = 0; i < dow; i++) html += '<div class="cal-day"></div>';

        const d = new Date(pStart);
        while (d <= pEnd) {
            const dStr = formatDate(d);
            const isToday = d.getTime() === today.getTime();
            const isFuture = d > today;
            const entries = appData.groceries[mk]?.[dStr] || [];
            const hasEntries = entries.length > 0;
            const dayTotal = entries.reduce((s, e) => s + (Number(e.amountCents) || 0), 0);

            let dotClass = 'cal-dot';
            if (isFuture) dotClass += ' empty';
            else if (hasEntries) dotClass += dayTotal <= budget ? ' green' : ' caution';

            const dayClass = 'cal-day' + (isToday ? ' today' : '');
            html += `<div class="${dayClass}" onclick="openDayDetail('${dStr}','${mk}')"><div class="${dotClass}"></div></div>`;
            d.setDate(d.getDate() + 1);
        }

        cal.innerHTML = html;
    }

    let editingOvGrocKey = null;

    function openDayDetail(dateStr, mk) {
        const detail = document.getElementById('ovDayDetail');
        const titleEl = document.getElementById('ovDayTitle');
        const entriesEl = document.getElementById('ovDayEntries');
        if (!detail || !titleEl || !entriesEl) return;

        const date = parseLocalDate(dateStr);
        titleEl.textContent = formatDateNLFull(date);

        const entries = appData.groceries[mk]?.[dateStr] || [];
        const budget = appData.dailyGroceryBudget || 3500;
        const dayTotal = entries.reduce((s, e) => s + (Number(e.amountCents) || 0), 0);
        const diff = budget - dayTotal;

        if (entries.length === 0) {
            entriesEl.innerHTML = `<div class="empty-state" style="padding:var(--space-md) 0">Geen uitgaven op deze dag.</div>`;
        } else {
            let html = `<div style="font-size:0.78rem;color:var(--text-tertiary);margin-bottom:var(--space-sm)">Totaal: ${formatEuro(dayTotal)} van ${formatEuro(budget)} — <span style="color:${diff >= 0 ? 'var(--green)' : 'var(--red)'}">${diff >= 0 ? formatEuro(diff) + ' bespaard' : formatEuro(Math.abs(diff)) + ' over'}</span></div>`;
            html += entries.map((e, i) => {
                const editKey = `${mk}|${dateStr}|${i}`;
                if (editingOvGrocKey === editKey) {
                    return `<div class="tx-item" style="flex-direction:column;gap:var(--space-sm)">
                        <div style="display:flex;gap:var(--space-sm);width:100%">
                            <input type="number" class="grip-input grip-input-sm" id="editOvGrocAmount" value="${fromCents(e.amountCents)}" inputmode="decimal" style="flex:1">
                            <input type="text" class="grip-input grip-input-sm" id="editOvGrocNote" value="${e.note || ''}" placeholder="Notitie" style="flex:2">
                        </div>
                        <div style="display:flex;gap:var(--space-sm);width:100%">
                            <button class="btn-add" onclick="saveEditOvGroc('${mk}','${dateStr}',${i})" style="flex:1">Opslaan</button>
                            <button class="btn-add" onclick="editingOvGrocKey=null;openDayDetail('${dateStr}','${mk}')" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                        </div>
                    </div>`;
                }
                return `<div class="tx-item">
                    <div class="tx-info">
                        <div class="tx-note">${e.note || 'Uitgave'}</div>
                        <div class="tx-time">${getTimeStr(e.timestamp)}</div>
                    </div>
                    <div class="tx-amount">-${formatEuro(e.amountCents)}</div>
                    <button class="tx-delete" onclick="editingOvGrocKey='${editKey}';openDayDetail('${dateStr}','${mk}')" title="Bewerken">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </button>
                </div>`;
            }).join('');
            entriesEl.innerHTML = html;
        }
        detail.classList.add('open');
    }

    function saveEditOvGroc(mk, dateStr, idx) {
        const entry = appData.groceries[mk]?.[dateStr]?.[idx];
        if (!entry) return;
        entry.amountCents = toCents(parseFloat(document.getElementById('editOvGrocAmount')?.value) || 0);
        entry.note = document.getElementById('editOvGrocNote')?.value?.trim() || '';
        saveData();
        editingOvGrocKey = null;
        updateOverzicht();
        openDayDetail(dateStr, mk);
        showToast('Aangepast.');
    }

    function closeDayDetail() {
        document.getElementById('ovDayDetail')?.classList.remove('open');
    }

    function deleteGroceryOv(mk, dateStr, idx) {
        const entries = appData.groceries[mk]?.[dateStr];
        if (!entries || !entries[idx]) return;
        const removed = { ...entries[idx] };
        entries.splice(idx, 1);
        if (entries.length === 0) delete appData.groceries[mk][dateStr];
        saveData();
        updateOverzicht();
        openDayDetail(dateStr, mk);
        showToast('Verwijderd.', function() {
            if (!appData.groceries[mk]) appData.groceries[mk] = {};
            if (!appData.groceries[mk][dateStr]) appData.groceries[mk][dateStr] = [];
            appData.groceries[mk][dateStr].splice(idx, 0, removed);
            saveData();
            updateOverzicht();
            openDayDetail(dateStr, mk);
        });
    }

    const SPENDING_CAT_LABELS = {
        kleding: 'Kleding', elektronica: 'Elektronica', horeca: 'Uit eten/drinken',
        cadeaus: 'Cadeaus', gezondheid: 'Gezondheid', hobby: 'Hobby',
        vakantie: 'Vakantie', huishouden: 'Huishouden', auto: 'Auto/vervoer', overig_vrij: 'Overig'
    };

    function showCustomDateRange() {
        const startStr = document.getElementById('ovCustomStart')?.value;
        const endStr = document.getElementById('ovCustomEnd')?.value;
        const resultEl = document.getElementById('ovCustomResult');
        if (!startStr || !endStr || !resultEl) { showToast('Kies een start- en einddatum.'); return; }
        const start = parseLocalDate(startStr);
        const end = parseLocalDate(endStr);
        if (end < start) { showToast('Einddatum moet na startdatum liggen.'); return; }

        // Calculate totals across the date range
        let grocTotal = 0, spendTotal = 0, daysCount = 0;
        const budget = appData.dailyGroceryBudget || 3500;
        const d = new Date(start);
        while (d <= end) {
            daysCount++;
            const dStr = formatDate(d);
            // Check all periods for this date
            for (const period of salaryPeriods) {
                const entries = appData.groceries[period.key]?.[dStr] || [];
                grocTotal += entries.reduce((s, e) => s + (Number(e.amountCents) || 0), 0);
            }
            d.setDate(d.getDate() + 1);
        }
        // Spending per period that overlaps
        for (const period of salaryPeriods) {
            const pStart = startOfDay(period.startDate);
            const pEnd = startOfDay(period.endDate);
            if (pEnd < start || pStart > end) continue;
            spendTotal += calculateMonthSpendingCents(period.key);
        }

        const dailyBudgetTotal = budget * daysCount;
        const grocSaved = dailyBudgetTotal - grocTotal;

        resultEl.innerHTML = `
            <div style="background:var(--glass);border-radius:var(--radius-md);padding:var(--space-lg)">
                <div style="font-size:0.82rem;font-weight:700;margin-bottom:var(--space-sm)">${formatDateNL(start)} – ${formatDateNL(end)} (${daysCount} dagen)</div>
                <div class="summary-row"><span class="summary-label">Dagbudget totaal</span><span class="summary-value">${formatEuro(dailyBudgetTotal)}</span></div>
                <div class="summary-row"><span class="summary-label">Dagelijks uitgegeven</span><span class="summary-value">-${formatEuro(grocTotal)}</span></div>
                <div class="summary-row"><span class="summary-label">Dagelijks bespaard</span><span class="summary-value" style="color:${grocSaved >= 0 ? 'var(--green)' : 'var(--red)'}">${formatEuro(grocSaved)}</span></div>
                <hr class="summary-divider">
                <div class="summary-row"><span class="summary-label">Vrij budget uitgegeven</span><span class="summary-value">-${formatEuro(spendTotal)}</span></div>
            </div>
        `;
    }

    // ═══════════════════════════════════════════════════════════════
    // SPAREN
    // ═══════════════════════════════════════════════════════════════
    function updateSparen() {
        try {
            const activeMK = getActiveMonthKey();
            const realtimeTotal = calculateRealtimeSavingsCents();
            const periodStart = calculateSavingsAtPeriodStartCents(activeMK);
            const periodChange = realtimeTotal - periodStart;

            // i18n labels
            const s = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
            s('sparenViewTitle', t('savingsRace'));
            s('spCardLabel', t('myBalance'));
            s('spMilestonesTitle', t('milestones'));
            s('spBreakdownTitle', t('thisPeriod'));
            s('spCollapseLabel', t('howGripCalc'));
            s('spCorrTitle', t('correctBalanceTitle'));
            s('spCorrExplain', t('correctBalanceExplain'));
            s('spCorrBtn', t('correct'));
            s('spNoGoalText', t('noGoalSet'));
            s('spNoGoalBtn', t('setGoal'));

            // Primary card
            const spTotalEl = document.getElementById('spSavingsTotal');
            spTotalEl.textContent = formatEuro(realtimeTotal);
            spTotalEl.style.color = realtimeTotal < 0 ? 'var(--red)' : '';
            const changeEl = document.getElementById('spSavingsChange');
            const sign = periodChange >= 0 ? '+' : '';
            changeEl.textContent = `${sign}${formatEuro(periodChange)} ${t('thisPeriod').toLowerCase()}`;
            changeEl.style.color = periodChange >= 0 ? 'var(--green)' : 'var(--red)';

            // Has goal?
            const hasGoal = appData.savingsGoalCents && appData.savingsGoalCents > 0;
            const goalReached = hasGoal && realtimeTotal >= appData.savingsGoalCents;

            document.getElementById('spGoalSection').classList.toggle('hidden', !hasGoal || goalReached);
            document.getElementById('spGoalReached').classList.toggle('hidden', !goalReached);
            document.getElementById('spNoGoal').classList.toggle('hidden', hasGoal);

            if (goalReached) {
                s('goalReachedTitle', t('goalReached'));
                s('goalReachedSub', t('goalReachedSub'));
                s('goalReachedNewBtn', t('setNewGoal'));
                s('goalReachedKeep', t('keepGoing'));
                const amtEl = document.getElementById('goalReachedAmount');
                if (amtEl) amtEl.textContent = `${formatEuro(realtimeTotal)} / ${formatEuro(appData.savingsGoalCents)}`;
            } else if (hasGoal) {
                renderSpaarRing(realtimeTotal);
                renderPrediction();
                renderMilestones();
            }

            renderSpBreakdown(activeMK);

        } catch(e) { console.error('Sparen error:', e); }
    }

    function renderSpaarRing(currentCents) {
        const goalCents = appData.savingsGoalCents || 1;
        const pct = Math.min(100, Math.max(0, Math.round((currentCents / goalCents) * 100)));
        const circumference = 2 * Math.PI * 68;

        const ringFill = document.getElementById('spRingFill');
        const ringPct = document.getElementById('spRingPct');
        const ringLabel = document.getElementById('spRingLabel');

        if (ringFill) {
            const offset = circumference - (pct / 100) * circumference;
            ringFill.style.strokeDasharray = circumference;
            ringFill.style.strokeDashoffset = offset;
        }
        if (ringPct) ringPct.textContent = pct + '%';
        if (ringLabel) ringLabel.textContent = `van ${formatEuro(goalCents)}`;
    }

    function calculateSavingsPrediction() {
        const currentCents = calculateRealtimeSavingsCents();
        const goalCents = appData.savingsGoalCents;
        if (!goalCents || goalCents <= 0) return null;
        if (currentCents >= goalCents) return { reached: true, currentCents, goalCents };

        const remainingCents = goalCents - currentCents;
        const today = startOfDay(getNLDate());

        const monthlyData = [];
        for (let i = 0; i < salaryPeriods.length; i++) {
            const p = salaryPeriods[i];
            const pEnd = startOfDay(p.endDate);
            if (pEnd >= today) continue;
            let mSav = 0;
            if (p.salaryDate) mSav += (appData.autoSaveCents || 0);
            mSav += calculateMonthGrocerySavingsCents(p.key);
            mSav += (getFreeBudgetCents(p.key) - calculateMonthSpendingCents(p.key));
            const days = Math.round((pEnd - startOfDay(p.startDate)) / (1000*60*60*24)) + 1;
            monthlyData.push({ key: p.key, savings: mSav, days });
        }

        const activeMK = getActiveMonthKey();
        const activePeriod = getPeriodInfo(activeMK);
        const pStart = startOfDay(activePeriod.startDate);
        const pEnd = startOfDay(activePeriod.endDate);
        const totalDays = Math.round((pEnd - pStart) / (1000*60*60*24)) + 1;
        const elapsedDays = Math.max(1, Math.round((today - pStart) / (1000*60*60*24)) + 1);

        let curSav = 0;
        if (activePeriod.salaryDate) curSav += (appData.autoSaveCents || 0);
        curSav += calculateMonthGrocerySavingsCents(activeMK);
        curSav += (getFreeBudgetCents(activeMK) - calculateMonthSpendingCents(activeMK));
        const extrapolated = Math.round(curSav * (totalDays / elapsedDays));

        let avgMonthlySavings = 0;
        if (monthlyData.length === 0) {
            avgMonthlySavings = elapsedDays >= 3 ? extrapolated : (appData.autoSaveCents || 0) + Math.round(getFreeBudgetCents(activeMK) * 0.5);
        } else {
            let totalWeight = 0, weightedSum = 0;
            const all = [...monthlyData];
            if (elapsedDays >= 5) all.push({ key: activeMK, savings: extrapolated, days: totalDays });
            all.forEach((m, i) => {
                const weight = Math.pow(1.5, i);
                weightedSum += m.savings * weight;
                totalWeight += weight;
            });
            avgMonthlySavings = Math.round(weightedSum / totalWeight);
        }

        if (avgMonthlySavings <= 0) {
            return { reachable: false, currentCents, goalCents, remainingCents, avgMonthlySavings: 0, monthlyData };
        }

        const monthsNeeded = remainingCents / avgMonthlySavings;
        const estimatedDate = new Date(today);
        estimatedDate.setDate(estimatedDate.getDate() + Math.ceil(monthsNeeded * 30.44));

        const pctNow = Math.round((currentCents / goalCents) * 100);
        const milestones = [];
        [25, 50, 75, 100].forEach(pct => {
            const targetCents = Math.round(goalCents * pct / 100);
            if (targetCents <= currentCents) {
                milestones.push({ pct, reached: true, date: null });
            } else {
                const needed = targetCents - currentCents;
                const months = needed / avgMonthlySavings;
                const d = new Date(today);
                d.setDate(d.getDate() + Math.ceil(months * 30.44));
                milestones.push({ pct, reached: false, date: d });
            }
        });

        let confidence = 'laag';
        if (monthlyData.length >= 3) confidence = 'hoog';
        else if (monthlyData.length >= 1 || elapsedDays >= 14) confidence = 'gemiddeld';

        return { reachable: true, currentCents, goalCents, remainingCents, avgMonthlySavings, estimatedDate, monthsNeeded: Math.ceil(monthsNeeded), milestones, pctNow, confidence, dataPoints: monthlyData.length + (elapsedDays >= 5 ? 1 : 0) };
    }

    function renderPrediction() {
        const el = document.getElementById('spPrediction');
        if (!el) return;
        const pred = calculateSavingsPrediction();

        if (!pred) { el.innerHTML = ''; return; }

        if (pred.reached) {
            el.innerHTML = ''; // Goal reached UI handled by updateSparen celebration card
            return;
        }

        if (!pred.reachable) {
            el.innerHTML = `<div class="pred-sub">${t('spendingOverBudget')}</div>`;
            return;
        }

        const dateStr = tMonth(pred.estimatedDate.getMonth()).toLowerCase() + ' ' + pred.estimatedDate.getFullYear();

        const confColors = { hoog: 'var(--green)', gemiddeld: 'var(--accent)', laag: 'var(--text-tertiary)' };
        const confLabels = { hoog: t('highConf'), gemiddeld: t('medConf'), laag: t('lowConf') };

        el.innerHTML = `
            <div class="pred-date">${t('estimated')}: ${dateStr}</div>
            <div class="pred-sub">~${formatEuro(pred.avgMonthlySavings)} ${t('perMonthAvg')}</div>
            <div class="pred-confidence" style="color:${confColors[pred.confidence]}">● ${confLabels[pred.confidence]}</div>
        `;
    }

    function renderMilestones() {
        const el = document.getElementById('spMilestones');
        const card = document.getElementById('spMilestonesCard');
        if (!el || !card) return;

        const pred = calculateSavingsPrediction();
        if (!pred || !pred.milestones) { card.classList.add('hidden'); return; }
        card.classList.remove('hidden');

        const months = MONTH_NAMES_NL;
        el.innerHTML = pred.milestones.map(m => {
            if (m.reached) {
                return `<div class="milestone-item">
                    <div class="milestone-pct">${m.pct}%</div>
                    <div class="milestone-status">Behaald</div>
                    <div class="milestone-check">✓</div>
                </div>`;
            } else if (m.date) {
                const dateStr = months[m.date.getMonth()].toLowerCase() + ' ' + m.date.getFullYear();
                return `<div class="milestone-item">
                    <div class="milestone-pct">${m.pct}%</div>
                    <div class="milestone-status">${dateStr}</div>
                </div>`;
            }
            return '';
        }).join('');
    }

    function renderSpBreakdown(mk) {
        const el = document.getElementById('spBreakdown');
        if (!el) return;

        const autoSave = getAutoSaveForMonthCents(mk);
        const grocSav = calculateMonthGrocerySavingsCents(mk);
        const freeLeft = getFreeBudgetCents(mk) - calculateMonthSpendingCents(mk);
        const total = autoSave + grocSav + freeLeft;

        el.innerHTML = `
            <div class="breakdown-row"><span class="breakdown-label">Auto-sparen</span><span class="breakdown-value">${formatEuro(autoSave)}</span></div>
            <div class="breakdown-row"><span class="breakdown-label">Dagelijks bespaard</span><span class="breakdown-value" style="color:${grocSav >= 0 ? 'var(--green)' : 'var(--red)'}">${grocSav >= 0 ? '+' : ''}${formatEuro(grocSav)}</span></div>
            <div class="breakdown-row"><span class="breakdown-label">Vrij budget over</span><span class="breakdown-value" style="color:${freeLeft >= 0 ? 'var(--green)' : 'var(--red)'}">${freeLeft >= 0 ? '+' : ''}${formatEuro(freeLeft)}</span></div>
            <hr class="summary-divider">
            <div class="breakdown-row"><span class="breakdown-label" style="font-weight:700;color:var(--text-primary)">Totaal deze periode</span><span class="breakdown-value" style="color:var(--accent)">${formatEuro(total)}</span></div>
        `;
    }

    function toggleCollapse(btn) {
        const isOpen = btn.classList.toggle('open');
        btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        document.getElementById('spCollapseContent')?.classList.toggle('open');
    }

    // ═══════════════════════════════════════════════════════════════
    // PROFIEL
    // ═══════════════════════════════════════════════════════════════
    function updateProfiel() {
        const av = document.getElementById('profAvatar');
        if (av) av.innerHTML = appData.avatarPhoto ? `<img src="${appData.avatarPhoto}">` : getInitialsHTML(appData.userName, 24);
        const n = document.getElementById('profName');
        if (n) n.textContent = appData.userName || 'Gebruiker';
        const s = document.getElementById('profSince');
        if (s) {
            const d = appData.appStartDate ? parseLocalDate(appData.appStartDate) : new Date();
            const months = ['jan','feb','mrt','apr','mei','jun','jul','aug','sep','okt','nov','dec'];
            s.textContent = `Lid sinds ${months[d.getMonth()]} ${d.getFullYear()}`;
        }
        const pi = document.getElementById('prIncome');
        if (pi) pi.textContent = formatEuro(appData.monthlyIncome || 0);
        const pf = document.getElementById('prFixed');
        if (pf) pf.textContent = formatEuro(calculateFixedCostsTotalCents());
        const pb = document.getElementById('prBudget');
        if (pb) pb.textContent = formatEuro(appData.dailyGroceryBudget || 3500);
        const pg = document.getElementById('prGoal');
        if (pg) pg.textContent = appData.savingsGoalCents ? formatEuro(appData.savingsGoalCents) : 'Geen doel';
        const pas = document.getElementById('prAutoSave');
        if (pas) pas.textContent = formatEuro(appData.autoSaveCents || 0) + '/mnd';
        const ps = document.getElementById('prSalary');
        if (ps) ps.textContent = (appData.defaultSalaryDay || 24) + 'e';
        const pn = document.getElementById('prNameVal');
        if (pn) pn.textContent = appData.userName || '';
        const pt = document.getElementById('prTheme');
        if (pt) pt.textContent = appData.theme === 'dark' ? 'Donker' : 'Licht';
        const bt = document.getElementById('biometrieToggle');
        if (bt) bt.classList.toggle('on', !!appData.biometrie);
    }

    function openSub(id) {
        const panel = document.getElementById(id);
        if (!panel) return;
        // Pre-fill fields
        if (id === 'subIncome') {
            document.getElementById('subIncomeVal').value = fromCents(appData.monthlyIncome || 0);
            document.getElementById('subSalaryDay').value = appData.defaultSalaryDay || 24;
        } else if (id === 'subBudget') {
            document.getElementById('subDailyBudget').value = fromCents(appData.dailyGroceryBudget || 3500);
        } else if (id === 'subAutoSave') {
            document.getElementById('subAutoSave2').value = fromCents(appData.autoSaveCents || 0);
        } else if (id === 'subGoal') {
            document.getElementById('subCurrentSavings').textContent = formatEuro(calculateRealtimeSavingsCents());
            document.getElementById('subStartSavings').value = fromCents(appData.startSavingsCents || 0);
            document.getElementById('subSavingsGoal').value = appData.savingsGoalCents ? fromCents(appData.savingsGoalCents) : '';
        } else if (id === 'subPersonal') {
            document.getElementById('subUserName').value = appData.userName || '';
            renderAvatarGrid();
            const tt = document.getElementById('themeToggle');
            if (tt) tt.classList.toggle('on', appData.theme === 'dark');
        } else if (id === 'subFixed') {
            renderFixedCostsList();
        } else if (id === 'subSecurity') {
            initSecurityPanel();
        } else if (id === 'subData') {
            document.getElementById('confirmWipe').value = '';
            document.getElementById('btnWipe').disabled = true;
        }
        panel.classList.add('open');
    }

    function closeSub(id) {
        document.getElementById(id)?.classList.remove('open');
        updateProfiel();
    }

    function saveSubIncome() {
        const inc = parseFloat(document.getElementById('subIncomeVal').value) || 0;
        const day = parseInt(document.getElementById('subSalaryDay').value) || 24;
        appData.monthlyIncome = toCents(inc);
        appData.defaultSalaryDay = Math.max(1, Math.min(31, day));
        // Save salary date overrides
        saveSalaryOverrides();
        generateSalaryPeriods();
        saveData(); closeSub('subIncome'); showToast('Opgeslagen.');
    }

    function toggleSalaryOverrides(btn) {
        const isOpen = btn.classList.toggle('open');
        btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        const content = document.getElementById('salaryOverrideContent');
        if (content) {
            content.classList.toggle('open');
            if (isOpen) renderSalaryOverrideGrid();
        }
    }

    function renderSalaryOverrideGrid() {
        const grid = document.getElementById('salaryOverrideGrid');
        if (!grid) return;
        const today = new Date();
        const months = MONTH_NAMES_NL;
        const overrides = appData.salaryDates || {};
        let html = '';
        for (let i = 0; i < 12; i++) {
            // Show months starting from current month - 1, up to +11
            const mIdx = (today.getMonth() - 1 + i + 12) % 12;
            const yr = today.getFullYear() + (today.getMonth() - 1 + i < 0 ? -1 : (today.getMonth() - 1 + i >= 12 ? 1 : 0));
            const key = `${yr}-${String(mIdx + 1).padStart(2, '0')}`;
            const val = overrides[key] || '';
            html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--glass-border)">
                <span style="font-size:0.82rem;min-width:80px">${months[mIdx].substring(0, 3)} ${yr}</span>
                <input type="number" class="grip-input grip-input-sm" data-salkey="${key}" value="${val}" min="1" max="31" inputmode="numeric" placeholder="${appData.defaultSalaryDay || 24}" style="width:64px;text-align:center;flex:none">
            </div>`;
        }
        grid.innerHTML = html;
    }

    function saveSalaryOverrides() {
        const inputs = document.querySelectorAll('#salaryOverrideGrid input[data-salkey]');
        if (!inputs.length) return;
        if (!appData.salaryDates) appData.salaryDates = {};
        inputs.forEach(inp => {
            const key = inp.dataset.salkey;
            const val = parseInt(inp.value);
            if (val && val >= 1 && val <= 31) {
                appData.salaryDates[key] = val;
            } else {
                delete appData.salaryDates[key];
            }
        });
    }

    function saveSubBudget() {
        const db = parseFloat(document.getElementById('subDailyBudget').value) || 35;
        appData.dailyGroceryBudget = toCents(db);
        saveData(); closeSub('subBudget'); showToast('Opgeslagen.');
    }

    function saveSubAutoSave() {
        const as = parseFloat(document.getElementById('subAutoSave2').value) || 0;
        appData.autoSaveCents = toCents(as);
        saveData(); closeSub('subAutoSave'); showToast('Opgeslagen. Geldt vanaf deze periode.');
    }

    function saveSubGoal() {
        const start = parseFloat(document.getElementById('subStartSavings').value) || 0;
        const goal = parseFloat(document.getElementById('subSavingsGoal').value) || 0;
        appData.startSavingsCents = toCents(start);
        appData.savingsGoalCents = goal > 0 ? toCents(goal) : 0;
        saveData(); closeSub('subGoal'); showToast('Opgeslagen.');
    }

    function applySavingsCorrection() {
        const inputEl = document.getElementById('spCorrectionVal') || document.getElementById('subSavingsCorrection');
        const desiredTotal = parseFloat(inputEl?.value);
        if (isNaN(desiredTotal)) { showToast(t('enterAmount')); return; }
        const desiredCents = toCents(desiredTotal);
        const currentCalc = calculateRealtimeSavingsCents();
        const diff = desiredCents - currentCalc;
        appData.startSavingsCents = (appData.startSavingsCents || 0) + diff;
        if (!appData.savingsCorrections) appData.savingsCorrections = [];
        appData.savingsCorrections.push({
            date: new Date().toISOString(),
            fromCents: currentCalc,
            toCents: desiredCents,
            adjustmentCents: diff
        });
        saveData();
        if (inputEl) inputEl.value = '';
        // Refresh all views that show savings
        updateSparen();
        try { renderSavingsCompact(getActiveMonthKey()); } catch(e) {}
        try { updateDagSparen(); } catch(e) {}
        showToast(`${t('adjusted')} ${formatEuro(desiredCents)}`);
    }

    function saveSubPersonal() {
        const name = document.getElementById('subUserName').value.trim();
        if (name) appData.userName = name;
        saveData(); closeSub('subPersonal'); showToast('Opgeslagen.');
    }

    function renderAvatarGrid() {
        const grid = document.getElementById('subAvatarGrid');
        if (!grid) return;
        const preview = appData.avatarPhoto
            ? `<img src="${appData.avatarPhoto}">`
            : getInitialsHTML(appData.userName, 24);
        grid.innerHTML = `
            <div class="avatar-upload-area">
                <div class="avatar-preview">${preview}</div>
                <div class="avatar-upload-info">
                    <div style="font-size:0.85rem;font-weight:600;margin-bottom:var(--space-xs)">${appData.avatarPhoto ? 'Foto ingesteld' : 'Initialen als avatar'}</div>
                    <div class="field-helper" style="margin:0">Upload een foto (max 5 MB) of gebruik je initialen.</div>
                    <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-md)">
                        <button class="avatar-upload-btn" onclick="document.getElementById('avatarFileInput').click()">Foto kiezen</button>
                        ${appData.avatarPhoto ? '<button class="avatar-upload-btn" onclick="removeAvatarPhoto()" style="color:var(--caution)">Verwijderen</button>' : ''}
                    </div>
                    <input type="file" id="avatarFileInput" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
                </div>
            </div>
        `;
    }

    function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (file.size > 5 * 1024 * 1024) {
            showToast('Bestand te groot. Maximaal 5 MB.');
            return;
        }
        if (!file.type.startsWith('image/')) {
            showToast('Alleen afbeeldingen zijn toegestaan.');
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            // Resize to max 256px to keep localStorage small
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const max = 256;
                let w = img.width, h = img.height;
                if (w > max || h > max) {
                    if (w > h) { h = Math.round(h * max / w); w = max; }
                    else { w = Math.round(w * max / h); h = max; }
                }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                appData.avatarPhoto = canvas.toDataURL('image/jpeg', 0.8);
                saveData();
                renderAvatarGrid();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function removeAvatarPhoto() {
        appData.avatarPhoto = '';
        saveData();
        renderAvatarGrid();
    }

    function selectAvatar() { /* Legacy no-op */ }

    function toggleTheme() {
        appData.theme = appData.theme === 'dark' ? 'light' : 'dark';
        applyTheme(); saveData();
        document.getElementById('themeToggle')?.classList.toggle('on', appData.theme === 'dark');
    }

    function toggleBiometrie() {
        appData.biometrie = !appData.biometrie;
        saveData();
        document.getElementById('biometrieToggle')?.classList.toggle('on', !!appData.biometrie);
        showToast(appData.biometrie ? 'Biometrie ingeschakeld.' : 'Biometrie uitgeschakeld.');
    }

    function renderFixedCostsList() {
        const el = document.getElementById('subFixedList');
        if (!el) return;
        ensureFixedCostsIds();
        let html = '';
        let total = 0;
        Object.keys(CAT_LABELS).forEach(cat => {
            const items = appData.fixedCosts[cat] || [];
            if (items.length === 0) return;
            html += `<div class="fc-cat-title">${CAT_LABELS[cat]}</div>`;
            items.forEach(item => {
                total += Number(item.amountCents) || 0;
                const isEditing = editingFixedCostId === item.id;
                if (isEditing) {
                    html += `<div class="fc-item" style="flex-direction:column;gap:var(--space-sm)">
                        <div style="display:flex;gap:var(--space-sm);width:100%">
                            <input type="text" class="grip-input grip-input-sm" id="editFcName" value="${item.name}" style="flex:2">
                            <input type="number" class="grip-input grip-input-sm" id="editFcAmount" value="${fromCents(item.amountCents)}" inputmode="decimal" style="flex:1">
                        </div>
                        <div style="display:flex;gap:var(--space-sm);width:100%">
                            <button class="btn-add" onclick="saveEditFixedCost('${cat}','${item.id}')" style="flex:1">Opslaan</button>
                            <button class="btn-add" onclick="cancelEditFixedCost()" style="flex:1;background:var(--glass);color:var(--text-secondary)">Annuleren</button>
                        </div>
                    </div>`;
                } else {
                    html += `<div class="fc-item">
                        <div class="fc-item-name">${item.name}</div>
                        <div style="display:flex;align-items:center;gap:var(--space-sm)">
                            <span class="fc-item-amount" style="cursor:pointer" onclick="startEditFixedCost('${item.id}')" title="Tik om te bewerken">${formatEuro(item.amountCents)}</span>
                            <button class="tx-delete" onclick="startEditFixedCost('${item.id}')" title="Bewerken" aria-label="Bewerk ${item.name}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                            <button class="tx-delete" onclick="deleteFixedCost('${cat}','${item.id}')" title="Verwijder" aria-label="Verwijder ${item.name}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>`;
                }
            });
        });
        if (total > 0) html += `<div style="padding:var(--space-md) 0;font-weight:700;text-align:right;font-variant-numeric:var(--tabular)">Totaal: ${formatEuro(total)}/maand</div>`;
        if (!html) html = '<div class="empty-state">Nog geen vaste lasten.</div>';
        el.innerHTML = html;
    }

    let editingFixedCostId = null;

    function startEditFixedCost(id) {
        editingFixedCostId = id;
        renderFixedCostsList();
    }

    function cancelEditFixedCost() {
        editingFixedCostId = null;
        renderFixedCostsList();
    }

    function saveEditFixedCost(cat, id) {
        const name = document.getElementById('editFcName')?.value?.trim();
        const amount = parseFloat(document.getElementById('editFcAmount')?.value) || 0;
        if (!name || amount <= 0) { showToast('Vul naam en bedrag in.'); return; }
        const items = appData.fixedCosts[cat] || [];
        const item = items.find(x => x.id === id);
        if (item) {
            item.name = name;
            item.amountCents = toCents(amount);
            saveData();
            showToast('Aangepast.');
        }
        editingFixedCostId = null;
        renderFixedCostsList();
    }

    function addFixedCost() {
        const name = document.getElementById('subFcName').value.trim();
        const amount = parseFloat(document.getElementById('subFcAmount').value) || 0;
        const cat = document.getElementById('subFcCat').value || 'overig';
        if (!name || amount <= 0) { showToast('Vul naam en bedrag in.'); return; }
        ensureFixedCostsIds();
        if (!Array.isArray(appData.fixedCosts[cat])) appData.fixedCosts[cat] = [];
        appData.fixedCosts[cat].push({ id: genId('fix'), name, amountCents: toCents(amount) });
        saveData();
        document.getElementById('subFcName').value = '';
        document.getElementById('subFcAmount').value = '';
        renderFixedCostsList();
        showToast('Toegevoegd.');
    }

    function deleteFixedCost(cat, id) {
        const items = appData.fixedCosts[cat] || [];
        const idx = items.findIndex(x => x.id === id);
        if (idx === -1) return;
        const removed = items.splice(idx, 1)[0];
        saveData();
        renderFixedCostsList();
        showToast('Verwijderd.', function() {
            appData.fixedCosts[cat].splice(idx, 0, removed);
            saveData(); renderFixedCostsList();
        });
    }

    // ─── FIXED COST PER-PERIOD OVERRIDES ───
    function toggleFixedOverrides(btn) {
        const isOpen = btn.classList.toggle('open');
        btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        const content = document.getElementById('fixedOverrideContent');
        if (content) {
            content.classList.toggle('open');
            if (isOpen) renderFixedOverrides();
        }
    }

    function renderFixedOverrides() {
        // Populate period selector
        const select = document.getElementById('fcOverridePeriod');
        if (select) {
            select.innerHTML = salaryPeriods.map(p =>
                `<option value="${p.key}">${p.name}</option>`
            ).join('');
            // Default to active period
            const activeMK = getActiveMonthKey();
            select.value = activeMK;
        }
        renderFixedOverrideList();
        // Listen for changes
        select?.addEventListener('change', renderFixedOverrideList);
    }

    function renderFixedOverrideList() {
        const el = document.getElementById('fcOverrideList');
        const mk = document.getElementById('fcOverridePeriod')?.value;
        if (!el || !mk) return;
        if (!appData.fixedCostOverrides) appData.fixedCostOverrides = {};
        const items = appData.fixedCostOverrides[mk] || [];
        if (items.length === 0) {
            el.innerHTML = `<div class="empty-state" style="padding:var(--space-sm) 0;font-size:0.78rem">Geen afwijkingen voor deze periode. Standaard vaste lasten gelden.</div>`;
            return;
        }
        let html = '';
        items.forEach((item, i) => {
            html += `<div class="tx-item">
                <div class="tx-info"><div class="tx-note">${item.name}</div></div>
                <div class="tx-amount">${formatEuro(item.amountCents)}</div>
                <button class="tx-delete" onclick="deleteFixedOverride('${mk}',${i})" title="Verwijder" aria-label="Verwijder afwijking">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
            </div>`;
        });
        const total = items.reduce((s, it) => s + (Number(it.amountCents) || 0), 0);
        html += `<div style="padding:var(--space-xs) 0;font-size:0.78rem;font-weight:700;text-align:right">Afwijking totaal: ${formatEuro(total)}</div>`;
        el.innerHTML = html;
    }

    function addFixedCostOverride() {
        const mk = document.getElementById('fcOverridePeriod')?.value;
        const name = document.getElementById('fcOverrideName')?.value?.trim();
        const amount = parseFloat(document.getElementById('fcOverrideAmount')?.value) || 0;
        if (!mk || !name || amount <= 0) { showToast('Vul periode, naam en bedrag in.'); return; }
        if (!appData.fixedCostOverrides) appData.fixedCostOverrides = {};
        if (!appData.fixedCostOverrides[mk]) appData.fixedCostOverrides[mk] = [];
        appData.fixedCostOverrides[mk].push({ id: genId('fco'), name, amountCents: toCents(amount) });
        saveData();
        document.getElementById('fcOverrideName').value = '';
        document.getElementById('fcOverrideAmount').value = '';
        renderFixedOverrideList();
        showToast('Afwijking toegevoegd voor deze periode.');
    }

    function deleteFixedOverride(mk, idx) {
        if (!appData.fixedCostOverrides?.[mk]) return;
        appData.fixedCostOverrides[mk].splice(idx, 1);
        if (appData.fixedCostOverrides[mk].length === 0) delete appData.fixedCostOverrides[mk];
        saveData();
        renderFixedOverrideList();
        showToast('Afwijking verwijderd.');
    }

    // ─── INCOME PER-PERIOD OVERRIDES ───
    function toggleIncomeOverrides(btn) {
        const isOpen = btn.classList.toggle('open');
        btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        const content = document.getElementById('incomeOverrideContent');
        if (content) {
            content.classList.toggle('open');
            if (isOpen) renderIncomeOverrideGrid();
        }
    }

    function renderIncomeOverrideGrid() {
        const grid = document.getElementById('incomeOverrideGrid');
        if (!grid) return;
        if (!appData.incomeByMonth) appData.incomeByMonth = {};
        const defaultIncome = fromCents(appData.monthlyIncome || 0);
        let html = '';
        salaryPeriods.forEach(p => {
            const override = appData.incomeByMonth[p.key];
            const val = override !== undefined ? fromCents(override) : '';
            html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--glass-border)">
                <span style="font-size:0.82rem;min-width:100px">${p.name}</span>
                <input type="number" class="grip-input grip-input-sm" data-inckey="${p.key}" value="${val}" inputmode="decimal" placeholder="${defaultIncome}" style="width:100px;text-align:center;flex:none">
            </div>`;
        });
        html += `<button class="btn-add" onclick="saveIncomeOverrides()" style="width:100%;margin-top:var(--space-md)">Afwijkingen opslaan</button>`;
        grid.innerHTML = html;
    }

    function saveIncomeOverrides() {
        const inputs = document.querySelectorAll('#incomeOverrideGrid input[data-inckey]');
        if (!inputs.length) return;
        if (!appData.incomeByMonth) appData.incomeByMonth = {};
        inputs.forEach(inp => {
            const key = inp.dataset.inckey;
            const val = parseFloat(inp.value);
            if (!isNaN(val) && val > 0) {
                appData.incomeByMonth[key] = toCents(val);
            } else {
                delete appData.incomeByMonth[key];
            }
        });
        // Re-generate income entries for affected months
        inputs.forEach(inp => {
            const key = inp.dataset.inckey;
            if (appData.income?.[key]) {
                delete appData.income[key]; // Force regeneration
            }
        });
        saveData();
        showToast('Inkomen-afwijkingen opgeslagen.');
    }

    function initSecurityPanel() {
        const el = document.getElementById('securityContent');
        if (!el) return;
        el.innerHTML = `
            <div class="field-group"><div class="field-label">PIN wijzigen</div>
            <div class="field-helper" style="margin-bottom:var(--space-md)">Voer eerst je huidige PIN in.</div>
            <div id="secPinFlow"></div></div>
        `;
        secPinState = 'current';
        secPinValue = '';
        renderSecPinFlow();
    }

    let secPinState = 'current'; // current → new → confirm
    let secPinValue = '';
    let secNewPin = '';

    function renderSecPinFlow() {
        const el = document.getElementById('secPinFlow');
        if (!el) return;
        const labels = { current: 'Huidige PIN', 'new': 'Nieuwe PIN', confirm: 'Bevestig nieuwe PIN' };
        el.innerHTML = `
            <div style="text-align:center;margin-bottom:var(--space-lg)">
                <div style="font-size:0.82rem;color:var(--text-tertiary);margin-bottom:var(--space-md)">${labels[secPinState]}</div>
                <div class="pin-dots" style="justify-content:center">${[0,1,2,3].map(i => `<div class="pin-dot${i < secPinValue.length ? ' filled' : ''}"></div>`).join('')}</div>
                <div class="pin-error" id="secPinError"></div>
            </div>
            <div class="pin-keypad" style="margin:0 auto">${[1,2,3,4,5,6,7,8,9,'⌫',0,''].map(k => {
                if (k === '⌫') return `<button class="pin-key" onclick="secPinKey('del')" style="font-size:1.1rem">&#9003;</button>`;
                if (k === '') return '<div></div>';
                return `<button class="pin-key" onclick="secPinKey('${k}')">${k}</button>`;
            }).join('')}</div>
        `;
    }

    function secPinKey(k) {
        if (k === 'del') { secPinValue = secPinValue.slice(0, -1); renderSecPinFlow(); return; }
        if (secPinValue.length >= 4) return;
        secPinValue += k;
        renderSecPinFlow();
        if (secPinValue.length === 4) {
            setTimeout(() => {
                if (secPinState === 'current') {
                    if (secPinValue === appData.pin) {
                        secPinState = 'new'; secPinValue = ''; renderSecPinFlow();
                    } else {
                        document.getElementById('secPinError').textContent = 'Onjuiste PIN.';
                        document.getElementById('secPinError').classList.add('show');
                        secPinValue = ''; renderSecPinFlow();
                    }
                } else if (secPinState === 'new') {
                    secNewPin = secPinValue; secPinState = 'confirm'; secPinValue = ''; renderSecPinFlow();
                } else if (secPinState === 'confirm') {
                    if (secPinValue === secNewPin) {
                        appData.pin = secNewPin; saveData();
                        showToast('PIN gewijzigd.');
                        closeSub('subSecurity');
                    } else {
                        document.getElementById('secPinError').textContent = 'PINs komen niet overeen.';
                        document.getElementById('secPinError').classList.add('show');
                        secPinState = 'new'; secPinValue = ''; renderSecPinFlow();
                    }
                }
            }, 200);
        }
    }

    function downloadBackup() {
        const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'grip-backup-' + formatDate(new Date()) + '.json';
        a.click(); URL.revokeObjectURL(url);
        showToast('Backup gedownload.');
    }

    function checkWipeConfirm() {
        const val = document.getElementById('confirmWipe')?.value || '';
        document.getElementById('btnWipe').disabled = val !== 'GRIP';
    }

    function wipeData() {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem('budgetAppData_v18b');
        location.reload();
    }

    // ═══════════════════════════════════════════════════════════════
    // ONBOARDING (8 steps)
    // ═══════════════════════════════════════════════════════════════
    const OB_STEPS = 9;
    let obStep = 0;
    let obData = {
        lang: 'nl',
        name:'', pin:'', pinConfirm:'',
        appStartDate: formatDate(new Date()),
        salaryMode: 'fixed',
        salaryDay: 24,
        salaryByMonth: {},
        income: 0, dailyBudget: 35,
        fixedMode: 'total',
        fixedTotal: 0,
        fixedItems: [],
        autoSave: 100, startSavings: 0, savingsGoal: 0
    };
    let obPinPhase = 'choose';

    const MONTH_DAYS = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

    function startOnboarding() {
        obStep = 0;
        obData = {
            lang: currentLang || 'nl',
            name:'', pin:'', pinConfirm:'',
            appStartDate: formatDate(new Date()),
            salaryMode: 'fixed', salaryDay: 24, salaryByMonth: {},
            income: 0, dailyBudget: 35,
            fixedMode: 'total', fixedTotal: 0, fixedItems: [],
            autoSave: 100, startSavings: 0, savingsGoal: 0
        };
        obPinPhase = 'choose';
        document.getElementById('onboarding').classList.remove('hidden');
        renderObStep();
    }

    function renderObStep() {
        const prog = document.getElementById('obProgress');
        prog.innerHTML = Array.from({length: OB_STEPS}, (_, i) =>
            `<div class="ob-progress-dot${i < obStep ? ' done' : ''}${i === obStep ? ' current' : ''}"></div>`
        ).join('');

        document.getElementById('obStepLabel').textContent = `${obStep + 1} / ${OB_STEPS}`;

        const content = document.getElementById('obContent');
        const nav = document.getElementById('obNav');
        const backBtn = `<button class="ob-nav-back" onclick="obBack()">${t('back')}</button>`;
        const nextBtn = `<button class="ob-nav-next" onclick="obNext()">${t('next')}</button>`;

        if (obStep === 0) {
            // LANGUAGE SELECTION
            content.innerHTML = `
                <div class="ob-step-title" style="text-align:center;font-size:1.3rem">${t('chooseLang')}</div>
                <div class="lang-grid">
                    ${Object.entries(LANGS).map(([code, lang]) =>
                        `<div class="lang-tile${obData.lang === code ? ' selected' : ''}" onclick="obData.lang='${code}';currentLang='${code}';renderObStep()">
                            <div class="lang-flag-circle">${lang.svg}</div>
                            <div class="lang-name">${lang.name}</div>
                        </div>`
                    ).join('')}
                </div>
            `;
            nav.innerHTML = nextBtn;

        } else if (obStep === 1) {
            // WELKOM + NAAM
            content.innerHTML = `
                <div class="ob-step-title">${t('welcomeTitle')}</div>
                <div class="ob-step-sub">${t('welcomeSub')}</div>
                <div class="field-group"><div class="field-label">${t('yourName')}</div>
                <input type="text" class="grip-input" id="obName" placeholder="${t('namePlaceholder')}" value="${obData.name}"></div>
            `;
            nav.innerHTML = `${backBtn}${nextBtn}`;
            setTimeout(() => document.getElementById('obName')?.focus(), 100);

        } else if (obStep === 2) {
            // PIN
            const label = obPinPhase === 'choose' ? t('pinChoose') : t('pinConfirm');
            const dots = obPinPhase === 'choose' ? obData.pin : obData.pinConfirm;
            content.innerHTML = `
                <div class="ob-step-title">${t('choosePIN')}</div>
                <div class="ob-step-sub">${t('pinSub')}</div>
                <div style="text-align:center">
                    <div style="font-size:0.82rem;color:var(--text-tertiary);margin-bottom:var(--space-md)">${label}</div>
                    <div class="pin-dots" style="justify-content:center">${[0,1,2,3].map(i => `<div class="pin-dot${i < dots.length ? ' filled' : ''}"></div>`).join('')}</div>
                    <div class="pin-error" id="obPinError"></div>
                </div>
                <div class="pin-keypad" style="margin:var(--space-xl) auto 0">${[1,2,3,4,5,6,7,8,9,'⌫',0,''].map(k => {
                    if (k === '⌫') return `<button class="pin-key" onclick="obPinKey('del')" style="font-size:1.1rem">&#9003;</button>`;
                    if (k === '') return '<div></div>';
                    return `<button class="pin-key" onclick="obPinKey('${k}')">${k}</button>`;
                }).join('')}</div>
            `;
            nav.innerHTML = `${backBtn}<div style="flex:1"></div>`;

        } else if (obStep === 3) {
            // STARTDATUM
            content.innerHTML = `
                <div class="ob-step-title">${t('whenStart')}</div>
                <div class="field-group"><div class="field-label">${t('startDate')}</div>
                <input type="date" class="grip-input" id="obStartDate" value="${obData.appStartDate}">
                <div class="field-helper">${t('startDateHelper')}</div></div>
            `;
            nav.innerHTML = `${backBtn}${nextBtn}`;

        } else if (obStep === 4) {
            // SALARISDAG
            const modeFixed = obData.salaryMode === 'fixed';
            let monthGrid = '';
            if (!modeFixed) {
                const startDate = obData.appStartDate ? parseLocalDate(obData.appStartDate) : new Date();
                const startMonth = startDate.getMonth();
                monthGrid = '<div style="margin-top:var(--space-lg)">';
                for (let m = startMonth; m < 12; m++) {
                    const val = obData.salaryByMonth[m] || '';
                    monthGrid += `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--glass-border)">
                        <span style="font-size:0.82rem;min-width:100px">${tMonth(m)}</span>
                        <input type="number" class="grip-input grip-input-sm" id="obSalMonth${m}" value="${val}" min="1" max="${MONTH_DAYS[m]}" inputmode="numeric" placeholder="dag" style="width:64px;text-align:center;flex:none">
                    </div>`;
                }
                monthGrid += '</div>';
            }
            content.innerHTML = `
                <div class="ob-step-title">${t('whenPaid')}</div>
                <div class="ob-step-sub">${t('salaryDaySub')}</div>
                <div class="field-group">
                    <div style="display:flex;gap:var(--space-sm);margin-bottom:var(--space-lg)">
                        <button class="quick-chip${modeFixed ? ' edit-chip' : ''}" style="flex:1;${modeFixed ? 'background:var(--accent-dim);border-color:var(--accent);color:var(--accent)' : ''}" onclick="obData.salaryMode='fixed';renderObStep()">${t('fixedDay')}</button>
                        <button class="quick-chip${!modeFixed ? ' edit-chip' : ''}" style="flex:1;${!modeFixed ? 'background:var(--accent-dim);border-color:var(--accent);color:var(--accent)' : ''}" onclick="obData.salaryMode='perMonth';renderObStep()">${t('perMonthDay')}</button>
                    </div>
                    ${modeFixed ? `
                        <div class="field-label">${t('salaryDay')}</div>
                        <input type="number" class="grip-input" id="obSalaryDay" value="${obData.salaryDay}" min="1" max="31" inputmode="numeric">
                    ` : `
                        <div class="field-label">${t('salaryDay')} ${t('perMonthDay').toLowerCase()}</div>
                        <div class="field-helper" style="margin-bottom:var(--space-sm)">${t('salaryPerMonthExplain')}</div>
                        ${monthGrid}
                    `}
                </div>
            `;
            nav.innerHTML = `${backBtn}${nextBtn}`;

        } else if (obStep === 5) {
            // FINANCIËLE BASIS
            content.innerHTML = `
                <div class="ob-step-title">${t('financialBase')}</div>
                <div class="ob-step-sub">${t('financialBaseSub')}</div>
                <div class="field-group"><div class="field-label">${t('netIncome')}</div>
                <input type="number" class="grip-input" id="obIncome" value="${obData.income || ''}" inputmode="decimal" placeholder="0,00">
                <div class="field-helper">${t('incomeVariesHint')}</div></div>
                <div class="field-group"><div class="field-label">${t('dailyBudget')}</div>
                <input type="number" class="grip-input" id="obBudget" value="${obData.dailyBudget || 35}" inputmode="decimal">
                <div class="field-helper">${t('dailyBudgetHelper')}</div></div>
            `;
            nav.innerHTML = `${backBtn}${nextBtn}`;

        } else if (obStep === 6) {
            // VASTE LASTEN
            const modeTotal = obData.fixedMode === 'total';
            let catForm = '';
            if (!modeTotal) {
                const catOpts = Object.entries(CAT_LABELS).map(([k,v]) => `<option value="${k}">${getCatLabel(k)}</option>`).join('');
                const existingHtml = obData.fixedItems.map((item, i) =>
                    `<div class="fc-item">
                        <div class="fc-item-name">${item.name || getCatLabel(item.cat)} <span style="color:var(--text-muted);font-size:0.72rem">${getCatLabel(item.cat)}</span></div>
                        <div style="display:flex;align-items:center;gap:var(--space-sm)">
                            <span class="fc-item-amount" style="cursor:pointer" onclick="obEditFixed(${i})">${formatEuro(item.amountCents)}</span>
                            <button class="tx-delete" onclick="obEditFixed(${i})" title="${t('edit')}"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button class="tx-delete" onclick="obRemoveFixed(${i})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        </div>
                    </div>`
                ).join('');
                const total = obData.fixedItems.reduce((s, it) => s + it.amountCents, 0);
                catForm = `
                    <div style="margin-top:var(--space-lg)">
                        ${existingHtml}
                        ${total > 0 ? `<div style="padding:var(--space-sm) 0;font-weight:700;text-align:right;font-variant-numeric:var(--tabular);font-size:0.85rem">${t('total')}: ${formatEuro(total)}</div>` : ''}
                        <div style="margin-top:var(--space-md);padding-top:var(--space-md);border-top:1px solid var(--glass-border)">
                            <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-sm)">
                                <input type="text" class="grip-input grip-input-sm" id="obFcName" placeholder="${t('description')}" style="flex:2">
                                <input type="number" class="grip-input grip-input-sm" id="obFcAmount" inputmode="decimal" placeholder="${t('amount')}" style="flex:1">
                            </div>
                            <select class="grip-input grip-input-sm" id="obFcCat" style="width:100%;margin-top:var(--space-sm)">${catOpts}</select>
                            <button class="btn-add" onclick="obAddFixed()" style="width:100%;margin-top:var(--space-sm)">${t('add')}</button>
                        </div>
                    </div>
                `;
            }
            content.innerHTML = `
                <div class="ob-step-title">${t('fixedCostsTitle')}</div>
                <div class="ob-step-sub">${t('fixedCostsSub2')}</div>
                <div class="field-group">
                    <div style="display:flex;gap:var(--space-sm);margin-bottom:var(--space-lg)">
                        <button class="quick-chip" style="flex:1;${modeTotal ? 'background:var(--accent-dim);border-color:var(--accent);color:var(--accent)' : ''}" onclick="obData.fixedMode='total';renderObStep()">${t('totalAmount')}</button>
                        <button class="quick-chip" style="flex:1;${!modeTotal ? 'background:var(--accent-dim);border-color:var(--accent);color:var(--accent)' : ''}" onclick="obData.fixedMode='detail';renderObStep()">${t('perCategory')}</button>
                    </div>
                    ${modeTotal ? `
                        <div class="field-label">${t('totalAmount')}</div>
                        <input type="number" class="grip-input" id="obFixed" value="${obData.fixedTotal || ''}" inputmode="decimal" placeholder="0,00">
                        <div class="field-helper">${t('fixedCostsAdjustHint')}</div>
                    ` : catForm}
                    ${!modeTotal ? `<div class="field-helper" style="margin-top:var(--space-md)">${t('fixedCostsAdjustHint')}</div>` : ''}
                </div>
            `;
            nav.innerHTML = `${backBtn}${nextBtn}`;

        } else if (obStep === 7) {
            // SPAREN
            content.innerHTML = `
                <div class="ob-step-title">${t('savingsTitle')}</div>
                <div class="ob-step-sub">${t('savingsSub2')}</div>
                <div class="field-group"><div class="field-label">${t('autoSavePerMonth')}</div>
                <input type="number" class="grip-input" id="obAutoSave" value="${obData.autoSave || 100}" inputmode="decimal"></div>
                <div class="field-group"><div class="field-label">${t('currentSavings')}</div>
                <input type="number" class="grip-input" id="obStartSavings" value="${obData.startSavings || ''}" inputmode="decimal" placeholder="0,00">
                <div class="field-helper">${t('howMuchSaved')}</div></div>
                <div class="field-group"><div class="field-label">${t('savingsGoalOpt')}</div>
                <input type="number" class="grip-input" id="obGoal" value="${obData.savingsGoal || ''}" inputmode="decimal" placeholder=""></div>
            `;
            nav.innerHTML = `${backBtn}${nextBtn}`;

        } else if (obStep === 8) {
            // AHA-MOMENT
            renderAhaStep();
            nav.innerHTML = `${backBtn}<button class="ob-nav-next" onclick="obFinish()" style="font-size:1rem">${t('startGrip')}</button>`;
        }
    }

    function obAddFixed() {
        const name = document.getElementById('obFcName')?.value?.trim() || '';
        const amount = parseFloat(document.getElementById('obFcAmount')?.value) || 0;
        const cat = document.getElementById('obFcCat')?.value || 'overig';
        if (amount <= 0) { showToast('Vul een bedrag in.'); return; }
        obData.fixedItems.push({ name: name || CAT_LABELS[cat] || 'Vaste last', amountCents: toCents(amount), cat });
        renderObStep();
    }

    function obEditFixed(idx) {
        const item = obData.fixedItems[idx];
        if (!item) return;
        const newAmount = prompt(`Nieuw bedrag voor "${item.name || 'Vaste last'}" (huidig: ${fromCents(item.amountCents)}):`);
        if (newAmount === null) return;
        const parsed = parseFloat(newAmount.replace(',', '.'));
        if (!isNaN(parsed) && parsed > 0) {
            item.amountCents = toCents(parsed);
            const newName = prompt(`Naam (huidige: "${item.name}"):\n(Druk op OK om te behouden)`, item.name);
            if (newName !== null && newName.trim()) item.name = newName.trim();
            renderObStep();
        } else {
            showToast('Ongeldig bedrag.');
        }
    }

    function obRemoveFixed(idx) {
        obData.fixedItems.splice(idx, 1);
        renderObStep();
    }

    function obPinKey(k) {
        if (obPinPhase === 'choose') {
            if (k === 'del') { obData.pin = obData.pin.slice(0, -1); renderObStep(); return; }
            if (obData.pin.length >= 4) return;
            obData.pin += k;
            renderObStep();
            if (obData.pin.length === 4) {
                setTimeout(() => { obPinPhase = 'confirm'; obData.pinConfirm = ''; renderObStep(); }, 200);
            }
        } else {
            if (k === 'del') { obData.pinConfirm = obData.pinConfirm.slice(0, -1); renderObStep(); return; }
            if (obData.pinConfirm.length >= 4) return;
            obData.pinConfirm += k;
            renderObStep();
            if (obData.pinConfirm.length === 4) {
                setTimeout(() => {
                    if (obData.pin === obData.pinConfirm) {
                        obStep = 3; renderObStep();
                    } else {
                        const err = document.getElementById('obPinError');
                        if (err) { err.textContent = t('pinMismatch'); err.classList.add('show'); }
                        obPinPhase = 'choose'; obData.pin = ''; obData.pinConfirm = '';
                        setTimeout(() => renderObStep(), 1200);
                    }
                }, 200);
            }
        }
    }

    function obNext() {
        if (obStep === 0) {
            // Language — just save
            currentLang = obData.lang;
        } else if (obStep === 1) {
            const name = document.getElementById('obName')?.value?.trim();
            if (!name) { showToast(t('enterName')); return; }
            obData.name = name;
        } else if (obStep === 3) {
            const dateVal = document.getElementById('obStartDate')?.value;
            if (dateVal) obData.appStartDate = dateVal;
        } else if (obStep === 4) {
            if (obData.salaryMode === 'fixed') {
                obData.salaryDay = Math.max(1, Math.min(31, parseInt(document.getElementById('obSalaryDay')?.value) || 24));
            } else {
                const startDate = obData.appStartDate ? parseLocalDate(obData.appStartDate) : new Date();
                const startMonth = startDate.getMonth();
                for (let i = startMonth; i < 12; i++) {
                    const val = parseInt(document.getElementById(`obSalMonth${i}`)?.value);
                    if (val && val >= 1 && val <= MONTH_DAYS[i]) {
                        obData.salaryByMonth[i] = val;
                    } else {
                        delete obData.salaryByMonth[i];
                    }
                }
            }
        } else if (obStep === 5) {
            const inc = parseFloat(document.getElementById('obIncome')?.value) || 0;
            if (inc <= 0) { showToast(t('enterIncome')); return; }
            obData.income = inc;
            obData.dailyBudget = parseFloat(document.getElementById('obBudget')?.value) || 35;
        } else if (obStep === 6) {
            if (obData.fixedMode === 'total') {
                obData.fixedTotal = parseFloat(document.getElementById('obFixed')?.value) || 0;
            }
        } else if (obStep === 7) {
            obData.autoSave = parseFloat(document.getElementById('obAutoSave')?.value) || 0;
            obData.startSavings = parseFloat(document.getElementById('obStartSavings')?.value) || 0;
            obData.savingsGoal = parseFloat(document.getElementById('obGoal')?.value) || 0;
        }
        obStep++;
        renderObStep();
    }

    function obBack() {
        if (obStep === 2) { obPinPhase = 'choose'; obData.pin = ''; obData.pinConfirm = ''; }
        if (obStep > 0) { obStep--; renderObStep(); }
    }

    function renderAhaStep() {
        const content = document.getElementById('obContent');
        const monthlyAutoSave = toCents(obData.autoSave);
        const dailyBudgetCents = toCents(obData.dailyBudget);
        const incomeCents = toCents(obData.income);
        const fixedCents = obData.fixedMode === 'total'
            ? toCents(obData.fixedTotal)
            : obData.fixedItems.reduce((s, it) => s + it.amountCents, 0);

        // Use actual period days based on salary day
        const salDay = obData.salaryMode === 'fixed' ? obData.salaryDay : (Object.values(obData.salaryByMonth)[0] || 24);
        const now = new Date();
        const periodStart = new Date(now.getFullYear(), now.getMonth(), salDay);
        const periodEnd = new Date(now.getFullYear(), now.getMonth() + 1, salDay - 1);
        const daysInPeriod = Math.round((periodEnd - periodStart) / (1000*60*60*24)) + 1;
        const dailyBudgetTotal = dailyBudgetCents * daysInPeriod;

        const overig = incomeCents - fixedCents - dailyBudgetTotal - monthlyAutoSave;
        const monthlyDisplay = Math.max(0, monthlyAutoSave + Math.max(0, overig));

        let goalLine = '';
        if (obData.savingsGoal > 0) {
            const goalCents = toCents(obData.savingsGoal);
            const startCents = toCents(obData.startSavings);
            const remaining = goalCents - startCents;
            if (monthlyDisplay > 0 && remaining > 0) {
                const months = remaining / monthlyDisplay;
                const estDate = new Date();
                estDate.setDate(estDate.getDate() + Math.ceil(months * 30.44));
                const mn = MONTH_NAMES_NL[estDate.getMonth()].toLowerCase();
                goalLine = `<div class="aha-line">Je bereikt ${formatEuro(goalCents)} rond <strong style="color:var(--accent)">${mn} ${estDate.getFullYear()}</strong></div>`;
            } else {
                goalLine = `<div class="aha-line">Na een jaar spaar je naar verwachting ${formatEuro(monthlyDisplay * 12)}</div>`;
            }
        } else {
            goalLine = `<div class="aha-line">Over een jaar heb je naar verwachting <strong style="color:var(--accent)">${formatEuro(monthlyDisplay * 12)}</strong> opzij</div>`;
        }

        content.innerHTML = `
            <div class="ob-step-title" style="text-align:center">Dit is wat GRIP voor je uitrekent</div>
            <div class="aha-amount">${formatEuro(monthlyDisplay)}</div>
            <div class="aha-line" style="font-weight:600">Maximale groei per maand</div>
            ${goalLine}

            <div style="background:var(--glass);border-radius:var(--radius-md);padding:var(--space-lg);margin-top:var(--space-xl);text-align:left">
                <div style="font-size:0.82rem;font-weight:700;margin-bottom:var(--space-sm)">Hoe komt GRIP aan dit bedrag?</div>
                <div style="font-size:0.78rem;color:var(--text-secondary);line-height:1.6">
                    <div style="margin-bottom:var(--space-xs)">Inkomen: <strong>${formatEuro(incomeCents)}</strong></div>
                    <div style="margin-bottom:var(--space-xs)">− Vaste lasten: <strong>${formatEuro(fixedCents)}</strong></div>
                    <div style="margin-bottom:var(--space-xs)">− Dagbudget (${daysInPeriod}d × ${formatEuro(dailyBudgetCents)}): <strong>${formatEuro(dailyBudgetTotal)}</strong></div>
                    <div style="margin-bottom:var(--space-sm)">− Automatisch sparen: <strong>${formatEuro(monthlyAutoSave)}</strong></div>
                    <hr style="border:none;border-top:1px solid var(--glass-border);margin:var(--space-sm) 0">
                    <div style="margin-bottom:var(--space-xs)">Resterend: <strong>${formatEuro(overig)}</strong></div>
                    <div style="font-size:0.72rem;color:var(--text-muted)">Dit resterende bedrag is je vrij besteedbare geld. Als je hier niets van uitgeeft, wordt het volledig als groei geteld. In de praktijk geef je hier waarschijnlijk een deel van uit — GRIP houdt dat bij en past de berekening automatisch aan.</div>
                </div>
            </div>

            <div style="background:var(--glass);border-radius:var(--radius-md);padding:var(--space-lg);margin-top:var(--space-md);text-align:left">
                <div style="font-size:0.82rem;font-weight:700;margin-bottom:var(--space-sm)">Wat doet GRIP hierna?</div>
                <div style="font-size:0.78rem;color:var(--text-secondary);line-height:1.6">
                    Elke dag vul je je uitgaven in. GRIP houdt bij hoeveel je bespaart en past de prognose automatisch aan. Hoe meer data je invoert, hoe nauwkeuriger de schatting wordt.${obData.savingsGoal > 0 ? ' De verwachte datum om je doel te bereiken wordt steeds betrouwbaarder naarmate je GRIP langer gebruikt.' : ''}
                </div>
            </div>

            <div class="aha-closing" style="margin-top:var(--space-xl)">Klaar om te beginnen?</div>
        `;
    }

    function obFinish() {
        appData.lang = obData.lang || 'nl';
        currentLang = appData.lang;
        appData.userName = obData.name;
        appData.pin = obData.pin;
        appData.appStartDate = obData.appStartDate || formatDate(new Date());
        appData.dailyGroceryBudget = toCents(obData.dailyBudget);
        appData.autoSaveCents = toCents(obData.autoSave);
        appData.startSavingsCents = toCents(obData.startSavings);
        appData.savingsGoalCents = obData.savingsGoal > 0 ? toCents(obData.savingsGoal) : 0;
        appData.monthlyIncome = toCents(obData.income);
        appData.theme = 'dark';

        // Salary settings
        if (obData.salaryMode === 'fixed') {
            appData.defaultSalaryDay = obData.salaryDay;
            appData.salaryDates = {};
        } else {
            // Per-month mode: use most common day as default, rest as overrides
            const counts = {};
            Object.values(obData.salaryByMonth).forEach(d => { counts[d] = (counts[d] || 0) + 1; });
            let mostCommon = 24;
            let maxCount = 0;
            Object.entries(counts).forEach(([d, c]) => { if (c > maxCount) { maxCount = c; mostCommon = parseInt(d); } });
            appData.defaultSalaryDay = mostCommon;
            appData.salaryDates = {};
            const yr = new Date().getFullYear();
            Object.entries(obData.salaryByMonth).forEach(([mIdx, day]) => {
                if (parseInt(day) !== mostCommon) {
                    const key = `${yr}-${String(parseInt(mIdx) + 1).padStart(2, '0')}`;
                    appData.salaryDates[key] = parseInt(day);
                }
            });
        }

        // Fixed costs
        ensureFixedCostsIds();
        if (obData.fixedMode === 'total' && obData.fixedTotal > 0) {
            appData.fixedCosts.overig = [{ id: genId('fix'), name: 'Vaste lasten (totaal)', amountCents: toCents(obData.fixedTotal) }];
        } else if (obData.fixedMode === 'detail' && obData.fixedItems.length > 0) {
            obData.fixedItems.forEach(item => {
                const cat = item.cat || 'overig';
                if (!Array.isArray(appData.fixedCosts[cat])) appData.fixedCosts[cat] = [];
                appData.fixedCosts[cat].push({ id: genId('fix'), name: item.name, amountCents: item.amountCents });
            });
        }

        appData.setupComplete = true;
        generateSalaryPeriods();
        ensureActiveMonthSynced();
        saveData();

        document.getElementById('onboarding').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('app').style.display = '';
        showView('home');
    }

    function dismissIntro() {
        document.getElementById('introSplash')?.classList.add('hidden');
        startOnboarding();
    }

    // ═══════════════════════════════════════════════════════════════
    // INIT
    // ═══════════════════════════════════════════════════════════════
    function startApp() {
        loadData();
        currentLang = appData.lang || 'nl';
        applyTheme();
        generateSalaryPeriods();

        if (!appData.setupComplete) {
            document.getElementById('introSplash')?.classList.remove('hidden');
        } else if (!appData.pin) {
            // Edge case: setupComplete but no PIN (corrupt state) — go to Home
            ensureActiveMonthSynced();
            document.getElementById('app')?.classList.remove('hidden');
            showView('home');
        } else {
            ensureActiveMonthSynced();
            initPinScreen();
            document.getElementById('pinScreen')?.classList.remove('hidden');
        }
    }

    // Boot
    startApp();

    </script>
</body>
</html>
