<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Budget Tracker">
    <meta name="theme-color" content="#FFD700">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%23FFD700'/><text x='256' y='365' font-family='system-ui' font-size='340' fill='%23000' text-anchor='middle' font-weight='900'>B</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%23FFD700'/><text x='256' y='365' font-family='system-ui' font-size='340' fill='%23000' text-anchor='middle' font-weight='900'>B</text></svg>">
    <title>Budget Tracker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-black: #0a0a0a;
            --card-bg: #1a1a1a;
            --yellow: #FFD700;
            --yellow-dark: #E5C100;
            --white: #ffffff;
            --gray: #888888;
            --gray-light: #cccccc;
            --success: #00ff00;
            --warning: #ff3333;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-black);
            color: var(--white);
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .hidden {
            display: none !important;
        }

        /* PIN SCREEN */
        #pinScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-black);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .pin-logo {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .pin-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--yellow);
            margin-bottom: 40px;
        }

        .pin-dots {
            display: flex;
            gap: 15px;
            margin-bottom: 40px;
        }

        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #333;
            transition: all 0.3s ease;
        }

        .pin-dot.filled {
            background: var(--yellow);
            transform: scale(1.2);
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 300px;
        }

        .pin-key {
            width: 70px;
            height: 70px;
            background: var(--card-bg);
            border: none;
            border-radius: 50%;
            font-size: 1.8rem;
            color: var(--white);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
        }

        .pin-key:active {
            transform: scale(0.95);
            background: #2a2a2a;
        }

        .pin-error {
            color: var(--warning);
            font-size: 0.9rem;
            margin-top: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pin-error.show {
            opacity: 1;
        }

        /* WELCOME SCREENS */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--yellow);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            animation: fadeIn 0.5s ease;
        }

        .welcome-emoji {
            font-size: 5rem;
            margin-bottom: 30px;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .welcome-text {
            font-size: 2.5rem;
            font-weight: 900;
            color: #000;
            text-align: center;
            margin-bottom: 20px;
        }

        .welcome-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #000;
            opacity: 0.8;
        }

        .welcome-quote {
            max-width: 80%;
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }

        .quote-text {
            font-size: 1.2rem;
            color: #000;
            font-weight: 700;
            line-height: 1.6;
            padding: 10px;
        }

        .quote-author {
            display: none;
        }

        /* LANDING MENU */
        #landingMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--yellow);
            z-index: 9997;
            overflow-y: auto;
            padding: 40px 20px;
        }

        .landing-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .landing-title {
            font-size: 2rem;
            font-weight: 900;
            color: #000;
            margin-bottom: 10px;
        }

        .landing-subtitle {
            font-size: 1rem;
            color: #000;
            opacity: 0.7;
        }

        .landing-cards {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .landing-card {
            background: rgba(0, 0, 0, 0.08);
            padding: 25px 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            align-items: center;
            border: 2px solid transparent;
        }

        .landing-card:active {
            transform: scale(0.98);
            background: rgba(0, 0, 0, 0.15);
        }

        .landing-card-icon {
            font-size: 2rem;
            margin-right: 15px;
        }

        .landing-card-content {
            flex: 1;
        }

        .landing-card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #000;
            margin-bottom: 5px;
        }

        .landing-card-desc {
            font-size: 0.85rem;
            color: #000;
            opacity: 0.7;
        }

        /* MAIN APP */
        #app {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        /* HEADER */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .menu-button {
            width: 44px;
            height: 44px;
            background: var(--card-bg);
            border: none;
            border-radius: 12px;
            color: var(--yellow);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
        }

        .menu-button:active {
            transform: scale(0.95);
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--yellow);
        }

        .month-selector {
            background: var(--card-bg);
            border: none;
            padding: 10px 15px;
            border-radius: 12px;
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        /* FULL SCREEN MENU */
        #fullscreenMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-black);
            z-index: 9996;
            transform: translateY(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            padding: 40px 20px;
        }

        #fullscreenMenu.active {
            transform: translateY(0);
        }

        .menu-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: var(--card-bg);
            border: none;
            border-radius: 12px;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }

        .menu-header-text {
            font-size: 2rem;
            font-weight: 900;
            color: var(--yellow);
            text-align: center;
            margin-bottom: 40px;
        }

        .menu-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 500px;
            margin: 0 auto;
        }

        .menu-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
        }

        .menu-card:active {
            transform: scale(0.98);
            background: #252525;
        }

        .menu-card-icon {
            font-size: 2rem;
            margin-right: 15px;
        }

        .menu-card-content {
            flex: 1;
        }

        .menu-card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 3px;
        }

        .menu-card-desc {
            font-size: 0.85rem;
            color: var(--gray);
        }

        /* VIEWS */
        .view {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* CARDS */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .hero-card {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            padding: 30px 20px;
            text-align: center;
            border: 2px solid var(--yellow);
        }

        .hero-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hero-amount {
            font-size: 3rem;
            font-weight: 900;
            color: var(--yellow);
            margin-bottom: 15px;
        }

        .hero-subtext {
            font-size: 1rem;
            color: var(--gray-light);
        }

        .hero-subtext .positive {
            color: var(--success);
        }

        .hero-subtext .negative {
            color: var(--warning);
        }

        /* SECTION HEADERS */
        .section-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 15px;
            margin-top: 30px;
        }

        /* QUICK ACTIONS */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-btn {
            background: var(--card-bg);
            border: 2px solid var(--yellow);
            padding: 15px 10px;
            border-radius: 12px;
            color: var(--yellow);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
        }

        .quick-btn:active {
            transform: scale(0.95);
            background: var(--yellow);
            color: #000;
        }

        /* TODAY CARD */
        .today-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .today-date {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--yellow);
            margin-bottom: 10px;
        }

        .today-status {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .today-total {
            font-size: 2rem;
            font-weight: 900;
            color: var(--white);
            margin-top: 10px;
        }

        /* WEEK GRID */
        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .day-box {
            aspect-ratio: 1;
            background: var(--card-bg);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            font-size: 0.75rem;
            box-shadow: var(--shadow);
        }

        .day-box .day-label {
            color: var(--gray);
            margin-bottom: 4px;
            font-weight: 600;
        }

        .day-box .day-amount {
            color: var(--white);
            font-weight: 700;
            font-size: 0.85rem;
        }

        .day-box.under-budget {
            background: linear-gradient(135deg, #00ff0020, #00cc0020);
            border: 1px solid var(--success);
        }

        .day-box.over-budget {
            background: linear-gradient(135deg, #ff333320, #cc000020);
            border: 1px solid var(--warning);
        }

        .day-box.no-data {
            opacity: 0.5;
        }

        /* ENTRIES LIST */
        .entries-list {
            margin-top: 20px;
        }

        .entry-item {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .entry-info {
            flex: 1;
        }

        .entry-amount {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--yellow);
            margin-bottom: 3px;
        }

        .entry-note {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .entry-date {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 3px;
        }

        .entry-actions {
            display: flex;
            gap: 8px;
        }

        .entry-btn {
            width: 36px;
            height: 36px;
            background: #2a2a2a;
            border: none;
            border-radius: 8px;
            color: var(--white);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .entry-btn:active {
            transform: scale(0.9);
        }

        .entry-btn.edit {
            color: var(--yellow);
        }

        .entry-btn.delete {
            color: var(--warning);
        }

        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-width: 500px;
            border-radius: 24px 24px 0 0;
            padding: 30px 20px;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--white);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            background: #2a2a2a;
            border: none;
            border-radius: 8px;
            color: var(--white);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 8px;
            display: block;
        }

        .input-field {
            width: 100%;
            background: #0a0a0a;
            border: 2px solid #333;
            padding: 16px;
            border-radius: 12px;
            color: var(--white);
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--yellow);
        }

        .input-field.note {
            font-size: 1rem;
            font-weight: 400;
            text-align: left;
        }

        .btn-primary {
            width: 100%;
            background: var(--yellow);
            border: none;
            padding: 18px;
            border-radius: 12px;
            color: #000;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
        }

        .btn-primary:active {
            transform: scale(0.98);
            background: var(--yellow-dark);
        }

        /* STAT GRID */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
        }

        .stat-value.yellow {
            color: var(--yellow);
        }

        .stat-value.success {
            color: var(--success);
        }

        .stat-value.warning {
            color: var(--warning);
        }

        /* CHART */
        .chart-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 15px;
        }

        #prognoseChart {
            width: 100%;
            height: 250px;
        }

        /* FIXED COSTS */
        .cost-category {
            margin-bottom: 20px;
        }

        .category-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--yellow);
            margin-bottom: 10px;
        }

        .cost-item {
            background: var(--card-bg);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cost-name {
            font-size: 0.9rem;
            color: var(--white);
        }

        .cost-amount {
            font-size: 1rem;
            font-weight: 700;
            color: var(--yellow);
        }

        /* TOOLS */
        .tool-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .tool-card:active {
            transform: scale(0.98);
        }

        .tool-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 5px;
        }

        .tool-desc {
            font-size: 0.85rem;
            color: var(--gray);
        }

        /* CALCULATOR */
        .calc-display {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: right;
            font-size: 2rem;
            font-weight: 700;
            color: var(--yellow);
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .calc-btn {
            background: var(--card-bg);
            border: none;
            padding: 20px;
            border-radius: 12px;
            color: var(--white);
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calc-btn:active {
            transform: scale(0.95);
            background: #2a2a2a;
        }

        .calc-btn.operator {
            background: var(--yellow);
            color: #000;
        }

        .calc-btn.equals {
            background: var(--success);
            color: #000;
        }

        /* SETTINGS */
        .setting-item {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-label {
            font-size: 1rem;
            color: var(--white);
        }

        .toggle-switch {
            width: 50px;
            height: 28px;
            background: #333;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--yellow);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: var(--white);
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 25px;
        }

        /* NOTIFICATIONS */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 12px;
            z-index: 10001;
            max-width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from { transform: translate(-50%, -100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        .notification-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 5px;
        }

        .notification-text {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        .notification.info {
            border-left: 4px solid var(--yellow);
        }

        /* ACHIEVEMENTS */
        .achievement-badge {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--yellow);
            padding: 30px;
            border-radius: 20px;
            z-index: 10002;
            text-align: center;
            animation: achievementPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }

        .achievement-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .achievement-title {
            font-size: 1.3rem;
            font-weight: 900;
            color: #000;
            margin-bottom: 8px;
        }

        .achievement-desc {
            font-size: 0.9rem;
            color: #000;
            opacity: 0.8;
        }

        /* MONTH NOT STARTED */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 1.1rem;
            color: var(--gray);
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top-color: var(--yellow);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* RESPONSIVE */
        @media (min-width: 768px) {
            .modal-content {
                border-radius: 24px;
                max-height: 80vh;
            }

            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    
        /* ---- Fixed costs & income list actions ---- */
        .muted-text {
            color: var(--gray);
            font-size: 0.9rem;
            line-height: 1.35;
            margin-top: 6px;
        }
        .btn-compact {
            width: auto;
            display: inline-block;
            padding: 12px 14px;
            font-size: 0.95rem;
            border-radius: 12px;
            margin-top: 12px;
        }
        .row-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .btn-mini {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.16);
            color: var(--white);
            padding: 7px 10px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
        }
        .btn-mini.danger {
            border-color: rgba(255,51,51,0.55);
            color: var(--warning);
        }
        .btn-mini:active {
            transform: scale(0.98);
        }
        .two-col {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
        }
        .right-col {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }



        .pill{
            padding:10px 12px;
            border-radius:999px;
            background:rgba(255,255,255,0.06);
            border:1px solid rgba(255,255,255,0.12);
            color:rgba(255,255,255,0.9);
            font-size:12px;
            letter-spacing:0.2px;
        }

</style>
</head>
<body>
    <!-- PIN SCREEN -->
    <div id="pinScreen">
        <div class="pin-logo">üí∞</div>
        <div class="pin-title">Voer je pincode in</div>
        <div class="pin-dots">
            <div class="pin-dot" id="dot1"></div>
            <div class="pin-dot" id="dot2"></div>
            <div class="pin-dot" id="dot3"></div>
            <div class="pin-dot" id="dot4"></div>
        </div>
        <div class="pin-keypad">
            <button class="pin-key" onclick="pinInput('1')">1</button>
            <button class="pin-key" onclick="pinInput('2')">2</button>
            <button class="pin-key" onclick="pinInput('3')">3</button>
            <button class="pin-key" onclick="pinInput('4')">4</button>
            <button class="pin-key" onclick="pinInput('5')">5</button>
            <button class="pin-key" onclick="pinInput('6')">6</button>
            <button class="pin-key" onclick="pinInput('7')">7</button>
            <button class="pin-key" onclick="pinInput('8')">8</button>
            <button class="pin-key" onclick="pinInput('9')">9</button>
            <button class="pin-key" onclick="pinClear()">‚å´</button>
            <button class="pin-key" onclick="pinInput('0')">0</button>
            <button class="pin-key" onclick="pinSubmit()">‚úì</button>
        </div>
        <div class="pin-error" id="pinError">Verkeerde pincode</div>
    </div>

    <!-- WELCOME SCREEN 1 -->
    <div id="welcomeScreen1" class="welcome-screen hidden">
        <div class="welcome-emoji">üëã</div>
        <div class="welcome-text">WELKOM</div>
        <div class="welcome-name">Anis</div>
    </div>

    <!-- WELCOME SCREEN 2 (Quote) -->
    <div id="welcomeScreen2" class="welcome-screen hidden">
        <div class="welcome-emoji">üí°</div>
        <div class="welcome-quote">
            <div class="quote-text" id="quoteText"></div>
            <div class="quote-author" id="quoteAuthor"></div>
        </div>
    </div>

    <!-- LANDING MENU -->
    <div id="landingMenu" class="hidden">
        <div class="landing-header">
            <div class="landing-title">BUDGET TRACKER</div>
            <div class="landing-subtitle">Jouw financi√´le overzicht</div>
        </div>
        <div class="landing-cards">
            <div class="landing-card" onclick="enterApp()">
                <div class="landing-card-icon">üè†</div>
                <div class="landing-card-content">
                    <div class="landing-card-title">Dashboard</div>
                    <div class="landing-card-desc">Overzicht & quick add</div>
                </div>
            </div>
            <div class="landing-card" onclick="enterApp('boodschappen')">
                <div class="landing-card-icon">üõí</div>
                <div class="landing-card-content">
                    <div class="landing-card-title">Boodschappen</div>
                    <div class="landing-card-desc">Track je dagelijks</div>
                </div>
            </div>
            <div class="landing-card" onclick="enterApp('vrij')">
                <div class="landing-card-icon">üéâ</div>
                <div class="landing-card-content">
                    <div class="landing-card-title" id="landingVrijTitle">Vrij te Besteden</div>
                    <div class="landing-card-desc" id="landingVrijDesc">Speelruimte per salarismand</div>
                </div>
            </div>
            <div class="landing-card" onclick="enterApp('vasteLasten')">
                <div class="landing-card-icon">üè¶</div>
                <div class="landing-card-content">
                    <div class="landing-card-title">Vaste Lasten</div>
                    <div class="landing-card-desc">Al je vaste kosten</div>
                </div>
            </div>
            <div class="landing-card" onclick="enterApp('prognose')">
                <div class="landing-card-icon">üìä</div>
                <div class="landing-card-content">
                    <div class="landing-card-title">Grafiek</div>
                    <div class="landing-card-desc">Spaargeld over tijd</div>
                </div>
            </div>
            <div class="landing-card" onclick="enterApp('tools')">
                <div class="landing-card-icon">üõ†Ô∏è</div>
                <div class="landing-card-content">
                    <div class="landing-card-title">Tools</div>
                    <div class="landing-card-desc">Calculator & meer</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="hidden">
        <div class="app-header">
            <button class="menu-button" onclick="openMenu()">‚ò∞</button>
            <div class="app-title">BUDGET TRACKER</div>
            <select class="month-selector" id="monthSelector" onchange="changeMonth()"></select>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView" class="view">
            <div class="card hero-card">
                <div class="hero-label">üí∞ TOTAAL GESPAARD</div>
                <div class="hero-amount" id="totalSavings">‚Ç¨0</div>
                <div class="hero-subtext" id="monthChange">Deze maand: ‚Ç¨0</div>
            </div>

            <div class="section-header">‚ö° Quick Add Boodschappen</div>
            <div class="quick-actions">
                <button class="quick-btn" onclick="quickAddGrocery(25)">‚Ç¨25</button>
                <button class="quick-btn" onclick="quickAddGrocery(30)">‚Ç¨30</button>
                <button class="quick-btn" onclick="quickAddGrocery(35)">‚Ç¨35</button>
                <button class="quick-btn" onclick="quickAddGrocery(40)">‚Ç¨40</button>
            </div>

            <div class="section-header">üìÖ Vandaag</div>
            <div class="today-card">
                <div class="today-date" id="todayDate">MA 9 FEB 2026</div>
                <div class="today-status" id="todayStatus">Nog geen boodschappen ingevuld</div>
                <div class="today-total" id="todayTotal"></div>
            </div>

            <div class="section-header">üìä Deze Week</div>
            <div class="week-grid" id="weekGrid"></div>

            <div class="section-header">üìà Overzicht</div>
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-label">Boodschappen</div>
                    <div class="stat-value yellow" id="groceriesTotal">‚Ç¨0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Vrij Gespendeerd</div>
                    <div class="stat-value yellow" id="spendingTotal">‚Ç¨0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Budget Over</div>
                    <div class="stat-value success" id="budgetLeft">‚Ç¨0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Streak</div>
                    <div class="stat-value yellow" id="streakDays">0 üî•</div>
                </div>
            </div>
        </div>

        <!-- BOODSCHAPPEN VIEW -->
        <div id="boodschappenView" class="view hidden">
            <div class="section-header">üõí Boodschappen</div>
            
            <button class="btn-primary" onclick="openAddGroceryModal()" style="margin-bottom: 20px;">
                + Boodschappen Toevoegen
            </button>

            <div class="today-card">
                <div class="today-date" id="groceryTodayDate">MA 9 FEB 2026</div>
                <div class="today-status" id="groceryTodayStatus">Nog geen boodschappen ingevuld</div>
                <div class="today-total" id="groceryTodayTotal"></div>
            </div>

            <div class="section-header">üìä Deze Week</div>
            <div class="week-grid" id="groceryWeekGrid"></div>

            <div class="section-header">üìù Alle Boodschappen</div>
            <div class="entries-list" id="groceryEntriesList"></div>
        </div>

        <!-- VRIJ VIEW -->
        <div id="vrijView" class="view hidden">
            <div class="section-header">üéâ Vrij te Besteden</div>
            
            <div class="card hero-card">
                <div class="hero-label">üí∏ BUDGET DEZE MAAND</div>
                <div class="hero-amount" id="vrijBudget">‚Ç¨0</div>
                <div class="hero-subtext" id="vrijLeft">Nog: ‚Ç¨0</div>
            </div>

            <button class="btn-primary" onclick="openAddSpendingModal()" style="margin-bottom: 20px;">
                + Uitgave Toevoegen
            </button>

            <div class="entries-list" id="spendingList"></div>
        </div>

        <!-- VASTE LASTEN VIEW -->
        <div id="vasteLastenView" class="view hidden">
            <div class="section-header">üè¶ Vaste Lasten</div>

            <div class="card hero-card">
                <div class="hero-label">üí∞ TOTAAL INKOMEN</div>
                <div class="hero-amount" id="incomeTotal">‚Ç¨0</div>
                <div class="hero-subtext" id="incomeSubtext">Salarismaand</div>
            </div>

            <div class="card">
                <div class="card-title">Inkomen</div>
                <div class="muted-text">Dit geldt voor de geselecteerde salarismand.</div>
                <button class="btn-primary btn-compact" onclick="openModal('addIncomeModal')">Nieuw inkomen</button>
                <div id="incomeList" style="margin-top: 14px;"></div>
            </div>

            <div class="card hero-card">
                <div class="hero-label">üí≥ TOTAAL VASTE LASTEN</div>
                <div class="hero-amount" id="fixedCostsTotal">‚Ç¨0</div>
                <div class="hero-subtext">Per maand</div>
            </div>

            <div class="card">
                <div class="card-title">Over na vaste lasten</div>
                <div class="hero-amount" id="netAfterFixed">‚Ç¨0</div>
                <div class="hero-subtext">Inkomen ‚àí vaste lasten</div>
            </div>


            <div class="card">
                <div class="card-title">Vrij te besteden</div>
                <div class="hero-amount" id="computedFreeBudget">‚Ç¨0</div>
                <div class="hero-subtext" id="computedFreeBudgetNote">Voor deze salarismand</div>

                <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
                    <div class="pill" id="freeBreakdownGroceries">Boodschappen cap: ‚Ç¨0</div>
                    <div class="pill" id="freeBreakdownAutoSave">Autosparen: ‚Ç¨0</div>
                </div>

            </div>


            <div class="card">
                <div class="card-title">Vaste lasten</div>
                <div class="muted-text">Bewerk, verwijder of voeg extra vaste lasten toe.</div>
                <button class="btn-primary btn-compact" onclick="openModal('addFixedCostModal')">Nieuwe vaste last</button>
                <div id="fixedCostsList" style="margin-top: 14px;"></div>
            </div>
        </div>

        <!-- PROGNOSE VIEW -->
        <div id="prognoseView" class="view hidden">
            <div class="section-header">üìà Spaargeld Grafiek</div>
            
            <div class="chart-container">
                <div class="chart-title">Spaargeld over tijd</div>
                <canvas id="prognoseChart"></canvas>
            </div>

            <div class="card">
                <div class="stat-label">Huidig spaargeld (realtime)</div>
                <div class="stat-value yellow" id="currentSavingsValue">‚Ç¨0</div>
            </div>
        </div>

        <!-- TOOLS VIEW -->
        <div id="toolsView" class="view hidden">
            <div class="section-header">üõ†Ô∏è Tools</div>
            
            <div class="tool-card" onclick="openCalculator()">
                <div class="tool-title">üßÆ Calculator</div>
                <div class="tool-desc">Snel berekeningen maken</div>
            </div>

            <div class="tool-card" onclick="exportToPDF()">
                <div class="tool-title">üìÑ Export naar PDF</div>
                <div class="tool-desc">Download je budget overzicht</div>
            </div>

            <div class="tool-card" onclick="backupData()">
                <div class="tool-title">üíæ Backup Data</div>
                <div class="tool-desc">Download je data als JSON</div>
            </div>

            <div class="tool-card" onclick="showView('settings')">
                <div class="tool-title">‚öôÔ∏è Instellingen</div>
                <div class="tool-desc">App configureren</div>
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="settingsView" class="view hidden">
            <div class="section-header">‚öôÔ∏è Instellingen</div>

            <div class="setting-item">
                <div class="setting-label">Notificaties</div>
                <div class="toggle-switch" id="notifToggle" onclick="toggleNotifications()"></div>
            </div>

            <div class="setting-item">
                <div class="setting-label">Dark Mode</div>
                <div class="toggle-switch active" id="darkModeToggle" onclick="toggleDarkMode()"></div>
            </div>

            <button class="btn-primary" onclick="resetAllData()" style="margin-top: 30px; background: var(--warning);">
                ‚ö†Ô∏è Reset Alle Data
            </button>
        </div>
    </div>

    <!-- FULLSCREEN MENU -->
    <div id="fullscreenMenu">
        <button class="menu-close" onclick="closeMenu()">‚úï</button>
        <div class="menu-header-text">MENU</div>
        <div class="menu-cards">
            <div class="menu-card" onclick="showView('dashboard')">
                <div class="menu-card-icon">üè†</div>
                <div class="menu-card-content">
                    <div class="menu-card-title">Dashboard</div>
                    <div class="menu-card-desc">Overzicht & quick add</div>
                </div>
            </div>
            <div class="menu-card" onclick="showView('boodschappen')">
                <div class="menu-card-icon">üõí</div>
                <div class="menu-card-content">
                    <div class="menu-card-title">Boodschappen</div>
                    <div class="menu-card-desc">Track je dagelijks</div>
                </div>
            </div>
            <div class="menu-card" onclick="showView('vrij')">
                <div class="menu-card-icon">üéâ</div>
                <div class="menu-card-content">
                    <div class="menu-card-title" id="menuVrijTitle">Vrij te Besteden</div>
                    <div class="menu-card-desc" id="menuVrijDesc">Speelruimte per salarismand</div>
                </div>
            </div>
            <div class="menu-card" onclick="showView('vasteLasten')">
                <div class="menu-card-icon">üè¶</div>
                <div class="menu-card-content">
                    <div class="menu-card-title">Vaste Lasten</div>
                    <div class="menu-card-desc">Al je vaste kosten</div>
                </div>
            </div>
            <div class="menu-card" onclick="showView('prognose')">
                <div class="menu-card-icon">üìä</div>
                <div class="menu-card-content">
                    <div class="menu-card-title">Grafiek</div>
                    <div class="menu-card-desc">Spaargeld over tijd</div>
                </div>
            </div>
            <div class="menu-card" onclick="showView('tools')">
                <div class="menu-card-icon">üõ†Ô∏è</div>
                <div class="menu-card-content">
                    <div class="menu-card-title">Tools</div>
                    <div class="menu-card-desc">Calculator & meer</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="addGroceryModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Boodschappen Toevoegen</div>
                <button class="modal-close" onclick="closeModal('addGroceryModal')">‚úï</button>
            </div>
            <div class="input-group">
                <label class="input-label">Bedrag</label>
                <input type="number" class="input-field" id="groceryAmount" placeholder="0.00" step="0.01">
            </div>
            <div class="input-group">
                <label class="input-label">Notitie (optioneel)</label>
                <input type="text" class="input-field note" id="groceryNote" placeholder="bijv. Albert Heijn">
            </div>
            <button class="btn-primary" onclick="addGrocery()">Toevoegen</button>
        </div>
    </div>

    <div id="editGroceryModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Boodschappen Bewerken</div>
                <button class="modal-close" onclick="closeModal('editGroceryModal')">‚úï</button>
            </div>
            <div class="input-group">
                <label class="input-label">Bedrag</label>
                <input type="number" class="input-field" id="editGroceryAmount" placeholder="0.00" step="0.01">
            </div>
            <div class="input-group">
                <label class="input-label">Notitie (optioneel)</label>
                <input type="text" class="input-field note" id="editGroceryNote" placeholder="bijv. Albert Heijn">
            </div>
            <button class="btn-primary" onclick="saveEditGrocery()">Opslaan</button>
        </div>
    </div>

    <div id="addSpendingModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Uitgave Toevoegen</div>
                <button class="modal-close" onclick="closeModal('addSpendingModal')">‚úï</button>
            </div>
            <div class="input-group">
                <label class="input-label">Categorie</label>
                <input type="text" class="input-field note" id="spendingCategory" placeholder="bijv. Entertainment">
            </div>
            <div class="input-group">
                <label class="input-label">Bedrag</label>
                <input type="number" class="input-field" id="spendingAmount" placeholder="0.00" step="0.01">
            </div>
            <div class="input-group">
                <label class="input-label">Notitie (optioneel)</label>
                <input type="text" class="input-field note" id="spendingNote" placeholder="bijv. Cinema">
            </div>
            <button class="btn-primary" onclick="addSpending()">Toevoegen</button>
        </div>
    </div>


    <!-- ADD INCOME MODAL -->
    <div id="addIncomeModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Inkomen Toevoegen</div>
                <button class="modal-close" onclick="closeModal('addIncomeModal')">‚úï</button>
            </div>
            <div class="input-group">
                <label class="input-label">Naam</label>
                <input type="text" class="input-field note" id="incomeName" placeholder="bijv. Salaris" value="Salaris">
            </div>
            <div class="input-group">
                <label class="input-label">Bedrag</label>
                <input type="number" class="input-field" id="incomeAmount" placeholder="0.00" step="0.01">
            </div>
            <button class="btn-primary" onclick="addIncome()">Toevoegen</button>
        </div>
    </div>

    <!-- EDIT INCOME MODAL -->
    <div id="editIncomeModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Inkomen Bewerken</div>
                <button class="modal-close" onclick="closeModal('editIncomeModal')">‚úï</button>
            </div>
            <div class="input-group">
                <label class="input-label">Naam</label>
                <input type="text" class="input-field note" id="editIncomeName" placeholder="bijv. Salaris">
            </div>
            <div class="input-group">
                <label class="input-label">Bedrag</label>
                <input type="number" class="input-field" id="editIncomeAmount" placeholder="0.00" step="0.01">
            </div>
            <button class="btn-primary" onclick="saveEditIncome()">Opslaan</button>
        </div>
    </div>

    <!-- ADD FIXED COST MODAL -->
    <div id="addFixedCostModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Vaste Last Toevoegen</div>
                <button class="modal-close" onclick="closeModal('addFixedCostModal')">‚úï</button>
            </div>
            <div class="input-group">
                <label class="input-label">Categorie</label>
                <select class="input-field" id="fixedCostCategory">
                    <option value="huis">Huis</option>
                    <option value="verzekeringen">Verzekeringen</option>
                    <option value="abonnementen">Abonnementen</option>
                    <option value="leningen">Leningen</option>
                    <option value="overigVast">Overig vast</option>
                    <option value="vliegtuig">Vliegtuig</option>
                    <option value="overig">Overig</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Naam</label>
                <input type="text" class="input-field note" id="fixedCostName" placeholder="bijv. Huur">
            </div>
            <div class="input-group">
                <label class="input-label">Bedrag</label>
                <input type="number" class="input-field" id="fixedCostAmount" placeholder="0.00" step="0.01">
            </div>
            <button class="btn-primary" onclick="addFixedCost()">Toevoegen</button>
        </div>
    </div>

    <!-- EDIT FIXED COST MODAL -->
    <div id="editFixedCostModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Vaste Last Bewerken</div>
                <button class="modal-close" onclick="closeModal('editFixedCostModal')">‚úï</button>
            </div>
            <div class="input-group">
                <label class="input-label">Naam</label>
                <input type="text" class="input-field note" id="editFixedCostName" placeholder="bijv. Huur">
            </div>
            <div class="input-group">
                <label class="input-label">Bedrag</label>
                <input type="number" class="input-field" id="editFixedCostAmount" placeholder="0.00" step="0.01">
            </div>
            <button class="btn-primary" onclick="saveEditFixedCost()">Opslaan</button>
        </div>
    </div>


    <div id="calculatorModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Calculator</div>
                <button class="modal-close" onclick="closeModal('calculatorModal')">‚úï</button>
            </div>
            <div class="calc-display" id="calcDisplay">0</div>
            <div class="calc-buttons">
                <button class="calc-btn" onclick="calcInput('7')">7</button>
                <button class="calc-btn" onclick="calcInput('8')">8</button>
                <button class="calc-btn" onclick="calcInput('9')">9</button>
                <button class="calc-btn operator" onclick="calcInput('/')">√∑</button>
                <button class="calc-btn" onclick="calcInput('4')">4</button>
                <button class="calc-btn" onclick="calcInput('5')">5</button>
                <button class="calc-btn" onclick="calcInput('6')">6</button>
                <button class="calc-btn operator" onclick="calcInput('*')">√ó</button>
                <button class="calc-btn" onclick="calcInput('1')">1</button>
                <button class="calc-btn" onclick="calcInput('2')">2</button>
                <button class="calc-btn" onclick="calcInput('3')">3</button>
                <button class="calc-btn operator" onclick="calcInput('-')">‚àí</button>
                <button class="calc-btn" onclick="calcClear()">C</button>
                <button class="calc-btn" onclick="calcInput('0')">0</button>
                <button class="calc-btn equals" onclick="calcEqual()">=</button>
                <button class="calc-btn operator" onclick="calcInput('+')">+</button>
            </div>
        </div>
    </div>

    
    <script>

function toCents(v) { return Math.round(Number(v) * 100); }
function fromCents(c) { return (Number(c) || 0) / 100; }
function formatCurrency(v) {
  try {
    return new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR' }).format(Number(v) || 0);
  } catch (e) {
    return '‚Ç¨' + (Number(v) || 0).toFixed(2);
  }
}


        // ============================================================================
        // FIXED MONEY MATH - Budget Tracker
        // All calculations now use correct salary period logic and cents for precision
        // ============================================================================
        
        // APP DATA STRUCTURE (using cents to avoid float issues)
        let appData = {
            userName: 'Anis',
            pin: '4771',
            currentMonth: 'jan2026',
            lastActiveMonthKey: null, // Tracks last active salary-month to auto-switch on salary day // This is VIEWED month (dropdown), NOT active month
            groceries: {}, // Structure: {monthKey: {dateStr: [{amountCents, note, timestamp}]}}
            spending: {},  // Structure: {monthKey: [{category, amountCents, note, date}]}
            fixedCosts: {
                huis: [
                    {name: 'Huur', amountCents: 88800},
                    {name: 'Energie', amountCents: 16000},
                    {name: 'Water', amountCents: 1400}
                ],
                verzekeringen: [
                    {name: 'CZ', amountCents: 19100},
                    {name: 'Fietsverzekering', amountCents: 1100}
                ],
                abonnementen: [
                    {name: 'Internet', amountCents: 2500},
                    {name: 'Telefoon', amountCents: 2900},
                    {name: 'Spotify', amountCents: 1300},
                    {name: 'iCloud', amountCents: 1000},
                    {name: 'OpenAI', amountCents: 2200},
                    {name: 'CapCut', amountCents: 1200},
                    {name: 'Gym', amountCents: 3300},
                    {name: 'NS', amountCents: 2000},
                    {name: 'Urban', amountCents: 5000}
                ],
                leningen: [
                    {name: 'Sant', amountCents: 9300},
                    {name: 'Lening', amountCents: 9700}
                ],
                overigVast: [
                    {name: 'Kapper', amountCents: 13800},
                    {name: 'Supplementen', amountCents: 7000}
                ],
                vliegtuig: [
                    {name: 'Vlucht', amountCents: 35000}
                ],
                overig: []
            },
            income: {},
            streak: 0,
            notificationsEnabled: true,
            achievements: []
        };

        // CONSTANTS (in cents for precision)
        const START_SAVINGS_CENTS = 75000;  // ‚Ç¨750
        const AUTO_SAVE_CENTS = 60000;      // ‚Ç¨600 per salary month (except jan2026)
        const DAILY_GROCERY_BUDGET_CENTS = 3500; // ‚Ç¨35 per day
        // Monthly grocery cap used for calculating vrije besteding (35/day => max 1050 per month)
        const MONTHLY_GROCERY_CAP_CENTS = DAILY_GROCERY_BUDGET_CENTS * 30;

        // Free budget (vrij te besteden / speelruimte) is NOT a fixed constant.
        // It is derived from Income ‚àí Fixed Costs ‚àí Grocery cap ‚àí Auto-save (per salary month).
        function calculateFixedCostsTotalCents() {
            ensureFixedCostsIds();
            let total = 0;
            const cats = Object.keys(appData.fixedCosts || {});
            cats.forEach(cat => {
                const items = appData.fixedCosts[cat] || [];
                items.forEach(it => { total += Number(it.amountCents) || 0; });
            });
            return Math.round(total);
        }

        function calculateIncomeTotalCents(monthKey) {
            ensureIncomeForMonth(monthKey);
            const incomes = appData.income[monthKey] || [];
            return Math.round(incomes.reduce((sum, it) => sum + (Number(it.amountCents) || 0), 0));
        }

        function getAutoSaveForMonthCents(monthKey) {
            const p = getPeriodInfo(monthKey);
            return (p && p.salaryDate) ? AUTO_SAVE_CENTS : 0; // jan2026 has no salaryDate => 0
        }

                                function getFreeBudgetCents(monthKey) {
                    // January special: fixed free-to-spend ‚Ç¨424 (your rule)
                    if (monthKey === 'jan2026') return 42400;

                    // For other salary months:
                    // Vrij te besteden = (Inkomen ‚àí Vaste lasten) ‚àí ‚Ç¨1.050 boodschappen cap ‚àí ‚Ç¨600 autosparen (if salary month has salaryDate)
                    const incomeCents = calculateIncomeTotalCents(monthKey);
                    const fixedCents = calculateFixedCostsTotalCents();
                    const groceryCapCents = MONTHLY_GROCERY_CAP_CENTS;
                    const autoSaveCents = getAutoSaveForMonthCents(monthKey);

                    return Math.round(incomeCents - fixedCents - groceryCapCents - autoSaveCents);
                }

        // CENTS HELPERS (avoid floating point errors)
        function toCents(euros) {
            // Convert to string, handle decimal properly
            const numStr = Number(euros).toFixed(2);
            const [whole, decimal] = numStr.split('.');
            return parseInt(whole) * 100 + parseInt(decimal || 0);
        }
        
        function fromCents(cents) {
            return (Number(cents) || 0) / 100;
        }
        
        function formatEuro(cents) {
            // Ensure cents is an integer
            const roundedCents = Math.round(Number(cents) || 0);
            const euros = roundedCents / 100;
            return '‚Ç¨' + euros.toFixed(2).replace('.', ',');
        }

        // Update menu labels that should include live budget amounts
                function updateMenuBudgetLabels() {
                    // Keep menu titles clean (no amounts in titles)
                    const vrijTitleText = 'Vrij te Besteden';

                    const landingTitle = document.getElementById('landingVrijTitle');
                    if (landingTitle) landingTitle.textContent = vrijTitleText;

                    const menuTitle = document.getElementById('menuVrijTitle');
                    if (menuTitle) menuTitle.textContent = vrijTitleText;
                }


        // QUOTES (unchanged)
                const quotes = [
            {text: 'Gierig zijn is gewoon: "Ik ben volwassen genoeg om niet elke impuls te adopteren."'},
            {text: 'Sparen is een superkracht'},
            {text: 'Ik ben niet gierig, ik ben selectief.'},
            {text: 'De echte luxe is niet duur doen'},
            {text: 'niet elke euro meteen op vakantie sturen zonder retourticket'},
            {text: 'Mensen die alles uitgeven, noemen jou gierig. Dat is alsof een drenkeling lacht om iemand met een zwemdiploma.'},
            {text: 'Ik heb geen "treat yourself"-momenten.'},
            {text: 'Ik ben niet goedkoop. Ik ben allergisch voor onzin.'},
            {text: '"niet nodig". Dat is de beste deal.'},
            {text: 'Zuinig zijn is het verschil tussen "ik heb zin" en "ik heb controle".'},
            {text: 'De winkel wil dat je koopt. Je bankrekening wil dat je ademt. Kies je kamp.'},
            {text: 'Zuinig zijn is niet bang zijn om arm te worden, maar weigeren om dom te worden.'},
            {text: 'bezuinigen = schadebeperking'},
            {text: 'Zuinig zijn is het wantrouwen dat je nodig hebt om niet overal in te trappen.'},
            {text: 'Sparen is kiezen voor rust in plaats van prikkels die je toch niet vullen.'},
            {text: 'Wie minder uitgeeft, geeft zichzelf minder kansen op spijt.'},
            {text: 'De goedkoopste vrijheid is nee zeggen.'},
            {text: 'Wie uitgeeft alsof morgen vanzelf goedkomt, heeft nog niet lang genoeg geleefd.'}
        ];

        // SALARY PERIOD DEFINITIONS (CRITICAL - determines which month a date belongs to)
        // Using local Date constructor to avoid timezone issues
        const salaryPeriods = [
            {
                key: 'jan2026',
                name: 'Januari 2026',
                color: '#00BFFF',
                startDate: new Date(2026, 1, 9),   // 9 feb 2026 (month is 0-indexed)
                endDate: new Date(2026, 1, 23),    // 23 feb 2026
                salaryDate: null                    // No salary for jan2026
            },
            {
                key: 'feb2026',
                name: 'Februari 2026',
                color: '#FFD700',
                startDate: new Date(2026, 1, 24),  // 24 feb 2026
                endDate: new Date(2026, 2, 23),    // 23 mar 2026
                salaryDate: new Date(2026, 1, 24)
            },
            {
                key: 'mar2026',
                name: 'Maart 2026',
                color: '#00FF7F',
                startDate: new Date(2026, 2, 24),
                endDate: new Date(2026, 3, 23),
                salaryDate: new Date(2026, 2, 24)
            },
            {
                key: 'apr2026',
                name: 'April 2026',
                color: '#FF69B4',
                startDate: new Date(2026, 3, 24),
                endDate: new Date(2026, 4, 23),
                salaryDate: new Date(2026, 3, 24)
            },
            {
                key: 'may2026',
                name: 'Mei 2026',
                color: '#FF6347',
                startDate: new Date(2026, 4, 24),
                endDate: new Date(2026, 5, 23),
                salaryDate: new Date(2026, 4, 24)
            },
            {
                key: 'jun2026',
                name: 'Juni 2026',
                color: '#9370DB',
                startDate: new Date(2026, 5, 24),
                endDate: new Date(2026, 6, 23),
                salaryDate: new Date(2026, 5, 24)
            },
            {
                key: 'jul2026',
                name: 'Juli 2026',
                color: '#FFA500',
                startDate: new Date(2026, 6, 24),
                endDate: new Date(2026, 7, 23),
                salaryDate: new Date(2026, 6, 24)
            },
            {
                key: 'aug2026',
                name: 'Augustus 2026',
                color: '#20B2AA',
                startDate: new Date(2026, 7, 24),
                endDate: new Date(2026, 8, 23),
                salaryDate: new Date(2026, 7, 24)
            },
            {
                key: 'sep2026',
                name: 'September 2026',
                color: '#FF1493',
                startDate: new Date(2026, 8, 24),
                endDate: new Date(2026, 9, 23),
                salaryDate: new Date(2026, 8, 24)
            },
            {
                key: 'oct2026',
                name: 'Oktober 2026',
                color: '#FF4500',
                startDate: new Date(2026, 9, 24),
                endDate: new Date(2026, 10, 23),
                salaryDate: new Date(2026, 9, 24)
            },
            {
                key: 'nov2026',
                name: 'November 2026',
                color: '#8B4513',
                startDate: new Date(2026, 10, 24),
                endDate: new Date(2026, 11, 23),
                salaryDate: new Date(2026, 10, 24)
            },
            {
                key: 'dec2026',
                name: 'December 2026',
                color: '#DC143C',
                startDate: new Date(2026, 11, 24),
                endDate: new Date(2027, 0, 23),
                salaryDate: new Date(2026, 11, 24)
            }
        ];

        // CRITICAL DATE HELPERS (timezone-safe)
        
        // Returns start of day (00:00:00) for timezone-safe comparisons
        function startOfDay(date) {
            return new Date(date.getFullYear(), date.getMonth(), date.getDate());
        }
        
        // Get current date/time (device locale)
        function getNLDate() {
            return new Date();
        }
        
        // Format date as YYYY-MM-DD for storage keys
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Format date for display: "MA 9 FEB 2026"
        function formatDateNL(date) {
            const days = ['ZO', 'MA', 'DI', 'WO', 'DO', 'VR', 'ZA'];
            const months = ['JAN', 'FEB', 'MRT', 'APR', 'MEI', 'JUN', 'JUL', 'AUG', 'SEP', 'OKT', 'NOV', 'DEC'];
            return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        // CRITICAL: Get salary month key for a given date
        // This determines which salary period a date belongs to
        function getMonthKeyForDate(date) {
            const d = startOfDay(date);
            
            for (const period of salaryPeriods) {
                const start = startOfDay(period.startDate);
                const end = startOfDay(period.endDate);
                
                if (d >= start && d <= end) {
                    return period.key;
                }
            }
            
            // Fallback to first period if before all periods
            return salaryPeriods[0].key;
        }
        
        // Get the active salary month based on today
        function getActiveMonthKey() {
            return getMonthKeyForDate(getNLDate());
        }


        // Auto-switch viewed month ONLY when the active salary-month changes (e.g., on salary day).
        // This avoids hijacking the dropdown when the user is browsing older months.
        function ensureActiveMonthSynced() {
            const active = getActiveMonthKey();

            // First run: set lastActive if missing (do not force-switch if user already picked something)
            if (!appData.lastActiveMonthKey) {
                appData.lastActiveMonthKey = active;
                if (!appData.currentMonth) appData.currentMonth = active;
            }

            // Salary-month transition detected -> auto switch viewed month to active month
            if (appData.lastActiveMonthKey !== active) {
                appData.lastActiveMonthKey = active;
                appData.currentMonth = active;

                const selector = document.getElementById('monthSelector');
                if (selector) selector.value = active;

                saveData();

                // Optional: subtle confirmation toast
                try {
                    const label = (salaryPeriods.find(p => p.key === active) || {}).name || active;
                    showNotification('Nieuwe salarismaand', `Nu actief: ${label}`, 'success');
                } catch (e) {}
            } else {
                // Keep selector aligned with viewed month on load
                const selector = document.getElementById('monthSelector');
                if (selector && selector.value !== appData.currentMonth) selector.value = appData.currentMonth;
            }
        }


        
        // Get period info for a month key
        function getPeriodInfo(monthKey) {
            return salaryPeriods.find(p => p.key === monthKey) || salaryPeriods[0];
        }

        // MONEY MATH - CORE CALCULATIONS
        
        // Calculate grocery spending for a specific salary month (in cents)
        // Only counts days where entries exist
        function calculateMonthGroceriesCents(monthKey) {
            const monthGroceries = appData.groceries[monthKey] || {};
            let totalCents = 0;
            
            Object.values(monthGroceries).forEach(dayEntries => {
                if (Array.isArray(dayEntries)) {
                    dayEntries.forEach(entry => {
                        // Handle both old format (euros) and new format (cents)
                        if (entry.amountCents !== undefined) {
                            totalCents += Number(entry.amountCents) || 0;
                        } else if (entry.amount !== undefined) {
                            totalCents += toCents(entry.amount);
                        }
                    });
                }
            });
            
            return Math.round(totalCents);
        }
        
        // Calculate grocery SAVINGS for a month (budget - spent, only for days with entries)
        // CRITICAL: Only days WITH entries count. Days without entries = diff 0, not +35
        function calculateMonthGrocerySavingsCents(monthKey) {
            const monthGroceries = appData.groceries[monthKey] || {};
            let savingsCents = 0;
            
            // For each day with entries, calculate: budget (35) - actual
            Object.keys(monthGroceries).forEach(dateStr => {
                const dayEntries = monthGroceries[dateStr];
                if (Array.isArray(dayEntries) && dayEntries.length > 0) {
                    const dayTotalCents = dayEntries.reduce((sum, e) => {
                        if (e.amountCents !== undefined) {
                            return sum + (Number(e.amountCents) || 0);
                        } else if (e.amount !== undefined) {
                            return sum + toCents(e.amount);
                        }
                        return sum;
                    }, 0);
                    
                    // Diff = budget - spent (can be negative if overspent)
                    const diffCents = DAILY_GROCERY_BUDGET_CENTS - Math.round(dayTotalCents);
                    savingsCents += diffCents;
                }
            });
            
            return Math.round(savingsCents);
        }
        
        // Calculate free spending total for a month (in cents)
        function calculateMonthSpendingCents(monthKey) {
            const monthSpending = appData.spending[monthKey] || [];
            const total = monthSpending.reduce((sum, entry) => {
                if (entry.amountCents !== undefined) {
                    return sum + (Number(entry.amountCents) || 0);
                } else if (entry.amount !== undefined) {
                    return sum + toCents(entry.amount);
                }
                return sum;
            }, 0);
            return Math.round(total);
        }
        
        // CRITICAL: Calculate REALTIME total savings as of today
        // This is the core business logic
                function calculateRealtimeSavingsCents() {
                    const today = startOfDay(getNLDate());
                    let totalCents = START_SAVINGS_CENTS; // Baseline: ‚Ç¨750

                    // Process each salary period that has started (period.startDate <= today)
                    for (const period of salaryPeriods) {
                        const periodStart = startOfDay(period.startDate);

                        if (periodStart > today) break;

                        // Salary/auto-save: +‚Ç¨600 only for periods that actually have salary (not jan2026)
                        if (period.salaryDate) {
                            const sd = startOfDay(period.salaryDate);
                            if (sd <= today) totalCents += AUTO_SAVE_CENTS;
                        }

                        // Groceries delta: only days with entries (budget/day - spent/day)
                        totalCents += calculateMonthGrocerySavingsCents(period.key);

                        // Free budget should affect savings directly:
                        // +‚Ç¨424 at start of the period, and spending reduces savings 1:1.
                        const spentCents = calculateMonthSpendingCents(period.key);
                        totalCents += (getFreeBudgetCents(period.key) - spentCents);
                    }

                    return Math.round(totalCents);
                }
        
        // Calculate savings at start of a specific salary period
                function calculateSavingsAtPeriodStartCents(monthKey) {
                    const target = getPeriodInfo(monthKey);
                    const targetStart = startOfDay(target.startDate);

                    let totalCents = START_SAVINGS_CENTS;

                    for (const period of salaryPeriods) {
                        const pStart = startOfDay(period.startDate);

                        // Stop when we reach the target period
                        if (pStart > targetStart) break;

                        if (period.key === monthKey) {
                            // Credits that happen at the START of this period
                            if (period.salaryDate) totalCents += AUTO_SAVE_CENTS;
                            totalCents += getFreeBudgetCents(period.key);
                            break;
                        }

                        // Previous (fully completed) periods: include their realized impact
                        if (period.salaryDate) totalCents += AUTO_SAVE_CENTS;
                        totalCents += calculateMonthGrocerySavingsCents(period.key);

                        const spentCents = calculateMonthSpendingCents(period.key);
                        totalCents += (getFreeBudgetCents(period.key) - spentCents);
                    }

                    return Math.round(totalCents);
                }

        // PIN HANDLING (unchanged)
        let pinValue = '';

        function pinInput(num) {
            if (pinValue.length < 4) {
                pinValue += num;
                updatePinDots();
                if (pinValue.length === 4) {
                    setTimeout(pinSubmit, 300);
                }
            }
        }

        function pinClear() {
            if (pinValue.length > 0) {
                pinValue = pinValue.slice(0, -1);
                updatePinDots();
            }
        }

        function updatePinDots() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`dot${i}`);
                if (dot) {
                    if (i <= pinValue.length) {
                        dot.classList.add('filled');
                    } else {
                        dot.classList.remove('filled');
                    }
                }
            }
        }

                function pinSubmit() {
                    if (pinValue === appData.pin) {
                        document.getElementById('pinScreen').classList.add('hidden');
                        ensureActiveMonthSynced();
                        populateMonthSelector();
                        showWelcomeScreens();
                    } else {
                        const error = document.getElementById('pinError');
                        if (error) {
                            error.classList.add('show');
                            setTimeout(() => error.classList.remove('show'), 2000);
                        }
                        pinValue = '';
                        updatePinDots();
                    }
                }

        // WELCOME SCREENS (unchanged)
        function showWelcomeScreens() {
            const screen1 = document.getElementById('welcomeScreen1');
            if (screen1) {
                screen1.classList.remove('hidden');
                
                setTimeout(() => {
                    screen1.classList.add('hidden');
                    
                    const screen2 = document.getElementById('welcomeScreen2');
                    if (screen2) {
                        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
                        const quoteText = document.getElementById('quoteText');
                        if (quoteText) quoteText.textContent = randomQuote.text;
                        
                        screen2.classList.remove('hidden');
                        
                        setTimeout(() => {
                            screen2.classList.add('hidden');
                            const landing = document.getElementById('landingMenu');
                            if (landing) landing.classList.remove('hidden');
                        }, 3000);
                    }
                }, 2000);
            }
        }

        // ENTER APP
        function enterApp(view = 'dashboard') {
            const landing = document.getElementById('landingMenu');
            const app = document.getElementById('app');
            if (landing) landing.classList.add('hidden');
            if (app) app.classList.remove('hidden');
            showView(view);
        }

        // MENU
        function openMenu() {
            const menu = document.getElementById('fullscreenMenu');
            if (menu) menu.classList.add('active');
        }

        function closeMenu() {
            const menu = document.getElementById('fullscreenMenu');
            if (menu) menu.classList.remove('active');
        }

        // VIEW SWITCHING (fixed - no event dependencies)
        function showView(viewName) {
            closeMenu();
            
            const views = ['dashboardView', 'boodschappenView', 'vrijView', 'vasteLastenView', 'prognoseView', 'toolsView', 'settingsView'];
            views.forEach(v => {
                const el = document.getElementById(v);
                if (el) el.classList.add('hidden');
            });
            
            const targetView = document.getElementById(`${viewName}View`);
            if (targetView) {
                targetView.classList.remove('hidden');
            }
            
            // Update view content
            try {
                if (viewName === 'dashboard') {
                    updateDashboard();
                } else if (viewName === 'boodschappen') {
                    updateGroceriesView();
                } else if (viewName === 'vrij') {
                    updateSpendingView();
                } else if (viewName === 'vasteLasten') {
                    updateFixedCostsView();
                } else if (viewName === 'prognose') {
                    updatePrognoseView();
                } else if (viewName === 'settings') {
                    updateSettingsView();
                }
            } catch (error) {
                console.error('Error updating view:', error);
            }
        }

        // MONTH SWITCHING (VIEWED month, not active month)
        function changeMonth() {
            const selector = document.getElementById('monthSelector');
            if (selector) {
                appData.currentMonth = selector.value;
                saveData();
                updateAllViews();
            }
        }

                function updateAllViews() {
                    try {
                        ensureActiveMonthSynced(); // will auto-switch dropdown only when active period changes
                        updateDashboard();
                        updateGroceriesView();
                        updateSpendingView();
                        updateFixedCostsView();
                        updatePrognoseView();
                    } catch (error) {
                        console.error('Error updating all views:', error);
                    }
                }

        // DASHBOARD UPDATE (FIXED - uses realtime calculations)
        function updateDashboard() {
            try {
                const today = getNLDate();
                const activeMonthKey = getActiveMonthKey();
                const activePeriod = getPeriodInfo(activeMonthKey);
                
                // REALTIME TOTAL SAVINGS (fixed calculation)
                const realtimeTotalCents = calculateRealtimeSavingsCents();
                const totalEl = document.getElementById('totalSavings');
                if (totalEl) {
                    totalEl.textContent = formatEuro(realtimeTotalCents);
                }
                
                // THIS MONTH CHANGE (fixed - shows change in active period)
                const periodStartTotalCents = calculateSavingsAtPeriodStartCents(activeMonthKey);
                const monthChangeCents = realtimeTotalCents - periodStartTotalCents;
                
                const changeEl = document.getElementById('monthChange');
                if (changeEl) {
                    const sign = monthChangeCents >= 0 ? '+' : '';
                    const color = monthChangeCents >= 0 ? 'positive' : 'negative';
                    changeEl.innerHTML = `Deze maand: <span class="${color}">${sign}${formatEuro(monthChangeCents)}</span>`;
                }
                
                // TODAY
                const todayDateEl = document.getElementById('todayDate');
                if (todayDateEl) {
                    todayDateEl.textContent = formatDateNL(today);
                }
                
                const todayStr = formatDate(today);
                const todayMonthKey = getMonthKeyForDate(today);
                const todayGroceries = appData.groceries[todayMonthKey] || {};
                const todayEntries = todayGroceries[todayStr] || [];
                
                const todayTotalCents = todayEntries.reduce((sum, e) => {
                    if (e.amountCents !== undefined) return sum + (Number(e.amountCents) || 0);
                    if (e.amount !== undefined) return sum + toCents(e.amount);
                    return sum;
                }, 0);
                
                const todayStatusEl = document.getElementById('todayStatus');
                const todayTotalEl = document.getElementById('todayTotal');
                
                if (todayEntries.length === 0) {
                    if (todayStatusEl) todayStatusEl.textContent = 'Nog geen boodschappen ingevuld';
                    if (todayTotalEl) todayTotalEl.textContent = '';
                } else {
                    if (todayStatusEl) todayStatusEl.textContent = `${todayEntries.length} ${todayEntries.length === 1 ? 'item' : 'items'}`;
                    if (todayTotalEl) todayTotalEl.textContent = formatEuro(todayTotalCents);
                }
                
                // WEEK GRID
                updateWeekGrid('weekGrid');
                
                // STATS (for active month)
                const groceriesTotalCents = calculateMonthGroceriesCents(activeMonthKey);
                const groceriesTotalEl = document.getElementById('groceriesTotal');
                if (groceriesTotalEl) {
                    groceriesTotalEl.textContent = formatEuro(groceriesTotalCents);
                }
                
                const spendingTotalCents = calculateMonthSpendingCents(activeMonthKey);
                const spendingTotalEl = document.getElementById('spendingTotal');
                if (spendingTotalEl) {
                    spendingTotalEl.textContent = formatEuro(spendingTotalCents);
                }
                
                // Budget left (grocery savings + free budget remaining)
                const grocerySavingsCents = calculateMonthGrocerySavingsCents(activeMonthKey);
                const freeBudgetCents = getFreeBudgetCents(activeMonthKey);
                const freeRemainingCents = freeBudgetCents - spendingTotalCents;
                const budgetLeftCents = grocerySavingsCents + freeRemainingCents;
                
                const budgetLeftEl = document.getElementById('budgetLeft');
                if (budgetLeftEl) {
                    budgetLeftEl.textContent = formatEuro(budgetLeftCents);
                    // Color based on whether it's positive or negative
                    budgetLeftEl.className = 'stat-value ' + (budgetLeftCents >= 0 ? 'success' : 'warning');
                }
                
                const streakEl = document.getElementById('streakDays');
                if (streakEl) {
                    streakEl.textContent = `${appData.streak} üî•`;
                }
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        // WEEK GRID
                function updateWeekGrid(gridId) {
                    const grid = document.getElementById(gridId);
                    if (!grid) return;

                    grid.innerHTML = '';

                    const today = startOfDay(getNLDate());

                    // Week should run Monday -> Sunday (not "last 7 days")
                    const dow = today.getDay(); // 0=Sun..6=Sat
                    const diffToMonday = (dow + 6) % 7; // Mon=0, Tue=1, ..., Sun=6
                    const monday = new Date(today);
                    monday.setDate(monday.getDate() - diffToMonday);

                    const days = [];
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(monday);
                        d.setDate(monday.getDate() + i);
                        days.push(d);
                    }

                    const weekdayLabels = ['MA', 'DI', 'WO', 'DO', 'VR', 'ZA', 'ZO'];

                    days.forEach((day, idx) => {
                        const dateStr = formatDate(day);
                        const dayMonthKey = getMonthKeyForDate(day);

                        const monthGroceries = appData.groceries[dayMonthKey] || {};
                        const dayEntries = monthGroceries[dateStr] || [];

                        const dayTotalCents = dayEntries.reduce((sum, e) => {
                            if (e.amountCents !== undefined) return sum + (Number(e.amountCents) || 0);
                            if (e.amount !== undefined) return sum + toCents(e.amount);
                            return sum;
                        }, 0);

                        const dayBox = document.createElement('div');
                        dayBox.className = 'day-box';

                        if (dateStr === formatDate(today)) dayBox.classList.add('today');

                        const groceryBudgetCents = toCents(appData.groceryBudget || 35);
                        if (dayEntries.length > 0 && dayTotalCents > groceryBudgetCents) {
                            dayBox.classList.add('over-budget');
                        }

                        const dayLabel = document.createElement('div');
                        dayLabel.className = 'day-label';
                        dayLabel.textContent = weekdayLabels[idx];

                        const dayAmount = document.createElement('div');
                        dayAmount.className = 'day-amount';
                        dayAmount.textContent = dayEntries.length > 0 ? formatEuro(dayTotalCents) : '‚Äî';

                        dayBox.appendChild(dayLabel);
                        dayBox.appendChild(dayAmount);
                        grid.appendChild(dayBox);
                    });
                }

        // GROCERIES VIEW (uses VIEWED month from dropdown)
        function updateGroceriesView() {
            try {
                const viewedMonthKey = appData.currentMonth;
                const today = getNLDate();
                const todayStr = formatDate(today);
                
                // Today info
                const todayDateEl = document.getElementById('groceryTodayDate');
                if (todayDateEl) {
                    todayDateEl.textContent = formatDateNL(today);
                }
                
                const todayMonthKey = getMonthKeyForDate(today);
                const todayGroceries = appData.groceries[todayMonthKey] || {};
                const todayEntries = todayGroceries[todayStr] || [];
                const todayTotalCents = todayEntries.reduce((sum, e) => {
                    if (e.amountCents !== undefined) return sum + (Number(e.amountCents) || 0);
                    if (e.amount !== undefined) return sum + toCents(e.amount);
                    return sum;
                }, 0);
                
                const todayStatusEl = document.getElementById('groceryTodayStatus');
                const todayTotalEl = document.getElementById('groceryTodayTotal');
                
                if (todayEntries.length === 0) {
                    if (todayStatusEl) todayStatusEl.textContent = 'Nog geen boodschappen ingevuld';
                    if (todayTotalEl) todayTotalEl.textContent = '';
                } else {
                    if (todayStatusEl) todayStatusEl.textContent = `${todayEntries.length} ${todayEntries.length === 1 ? 'item' : 'items'}`;
                    if (todayTotalEl) todayTotalEl.textContent = formatEuro(todayTotalCents);
                }
                
                // Week grid
                updateWeekGrid('groceryWeekGrid');
                
                // Entries list (for VIEWED month)
                const entriesList = document.getElementById('groceryEntriesList');
                if (entriesList) {
                    entriesList.innerHTML = '';
                    
                    const viewedGroceries = appData.groceries[viewedMonthKey] || {};
                    const dates = Object.keys(viewedGroceries).sort().reverse();
                    
                    if (dates.length === 0) {
                        entriesList.innerHTML = '<div class="empty-state"><div class="empty-icon">üõí</div><div class="empty-text">Nog geen boodschappen deze maand</div></div>';
                    } else {
                        dates.forEach(dateStr => {
                            const dayEntries = viewedGroceries[dateStr];
                            const dayTotalCents = dayEntries.reduce((sum, e) => {
                                if (e.amountCents !== undefined) return sum + (Number(e.amountCents) || 0);
                                if (e.amount !== undefined) return sum + toCents(e.amount);
                                return sum;
                            }, 0);
                            
                            const date = new Date(dateStr + 'T00:00:00'); // Parse as local
                            
                            const dateHeader = document.createElement('div');
                            dateHeader.className = 'section-header';
                            dateHeader.textContent = `${formatDateNL(date)} - Totaal: ${formatEuro(dayTotalCents)}`;
                            entriesList.appendChild(dateHeader);
                            
                            dayEntries.forEach((entry, index) => {
                                const entryItem = document.createElement('div');
                                entryItem.className = 'entry-item';
                                
                                const entryInfo = document.createElement('div');
                                entryInfo.className = 'entry-info';
                                
                                const entryAmount = document.createElement('div');
                                entryAmount.className = 'entry-amount';
                                const amountCents = entry.amountCents !== undefined ? entry.amountCents : toCents(entry.amount);
                                entryAmount.textContent = formatEuro(amountCents);
                                
                                const entryNote = document.createElement('div');
                                entryNote.className = 'entry-note';
                                entryNote.textContent = entry.note || 'Geen notitie';
                                
                                entryInfo.appendChild(entryAmount);
                                entryInfo.appendChild(entryNote);
                                
                                const entryActions = document.createElement('div');
                                entryActions.className = 'entry-actions';
                                
                                const editBtn = document.createElement('button');
                                editBtn.className = 'entry-btn edit';
                                editBtn.textContent = '‚úèÔ∏è';
                                editBtn.onclick = () => editGrocery(viewedMonthKey, dateStr, index);
                                
                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'entry-btn delete';
                                deleteBtn.textContent = 'üóëÔ∏è';
                                deleteBtn.onclick = () => deleteGrocery(viewedMonthKey, dateStr, index);
                                
                                entryActions.appendChild(editBtn);
                                entryActions.appendChild(deleteBtn);
                                
                                entryItem.appendChild(entryInfo);
                                entryItem.appendChild(entryActions);
                                entriesList.appendChild(entryItem);
                            });
                        });
                    }
                }
            } catch (error) {
                console.error('Error updating groceries view:', error);
            }
        }

        // QUICK ADD GROCERY (FIXED - saves to active month, not viewed month)
                function quickAddGrocery(amountEuros) {
                    const today = getNLDate();
                    const todayStr = formatDate(today);
                    const activeMonthKey = getMonthKeyForDate(today); // use ACTIVE salary month

                    if (!appData.groceries[activeMonthKey]) appData.groceries[activeMonthKey] = {};
                    if (!appData.groceries[activeMonthKey][todayStr]) appData.groceries[activeMonthKey][todayStr] = [];

                    appData.groceries[activeMonthKey][todayStr].push({
                        amountCents: toCents(amountEuros),
                        note: '',
                        timestamp: new Date().toISOString()
                    });

                    saveData();
                    updateAllViews();

                    // IMPORTANT: budget feedback must be based on TOTAL spent today (not just this single entry)
                    const dayTotalCents = appData.groceries[activeMonthKey][todayStr]
                        .reduce((sum, e) => sum + (Number(e.amountCents) || 0), 0);

                    const diff = DAILY_GROCERY_BUDGET_CENTS - dayTotalCents; // + = under budget, - = over budget

                    const newTotalCents = calculateRealtimeSavingsCents();
                    const newTotal = formatEuro(newTotalCents);

                    let message = '';
                    let type = 'success';

                    if (diff > 0) {
                        const saved = formatEuro(diff);
                        message = `Onder dagbudget: +${saved} impact. Totaal: ${newTotal}`;
                        type = 'success';
                    } else if (diff === 0) {
                        message = `Exact dagbudget. Totaal: ${newTotal}`;
                        type = 'success';
                    } else {
                        const loss = formatEuro(Math.abs(diff));
                        message = `Over dagbudget: -${loss} impact. Totaal: ${newTotal}`;
                        type = 'warning';
                    }

                    if (activeMonthKey !== appData.currentMonth) {
                        const periodName = getPeriodInfo(activeMonthKey).name;
                        showNotification('Opgeslagen', `‚Ç¨${amountEuros.toFixed(2)} ‚Üí ${periodName}`, 'info');
                    }

                    showNotification('Boodschappen', message, type);
                    checkStreak();
                }

        // MODALS
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('hidden');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('hidden');
        }

        // ADD GROCERY (FIXED - saves to active month)
        let editingGrocery = null;

        function openAddGroceryModal() {
            const amountField = document.getElementById('groceryAmount');
            const noteField = document.getElementById('groceryNote');
            if (amountField) amountField.value = '';
            if (noteField) noteField.value = '';
            openModal('addGroceryModal');
        }

                function addGrocery() {
                    const amountEuros = parseFloat(document.getElementById('groceryAmount')?.value || 0);
                    const note = document.getElementById('groceryNote')?.value || '';

                    if (amountEuros <= 0) {
                        showNotification('Fout', 'Voer een geldig bedrag in', 'warning');
                        return;
                    }

                    const today = getNLDate();
                    const todayStr = formatDate(today);
                    const activeMonthKey = getMonthKeyForDate(today); // use ACTIVE salary month

                    if (!appData.groceries[activeMonthKey]) appData.groceries[activeMonthKey] = {};
                    if (!appData.groceries[activeMonthKey][todayStr]) appData.groceries[activeMonthKey][todayStr] = [];

                    appData.groceries[activeMonthKey][todayStr].push({
                        amountCents: toCents(amountEuros),
                        note: note,
                        timestamp: new Date().toISOString()
                    });

                    saveData();
                    closeModal('addGroceryModal');
                    updateAllViews();

                    // IMPORTANT: budget feedback must be based on TOTAL spent today (not just this single entry)
                    const dayTotalCents = appData.groceries[activeMonthKey][todayStr]
                        .reduce((sum, e) => sum + (Number(e.amountCents) || 0), 0);

                    const diff = DAILY_GROCERY_BUDGET_CENTS - dayTotalCents; // + = under budget, - = over budget

                    const newTotalCents = calculateRealtimeSavingsCents();
                    const newTotal = formatEuro(newTotalCents);

                    let message = '';
                    let type = 'success';

                    if (diff > 0) {
                        const saved = formatEuro(diff);
                        message = `Onder dagbudget: +${saved} impact. Totaal: ${newTotal}`;
                        type = 'success';
                    } else if (diff === 0) {
                        message = `Exact dagbudget. Totaal: ${newTotal}`;
                        type = 'success';
                    } else {
                        const loss = formatEuro(Math.abs(diff));
                        message = `Over dagbudget: -${loss} impact. Totaal: ${newTotal}`;
                        type = 'warning';
                    }

                    if (activeMonthKey !== appData.currentMonth) {
                        const periodName = getPeriodInfo(activeMonthKey).name;
                        showNotification('Opgeslagen', `${formatEuro(toCents(amountEuros))} ‚Üí ${periodName}`, 'info');
                    }

                    showNotification('Boodschappen', message, type);

                    checkStreak();
                }

        function editGrocery(monthKey, dateStr, index) {
            const entry = appData.groceries[monthKey][dateStr][index];
            editingGrocery = {monthKey, dateStr, index};
            
            const amountCents = entry.amountCents !== undefined ? entry.amountCents : toCents(entry.amount);
            
            const amountField = document.getElementById('editGroceryAmount');
            const noteField = document.getElementById('editGroceryNote');
            if (amountField) amountField.value = fromCents(amountCents);
            if (noteField) noteField.value = entry.note || '';
            
            openModal('editGroceryModal');
        }

        function saveEditGrocery() {
            if (!editingGrocery) return;
            
            const amountEuros = parseFloat(document.getElementById('editGroceryAmount')?.value || 0);
            const note = document.getElementById('editGroceryNote')?.value || '';
            
            if (amountEuros <= 0) {
                showNotification('Fout', 'Voer een geldig bedrag in', 'warning');
                return;
            }
            
            appData.groceries[editingGrocery.monthKey][editingGrocery.dateStr][editingGrocery.index] = {
                amountCents: toCents(amountEuros),
                note: note,
                timestamp: new Date().toISOString()
            };
            
            saveData();
            closeModal('editGroceryModal');
            updateAllViews();
            showNotification('Opgeslagen! ‚úÖ', 'Boodschappen bijgewerkt', 'success');
            editingGrocery = null;
        }

        function deleteGrocery(monthKey, dateStr, index) {
            if (confirm('Weet je zeker dat je deze boodschappen wilt verwijderen?')) {
                appData.groceries[monthKey][dateStr].splice(index, 1);
                
                if (appData.groceries[monthKey][dateStr].length === 0) {
                    delete appData.groceries[monthKey][dateStr];
                }
                
                saveData();
                updateAllViews();
                showNotification('Verwijderd', 'Boodschappen verwijderd', 'info');
            }
        }

        // SPENDING VIEW (uses VIEWED month)
        function updateSpendingView() {
            try {
                const viewedMonthKey = appData.currentMonth;
                const monthSpending = appData.spending[viewedMonthKey] || [];
                
                const totalCents = Math.round(monthSpending.reduce((sum, e) => {
                    if (e.amountCents !== undefined) return sum + (Number(e.amountCents) || 0);
                    if (e.amount !== undefined) return sum + toCents(e.amount);
                    return sum;
                }, 0));
                
                const monthBudgetCents = getFreeBudgetCents(viewedMonthKey);
                const budgetEl = document.getElementById('vrijBudget');
                if (budgetEl) budgetEl.textContent = formatEuro(monthBudgetCents);

                const leftCents = Math.round(monthBudgetCents - totalCents);
                
                const leftEl = document.getElementById('vrijLeft');
                if (leftEl) {
                    const color = leftCents >= 0 ? 'positive' : 'negative';
                    leftEl.innerHTML = `Nog: <span class="${color}">${formatEuro(leftCents)}</span>`;
                }
                
                const list = document.getElementById('spendingList');
                if (list) {
                    list.innerHTML = '';
                    
                    if (monthSpending.length === 0) {
                        list.innerHTML = '<div class="empty-state"><div class="empty-icon">üéâ</div><div class="empty-text">Nog geen uitgaven deze maand</div></div>';
                    } else {
                        monthSpending.forEach((entry, index) => {
                            const item = document.createElement('div');
                            item.className = 'entry-item';
                            
                            const info = document.createElement('div');
                            info.className = 'entry-info';
                            
                            const amount = document.createElement('div');
                            amount.className = 'entry-amount';
                            const amountCents = entry.amountCents !== undefined ? entry.amountCents : toCents(entry.amount);
                            amount.textContent = formatEuro(amountCents);
                            
                            const category = document.createElement('div');
                            category.className = 'entry-note';
                            category.textContent = entry.category || 'Geen categorie';
                            
                            const note = document.createElement('div');
                            note.className = 'entry-date';
                            note.textContent = entry.note || '';
                            
                            info.appendChild(amount);
                            info.appendChild(category);
                            info.appendChild(note);
                            
                            const actions = document.createElement('div');
                            actions.className = 'entry-actions';
                            
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'entry-btn delete';
                            deleteBtn.textContent = 'üóëÔ∏è';
                            deleteBtn.onclick = () => deleteSpending(viewedMonthKey, index);
                            
                            actions.appendChild(deleteBtn);
                            
                            item.appendChild(info);
                            item.appendChild(actions);
                            list.appendChild(item);
                        });
                    }
                }
            } catch (error) {
                console.error('Error updating spending view:', error);
            }
        }

        function openAddSpendingModal() {
            const categoryField = document.getElementById('spendingCategory');
            const amountField = document.getElementById('spendingAmount');
            const noteField = document.getElementById('spendingNote');
            if (categoryField) categoryField.value = '';
            if (amountField) amountField.value = '';
            if (noteField) noteField.value = '';
            openModal('addSpendingModal');
        }

        function addSpending() {
            const category = document.getElementById('spendingCategory')?.value || '';
            const amountEuros = parseFloat(document.getElementById('spendingAmount')?.value || 0);
            const note = document.getElementById('spendingNote')?.value || '';
            
            if (!category || amountEuros <= 0) {
                showNotification('Fout', 'Voer een categorie en geldig bedrag in', 'warning');
                return;
            }
            
            const activeMonthKey = getActiveMonthKey(); // CRITICAL: save to active month
            
            if (!appData.spending[activeMonthKey]) {
                appData.spending[activeMonthKey] = [];
            }
            
            appData.spending[activeMonthKey].push({
                category: category,
                amountCents: toCents(amountEuros),
                note: note,
                date: new Date().toISOString()
            });
            
            saveData();
            closeModal('addSpendingModal');
            updateAllViews();
            
            // Calculate impact on TOTAL SAVINGS
            const spentAmountCents = toCents(amountEuros);
            const newTotalCents = calculateRealtimeSavingsCents();
            const newTotal = formatEuro(newTotalCents);
            
            // Calculate remaining free budget
            const totalSpentCents = calculateMonthSpendingCents(activeMonthKey);
            const leftCents = getFreeBudgetCents(activeMonthKey) - totalSpentCents;
            
            // Messages focused on SPAARGELD IMPACT
            let message = '';
            let type = 'success';
            
            if (leftCents > 30000) { // ‚Ç¨300+ remaining - SAVING WELL
                const left = formatEuro(leftCents);
                const saving = formatEuro(leftCents); // This will be saved
                const messages = [
                    `üí∞ Nog ${left} onuitgegeven = meer sparen! Totaal: ${newTotal}`,
                    `‚ú® ${left} vrij ‚Üí Gaat naar spaarpot. Stand: ${newTotal}`,
                    `üëë ${saving} kan nog gespaard. Totaal nu: ${newTotal}`,
                    `üíé ${left} over = potentieel sparen. Stand: ${newTotal}`
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
            } else if (leftCents > 15000) { // ‚Ç¨150-300 remaining
                const left = formatEuro(leftCents);
                const messages = [
                    `‚ö° Nog ${left} te sparen mogelijk. Totaal: ${newTotal}`,
                    `üéØ ${left} vrij ‚Üí Wordt sparen als je stopt. Stand: ${newTotal}`,
                    `‚ö†Ô∏è ${left} kan gespaard. Totaal nu: ${newTotal}`
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                type = 'info';
            } else if (leftCents > 5000) { // ‚Ç¨50-150 remaining - CRITICAL
                const left = formatEuro(leftCents);
                const messages = [
                    `üö® Nog ${left}! Stop nu = meer sparen. Stand: ${newTotal}`,
                    `‚õî ${left} rest voor spaarpot. Totaal: ${newTotal}`,
                    `‚ö†Ô∏è Elke euro nu pakt ‚Ç¨1 van spaardoel. Stand: ${newTotal}`,
                    `üî¥ ${left} = spaarpotentieel. Nu stoppen! Totaal: ${newTotal}`
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                type = 'warning';
            } else if (leftCents > 0) { // ‚Ç¨0-50 remaining - DANGER
                const left = formatEuro(leftCents);
                const messages = [
                    `üî• ${left} rest voor sparen. Elk cent telt! Stand: ${newTotal}`,
                    `üíÄ Laatste ${left} voor spaarpot. Totaal: ${newTotal}`,
                    `‚õî Bijna overspend = min sparen. Stand: ${newTotal}`
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                type = 'warning';
            } else { // OVERSPENT - EATING INTO SAVINGS
                const loss = formatEuro(Math.abs(leftCents));
                const messages = [
                    `üí∏ ${loss} VERLIES van spaardoel! Totaal: ${newTotal}`,
                    `üö® ${loss} minder gespaard door overspend. Stand: ${newTotal}`,
                    `‚ö†Ô∏è Overspend pakt ${loss} van je vrijheid. Totaal: ${newTotal}`,
                    `‚ùå ${loss} verlies. Dit is spijt. Stand: ${newTotal}`
                ];
                message = messages[Math.floor(Math.random() * messages.length)];
                type = 'warning';
            }
            
            // Show which month if different
            if (activeMonthKey !== appData.currentMonth) {
                const periodName = getPeriodInfo(activeMonthKey).name;
                showNotification('Opgeslagen', `${formatEuro(spentAmountCents)} ‚Üí ${periodName}`, 'info');
            }
            
            showNotification('Spaargeld Impact', message, type);
        }

        function deleteSpending(monthKey, index) {
            if (confirm('Weet je zeker dat je deze uitgave wilt verwijderen?')) {
                appData.spending[monthKey].splice(index, 1);
                saveData();
                updateAllViews();
                showNotification('Verwijderd', 'Uitgave verwijderd', 'info');
            }
        }

        // FIXED COSTS VIEW (unchanged, using cents)
                // ---- INCOME & FIXED COSTS (editable) ----

        function genId(prefix) {
            return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        }

        function ensureIncomeForMonth(monthKey) {
            if (!appData.income || typeof appData.income !== 'object') appData.income = {};
            if (!Array.isArray(appData.income[monthKey])) {
                // Copy from most recent previous month if possible, otherwise create a default salary placeholder
                const idx = salaryPeriods.findIndex(p => p.key === monthKey);
                let copied = null;
                if (idx > 0) {
                    for (let i = idx - 1; i >= 0; i--) {
                        const prevKey = salaryPeriods[i].key;
                        if (Array.isArray(appData.income[prevKey]) && appData.income[prevKey].length > 0) {
                            copied = appData.income[prevKey].map(x => ({
                                id: genId('inc'),
                                name: x.name || 'Salaris',
                                amountCents: Number(x.amountCents) || 0,
                                createdAt: new Date().toISOString()
                            }));
                            break;
                        }
                    }
                }
                appData.income[monthKey] = copied || [{
                    id: genId('inc'),
                    name: 'Salaris',
                    amountCents: 430000,
                    createdAt: new Date().toISOString()
                }];
                saveData();
            }

            // Ensure ids exist
            appData.income[monthKey].forEach(item => {
                if (!item.id) item.id = genId('inc');
                if (item.amountCents === undefined && item.amount !== undefined) item.amountCents = toCents(item.amount);
            });
        }

        function ensureFixedCostsIds() {
            if (!appData.fixedCosts || typeof appData.fixedCosts !== 'object') {
                appData.fixedCosts = {huis: [], verzekeringen: [], abonnementen: [], leningen: [], overigVast: [], vliegtuig: [], overig: []};
            }
            ['huis', 'verzekeringen', 'abonnementen', 'leningen', 'overigVast', 'vliegtuig', 'overig'].forEach(cat => {
                if (!Array.isArray(appData.fixedCosts[cat])) appData.fixedCosts[cat] = [];
                appData.fixedCosts[cat].forEach(item => {
                    if (!item.id) item.id = genId('fix');
                    if (item.amountCents === undefined && item.amount !== undefined) item.amountCents = toCents(item.amount);
                });
            });
        }
        function seedUserFinanceDefaultsIfNeeded() {
            // Only seed if user hasn't configured anything yet, or if we detect demo placeholders.
            if (appData.userFinanceSeeded) return;

            try {
                const huis = Array.isArray(appData.fixedCosts?.huis) ? appData.fixedCosts.huis : [];
                const abonnementen = Array.isArray(appData.fixedCosts?.abonnementen) ? appData.fixedCosts.abonnementen : [];
                const looksLikeDemo =
                    huis.some(x => (x.name || '').toLowerCase().includes('gas/licht/water')) ||
                    abonnementen.some(x => (x.name || '').toLowerCase().includes('netflix'));

                const fixedCount =
                    Object.values(appData.fixedCosts || {}).reduce((sum, arr) => sum + (Array.isArray(arr) ? arr.length : 0), 0);

                // Seed only if empty OR demo data
                if (fixedCount === 0 || looksLikeDemo) {
                    appData.fixedCosts = {
                        huis: [
                            {id: genId('fix'), name: 'Huur', amountCents: 88800},
                            {id: genId('fix'), name: 'Energie', amountCents: 16000},
                            {id: genId('fix'), name: 'Water', amountCents: 1400}
                        ],
                        verzekeringen: [
                            {id: genId('fix'), name: 'CZ', amountCents: 19100},
                            {id: genId('fix'), name: 'Fietsverzekering', amountCents: 1100}
                        ],
                        abonnementen: [
                            {id: genId('fix'), name: 'Internet', amountCents: 2500},
                            {id: genId('fix'), name: 'Telefoon', amountCents: 2900},
                            {id: genId('fix'), name: 'Spotify', amountCents: 1300},
                            {id: genId('fix'), name: 'iCloud', amountCents: 1000},
                            {id: genId('fix'), name: 'OpenAI', amountCents: 2200},
                            {id: genId('fix'), name: 'CapCut', amountCents: 1200},
                            {id: genId('fix'), name: 'Gym', amountCents: 3300},
                            {id: genId('fix'), name: 'NS', amountCents: 2000},
                            {id: genId('fix'), name: 'Urban', amountCents: 5000}
                        ],
                        leningen: [
                            {id: genId('fix'), name: 'Sant', amountCents: 9300},
                            {id: genId('fix'), name: 'Lening', amountCents: 9700}
                        ],
                        overigVast: [
                            {id: genId('fix'), name: 'Kapper', amountCents: 13800},
                            {id: genId('fix'), name: 'Supplementen', amountCents: 7000}
                        ],
                        vliegtuig: [
                            {id: genId('fix'), name: 'Vlucht', amountCents: 35000}
                        ],
                        overig: []
                    };
                }

                // Seed income only if empty or default 0 for current month
                ensureIncomeForMonth(appData.currentMonth);
                const inc = appData.income?.[appData.currentMonth] || [];
                if (inc.length === 1 && (inc[0].name || '').toLowerCase().includes('salaris') && (Number(inc[0].amountCents) || 0) === 0) {
                    inc[0].amountCents = 430000; // ‚Ç¨4.300
                }

                appData.userFinanceSeeded = true;
                saveData();
            } catch (e) {
                console.warn('Seeding defaults failed:', e);
            }
        }


        let editingIncome = null;     // {monthKey, id}
        let editingFixedCost = null;  // {category, id}

        function addIncome() {
            const monthKey = appData.currentMonth; // income is per selected salary month
            ensureIncomeForMonth(monthKey);

            const nameEl = document.getElementById('incomeName');
            const amountEl = document.getElementById('incomeAmount');

            const name = (nameEl?.value || '').trim() || 'Inkomen';
            const amount = parseFloat(amountEl?.value || '0');

            if (!isFinite(amount) || amount <= 0) {
                showNotification('Fout', 'Voer een geldig bedrag in', 'warning');
                return;
            }

            appData.income[monthKey].push({
                id: genId('inc'),
                name,
                amountCents: toCents(amount),
                createdAt: new Date().toISOString()
            });

            saveData();
            closeModal('addIncomeModal');
            if (nameEl) nameEl.value = 'Salaris';
            if (amountEl) amountEl.value = '';
            updateAllViews();
            showNotification('Toegevoegd', 'Inkomen toegevoegd', 'success');
        }

        function editIncome(monthKey, id) {
            ensureIncomeForMonth(monthKey);
            const item = appData.income[monthKey].find(x => x.id === id);
            if (!item) return;

            editingIncome = {monthKey, id};

            const nameEl = document.getElementById('editIncomeName');
            const amountEl = document.getElementById('editIncomeAmount');
            if (nameEl) nameEl.value = item.name || '';
            if (amountEl) amountEl.value = fromCents(item.amountCents);

            openModal('editIncomeModal');
        }

        function saveEditIncome() {
            if (!editingIncome) return;

            const nameEl = document.getElementById('editIncomeName');
            const amountEl = document.getElementById('editIncomeAmount');

            const name = (nameEl?.value || '').trim() || 'Inkomen';
            const amount = parseFloat(amountEl?.value || '0');

            if (!isFinite(amount) || amount <= 0) {
                showNotification('Fout', 'Voer een geldig bedrag in', 'warning');
                return;
            }

            const list = appData.income[editingIncome.monthKey] || [];
            const idx = list.findIndex(x => x.id === editingIncome.id);
            if (idx === -1) return;

            list[idx].name = name;
            list[idx].amountCents = toCents(amount);

            saveData();
            closeModal('editIncomeModal');
            editingIncome = null;
            updateAllViews();
            showNotification('Opgeslagen', 'Inkomen bijgewerkt', 'success');
        }

        function deleteIncome(monthKey, id) {
            if (!confirm('Weet je zeker dat je dit inkomen wilt verwijderen?')) return;
            ensureIncomeForMonth(monthKey);
            appData.income[monthKey] = (appData.income[monthKey] || []).filter(x => x.id !== id);
            saveData();
            updateAllViews();
            showNotification('Verwijderd', 'Inkomen verwijderd', 'info');
        }

        function addFixedCost() {
            ensureFixedCostsIds();
            const catEl = document.getElementById('fixedCostCategory');
            const nameEl = document.getElementById('fixedCostName');
            const amountEl = document.getElementById('fixedCostAmount');

            const category = catEl?.value || 'overig';
            const name = (nameEl?.value || '').trim() || 'Vaste last';
            const amount = parseFloat(amountEl?.value || '0');

            if (!isFinite(amount) || amount <= 0) {
                showNotification('Fout', 'Voer een geldig bedrag in', 'warning');
                return;
            }

            appData.fixedCosts[category].push({
                id: genId('fix'),
                name,
                amountCents: toCents(amount)
            });

            saveData();
            closeModal('addFixedCostModal');
            if (nameEl) nameEl.value = '';
            if (amountEl) amountEl.value = '';
            updateAllViews();
            showNotification('Toegevoegd', 'Vaste last toegevoegd', 'success');
        }

        function editFixedCost(category, id) {
            ensureFixedCostsIds();
            const item = (appData.fixedCosts[category] || []).find(x => x.id === id);
            if (!item) return;

            editingFixedCost = {category, id};

            const nameEl = document.getElementById('editFixedCostName');
            const amountEl = document.getElementById('editFixedCostAmount');
            if (nameEl) nameEl.value = item.name || '';
            if (amountEl) amountEl.value = fromCents(item.amountCents);

            openModal('editFixedCostModal');
        }

        function saveEditFixedCost() {
            if (!editingFixedCost) return;
            ensureFixedCostsIds();

            const nameEl = document.getElementById('editFixedCostName');
            const amountEl = document.getElementById('editFixedCostAmount');

            const name = (nameEl?.value || '').trim() || 'Vaste last';
            const amount = parseFloat(amountEl?.value || '0');

            if (!isFinite(amount) || amount <= 0) {
                showNotification('Fout', 'Voer een geldig bedrag in', 'warning');
                return;
            }

            const list = appData.fixedCosts[editingFixedCost.category] || [];
            const idx = list.findIndex(x => x.id === editingFixedCost.id);
            if (idx === -1) return;

            list[idx].name = name;
            list[idx].amountCents = toCents(amount);

            saveData();
            closeModal('editFixedCostModal');
            editingFixedCost = null;
            updateAllViews();
            showNotification('Opgeslagen', 'Vaste last bijgewerkt', 'success');
        }

        function deleteFixedCost(category, id) {
            if (!confirm('Weet je zeker dat je deze vaste last wilt verwijderen?')) return;
            ensureFixedCostsIds();
            appData.fixedCosts[category] = (appData.fixedCosts[category] || []).filter(x => x.id !== id);
            saveData();
            updateAllViews();
            showNotification('Verwijderd', 'Vaste last verwijderd', 'info');
        }

        // FIXED COSTS VIEW (editable)
                                                                                                                                                                                                                                                                function updateFixedCostsView() {
                                                                                                                                                                                                                                                                    try {
                                                                                                                                                                                                                                                                        ensureFixedCostsIds();
                                                                                                                                                                                                                                                                        ensureIncomeForMonth(appData.currentMonth);

                                                                                                                                                                                                                                                                        const monthKey = appData.currentMonth;
                                                                                                                                                                                                                                                                        const period = salaryPeriods.find(p => p.key === monthKey);
                                                                                                                                                                                                                                                                        const periodName = period ? period.name : monthKey;

                                                                                                                                                                                                                                                                        // Income
                                                                                                                                                                                                                                                                        const incomeListEl = document.getElementById('incomeList');
                                                                                                                                                                                                                                                                        const incomeTotalEl = document.getElementById('incomeTotal');
                                                                                                                                                                                                                                                                        const incomeSubtextEl = document.getElementById('incomeSubtext');

                                                                                                                                                                                                                                                                        const incomes = (appData.income[monthKey] || []);
                                                                                                                                                                                                                                                                        let incomeTotalCents = 0;

                                                                                                                                                                                                                                                                        if (incomeListEl) incomeListEl.innerHTML = '';
                                                                                                                                                                                                                                                                        incomes.forEach(item => {
                                                                                                                                                                                                                                                                            incomeTotalCents += Number(item.amountCents) || 0;

                                                                                                                                                                                                                                                                            if (!incomeListEl) return;
                                                                                                                                                                                                                                                                            const row = document.createElement('div');
                                                                                                                                                                                                                                                                            row.className = 'cost-item';

                                                                                                                                                                                                                                                                            const left = document.createElement('div');
                                                                                                                                                                                                                                                                            left.className = 'two-col';
                                                                                                                                                                                                                                                                            left.style.flex = '1';

                                                                                                                                                                                                                                                                            const nameEl = document.createElement('div');
                                                                                                                                                                                                                                                                            nameEl.className = 'cost-name';
                                                                                                                                                                                                                                                                            nameEl.textContent = item.name || 'Inkomen';

                                                                                                                                                                                                                                                                            const right = document.createElement('div');
                                                                                                                                                                                                                                                                            right.className = 'right-col';

                                                                                                                                                                                                                                                                            const amountEl = document.createElement('div');
                                                                                                                                                                                                                                                                            amountEl.className = 'cost-amount';
                                                                                                                                                                                                                                                                            amountEl.textContent = formatEuro(item.amountCents);

                                                                                                                                                                                                                                                                            const actions = document.createElement('div');
                                                                                                                                                                                                                                                                            actions.className = 'row-actions';
                                                                                                                                                                                                                                                                            actions.innerHTML = `
                                                                                                                                                                                                                                                                                <button class="btn-mini" onclick="editIncome('${monthKey}','${item.id}')">Wijzig</button>
                                                                                                                                                                                                                                                                                <button class="btn-mini danger" onclick="deleteIncome('${monthKey}','${item.id}')">Verwijder</button>
                                                                                                                                                                                                                                                                            `;

                                                                                                                                                                                                                                                                            right.appendChild(amountEl);
                                                                                                                                                                                                                                                                            right.appendChild(actions);

                                                                                                                                                                                                                                                                            row.appendChild(nameEl);
                                                                                                                                                                                                                                                                            row.appendChild(right);
                                                                                                                                                                                                                                                                            incomeListEl.appendChild(row);
                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                        if (incomeTotalEl) incomeTotalEl.textContent = formatEuro(incomeTotalCents);
                                                                                                                                                                                                                                                                        if (incomeSubtextEl) incomeSubtextEl.textContent = `Salarismaand: ${periodName}`;

                                                                                                                                                                                                                                                                        // Fixed costs
                                                                                                                                                                                                                                                                        let fixedTotalCents = 0;
                                                                                                                                                                                                                                                                        const fixedListEl = document.getElementById('fixedCostsList');
                                                                                                                                                                                                                                                                        if (fixedListEl) fixedListEl.innerHTML = '';

                                                                                                                                                                                                                                                                        const categories = [
                                                                                                                                                                                                                                                                            {key: 'huis', title: 'üè† Huis'},
                                                                                                                                                                                                                                                                            {key: 'verzekeringen', title: 'üõ°Ô∏è Verzekeringen'},
                                                                                                                                                                                                                                                                            {key: 'abonnementen', title: 'üì± Abonnementen'},
                                                                                                                                                                                                                                                                            {key: 'leningen', title: 'üí≥ Leningen'},
                                                                                                                                                                                                                                                                            {key: 'overigVast', title: 'üìå Overig vast'},
                                                                                                                                                                                                                                                                            {key: 'vliegtuig', title: '‚úàÔ∏è Vliegtuig'},
                                                                                                                                                                                                                                                                            {key: 'overig', title: 'üì¶ Overig'}
                                                                                                                                                                                                                                                                        ];

                                                                                                                                                                                                                                                                        categories.forEach(cat => {
                                                                                                                                                                                                                                                                            const items = appData.fixedCosts[cat.key] || [];
                                                                                                                                                                                                                                                                            if (!fixedListEl) return;

                                                                                                                                                                                                                                                                            const categoryDiv = document.createElement('div');
                                                                                                                                                                                                                                                                            categoryDiv.className = 'cost-category';

                                                                                                                                                                                                                                                                            const categoryTitle = document.createElement('div');
                                                                                                                                                                                                                                                                            categoryTitle.className = 'category-title';
                                                                                                                                                                                                                                                                            categoryTitle.textContent = cat.title;
                                                                                                                                                                                                                                                                            categoryDiv.appendChild(categoryTitle);

                                                                                                                                                                                                                                                                            if (items.length === 0) {
                                                                                                                                                                                                                                                                                const empty = document.createElement('div');
                                                                                                                                                                                                                                                                                empty.className = 'muted-text';
                                                                                                                                                                                                                                                                                empty.style.margin = '8px 0 14px';
                                                                                                                                                                                                                                                                                empty.textContent = 'Geen vaste lasten in deze categorie.';
                                                                                                                                                                                                                                                                                categoryDiv.appendChild(empty);
                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                items.forEach(item => {
                                                                                                                                                                                                                                                                                    const row = document.createElement('div');
                                                                                                                                                                                                                                                                                    row.className = 'cost-item';

                                                                                                                                                                                                                                                                                    const nameEl = document.createElement('div');
                                                                                                                                                                                                                                                                                    nameEl.className = 'cost-name';
                                                                                                                                                                                                                                                                                    nameEl.textContent = item.name;

                                                                                                                                                                                                                                                                                    const right = document.createElement('div');
                                                                                                                                                                                                                                                                                    right.className = 'right-col';

                                                                                                                                                                                                                                                                                    const amountEl = document.createElement('div');
                                                                                                                                                                                                                                                                                    amountEl.className = 'cost-amount';
                                                                                                                                                                                                                                                                                    amountEl.textContent = formatEuro(item.amountCents);

                                                                                                                                                                                                                                                                                    const actions = document.createElement('div');
                                                                                                                                                                                                                                                                                    actions.className = 'row-actions';
                                                                                                                                                                                                                                                                                    actions.innerHTML = `
                                                                                                                                                                                                                                                                                        <button class="btn-mini" onclick="editFixedCost('${cat.key}','${item.id}')">Wijzig</button>
                                                                                                                                                                                                                                                                                        <button class="btn-mini danger" onclick="deleteFixedCost('${cat.key}','${item.id}')">Verwijder</button>
                                                                                                                                                                                                                                                                                    `;

                                                                                                                                                                                                                                                                                    right.appendChild(amountEl);
                                                                                                                                                                                                                                                                                    right.appendChild(actions);

                                                                                                                                                                                                                                                                                    row.appendChild(nameEl);
                                                                                                                                                                                                                                                                                    row.appendChild(right);
                                                                                                                                                                                                                                                                                    categoryDiv.appendChild(row);

                                                                                                                                                                                                                                                                                    fixedTotalCents += Number(item.amountCents) || 0;
                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                            fixedListEl.appendChild(categoryDiv);
                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                        const fixedTotalEl = document.getElementById('fixedCostsTotal');
                                                                                                                                                                                                                                                                        if (fixedTotalEl) fixedTotalEl.textContent = formatEuro(fixedTotalCents);

                                                                                                                                                                                                                                                                        const netEl = document.getElementById('netAfterFixed');
                                                                                                                                                                                                                                                                        if (netEl) netEl.textContent = formatEuro(incomeTotalCents - fixedTotalCents);
                                                                                                                                                                                                                                                                        // Vrij te besteden (berekend) = (Inkomen ‚àí Vaste lasten) ‚àí boodschappen cap ‚àí autosparen
                                                                                                                                                                                                                                                                        const monthKeyForFree = monthKey || getMonthKeyForDate(getNLDate());
                                                                                                                                                                                                                                                                        const netAfterFixedCents = (calculateIncomeTotalCents(monthKeyForFree) - calculateFixedCostsTotalCents());

                                                                                                                                                                                                                                                                        const groceriesCapCents = MONTHLY_GROCERY_CAP_CENTS; // ‚Ç¨1.050 (35/dag max p/m)
                                                                                                                                                                                                                                                                        const autoSaveCents = getAutoSaveForMonthCents(monthKeyForFree);

                                                                                                                                                                                                                                                                        const freeCents = getFreeBudgetCents(monthKeyForFree);

                                                                                                                                                                                                                                                                        const freeEl = document.getElementById('computedFreeBudget');
                                                                                                                                                                                                                                                                        const freeNoteEl = document.getElementById('computedFreeBudgetNote');
                                                                                                                                                                                                                                                                        const groEl = document.getElementById('freeBreakdownGroceries');
                                                                                                                                                                                                                                                                        const asEl = document.getElementById('freeBreakdownAutoSave');

                                                                                                                                                                                                                                                                        if (freeEl) freeEl.textContent = formatEuro(freeCents);

                                                                                                                                                                                                                                                                        if (freeNoteEl) {
                                                                                                                                                                                                                                                                            freeNoteEl.textContent = (monthKey === 'jan2026')
                                                                                                                                                                                                                                                                                ? 'Januari: vrij te besteden is vast ‚Ç¨424 (los van inkomen)'
                                                                                                                                                                                                                                                                                : `(${formatEuro(netAfterFixedCents)} over na vaste lasten) ‚àí ${formatEuro(groceriesCapCents)} boodschappen cap ‚àí ${formatEuro(autoSaveCents)} autosparen`;
                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                        if (groEl) groEl.textContent = `Boodschappen cap: ${formatEuro(groceriesCapCents)}`;
                                                                                                                                                                                                                                                                        if (asEl) asEl.textContent = `Autosparen: ${formatEuro(autoSaveCents)}`;


                                                                                                                                                                                                                                } catch (error) {
                                                                                                                                                                                                                                                                        console.error('Error updating fixed costs view:', error);
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                        }

        // PROGNOSE VIEW (FIXED - based on today, not dropdown)
                function updatePrognoseView() {
                    try {
                        const canvas = document.getElementById('prognoseChart');
                        if (!canvas) return;

                        const ctx = canvas.getContext('2d');
                        const dpr = window.devicePixelRatio || 1;

                        const cssWidth = canvas.offsetWidth || 320;
                        const cssHeight = 260;

                        canvas.width = Math.floor(cssWidth * dpr);
                        canvas.height = Math.floor(cssHeight * dpr);
                        canvas.style.height = cssHeight + 'px';

                        // Reset transform so 1 unit in drawing space == 1 CSS pixel
                        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                        ctx.clearRect(0, 0, cssWidth, cssHeight);

                        const now = new Date();
                        const today = startOfDay(getNLDate());

                        // Build a "stock-like" line that follows the REALTIME savings total over time.
                        // No future forecast: only history + current value.
                        function parseDateKey(dateKey) {
                            const [y, m, d] = String(dateKey).split('-').map(Number);
                            return new Date(y, (m || 1) - 1, d || 1);
                        }

                        const events = [];

                        // Salary (auto-save) events: only when the salary date has passed.
                        for (const p of salaryPeriods) {
                            if (!p.salaryDate) continue;
                            const sd = new Date(p.salaryDate);
                            if (!isNaN(sd) && sd <= now) {
                                events.push({ t: sd, delta: AUTO_SAVE_CENTS });
                            }
                        }

                        // Grocery events: per day net delta = 35 - totalSpentThatDay.
                        // We apply the net delta at the timestamp of the last entry that day (or end-of-day).
                        Object.keys(appData.groceries || {}).forEach(monthKey => {
                            const monthGroceries = appData.groceries[monthKey] || {};
                            Object.keys(monthGroceries).forEach(dateKey => {
                                const entries = monthGroceries[dateKey];
                                if (!Array.isArray(entries) || entries.length === 0) return;

                                const dayTotalCents = entries.reduce((sum, e) => {
                                    if (e.amountCents !== undefined) return sum + (Number(e.amountCents) || 0);
                                    if (e.amount !== undefined) return sum + toCents(e.amount);
                                    return sum;
                                }, 0);

                                const delta = DAILY_GROCERY_BUDGET_CENTS - dayTotalCents;

                                let t = null;
                                for (const e of entries) {
                                    const ts = e.timestamp || e.date || e.createdAt;
                                    if (!ts) continue;
                                    const d = new Date(ts);
                                    if (!isNaN(d) && (!t || d > t)) t = d;
                                }
                                if (!t) {
                                    const d = parseDateKey(dateKey);
                                    t = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 0);
                                }

                                if (t <= now) {
                                    events.push({ t, delta });
                                }
                            });
                        });


                        // Free budget credits: at the start of each salary period we count the full
                        // "Vrij te Besteden" budget as potential savings (+‚Ç¨424). Spending later reduces it 1:1.
                        for (const p of salaryPeriods) {
                            const t = startOfDay(p.startDate);
                            if (t <= now) {
                                events.push({ t, delta: getFreeBudgetCents(p.key) });
                            }
                        }

                        // Free spending events: each spending entry reduces savings immediately (delta = -amount).
                        Object.keys(appData.spending || {}).forEach(monthKey => {
                            const entries = (appData.spending[monthKey] || []).slice();
                            entries.sort((a, b) => {
                                const da = new Date(a.date || a.timestamp || a.createdAt || 0);
                                const db = new Date(b.date || b.timestamp || b.createdAt || 0);
                                return da - db;
                            });

                            for (const e of entries) {
                                const amt = (e.amountCents !== undefined)
                                    ? (Number(e.amountCents) || 0)
                                    : (e.amount !== undefined ? toCents(e.amount) : 0);

                                if (!amt) continue;

                                const tRaw = e.date || e.timestamp || e.createdAt;
                                const t = tRaw ? new Date(tRaw) : now;
                                const tt = (!isNaN(t) ? t : now);

                                if (tt <= now) {
                                    events.push({ t: tt, delta: -amt });
                                }
                            }
                        });

        events.sort((a, b) => a.t - b.t);

                        // Determine first date on chart: first started salary period (fallback: jan2026 start)
                        let firstStart = startOfDay(salaryPeriods[0].startDate);
                        for (const p of salaryPeriods) {
                            const s = startOfDay(p.startDate);
                            if (s <= today) {
                                firstStart = s;
                                break;
                            }
                        }

                        // Build series
                        const series = [];
                        let running = START_SAVINGS_CENTS;
                        series.push({ t: firstStart, v: running });

                        for (const ev of events) {
                            if (ev.t < firstStart) continue;
                            running += ev.delta;
                            series.push({ t: ev.t, v: running });
                        }

                        // Ensure last point equals the current realtime savings value
                        const currentCents = calculateRealtimeSavingsCents();
                        series.push({ t: now, v: currentCents });

                        // Update the value label under the chart
                        const valueEl = document.getElementById('currentSavingsValue');
                        if (valueEl) valueEl.textContent = formatEuro(currentCents);

                        // If not enough points, show placeholder
                        if (series.length < 2 || cssWidth < 10) {
                            ctx.fillStyle = 'rgba(255,255,255,0.6)';
                            ctx.font = '14px system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText('Nog geen data om te tekenen', cssWidth / 2, cssHeight / 2);
                            return;
                        }

                        // Chart mapping
                        const padding = 42;
                        const cw = cssWidth - padding * 2;
                        const ch = cssHeight - padding * 2;

                        const values = series.map(p => p.v);
                        let minV = Math.min(...values);
                        let maxV = Math.max(...values);

                        if (minV === maxV) {
                            minV -= 5000;
                            maxV += 5000;
                        }

                        const padV = Math.round((maxV - minV) * 0.12) || 5000;
                        minV -= padV;
                        maxV += padV;

                        const t0 = series[0].t.getTime();
                        const t1 = series[series.length - 1].t.getTime() || (t0 + 1);

                        const xFor = (t) => padding + ((t.getTime() - t0) / (t1 - t0)) * cw;
                        const yFor = (v) => padding + (1 - ((v - minV) / (maxV - minV))) * ch;

                        // Grid
                        ctx.strokeStyle = 'rgba(255,255,255,0.10)';
                        ctx.lineWidth = 1;

                        for (let i = 0; i <= 4; i++) {
                            const y = padding + (ch / 4) * i;
                            ctx.beginPath();
                            ctx.moveTo(padding, y);
                            ctx.lineTo(padding + cw, y);
                            ctx.stroke();
                        }

                        // Y axis labels
                        ctx.fillStyle = 'rgba(255,255,255,0.55)';
                        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif';
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'middle';

                        for (let i = 0; i <= 4; i++) {
                            const v = maxV - ((maxV - minV) / 4) * i;
                            const y = padding + (ch / 4) * i;
                            ctx.fillText(formatEuro(Math.round(v)), padding - 8, y);
                        }

                        // X axis labels (start / mid / end)
                        const fmt = (d) => d.toLocaleDateString('nl-NL', { day: '2-digit', month: 'short' }).replace('.', '').toUpperCase();

                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'top';

                        const yLabel = padding + ch + 10;
                        ctx.fillText(fmt(series[0].t), padding, yLabel);
                        ctx.fillText(fmt(new Date((t0 + t1) / 2)), padding + cw / 2, yLabel);
                        ctx.fillText(fmt(series[series.length - 1].t), padding + cw, yLabel);

                        // Line (stock-like)
                        const accent = (getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#00BFFF').trim();
                        ctx.strokeStyle = accent;
                        ctx.lineWidth = 2.5;
                        ctx.beginPath();

                        series.forEach((p, i) => {
                            const x = xFor(p.t);
                            const y = yFor(p.v);
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        });

                        ctx.stroke();

                        // Last point dot
                        const last = series[series.length - 1];
                        ctx.fillStyle = accent;
                        ctx.beginPath();
                        ctx.arc(xFor(last.t), yFor(last.v), 4, 0, Math.PI * 2);
                        ctx.fill();

                    } catch (error) {
                        console.error('Error updating savings chart:', error);
                    }
                }

        // CALCULATOR (unchanged)
        let calcValue = '0';

        function openCalculator() {
            calcValue = '0';
            const display = document.getElementById('calcDisplay');
            if (display) display.textContent = '0';
            openModal('calculatorModal');
        }

        function calcInput(val) {
            if (calcValue === '0') {
                calcValue = val;
            } else {
                calcValue += val;
            }
            const display = document.getElementById('calcDisplay');
            if (display) display.textContent = calcValue;
        }

        function calcEqual() {
            try {
                calcValue = eval(calcValue).toString();
                const display = document.getElementById('calcDisplay');
                if (display) display.textContent = calcValue;
            } catch (e) {
                const display = document.getElementById('calcDisplay');
                if (display) display.textContent = 'ERROR';
                calcValue = '0';
            }
        }

        function calcClear() {
            calcValue = '0';
            const display = document.getElementById('calcDisplay');
            if (display) display.textContent = '0';
        }

        // SETTINGS
        function updateSettingsView() {
            const notifToggle = document.getElementById('notifToggle');
            if (notifToggle) {
                if (appData.notificationsEnabled) {
                    notifToggle.classList.add('active');
                } else {
                    notifToggle.classList.remove('active');
                }
            }
        }

        function toggleNotifications() {
            appData.notificationsEnabled = !appData.notificationsEnabled;
            saveData();
            updateSettingsView();
            
            if (appData.notificationsEnabled) {
                requestNotificationPermission();
                showNotification('Notificaties aan', 'Je ontvangt nu dagelijkse herinneringen', 'success');
            } else {
                showNotification('Notificaties uit', 'Dagelijkse herinneringen uitgeschakeld', 'info');
            }
        }

        function toggleDarkMode() {
            showNotification('Dark Mode', 'Deze app is altijd in dark mode', 'info');
        }

        // TOOLS
        function exportToPDF() {
            showNotification('PDF Export', 'Feature in ontwikkeling...', 'info');
        }

        function backupData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `budget-backup-${formatDate(getNLDate())}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Backup Gemaakt', 'Data gedownload', 'success');
        }

        function resetAllData() {
            if (confirm('Weet je zeker dat je ALLE data wilt wissen? Dit kan niet ongedaan gemaakt worden!')) {
                if (confirm('Laatste waarschuwing! ALLES wordt gewist.')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        // STREAK
        function checkStreak() {
            const today = formatDate(getNLDate());
            const yesterday = new Date(getNLDate());
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = formatDate(yesterday);
            
            const todayMonthKey = getMonthKeyForDate(getNLDate());
            const yesterdayMonthKey = getMonthKeyForDate(yesterday);
            
            const todayGroceries = appData.groceries[todayMonthKey] || {};
            const yesterdayGroceries = appData.groceries[yesterdayMonthKey] || {};
            
            if (todayGroceries[today]) {
                if (yesterdayGroceries[yesterdayStr] || appData.streak === 0) {
                    appData.streak++;
                }
            } else {
                if (!yesterdayGroceries[yesterdayStr] && appData.streak > 0) {
                    appData.streak = 0;
                }
            }
            
            if (appData.streak >= 7 && !appData.achievements.includes('streak7')) {
                appData.achievements.push('streak7');
                showAchievement('7 Dagen Streak! üî•', 'Je bent een week lang consistent!');
            }
            
            saveData();
        }

        // NOTIFICATIONS
        function showNotification(title, text, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const titleEl = document.createElement('div');
            titleEl.className = 'notification-title';
            titleEl.textContent = title;
            
            const textEl = document.createElement('div');
            textEl.className = 'notification-text';
            textEl.textContent = text;
            
            notification.appendChild(titleEl);
            notification.appendChild(textEl);
            document.body.appendChild(notification);
            
            if (navigator.vibrate) {
                if (type === 'success') {
                    navigator.vibrate([50, 30, 50]);
                } else if (type === 'warning') {
                    navigator.vibrate([100, 50, 100]);
                } else {
                    navigator.vibrate(50);
                }
            }
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -100px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showAchievement(title, desc) {
            const achievement = document.createElement('div');
            achievement.className = 'achievement-badge';
            
            achievement.innerHTML = `
                <div class="achievement-icon">üèÜ</div>
                <div class="achievement-title">${title}</div>
                <div class="achievement-desc">${desc}</div>
            `;
            
            document.body.appendChild(achievement);
            
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100, 50, 100]);
            }
            
            setTimeout(() => {
                achievement.style.transform = 'translate(-50%, -50%) scale(0)';
                setTimeout(() => achievement.remove(), 600);
            }, 3000);
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function scheduleReminder() {
            if (!appData.notificationsEnabled) return;
            
            const now = getNLDate();
            const reminder = getNLDate();
            reminder.setHours(22, 0, 0, 0);
            
            if (now > reminder) {
                reminder.setDate(reminder.getDate() + 1);
            }
            
            const timeUntilReminder = reminder - now;
            
            setTimeout(() => {
                const todayStr = formatDate(getNLDate());
                const todayMonthKey = getMonthKeyForDate(getNLDate());
                const todayGroceries = appData.groceries[todayMonthKey] || {};
                
                if (!todayGroceries[todayStr]) {
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('Budget Tracker üí∞', {
                            body: 'Vergeet niet je boodschappen van vandaag in te vullen! üõí',
                            tag: 'daily-reminder'
                        });
                    } else {
                        showNotification('Budget Tracker üí∞', 'Vergeet niet je boodschappen van vandaag in te vullen! üõí', 'info');
                    }
                }
                scheduleReminder();
            }, timeUntilReminder);
        }

        // DATA PERSISTENCE (with migration from old format)
        function saveData() {
            try {
                localStorage.setItem('budgetAppData', JSON.stringify(appData));
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('budgetAppData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    
                    // Migrate old format to new format (euros to cents)
                    if (parsed.groceries) {
                        Object.keys(parsed.groceries).forEach(monthKey => {
                            Object.keys(parsed.groceries[monthKey]).forEach(dateKey => {
                                const entries = parsed.groceries[monthKey][dateKey];
                                if (Array.isArray(entries)) {
                                    entries.forEach(entry => {
                                        if (entry.amount !== undefined && entry.amountCents === undefined) {
                                            entry.amountCents = toCents(entry.amount);
                                            delete entry.amount;
                                        }
                                    });
                                }
                            });
                        });
                    }
                    
                    if (parsed.spending) {
                        Object.keys(parsed.spending).forEach(monthKey => {
                            const entries = parsed.spending[monthKey];
                            if (Array.isArray(entries)) {
                                entries.forEach(entry => {
                                    if (entry.amount !== undefined && entry.amountCents === undefined) {
                                        entry.amountCents = toCents(entry.amount);
                                        delete entry.amount;
                                    }
                                });
                            }
                        });
                    }
                    
                    appData = {...appData, ...parsed};
                    // PIN migration: older builds used 1234 as default; user default is now 4771
                    if (!appData.pin || String(appData.pin).trim() === '1234') {
                        appData.pin = '4771';
                    }
                    // Migrate/ensure structures
                    ensureFixedCostsIds();
                    ensureIncomeForMonth(appData.currentMonth);
                    
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // MONTH SELECTOR
        function populateMonthSelector() {
            const selector = document.getElementById('monthSelector');
            if (selector) {
                selector.innerHTML = '';
                salaryPeriods.forEach(period => {
                    const option = document.createElement('option');
                    option.value = period.key;
                    option.textContent = period.name;
                    if (period.key === appData.currentMonth) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
            }
        }

        // INIT
                function init() {
                    loadData();
            seedUserFinanceDefaultsIfNeeded();
                    ensureActiveMonthSynced();   // auto-switch on salary-month change (only once per transition)
                    populateMonthSelector();
                    updateMenuBudgetLabels();

                    const pinScreen = document.getElementById('pinScreen');
                    if (pinScreen) {
                        pinScreen.classList.remove('hidden');
                    }

                    if (appData.notificationsEnabled) {
                        requestNotificationPermission();
                        scheduleReminder();
                    }
                }

        // START
        init();
    </script>
</body>
</html>
